<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Gestion RH - QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="roboto.css" rel="stylesheet">
    <link href="icons.css" rel="stylesheet">
    <link rel="manifest" href="/systeme-rh-behavana/manifest.json">



    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-success: #4CAF50;
            --md-sys-color-warning: #FF9800;
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-primary-container));
            color: var(--md-sys-color-on-primary);
            padding: 24px;
            border-radius: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .theme-toggle, .settings-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--md-sys-color-on-primary);
            transition: all 0.3s ease;
            z-index: 2;
        }

        .settings-btn {
            right: 80px;
        }

        .theme-toggle:hover, .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .nav-tabs {
            display: flex;
            background: var(--md-sys-color-surface-variant);
            border-radius: 16px;
            padding: 4px;
            margin-bottom: 24px;
            gap: 4px;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            min-width: 120px;
        }

        .nav-tab.active {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .nav-tab:hover:not(.active) {
            background: var(--md-sys-color-outline-variant);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--md-sys-color-surface-variant);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-icon {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-content h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }

        .stat-content p {
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        .card {
            background: var(--md-sys-color-surface-variant);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--md-sys-color-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 8px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.12);
        }

        .btn {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .btn-danger {
            background: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .btn-success {
            background: var(--md-sys-color-success);
        }

        .btn-warning {
            background: var(--md-sys-color-warning);
        }


        .employee-list {
            display: grid;
            gap: 12px;
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-on-surface-variant);
            font-size: 20px;
            z-index: 1;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 48px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 24px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.12);
        }

        .employee-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-top: 8px;
        }

        .employee-status.present {
            color: var(--md-sys-color-success);
        }

        .employee-status.absent {
            color: var(--md-sys-color-error);
        }

        .employee-status.qr-present {
            color: var(--md-sys-color-primary);
        }


        .employee-item {
            background: var(--md-sys-color-surface);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .employee-item:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .employee-info h4 {
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }

        .employee-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .employee-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            transform: scale(1.1);
        }

        .btn-icon:active {
            transform: scale(0.95); /* Ataovy kely kokoa rehefa tsindriana */
            background: var(--md-sys-color-outline-variant); /* Loko hafa kely */
        }


        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--md-sys-color-surface);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .attendance-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--md-sys-color-error);
        }

        .status-indicator.present {
            background: var(--md-sys-color-success);
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--md-sys-color-primary);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .modal-header h3 {
            color: var(--md-sys-color-primary);
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            padding: 4px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--md-sys-color-success);
            border: 1px solid var(--md-sys-color-success);
        }

        .alert-error {
            background: rgba(179, 38, 30, 0.1);
            color: var(--md-sys-color-error);
            border: 1px solid var(--md-sys-color-error);
        }

        /* ================== AMPIO IRETO ANDALANA VAOVAO IRETO ================== */
        .alert-warning {
            background: rgba(255, 152, 0, 0.1); /* Loko mavo manopy volomboasary (amber) */
            color: #FFA000; /* Loko matro-doko kely ho an'ny soratra */
            border: 1px solid var(--md-sys-color-warning);
            border-left: 5px solid var(--md-sys-color-warning); /* Tsipika matevina eo ankavia mba hisongadina */
        }

        .alert-info {
            background: rgba(103, 80, 164, 0.08); /* Loko volomparasy manify (primary) */
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-primary-container);
            border-left: 5px solid var(--md-sys-color-primary);
        }
        /* ======================================================================= */

        /* QR Code Styles */
        .qr-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .qr-card {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .qr-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .qr-code-canvas {
            margin: 12px 0;
            border-radius: 8px;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        #qrVideo {
            width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid var(--md-sys-color-primary);
            border-radius: 12px;
            background: rgba(103, 80, 164, 0.1);
            pointer-events: none;
        }

        .scan-overlay::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--md-sys-color-primary);
            border-radius: 12px;
            animation: scanPulse 2s ease-in-out infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .scan-result {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .scan-result.success {
            background: var(--md-sys-color-success);
            color: white;
        }

        .scan-result.error {
            background: var(--md-sys-color-error);
            color: white;
        }

        .qr-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .db-status {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .db-status.connected {
            background: rgba(76, 175, 80, 0.1);
            color: var(--md-sys-color-success);
            border: 1px solid var(--md-sys-color-success);
        }

        .db-status.error {
            background: rgba(179, 38, 30, 0.1);
            color: var(--md-sys-color-error);
            border: 1px solid var(--md-sys-color-error);
        }

        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .qr-container {
                grid-template-columns: 1fr;
            }
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--md-sys-color-surface);
            box-shadow: -4px 0 16px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            z-index: 3000;
            padding: 24px;
            overflow-y: auto;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2999;
            display: none;
        }

        .settings-overlay.active {
            display: block;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h3 {
            color: var(--md-sys-color-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Pr√©sence QR Tab */
        .qr-scan-section {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .employee-qr-item {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .employee-qr-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .employee-qr-info h4 {
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }

        .employee-qr-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .qr-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .qr-status.present {
            color: var(--md-sys-color-success);
        }

        .qr-status.absent {
            color: var(--md-sys-color-error);
        }

        .payroll-item {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .payroll-item.paid {
            border-left-color: var(--md-sys-color-success);
        }

        .payroll-item.paid .amount {
            color: var(--md-sys-color-success);
        }

        .payroll-item.paid .material-icons {
            color: var(--md-sys-color-success);
        }

        .payroll-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        /* =================================================== */
        /*  FANATSARANA NY LIStE AVANCE (Trosa)                */
        /* =================================================== */

        /* Famaritana ankapobeny ny kaontenera misy ny trosa */
        #advancesList {
            display: flex;
            flex-direction: column;
            gap: 12px; /* Elanelana eo anelanelan'ny singa tsirairay */
            margin-top: 24px; /* Elanelana avy eo ambony */
        }

        /* Ny endriky ny singa tsirairay ao anaty lisitra */
        .advance-item {
            display: flex;
            justify-content: space-between; /* Mampifanelanelana ny atiny (ankavia sy ankavanana) */
            align-items: center; /* Mampifanitsy azy ireo eo afovoany mitsangana */
            background: var(--md-sys-color-surface); /* Loko fototra avy amin'ny lohahevitra */
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--md-sys-color-outline-variant); /* Sisiny manify mba hisy fiavahana */
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Aloka kely ho an'ny halalina */
        }

        /* Rehefa alefa eo amboniny ny totozy */
        .advance-item:hover {
            transform: translateY(-2px); /* Asondrotra kely */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Aloka lehibebe kokoa */
            border-left: 4px solid var(--md-sys-color-primary); /* Tsipika miloko eo ankavia mba hanamafisana */
            padding-left: 13px; /* Ahitsy kely ny padding mba tsy hihetsika ny lahatsoratra */
        }

        /* Fizarana misy ny fampahalalana (anarana, daty, sns.) */
        .advance-item .advance-info {
            display: flex;
            flex-direction: column; /* Atao mitsangana ny fampahalalana */
            gap: 4px; /* Elanelana kely eo anelanelan'ny andalana */
        }

        /* Ny anaran'ny mpiasa */
        .advance-item .advance-info h4 {
            color: var(--md-sys-color-primary);
            margin: 0;
            font-size: 1.1rem;
        }

        /* Ny lahatsoratra kely (daty, antony) */
        .advance-item .advance-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
            margin: 0;
        }

        /* Ny fizarana misy ny sandan'ny vola sy ny bokotra */
        .advance-item .amount-actions {
            text-align: right; /* Apetraka eo ankavanana ny atiny */
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Atao mifanitsy eo ankavanana daholo */
            gap: 8px;
        }

        /* Ny sandan'ny vola */
        .advance-item .amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--md-sys-color-error); /* Loko mena mba hanamafisana fa trosa io */
        }

        
        #editAdvanceEmployeeName {
            padding: 12px 16px;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 8px;
            color: var(--md-sys-color-on-surface-variant);
        }

        /*Pagination*/
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        .pagination-controls button {
            background: var(--md-sys-color-secondary-container); /* Loko volondavenona */
            color: var(--md-sys-color-on-secondary-container);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        /* Style vaovao ho an'ny fizarana sivana sy fikarohana */
        .filter-controls {
            display: flex;
            gap: 24px; /* Elanelana eo anelanelan'ny fikarohana sy ny safidy */
            align-items: flex-end; /* Mampifanitsy ny singa eo ambany */
            margin-bottom: 24px; /* Elanelana avy eo ambany */
            flex-wrap: wrap; /* Mba tsy hifandona amin'ny finday */
        }

        .filter-controls .search-group {
            flex-grow: 1; /* Mba haka ny toerana malalaka rehetra ny fikarohana */
        }

        .filter-controls .items-per-page-group {
            flex-shrink: 0; /* Mba tsy hihena ny sakan'ny safidy */
            min-width: 150px; /* Sakan'ny kely indrindra */
        }

        /* Fanitsiana kely ny search-container mba tsy hisy margin ambany intsony */
        .search-container {
            margin-bottom: 0; 
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="toggleSettings()">
                <span class="material-icons">settings</span>
            </button>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span class="material-icons" id="theme-icon">dark_mode</span>
            </button>
            <h1><span class="material-icons" style="font-size: 2.5rem; vertical-align: middle;">business</span> Syst√®me RH BEHAVANA</h1>
            <p>Gestion compl√®te du personnel et de la paie avec QR Code</p>
            
            <!-- Status de la base de donn√©es -->
            <div id="dbStatus" class="db-status">
                <span class="material-icons">database</span>
                <span id="dbStatusText">Initialisation de la base de donn√©es...</span>
            </div>
        </div>

        <!-- ================== BLOC VAOVAO HO AN'NY NOTIFICATIONS ================== -->
        <div id="notificationsContainer" style="margin-bottom: 16px; display: flex; flex-direction: column; gap: 8px;">
            <!-- Ho fenoina amin'ny alalan'ny JavaScript ity fizarana ity -->
        </div>
        <!-- ======================================================================= -->


        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">
                <span class="material-icons">dashboard</span>
                Tableau de Bord
            </button>
            <button class="nav-tab" onclick="showSection('employees')">
                <span class="material-icons">people</span>
                Employ√©s
            </button>

            <button class="nav-tab" onclick="showSection('groups')">
                <span class="material-icons">groups</span>
                Groupes
            </button>

            <button class="nav-tab" onclick="showSection('employee-stats')">
                <span class="material-icons">person_search</span>
                Statut Employ√©
            </button>
            <button class="nav-tab" onclick="showSection('attendance')">
                <span class="material-icons">schedule</span>
                Pr√©sence
            </button>
            <button class="nav-tab" onclick="showSection('qr-presence')">
                <span class="material-icons">qr_code</span>
                Pr√©sence QR
            </button>
            <button class="nav-tab" onclick="showSection('qr-codes')">
                <span class="material-icons">qr_code_2</span>
                Codes QR
            </button>
            <button class="nav-tab" onclick="showSection('advances')">
                <span class="material-icons">savings</span>
                Avances
            </button>
            <button class="nav-tab" onclick="showSection('payroll')">
                <span class="material-icons">payments</span>
                Paie
            </button>
            
            <button class="nav-tab" onclick="showSection('stc')">
                <span class="material-icons">exit_to_app</span>
                Solde de Tout Compte
            </button>

            <button class="nav-tab" onclick="showSection('payments')">
                <span class="material-icons">history</span>
                Paiements
            </button>
            <button class="nav-tab" onclick="showSection('reports')">
                <span class="material-icons">analytics</span>
                Rapports
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">people</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalEmployees">0</h3>
                        <p>Total Employ√©s</p>
                    </div>
                </div>

                <!-- ================== BLOC VAOVAO NAMPIDIRINA ================== -->
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--md-sys-color-secondary);">
                        <span class="material-icons">fact_check</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="checkedInToday">0</h3>
                        <p>Employ√©s Ayant Point√©</p>
                    </div>
                </div>
                <!-- ============================================================ -->

                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">check_circle</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="presentToday">0</h3>
                        <!-- FANovana ny soratra -->
                        <p>Journ√©es Compl√®tes (>= 4h)</p>
                    </div>
                </div>
                
                <!-- ... Ny tohin'ny stat-card hafa ... -->
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">qr_code</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="qrScansToday">0</h3>
                        <p>Scans QR Aujourd'hui</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">payments</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalSalaries">0 Ar</h3>
                        <p>Salaires ce Mois</p>
                    </div>
                </div>
            </div>
            <!-- Ity bloc vaovao ity dia apetraka ao anatin'ny #dashboard, eo ambanin'ny stats-grid -->
            <div class="card" style="margin-top: 24px;">
                <h2 style="margin-bottom: 24px;"><span class="material-icons">analytics</span>Aper√ßu Visuel</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px;">
                    
                    <!-- Toerana ho an'ny Grafika 1: Pr√©sence -->
                    <div>
                        <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">Taux de Pr√©sence (7 derniers jours)</h3>
                        <div style="position: relative; height:300px;">
                            <canvas id="weeklyAttendanceChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Toerana ho an'ny Grafika 2: Groupes -->
                    <div>
                        <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">R√©partition des Employ√©s par Groupe</h3>
                        <div style="position: relative; height:300px;">
                            <canvas id="groupDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- =================================================== -->
                    <div>
                        <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">R√©partition par Genre</h3>
                        <div style="position: relative; height:280px;">
                            <canvas id="genderDistributionChart"></canvas>
                        </div>
                    </div>
                    <!-- =================================================== -->

                </div>
            </div>

            
        </div>

        <!-- Employees Section -->
        <div id="employees" class="section">
            <div class="card">
                <h2><span class="material-icons">people</span>Liste des Employ√©s</h2>
                <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
                    <button class="btn" onclick="openAddEmployeeModal()"> <!-- Mila manamboatra an'ity fonction ity ianao -->
                        <span class="material-icons">person_add</span>
                        Ajouter un Nouvel Employ√©
                    </button>
                </div>
                <!-- ... eo ambanin'ny <h2> ... </h2> ... -->
                <div class="form-group" style="max-width: 300px; margin-bottom: 16px;">
                    <label for="employeeGroupFilter">Filtrer par Groupe</label>
                    <div class="select-dropdown">
                        <select class="form-control" id="employeeGroupFilter" onchange="displayEmployees()">
                            <option value="all">Tous les Groupes</option>
                            <option value="none">Sans Groupe</option>
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </select>
                    </div>
                </div>
                <!-- ... eo ambonin'ny search-container ... -->

                <div class="search-container">
                    <span class="material-icons search-icon">search</span>
                    <input type="text" class="search-input" id="employeeSearch" placeholder="Rechercher un employ√©...">
                </div>
                <!-- FANAMPIANA VAOVAO -->
                <div class="form-group" style="max-width: 200px; margin-top: 16px;">
                    <label for="employeeItemsPerPageSelect">El√©ments par page</label>
                    <select id="employeeItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('employee', this.value)">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>

                <div class="employee-list" id="employeeList"></div>
                <div class="pagination-controls" id="employeePagination">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>

            </div>
        </div>

        <!-- Groups Section -->
        <div id="groups" class="section">
            <div class="card">
                <h2><span class="material-icons">groups</span>Gestion des Groupes d'Employ√©s</h2>
                <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                    Cr√©ez et g√©rez les √©quipes ou d√©partements de votre organisation.
                </p>

                <form id="groupForm" style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="groupName">Nom du Groupe</label>
                            <input type="text" id="groupName" class="form-control" placeholder="Ex: √âquipe Technique, Vente, Administration" required>
                        </div>
                        <div class="form-group">
                            <label for="groupDescription">Description (Optionnel)</label>
                            <input type="text" id="groupDescription" class="form-control" placeholder="Courte description du r√¥le du groupe">
                        </div>
                    </div>
                    <input type="hidden" id="groupId">
                    <button type="submit" class="btn">
                        <span class="material-icons">add</span>
                        <span id="groupFormBtnText">Ajouter le Groupe</span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelEditGroupBtn" style="display: none;" onclick="cancelGroupEdit()">
                        <span class="material-icons">cancel</span>
                        Annuler
                    </button>
                </form>

                <h3>Liste des Groupes</h3>
                <div id="groupList" class="employee-list">
                    <!-- Ho fenoina amin'ny alalan'ny JavaScript -->
                </div>
            </div>
        </div>


        <!-- Statut Employ√©es-->
                <!-- Statut Employ√© (Smart Search) Section - VERSION NOHATSARAINA -->
        <div id="employee-stats" class="section">
            <div class="card">
                <h2><span class="material-icons">person_search</span>Recherche Intelligente de Statut</h2>
                <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                    Recherchez un employ√© par son nom pour voir son statut en temps r√©el.
                </p>

                <div class="form-row" style="align-items: flex-end;">
                    <!-- Sehatra Fikarohana vaovao -->
                    <div class="form-group">
                        <label for="smartSearchInput">Nom de l'employ√©</label>
                        <div class="search-container" style="margin-bottom: 0;">
                            <span class="material-icons search-icon">search</span>
                            <input type="text" class="search-input" id="smartSearchInput" placeholder="Commencez √† taper un nom...">
                        </div>
                    </div>
                    <!-- Safidy volana (tsy miova) -->
                    <div class="form-group">
                        <label for="statsMonth">Mois</label>
                        <input type="month" class="form-control" id="statsMonth">
                    </div>
                </div>

                <!-- Fampisehoana ny vokatry ny fikarohana -->
                <div id="smartSearchResults" style="margin-top: 16px;"></div>
                
                <!-- Fampisehoana ny tatitra rehefa misy voafidy -->
                <div id="employeeStatusResults" style="margin-top: 24px;"></div>
            </div>
        </div>


        <!-- QR Presence Section -->
        <!-- =================================================== -->
        <!--      QR Presence Section (VERSION NOHATSARAINA)     -->
        <!-- =================================================== -->
        <div id="qr-presence" class="section">
            <div class="qr-scan-section">
                <h2><span class="material-icons">qr_code_scanner</span>Scanner QR Code pour Pr√©sence</h2>
                <p>Tsindrio ny bokotra hanombohana ny scan.</p>
                
                <!-- 
                    NAFANA DAHOLO IREO SINGA TALOHA (video, canvas, overlay, sns.)
                    SATRIA EFA AO ANATIN'ILAY MODAL IZY IREO ANKEHITRINY.
                    BOKOTRA TOKANA SISA NO ILAINA ETO.
                -->
                <div style="margin-top: 16px;">
                    <button class="btn" onclick="startQRScan('attendance')">
                        <span class="material-icons">camera_alt</span>
                        D√©marrer le Scanner
                    </button>
                </div>
            </div>

            <div class="card">
                <h2><span class="material-icons">today</span>Pr√©sences QR d'Aujourd'hui</h2>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <input type="date" class="form-control" id="qrAttendanceDate" style="max-width: 200px;" onchange="qrAttendanceCurrentPage = 1; displayQRAttendance()">
                    <button class="btn btn-secondary" onclick="refreshQRAttendance()">
                        <span class="material-icons">refresh</span>
                        Actualiser
                    </button>
                    <button class="btn btn-warning" onclick="exportQRAttendancePDF()">
                        <span class="material-icons">picture_as_pdf</span>
                        Export PDF
                    </button>
                </div>
                <div id="qrAttendanceList"></div>
                <!-- FANAMPIANA VAOVAO HO AN'NY PAGINATION -->
                <div class="pagination-controls" id="qrAttendancePagination" style="margin-top: 16px;">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>

            </div>
        </div>


        <!-- QR Codes Section -->
        <div id="qr-codes" class="section">
            <div class="card">
                <h2><span class="material-icons">qr_code_2</span>Codes QR des Employ√©s</h2>
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="btn" onclick="generateAllQRCodes()">
                        <span class="material-icons">refresh</span>
                        G√©n√©rer Tous les QR
                    </button>
                    <button class="btn btn-secondary" onclick="downloadAllQRCodes()">
                        <span class="material-icons">download</span>
                        T√©l√©charger Tous
                    </button>
                    <button class="btn btn-warning" onclick="printAllQRCodes()">
                        <span class="material-icons">print</span>
                        Imprimer Tous
                    </button>
                </div>
                <div class="qr-container" id="qrContainer"></div>
            </div>
        </div>

        <!-- Attendance Section (Original) -->
        <div id="attendance" class="section">
            <div class="card">
                <h2><span class="material-icons">schedule</span>Gestion des Pr√©sences (Manuel)</h2>
                <div class="form-row" style="margin-bottom: 16px;">
                    <div class="form-group">
                        <label>Date de Pr√©sence</label>
                        <input type="date" class="form-control" id="attendanceDate" onchange="displayAttendance()">
                    </div>
                    <div class="form-group">
                        <label style="visibility: hidden;">Actions</label>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="goToPreviousDay()">
                                <span class="material-icons">chevron_left</span>
                                Jour Pr√©c√©dent
                            </button>
                            <button class="btn btn-secondary" onclick="goToNextDay()">
                                <span class="material-icons">chevron_right</span>
                                Jour Suivant
                            </button>
                        </div>
                    </div>
                                    <!-- Champ de recherche d'employ√©s pour la pr√©sence -->
                    <!-- RAFITRA VAOVAO NOHATSARAINA -->
                    <div class="filter-controls">
                        <!-- Fizarana Fikarohana -->
                        <div class="form-group search-group">
                            <label for="attendanceEmployeeSearch">Rechercher un employ√©</label>
                            <div class="search-container">
                                <span class="material-icons search-icon">search</span>
                                <input type="text" class="search-input" id="attendanceEmployeeSearch" placeholder="Taper un nom..." oninput="filterAttendanceEmployees()">
                            </div>
                        </div>

                        <!-- Fizarana Safidy Isan'ny Singa -->
                        <div class="form-group items-per-page-group">
                            <label for="attendanceItemsPerPageSelect">√âl√©ments par page</label>
                            <select id="attendanceItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('attendance', this.value)">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>


                </div>
                <div id="attendanceList"></div>
                <div class="pagination-controls" id="attendancePagination">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>

                <button class="btn" onclick="saveAttendance()" style="margin-top: 16px;">
                    <span class="material-icons">save</span>
                    Enregistrer Pr√©sences
                </button>
            </div>
        </div>

        <!-- Advances Section -->
        <div id="advances" class="section">
            <div class="card">
                <h2><span class="material-icons">savings</span>Gestion des Avances</h2>
                <form id="advanceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Employ√©</label>
                            <div class="select-dropdown">
                                <select class="form-control" id="advanceEmployee" required>
                                    <option value="">S√©lectionner un employ√©</option>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="startQRScan('advance')" title="Scanner QR">

                                    <span class="material-icons">qr_code_scanner</span>
                                </button>
                            </div>
                        </div>

                        
                        <div class="form-group">
                            <label>Montant (Ar)</label>
                            <input type="text" class="form-control currency-input" id="advanceAmount" required data-type="currency">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-control" id="advanceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Motif/Observation</label>
                        <textarea class="form-control" id="advanceReason" rows="3" placeholder="Motif de l'avance..."></textarea>
                    </div>

                    <div id="netSalaryPreview" style="margin-bottom: 16px; padding: 10px; border-radius: 8px; background-color: var(--md-sys-color-surface); display: none;"></div>

                    <button type="submit" class="btn">
                        <span class="material-icons">add</span>
                        Ajouter Avance
                    </button>
                </form>
                <!-- ================== BLOC VAOVAO NAMPIDIRINA ================== -->
                <div id="advancesSummary" style="margin-top: 24px; margin-bottom: 16px; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px; border-left: 5px solid var(--md-sys-color-primary);">
                    <h4 style="margin-top: 0; margin-bottom: 8px; color: var(--md-sys-color-primary);">R√©sum√© des Avances pour le Mois S√©lectionn√©</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.1em; font-weight: 500;">Total des Avances:</span>
                        <span id="totalAdvancesMonth" style="font-size: 1.5em; font-weight: 700; color: var(--md-sys-color-error);">0 Ar</span>
                    </div>
                    <p id="advancesSummaryPeriod" style="font-size: 0.9em; color: var(--md-sys-color-on-surface-variant); margin: 8px 0 0 0; text-align: right;"></p>
                </div>

                <!-- FANAMPIANA VAOVAO: Bokotra Export -->
                <div style="margin-top: 24px; margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="exportAdvances('pdf')">
                        <span class="material-icons">picture_as_pdf</span>
                        Export PDF
                    </button>
                    <button class="btn btn-success" onclick="exportAdvances('xlsx')">
                        <span class="material-icons">table_view</span>
                        Export Excel
                    </button>

                </div>

                <!-- ============================================================ -->
                <!-- Fikarohana sy lisitra vaovao -->
                <div class="form-row" style="margin-top: 24px; align-items: flex-end;">
                    <div class="form-group">
                        <label for="advanceSearchInput">Rechercher par nom, poste ou motif</label>
                        <div class="search-container" style="margin-bottom: 0;">
                            <span class="material-icons search-icon">search</span>
                            <input type="text" class="search-input" id="advanceSearchInput" placeholder="Taper pour filtrer...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="advanceMonthFilter">Filtrer par mois</label>
                        <input type="month" class="form-control" id="advanceMonthFilter">
                    </div>
                    <div class="form-group">
                        <label for="advanceGroupFilter">Filtrer par Groupe</label>
                        <select class="form-control" id="advanceGroupFilter">
                            <option value="all">Tous les Groupes</option>
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </select>
                    </div>
                </div>

                <!-- FANAMPIANA VAOVAO HO AN'NY AVANCES -->
                <div class="form-group" style="max-width: 200px; margin-top: 16px;">
                    <label for="advancesItemsPerPageSelect">√âl√©ments par page</label>
                    <select id="advancesItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('advances', this.value)">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                    </select>
                </div>


                <div id="advancesList" style="margin-top: 16px;"></div>
                <div class="pagination-controls" id="advancesPagination">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>


            </div>
        </div>

        <!-- Payroll Section -->
        <div id="payroll" class="section">
            <div class="card">
                <h2><span class="material-icons">payments</span>Gestion de la Paie</h2>
                
                <!-- Ovaina ity div ity -->
                <div class="form-row" style="align-items: flex-end;">

                    <!-- Fizarana 1: Fisafidianana Mpiasa (Tsy miova) -->
                    <div class="form-group">
                        <label>S√©lectionner Employ√©</label>
                        <div class="select-dropdown" style="display: flex;">
                            <select class="form-control" id="payrollEmployeeSelect" onchange="handlePayrollEmployeeChange()">
                                <option value="">Tous les employ√©s</option>
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="startQRScan('payroll')" title="Scanner QR">
                                <span class="material-icons">qr_code_scanner</span>
                            </button>
                        </div>
                    </div>

                    <!-- Fizarana 2: FANAMPIANA SIVANA VONDROM-PIASA -->
                    <div class="form-group">
                        <label>Filtrer par Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="payrollGroupFilter" onchange="handlePayrollGroupChange()">
                                <option value="all">Tous les Groupes</option>
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </select>
                        </div>
                    </div>

                    <!-- Fizarana 3: Fisafidianana Volana (Tsy miova) -->
                    <div class="form-group">
                        <label>Mois</label>
                        <input type="month" class="form-control" id="payrollMonth" value="">
                    </div>

                </div>

                <button class="btn" onclick="calculatePayroll()">
                    <span class="material-icons">calculate</span>
                    Calculer Paie
                </button>

                <!-- =================================================== -->
                <!--           DIV VAOVAO HO AN'NY FAMINTINANA            -->
                <!-- =================================================== -->
                <div id="payrollSummary" style="margin-top: 24px; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px; display: none;">
                    <h3 style="color: var(--md-sys-color-primary); margin-top: 0; margin-bottom: 16px;">R√©sum√© du Paiement</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <p style="margin: 0; font-size: 0.8em; color: var(--md-sys-color-on-surface-variant);">Total Net √† Payer (Initial)</p>
                            <strong id="totalToPay" style="color: var(--md-sys-color-error); font-size: 1.1em;">0 Ar</strong>
                        </div>
                        <div>
                            <p style="margin: 0; font-size: 0.8em; color: var(--md-sys-color-on-surface-variant);">Reste √† Payer</p>
                            <strong id="remainingToPay" style="color: var(--md-sys-color-success); font-size: 1.2em;">0 Ar</strong>
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <p style="margin: 0; font-size: 0.8em; color: var(--md-sys-color-on-surface-variant);">Employ√©s non pay√©s:</p>
                        <div id="unpaidEmployeesList" style="font-size: 0.9em; max-height: 100px; overflow-y: auto;">
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </div>
                    </div>
                </div>

                <div id="payrollResults"></div>
            </div>
        </div>


        <!-- Payments Section -->
        <div id="payments" class="section">
            <div class="card">
                <h2><span class="material-icons">history</span>Historique de Paiement</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Filtrer par Employ√©</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="paymentEmployeeFilter" onchange="displayPayments()">
                                <option value="">Tous les employ√©s</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Recherche</label>
                        <input type="text" class="form-control" id="paymentSearch" placeholder="Rechercher...">
                    </div>
                </div>
                <div id="paymentList"></div>
            </div>
        </div>

        <!-- Solde de Tout Compte Section -->
        <div id="stc" class="section">
            <div class="card">
                <h2><span class="material-icons">exit_to_app</span>Calcul du Solde de Tout Compte</h2>
                <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                    Calculez et finalisez le paiement pour les employ√©s qui quittent l'entreprise.
                </p>

                <div class="form-group">
                    <label>S√©lectionner l'Employ√© (D√©part Programm√©)</label>
                    <div class="select-dropdown">
                        <select class="form-control" id="stcEmployeeSelect" onchange="calculateSTC()">
                            <option value="">-- Choisir un employ√© --</option>
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </select>
                    </div>
                </div>

                <div id="stcResultsContainer" style="margin-top: 24px; display: none;">
                    <!-- Ho fenoina amin'ny JavaScript ny vokatry ny kajy -->
                </div>
            </div>
        </div>


        <!-- Reports Section -->
        <div id="reports" class="section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">today</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="reportPresentToday">0</h3>
                        <p>Pr√©sents Aujourd'hui</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">calendar_month</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="reportPresentMonth">0</h3>
                        <p>Pr√©sences ce Mois</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">payments</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="reportSalariesPaid">0 Ar</h3>
                        <p>Salaires Pay√©s</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">people</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="reportActiveEmployees">0</h3>
                        <p>Employ√©s Actifs</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><span class="material-icons">analytics</span>G√©n√©ration de Rapports</h2>
                
                <div class="form-group" style="max-width: 300px;">
                    <label for="reportMonth">S√©lectionner le mois pour les rapports</label>
                    <input type="month" class="form-control" id="reportMonth">
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px;">
                    <button class="btn" onclick="exportGlobalReport()">
                        <span class="material-icons">download</span>
                        Export Global (JSON)
                    </button>
                    <button class="btn btn-secondary" onclick="exportAttendanceReport()">
                        <span class="material-icons">schedule</span>
                        Export Pr√©sences (JSON)
                    </button>
                    <button class="btn btn-warning" onclick="generatePayrollPDFReport()">
                        <span class="material-icons">picture_as_pdf</span>
                        Rapport de Paie (PDF)
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="modal-header">
            <h3><span class="material-icons">settings</span>Param√®tres</h3>
            <button class="close-btn" onclick="toggleSettings()">
                <span class="material-icons">close</span>
            </button>
        </div>

        <div class="settings-section">
            <h3><span class="material-icons">palette</span>Apparence</h3>
            <div class="form-group">
                <label>Th√®me</label>
                <div class="select-dropdown">
                    <select class="form-control" id="themeSelect" onchange="changeTheme(this.value)">
                        <option value="light">Clair</option>
                        <option value="dark">Sombre</option>
                        <option value="auto">Automatique</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3><span class="material-icons">qr_code</span>QR Code</h3>
            <div class="form-group">
                <label>Taille des QR Codes</label>
                <select class="form-control" id="qrSizeSelect" onchange="updateQRSettings()">
                    <option value="128">Petit (128px)</option>
                    <option value="256" selected>Moyen (256px)</option>
                    <option value="512">Grand (512px)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Couleur QR Code</label>
                <input type="color" class="form-control" id="qrColorSelect" value="#6750A4" onchange="updateQRSettings()">
            </div>
        </div>

        <div class="settings-section">
            

            <!-- =================================================== -->
            <!--       FIZARANA SAUVEGARDE NOHATSARAINA            -->
            <!-- =================================================== -->
            <div class="settings-section">
                <h3><span class="material-icons">backup</span>Sauvegarde et Restauration</h3>
                
                <div class="alert" style="background-color: rgba(255, 152, 0, 0.1); color: var(--md-sys-color-warning); border-color: var(--md-sys-color-warning);">
                    <span class="material-icons">warning</span>
                    <div>
                        <strong>Important:</strong> Pensez √† t√©l√©charger une sauvegarde r√©guli√®rement (ex: chaque semaine) pour prot√©ger vos donn√©es.
                    </div>
                </div>

                <button class="btn" onclick="exportData()" style="width: 100%; margin-bottom: 12px;">
                    <span class="material-icons">file_download</span>
                    T√©l√©charger la Sauvegarde Actuelle
                </button>
                
                <div class="form-group">
                    <label for="importFile" style="cursor: pointer; display: block; padding: 12px; background-color: var(--md-sys-color-secondary-container); text-align: center; border-radius: 8px;">
                        <span class="material-icons">file_upload</span>
                        Importer une Sauvegarde
                    </label>
                    <input type="file" class="form-control" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
                </div>
                <p id="lastBackupInfo" style="font-size: 12px; text-align: center; color: var(--md-sys-color-on-surface-variant);"></p>
            </div>
        </div>
        <!-- FANAMPIANA VAOVAO: Fizarana "√Ä Propos" ao anatin'ny Settings -->
        <div class="settings-section" style="margin-top: 40px; text-align: center; opacity: 0.8;">
            <h3 style="justify-content: center;">
                <span class="material-icons">code</span>
                Mombamomba ny Fampiharana
            </h3>
            <p style="font-size: 14px; margin-top: 8px;">
                Noforonin'i Rado Arijao tamim-pitiavana.
            </p>
            <p style="font-size: 12px; margin-top: 4px;">
                Version 1.0.0 &copy; 2025
            </p>
            <!-- Azonao ampiana rohy mankany amin'ny portfolio-nao raha tianao -->
            <!-- <a href="https://www.ny-tranokalanao.com" target="_blank" class="btn" style="margin-top: 12px;">Portfolio</a> -->
        </div>

    </div>

    <!-- Modals -->
    <div class="modal" id="editEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier Employ√©</h3>
                <button class="close-btn" onclick="closeModal('editEmployeeModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="editEmployeeForm">
                <input type="hidden" id="editEmployeeId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom Complet</label>
                        <input type="text" class="form-control" id="editEmployeeName" required>
                    </div>
                    <div class="form-group">
                        <label>Poste</label>
                        <input type="text" class="form-control" id="editEmployeePosition" required>
                    </div>
                    <!-- ... aorian'ny div-n'ny editEmployeePosition ... -->
                    <div class="form-group">
                        <label>Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="editEmployeeGroup">
                                <option value="">Aucun groupe</option>
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </select>
                        </div>
                    </div>
                    <!-- ... alohan'ny div-n'ny editEmployeeGender ... -->

                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Genre</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="editEmployeeGender" required>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Salaire Mensuel (Ar)</label>
                        <input type="text" class="form-control currency-input" id="editEmployeeSalary" required data-type="currency">
                    </div>
                </div>
                <div class="form-group">
                    <label>Statut de l'Employ√©</label>
                    <div class="select-dropdown">
                        <select class="form-control" id="editEmployeeStatus">
                            <option value="actif">Actif</option>
                            <option value="depart">D√©part Programm√©</option>
                            <option value="inactif">Inactif (A quitt√©)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="editDepartureDateContainer" style="display: none;">
                    <label>Date de D√©part</label>
                    <input type="date" class="form-control" id="editEmployeeDepartureDate">
                </div>
                <button type="submit" class="btn">
                    <span class="material-icons">save</span>
                    Sauvegarder
                </button>
            </form>
        </div>
    </div>

    <!-- Modal ho an'ny Fanovana Trosa (Avance) -->
    <div class="modal" id="editAdvanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier une Avance</h3>
                <button class="close-btn" onclick="closeModal('editAdvanceModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="editAdvanceForm">
                <input type="hidden" id="editAdvanceId">
                
                <div class="form-group">
                    <label>Employ√©</label>
                    <p id="editAdvanceEmployeeName" style="font-weight: 500; font-size: 1.1rem;"></p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nouveau Montant (Ar)</label>
                        <input type="text" class="form-control currency-input" id="editAdvanceAmount" required data-type="currency">
                    </div>
                    <div class="form-group">
                        <label>Date de l'avance</label>
                        <input type="date" class="form-control" id="editAdvanceDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Motif/Observation</label>
                    <textarea class="form-control" id="editAdvanceReason" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn">
                    <span class="material-icons">save</span>
                    Enregistrer les modifications
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL VAOVAO HO AN'NY FANAMPIANA MPIASA -->
    <div class="modal" id="addEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><span class="material-icons">person_add</span> Ajouter un Nouvel Employ√©</h3>
                <button class="close-btn" onclick="closeModal('addEmployeeModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="employeeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom Complet</label>
                        <input type="text" class="form-control" id="employeeName_add" required>
                    </div>
                    <div class="form-group">
                        <label>Poste</label>
                        <input type="text" class="form-control" id="employeePosition_add" required>
                    </div>
                    <div class="form-group">
                        <label>Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="employeeGroup_add">
                                <option value="">Aucun groupe</option>
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Genre</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="employeeGender_add" required>
                                <option value="">S√©lectionner</option>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Salaire Mensuel (Ar)</label>
                        <input type="text" class="form-control currency-input" id="employeeSalary_add" required data-type="currency">
                    </div>
                </div>
                <button type="submit" class="btn">
                    <span class="material-icons">add</span>
                    Ajouter Employ√©
                </button>
            </form>
        </div>
    </div>

    <!-- ========================================================== -->
    <!--      MODAL VAOVAO HO AN'NY SCANNER QR (IRAIZAN'NY REHETRA)      -->
    <!-- ========================================================== -->
    <div class="modal" id="qrScannerModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="qrScannerTitle"><span class="material-icons">qr_code_scanner</span> Scanner le QR Code</h3>
                <button class="close-btn" onclick="stopQRScan()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <div style="text-align: center; padding: 16px 0;">
                <p id="qrScannerInstruction" style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
                    Veuillez pointer la cam√©ra vers le QR Code de l'employ√©.
                </p>

                <!-- ITO ILAY KAODY NAFINDRA AVY ANY AMBONY -->
                <div class="video-container">
                    <video id="qrVideo" style="width: 100%; border-radius: 8px; display: none;"></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                    <div class="scan-overlay" id="scanOverlay" style="display: none;"></div>
                </div>
                
                <div id="cameraPermissionMessage" class="alert alert-warning" style="display: none; justify-content: center; margin-top: 16px;">
                    <span class="material-icons">videocam_off</span>
                    <span>Mila fahazoan-d√†lana hampiasa ny fakantsary.</span>
                </div>

                <div id="scanResult" class="scan-result" style="display: none; margin-top: 16px;"></div>
            </div>

            <div style="text-align: center; margin-top: 16px; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 16px;">
                <button class="btn btn-danger" onclick="stopQRScan()">
                    <span class="material-icons">cancel</span>
                    Annuler le Scan
                </button>
            </div>
        </div>
    </div>



    <script>
        // ===============================
        // INDEXEDDB MANAGER CLASS (identique √† l'original)
        // ===============================
        class IndexedDBManager {
            constructor() {
                this.db = null;
                this.dbName = 'BehavanaHRSystem';
                this.version = 3; // Augmenter la version pour les nouvelles tables
                this.isInitialized = false;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => {
                        console.error('Erreur lors de l\'ouverture de la base de donn√©es:', request.error);
                        this.updateDBStatus('Erreur de connexion √† la base de donn√©es', 'error');
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        this.isInitialized = true;
                        this.updateDBStatus('Base de donn√©es connect√©e', 'connected');
                        console.log('Base de donn√©es IndexedDB initialis√©e avec succ√®s');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // 1. Famoronana ny table "groups"
                        if (!db.objectStoreNames.contains('groups')) {
                            const groupStore = db.createObjectStore('groups', { keyPath: 'id' });
                            groupStore.createIndex('name', 'name', { unique: true });
                            console.log('‚úÖ ObjectStore "groups" cr√©√©.');
                        }

                        // 2. Fanamarinana sy fanampiana index "groupId" amin'ny table "employees"
                        // Ity fomba ity dia miantoka fa tsy misy erreur na efa misy aza ny table employees
                        if (db.objectStoreNames.contains('employees')) {
                            const employeeStore = event.target.transaction.objectStore('employees');
                            if (!employeeStore.indexNames.contains('groupId')) {
                                employeeStore.createIndex('groupId', 'groupId', { unique: false });
                                console.log('‚úÖ Index "groupId" ajout√© √† "employees".');
                            }
                        }
                        
                        // Cr√©er les stores (tables) existantes
                        if (!db.objectStoreNames.contains('employees')) {
                            const employeeStore = db.createObjectStore('employees', { keyPath: 'id' });
                            employeeStore.createIndex('name', 'name', { unique: false });
                            employeeStore.createIndex('position', 'position', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('attendance')) {
                            const attendanceStore = db.createObjectStore('attendance', { keyPath: 'date' });
                            attendanceStore.createIndex('date', 'date', { unique: true });
                        }

                        if (!db.objectStoreNames.contains('payrolls')) {
                            const payrollStore = db.createObjectStore('payrolls', { keyPath: 'id' });
                            payrollStore.createIndex('employeeId', 'employeeId', { unique: false });
                            payrollStore.createIndex('month', 'month', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('advances')) {
                            const advanceStore = db.createObjectStore('advances', { keyPath: 'id' });
                            advanceStore.createIndex('employeeId', 'employeeId', { unique: false });
                            advanceStore.createIndex('date', 'date', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }

                        // Nouvelles tables pour QR Code
                        if (!db.objectStoreNames.contains('qr_attendance')) {
                            const qrAttendanceStore = db.createObjectStore('qr_attendance', { keyPath: 'id' });
                            qrAttendanceStore.createIndex('employeeId', 'employeeId', { unique: false });
                            qrAttendanceStore.createIndex('date', 'date', { unique: false });
                            qrAttendanceStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('qr_codes')) {
                            const qrCodesStore = db.createObjectStore('qr_codes', { keyPath: 'employeeId' });
                            qrCodesStore.createIndex('generated', 'generated', { unique: false });
                        }

                        console.log('Structures de base de donn√©es cr√©√©es avec support QR Code');
                    };
                });
            }

            updateDBStatus(message, type = 'connected') {
                const statusElement = document.getElementById('dbStatus');
                const textElement = document.getElementById('dbStatusText');
                
                if (statusElement && textElement) {
                    statusElement.className = `db-status ${type}`;
                    textElement.textContent = message;
                } else {
                    console.log(`Status DB: ${message} (${type})`);
                }
            }

            // M√©thodes CRUD g√©n√©riques (identiques √† l'original)
            async add(storeName, data) {
                if (!this.isInitialized) {
                    throw new Error('Base de donn√©es non initialis√©e');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async put(storeName, data) {
                if (!this.isInitialized) {
                    throw new Error('Base de donn√©es non initialis√©e');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async get(storeName, key) {
                if (!this.isInitialized) {
                    throw new Error('Base de donn√©es non initialis√©e');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                if (!this.isInitialized) {
                    throw new Error('Base de donn√©es non initialis√©e');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, key) {
                if (!this.isInitialized) {
                    throw new Error('Base de donn√©es non initialis√©e');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                if (!this.isInitialized) {
                    throw new Error('Base de donn√©es non initialis√©e');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // ===============================
        // APPLICATION STATE & VARIABLES
        // ===============================
        let dbManager = new IndexedDBManager();
        let weeklyAttendanceChartInstance = null;
        let genderDistributionChartInstance = null;
        let groupDistributionChartInstance = null;
        let employees = [];
        // Variables ho an'ny pagination
        let employeeCurrentPage = 1;
        let employeeItemsPerPage = 20;

        let attendanceCurrentPage = 1;
        let attendanceItemsPerPage = 20;

        let advancesCurrentPage = 1;
        let advancesItemsPerPage = 15;

        let qrAttendanceCurrentPage = 1;
        let qrAttendanceItemsPerPage = 15; // Azo ovaina raha tiana


        let groups = [];
        let attendance = {};
        let payrolls = [];
        let advances = [];
        let qrAttendance = []; // Nouvelles donn√©es QR
        let qrCodes = {}; // Stockage des QR codes g√©n√©r√©s
        let currentTheme = 'light';
        let isScanning = false;
        let scanInterval = null;
        let qrSettings = {
            size: 256,
            color: '#6750A4'
        };


        // ===============================
        // APPLICATION STATE & VARIABLES (FANAMPIANA)
        // ===============================
        let currentScanPurpose = null; // 'attendance', 'advance', 'payroll'
        let scanStream = null; // Tehirizina eto ny stream-n'ny cam√©ra

        // Fanomanana ny feo
        let audioContext;
        let successSoundBuffer;


        //========================================================
        //  PERFORMANCE: Virtualization ho an'ny lisitry ny mpiasa
        //========================================================
        let displayedEmployeesCount = 0;
        const employeesPerPage = 25; // Isan'ny mpiasa aseho isaky ny mandeha
        // =================================================================
        //  GESTION DU SON (VERSION 6 - "TRITONE" STYLE IPHONE NATAO TAMIN'NY JS)
        // =================================================================

        // Ity fonction ity dia antsoina indray mandeha fotsiny
        function initializeAudio() {
            try {
                // Amboarina mba tsy hisy "warning" amin'ny navigateur sasany
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Ny navigateur sasany (Chrome) dia mitaky "interaction" avy amin'ny mpampiasa
                // vao mamela ny feo handeha. Ity no mamaha an'izany.
                if (audioContext.state === 'suspended') {
                    const resume = () => {
                        audioContext.resume();
                        document.body.removeEventListener('click', resume);
                        document.body.removeEventListener('touchstart', resume);
                    };
                    document.body.addEventListener('click', resume);
                    document.body.addEventListener('touchstart', resume);
                }
            } catch (e) {
                console.error("Tsy afaka namorona AudioContext:", e);
            }
        }

        // Ity no mamorona sy mandefa ny feo "Tritone"
        function playSuccessSound() {
            if (!audioContext) {
                console.warn("AudioContext tsy vonona, tsy misy feo.");
                return;
            }

            try {
                const now = audioContext.currentTime;
                const gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.5, now); // Hamafin'ny feo (tsy mafy loatra)

                // Ireo naoty telo mandrafitra ny "Tritone"
                // Naoty 1: A4 (La) - 440 Hz
                const osc1 = audioContext.createOscillator();
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(440, now);
                osc1.connect(gainNode);
                osc1.start(now);
                osc1.stop(now + 0.1); // Maharitra 0.1 segondra

                // Naoty 2: C#5 (Do di√®se) - 554.37 Hz
                const osc2 = audioContext.createOscillator();
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(554.37, now + 0.1);
                osc2.connect(gainNode);
                osc2.start(now + 0.1);
                osc2.stop(now + 0.2);

                // Naoty 3: F#5 (Fa di√®se) - 739.99 Hz
                const osc3 = audioContext.createOscillator();
                osc3.type = 'sine';
                osc3.frequency.setValueAtTime(739.99, now + 0.2);
                osc3.connect(gainNode);
                osc3.start(now + 0.2);
                osc3.stop(now + 0.5); // Maharitra kely kokoa ity farany

            } catch (e) {
                console.error("Tsy afaka nandefa feo:", e);
            }
        }



        // ===============================
        // INITIALIZATION
        // ===============================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üîÑ Initialisation du syst√®me RH avec QR Code...');
                initializeAudio();
                await dbManager.init();
                console.log('‚úÖ IndexedDB initialis√©');
                
                await loadData();
                console.log('‚úÖ Donn√©es charg√©es');
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                updateStats();
                setCurrentDate();
                setCurrentMonth();
                populateEmployeeSelects(); // Antsoina tsy misy sivana mba hampisehoana ny mpiasa rehetra amin'ny voalohany
                populateGroupSelects();
                initializeTheme();
                initializeCurrencyInputs();
                initializeQRFunctionality();
                updateLastBackupInfo();
                displayDashboardCharts();
                runSmartChecks();

                console.log('‚úÖ Interface initialis√©e avec QR Code');

                const nameInput = document.getElementById('employeeName');
                if (nameInput) {
                    nameInput.addEventListener('input', function () {
                        this.value = capitalizeWords(this.value);
                    });
                }

                const positionInput = document.getElementById('employeePosition');
                if (positionInput) {
                    positionInput.addEventListener('input', function () {
                        this.value = capitalizeWords(this.value);
                    });
                }

                console.log('üöÄ Syst√®me RH avec QR Code initialis√© avec succ√®s');

            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                dbManager.updateDBStatus('Erreur d\'initialisation', 'error');
                showAlert('Erreur lors de l\'initialisation de la base de donn√©es', 'error');
            }

            // ===================================================
            //  FANITSINA: Mampifandray ny formulaire fanovana
            // ==================================================
            document.getElementById('editEmployeeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const employeeId = document.getElementById('editEmployeeId').value;
                const newName = capitalizeWords(document.getElementById('editEmployeeName').value.trim());
                const newPosition = capitalizeWords(document.getElementById('editEmployeePosition').value.trim());
                const newGender = document.getElementById('editEmployeeGender').value;
                const newSalary = getCurrencyValue('editEmployeeSalary');
                const newGroupId = document.getElementById('editEmployeeGroup').value;

                // Alaina ny sanda avy amin'ireo sehatra voaitsy
                const newStatus = document.getElementById('editEmployeeStatus').value;
                const newDepartureDate = document.getElementById('editEmployeeDepartureDate').value || null;

                if (!employeeId || !newName || !newPosition || newSalary === 0) {
                    showAlert("Veuillez remplir tous les champs correctement.", 'error');
                    return;
                }

                const employeeIndex = employees.findIndex(emp => emp.id === employeeId);
                if (employeeIndex === -1) {
                    showAlert("Erreur: Employ√© non trouv√©.", 'error');
                    return;
                }

                // Havaozina ny fampahalalana rehetra
                employees[employeeIndex].name = newName;
                employees[employeeIndex].position = newPosition;
                employees[employeeIndex].gender = newGender;
                employees[employeeIndex].salary = newSalary;
                employees[employeeIndex].groupId = newGroupId || null;
                employees[employeeIndex].status = newStatus;
                employees[employeeIndex].departureDate = newDepartureDate;

                await saveData();
                closeModal('editEmployeeModal');
                displayEmployees();
                updateStats();
                populateEmployeeSelects();
                showAlert("Les informations de l'employ√© ont √©t√© mises √† jour avec succ√®s!", 'success');
            });


            // ===================================================
            //  FANAMPINY HO AN'NY SMART SEARCH (STATUT EMPLOY√â)
            // ===================================================
            const smartSearchInput = document.getElementById('smartSearchInput');
            const statsMonthInput = document.getElementById('statsMonth');

            // Mametraka ny volana ankehitriny ho default
            if (statsMonthInput) {
                statsMonthInput.value = new Date().toISOString().slice(0, 7);
            }

            // Mampifandray ny hetsika amin'ny sehatra fikarohana
            if (smartSearchInput) {
                smartSearchInput.addEventListener('input', debounce(handleSmartSearch, 300));
            }
            
            // Mampifandray ny hetsika amin'ny fanovana volana
            if (statsMonthInput) {
                statsMonthInput.addEventListener('change', () => {
                    // Raha efa misy tatitra miseho, havaozina izany
                    if (document.getElementById('employeeStatusResults').innerHTML !== '' && document.getElementById('employeeStatusResults').innerText.trim() !== '') {
                        const currentEmployeeName = document.getElementById('smartSearchInput').value;
                        const employee = employees.find(e => e.name === currentEmployeeName);
                        if (employee) {
                            displayEmployeeStatus(employee.id);
                        }
                    }
                });
            }
            // --- FARAN'NY FANAMPINY ---

            // Mampifandray ny formulaire fanovana trosa
            document.getElementById('editAdvanceForm').addEventListener('submit', handleUpdateAdvance);

            // Mampifandray ny sehatra fikarohana mba hi-filtrer avy hatrany
            document.getElementById('advanceSearchInput').addEventListener('input', displayAdvances);
            document.getElementById('advanceMonthFilter').addEventListener('change', displayAdvances);

            // Mametraka ny volana ankehitriny ho default
            const advanceMonthFilter = document.getElementById('advanceMonthFilter');
            if (advanceMonthFilter) {
                advanceMonthFilter.value = new Date().toISOString().slice(0, 7);
            }

            // Averina amin'ny pejy 1 rehefa misy fikarohana vaovao
            document.getElementById('employeeSearch').addEventListener('input', () => {
                employeeCurrentPage = 1;
                displayEmployees();
            });

            document.getElementById('employeeGroupFilter').addEventListener('change', () => {
                employeeCurrentPage = 1;
                displayEmployees();
            });

            // --- Event Listeners ho an'ny Fizarana Pr√©sence ---
            document.getElementById('attendanceDate').addEventListener('change', () => {
                attendanceCurrentPage = 1;
                displayAttendance();
            });
            document.getElementById('attendanceEmployeeSearch').addEventListener('input', () => {
                attendanceCurrentPage = 1;
                displayAttendance();
            });

            // --- Event Listeners ho an'ny Fizarana Avances ---
            document.getElementById('advanceSearchInput').addEventListener('input', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });
            document.getElementById('advanceMonthFilter').addEventListener('change', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });

            // Ampio ity ao amin'ny lisitry ny event listeners
            document.getElementById('advanceGroupFilter').addEventListener('change', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });
        });


        // ===============================
        // QR CODE FUNCTIONALITY
        // ===============================
        function initializeQRFunctionality() {
            // D√©finir la date actuelle pour le scanner QR
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('qrAttendanceDate').value = today;
            
            // Charger les pr√©sences QR d'aujourd'hui
            displayQRAttendance();
        }

        // G√©n√©rer QR Code pour un employ√© (version alternative qui fonctionne)
        // ====================================================================
        //  FANITSIANA 1: Famoronana QR Code miaraka amin'ny Base64
        // ====================================================================
        async function generateQRCode(employee, size = 256, color = '#6750A4') {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            try {
                if (typeof qrcode === 'undefined') {
                    throw new Error("La biblioth√®que qrcode-generator n'est pas charg√©e.");
                }

                const qrDataObject = {
                    employeeId: employee.id,
                    name: employee.name,
                    position: employee.position,
                    type: 'BEHAVANA_ATTENDANCE'
                };
                const qrDataString = JSON.stringify(qrDataObject);

                // --- ITO NY FANITSIANA LEHIBE ---
                // 1. Avadika ho Base64 ilay lahatsoratra JSON.
                //    Ny btoa() dia fonction an'ny navigateur mamadika ho Base64.
                //    Ny unescape(encodeURIComponent(...)) dia miantoka fa mandeha tsara ny tendro.
                const base64String = btoa(unescape(encodeURIComponent(qrDataString)));

                const qr = qrcode(0, 'M');
                // 2. Ampidirina toy ny lahatsoratra tsotra ilay Base64. Tsy misy olana intsony eto.
                qr.addData(base64String);
                qr.make();

                const moduleCount = qr.getModuleCount();
                if (moduleCount === 0) throw new Error("G√©n√©ration QR √©chou√©e.");
                
                const cellSize = size / moduleCount;
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, size, size);
                ctx.fillStyle = color;
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(col * cellSize, row * cellSize, Math.ceil(cellSize), Math.ceil(cellSize));
                        }
                    }
                }
                return canvas;

            } catch (error) {
                // Ity vahaolana mpisolo toerana ity dia tsy miova
                console.error(`Erreur g√©n√©ration QR pour ${employee.name}:`, error);
                ctx.clearRect(0, 0, size, size);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, size, size);
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.strokeRect(2, 2, size - 4, size - 4);
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.font = `bold ${size * 0.1}px sans-serif`;
                ctx.fillText(employee.name, size / 2, size / 2.5);
                ctx.font = `normal ${size * 0.07}px sans-serif`;
                ctx.fillText(employee.position, size / 2, size / 1.8);
                ctx.font = `monospace ${size * 0.06}px`;
                ctx.fillText(`ID: ${employee.id}`, size / 2, size / 1.2);
                ctx.fillStyle = '#B3261E';
                ctx.font = `bold ${size * 0.05}px sans-serif`;
                ctx.fillText("ERREUR QR - V√âRIFIER", size / 2, size - (size * 0.1));
                return canvas;
            }
        }


        // Alternative compl√®te sans biblioth√®que externe - QR Code simple
        function generateSimpleQRCode(employee, size = 256, color = '#6750A4') {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;

                // Cr√©er un QR code visuel simple avec pattern
                const qrData = `${employee.id}|${employee.name}|BEHAVANA`;
                
                // Fond blanc
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, size, size);
                
                // Bordure
                ctx.strokeStyle = color;
                ctx.lineWidth = 8;
                ctx.strokeRect(4, 4, size-8, size-8);
                
                // Pattern de QR Code simplifi√©
                const cellSize = (size - 40) / 15; // 15x15 grid
                ctx.fillStyle = color;
                
                // Coins de positionnement (comme un vrai QR code)
                function drawPositionMarker(x, y) {
                    // Carr√© ext√©rieur
                    ctx.fillRect(x, y, cellSize * 7, cellSize * 7);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(x + cellSize, y + cellSize, cellSize * 5, cellSize * 5);
                    ctx.fillStyle = color;
                    ctx.fillRect(x + cellSize * 2, y + cellSize * 2, cellSize * 3, cellSize * 3);
                }
                
                drawPositionMarker(20, 20); // Coin haut-gauche
                drawPositionMarker(20, size - 20 - cellSize * 7); // Coin bas-gauche
                drawPositionMarker(size - 20 - cellSize * 7, 20); // Coin haut-droit
                
                // Pattern central bas√© sur l'ID de l'employ√©
                const hash = employee.id.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0);
                
                // G√©n√©rer un pattern unique bas√© sur le hash
                for (let i = 0; i < 15; i++) {
                    for (let j = 0; j < 15; j++) {
                        // √âviter les coins de positionnement
                        const isCorner = (i < 9 && j < 9) || (i < 9 && j > 5) || (i > 5 && j < 9);
                        if (!isCorner) {
                            // Pattern pseudo-al√©atoire bas√© sur position et hash
                            if ((i + j + hash) % 3 === 0) {
                                ctx.fillRect(20 + i * cellSize, 20 + j * cellSize, cellSize, cellSize);
                            }
                        }
                    }
                }
                
                // Texte centr√©
                ctx.fillStyle = color;
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(employee.name, size/2, size - 15);
                
                // ID en petit
                ctx.font = '8px Arial';
                ctx.fillText(`ID: ${employee.id}`, size/2, size - 5);
                
                resolve(canvas);
            });
        }

        // Modifier la fonction generateAllQRCodes pour utiliser la version simple
        async function generateAllQRCodes() {
            const container = document.getElementById('qrContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>G√©n√©ration des QR codes...</p></div>';

            try {
                const qrCards = [];
                
                for (const employee of employees) {
                    // Essayer d'abord la version compl√®te, puis la version simple en cas d'erreur
                    let canvas;
                    try {
                        canvas = await generateQRCode(employee, qrSettings.size, qrSettings.color);
                    } catch (error) {
                        console.log('Utilisation de la version simple pour:', employee.name);
                        canvas = await generateSimpleQRCode(employee, qrSettings.size, qrSettings.color);
                    }
                    
                    if (canvas) {
                        // Sauvegarder le QR code en base
                        await dbManager.put('qr_codes', {
                            employeeId: employee.id,
                            dataURL: canvas.toDataURL(),
                            generated: new Date().toISOString(),
                            size: qrSettings.size,
                            color: qrSettings.color
                        });

                        qrCards.push(`
                            <div class="qr-card">
                                <h4>${employee.name}</h4>
                                <p>${employee.position}</p>
                                <div class="qr-code-canvas">
                                    ${canvas.outerHTML}
                                </div>
                                <div class="qr-actions">
                                    <button class="btn-icon" onclick="downloadQRCode('${employee.id}')" title="T√©l√©charger">
                                        <span class="material-icons">download</span>
                                    </button>
                                    <button class="btn-icon" onclick="printQRCode('${employee.id}')" title="Imprimer">
                                        <span class="material-icons">print</span>
                                    </button>
                                </div>
                            </div>
                        `);
                    }
                }

                container.innerHTML = qrCards.join('');
                showAlert(`${qrCards.length} QR codes g√©n√©r√©s avec succ√®s!`, 'success');
                
            } catch (error) {
                console.error('Erreur g√©n√©ration QR codes:', error);
                container.innerHTML = '<p style="text-align: center; color: var(--md-sys-color-error);">Erreur lors de la g√©n√©ration des QR codes</p>';
                showAlert('Erreur lors de la g√©n√©ration des QR codes', 'error');
            }
        }

        // Scanner QR Code
        // ===================================================
        //  GESTION DU SCANNER QR (VERSION 3.0 - UNIFI√âE)
        // ===================================================

        async function startQRScan(purpose) {
            if (isScanning) {
                stopQRScan(false);
            }

            currentScanPurpose = purpose;
            console.log(`Tanjon'ny scan napetraka: ${currentScanPurpose}`);

            const video = document.getElementById('qrVideo');
            const overlay = document.getElementById('scanOverlay');
            const permissionMsg = document.getElementById('cameraPermissionMessage');
            const scannerTitle = document.getElementById('qrScannerTitle');
            const scannerInstruction = document.getElementById('qrScannerInstruction');
            const scanResult = document.getElementById('scanResult');

            // Diovina ny hafatra taloha
            scanResult.style.display = 'none';
            permissionMsg.style.display = 'none';

            if (purpose === 'attendance') {
                scannerTitle.innerHTML = `<span class="material-icons">qr_code_scanner</span> Scanner pour Pr√©sence`;
                scannerInstruction.textContent = "Marquer l'arriv√©e ou le d√©part d'un employ√©.";
            } else if (purpose === 'payroll') {
                scannerTitle.innerHTML = `<span class="material-icons">payments</span> Scanner pour la Paie`;
                scannerInstruction.textContent = "S√©lectionner un employ√© pour le calcul de la paie.";
            } else if (purpose === 'advance') {
                scannerTitle.innerHTML = `<span class="material-icons">savings</span> Scanner pour Avance`;
                scannerInstruction.textContent = "S√©lectionner un employ√© pour une demande d'avance.";
            }

            isScanning = true;
            openModal('qrScannerModal');

            try {
                scanStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }
                });

                video.srcObject = scanStream;
                await video.play();

                video.style.display = 'block';
                overlay.style.display = 'block';

                const canvas = document.getElementById('qrCanvas');
                scanInterval = setInterval(() => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        scanQRFromVideo(video, canvas);
                    }
                }, 500);

            } catch (error) {
                console.error("Erreur d'acc√®s √† la cam√©ra:", error);
                permissionMsg.style.display = 'flex';
                if (error.name === "NotAllowedError") {
                    permissionMsg.querySelector('span').textContent = "Vous avez refus√© l'acc√®s √† la cam√©ra. Veuillez l'autoriser.";
                } else {
                    permissionMsg.querySelector('span').textContent = "Erreur: Impossible de trouver ou d'acc√©der √† la cam√©ra.";
                }
            }
        }



        // ===================================================
        //  STOP SCAN (VERSION 4.0 - MIKATONA NY MODAL)
        //  ITY NO SOLON'ILAY TALOHA
        // ===================================================
        function stopQRScan(showMsg = true) {
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }

            const video = document.getElementById('qrVideo');
            if(video) video.style.display = 'none';
            
            const overlay = document.getElementById('scanOverlay');
            if(overlay) overlay.style.display = 'none';

            closeModal('qrScannerModal');

            if (showMsg && isScanning) {
                showAlert("Scan annul√©.", "warning");
            }
            
            isScanning = false;
        }



        function scanQRFromVideo(video, canvas) {
            const context = canvas.getContext('2d', { willReadFrequently: true });
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                playSuccessSound(); // Alefa ny feo
                handleQRScanResult(code.data);
            }
        }

        // ====================================================================
        //  FANITSIANA 2: Famakiana QR Code mahazaka Taloha sy Vaovao (Base64)
        // ====================================================================
        // ====================================================================
        //  handleQRScanResult (VERSION FARANY INDRINDRA - Mifehy ny rehetra)
        // ====================================================================
        async function handleQRScanResult(qrData) {
            const purpose = currentScanPurpose;
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }

            let parsedData;
            try {
                // ... (ny kaody famakiana QR dia tsy miova) ...
                if (qrData.startsWith('{')) {
                    parsedData = JSON.parse(qrData);
                } else {
                    const decodedString = decodeURIComponent(escape(atob(qrData)));
                    parsedData = JSON.parse(decodedString);
                }
            } catch (e) {
                showScanResult('QR Code illisible ou corrompu.', 'error');
                return;
            }

            if (!parsedData || parsedData.type !== 'BEHAVANA_ATTENDANCE' || !parsedData.employeeId) {
                showScanResult('QR Code non valide pour ce syst√®me.', 'error');
                return;
            }

            const employee = employees.find(emp => emp.id === parsedData.employeeId);
            if (!employee) {
                showScanResult(`Employ√© non trouv√© (ID: ${parsedData.employeeId})`, 'error');
                return;
            }

            // --- ITO NY LOJIKA VAOVAO SY MARINA ---
            if (purpose === 'attendance') {
                const success = await processAttendanceScan(employee);

                if (success) {
                    // Raha nahomby (scan 1 na 2), miandry 2 segondra vao manakatona ny MODAL
                    setTimeout(() => {
                        stopQRScan(false); 
                    }, 800); // Fiatoana 2 segondra
                }
                // Raha tsy nahomby (scan 3), dia tsy manao na inona na inona, ka mijanona misokatra ny modal

            } else {
                // Ho an'ny Paie sy Avance, akatona avy hatrany rehefa avy mampiseho fampandrenesana
                if (purpose === 'advance') {
                    const advanceEmployeeSelect = document.getElementById('advanceEmployee');
                    advanceEmployeeSelect.value = employee.id;
                    advanceEmployeeSelect.dispatchEvent(new Event('change'));
                    showAlert(`Employ√© s√©lectionn√©: ${employee.name}`, 'success');
                } else if (purpose === 'payroll') {
                    const payrollEmployeeSelect = document.getElementById('payrollEmployeeSelect');
                    populatePayrollEmployeeSelect('all');
                    payrollEmployeeSelect.value = employee.id;
                    handlePayrollEmployeeChange();
                    showAlert(`Employ√© s√©lectionn√©: ${employee.name}`, 'success');
                }
                
                stopQRScan(false);
            }
        }






        // =================================================================
        //  processAttendanceScan (VERSION FARANY - MAMERINA SANDA MARINA)
        // =================================================================
        async function processAttendanceScan(employee) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            if (!attendance[today]) {
                attendance[today] = {};
            }

            const existingAttendance = attendance[today][employee.id];

            // CAS 1: Scan voalohany (Arriv√©e)
            if (!existingAttendance) {
                attendance[today][employee.id] = { status: 'journee', arrivee: currentTime, depart: null, method: 'QR' };
                showScanResult(`‚úÖ Arriv√©e enregistr√©e pour ${employee.name} √† ${currentTime}`, 'success');
                
                // Tehirizina ny angona
                await saveAttendanceData();
                updateStats();
                runSmartChecks();
                if (document.getElementById('qr-presence').classList.contains('active')) { displayQRAttendance(); }
                if (document.getElementById('attendance').classList.contains('active')) { displayAttendance(); }

                // --- FANITSIANA LEHIBE 1: Averina ny TRUE ---
                return true;

            // CAS 2: Scan faharoa (D√©part)
            } else if (existingAttendance && !existingAttendance.depart) {
                existingAttendance.depart = currentTime;
                showScanResult(`‚úÖ D√©part enregistr√© pour ${employee.name} √† ${currentTime}`, 'success');

                // Tehirizina ny angona
                await saveAttendanceData();
                updateStats();
                runSmartChecks();
                if (document.getElementById('qr-presence').classList.contains('active')) { displayQRAttendance(); }
                if (document.getElementById('attendance').classList.contains('active')) { displayAttendance(); }

                // --- FANITSIANA LEHIBE 2: Averina ny TRUE ---
                return true;

            // CAS 3: Scan fahatelo (Efa feno)
            } else {
                const arrivalTime = existingAttendance.arrivee;
                const departureTime = existingAttendance.depart;

                const errorMessageHTML = `
                    <div style="text-align: center;">
                        <span class="material-icons" style="font-size: 36px; margin-bottom: 8px;">error</span>
                        <h4 style="margin: 0; font-size: 1.1rem;">D√âJ√Ä ENREGISTR√â</h4>
                        <p style="margin: 8px 0 0 0;">
                            <strong>${employee.name}</strong> a d√©j√† point√© pour la journ√©e.
                        </p>
                        <div style="margin-top: 12px; padding: 8px; background-color: rgba(0,0,0,0.1); border-radius: 8px;">
                            Heure d'arriv√©e: <strong style="font-size: 1.1em;">${arrivalTime}</strong>  

                            Heure de d√©part: <strong style="font-size: 1.1em;">${departureTime}</strong>
                        </div>
                    </div>
                `;
                
                showScanResult(errorMessageHTML, 'error');

                // --- FANITSIANA LEHIBE 3: Averina ny FALSE ---
                return false;
            }
        }





        // ===================================================
        //  showScanResult (FANITSARANA: Mampiasa innerHTML)
        //  showScanResult (VERSION FARANY - TSY MANAFINA INTSONY)
        // ===================================================
        function showScanResult(message, type) {
            const scanResult = document.getElementById('scanResult');
            if (!scanResult) return;

            scanResult.innerHTML = message;
            scanResult.className = `scan-result ${type}`;
            scanResult.style.display = 'block';
        }



        // Afficher les pr√©sences QR
        // ===================================================
        function displayQRAttendance() {
            const container = document.getElementById('qrAttendanceList');
            const selectedDate = document.getElementById('qrAttendanceDate').value;

            if (!selectedDate) {
                container.innerHTML = '<p>Veuillez s√©lectionner une date.</p>';
                document.getElementById('qrAttendancePagination').innerHTML = ''; // Fafana ny pagination
                return;
            }

            const dayAttendance = attendance[selectedDate] || {};

            // --- DINGANA 1: Fandaharana ny lisitry ny mpiasa rehetra ---
            let sortedEmployees = [...employees].sort((a, b) => {
                const aIsPresent = dayAttendance[a.id] && dayAttendance[a.id].arrivee;
                const bIsPresent = dayAttendance[b.id] && dayAttendance[b.id].arrivee;

                if (aIsPresent && !bIsPresent) {
                    return -1; // 'a' (tonga) alohan'ny 'b' (tsy tonga)
                }
                if (!aIsPresent && bIsPresent) {
                    return 1; // 'b' (tonga) alohan'ny 'a' (tsy tonga)
                }
                if (aIsPresent && bIsPresent) {
                    // Raha samy tonga, dia alahatra araka ny ora
                    return dayAttendance[a.id].arrivee.localeCompare(dayAttendance[b.id].arrivee);
                }
                // Raha samy tsy tonga, dia alahatra araka ny anarana
                return a.name.localeCompare(b.name);
            });

            // --- DINGANA 2: Lojika Pagination ---
            const totalItems = sortedEmployees.length;
            const totalPages = Math.ceil(totalItems / qrAttendanceItemsPerPage);
            if (qrAttendanceCurrentPage > totalPages) {
                qrAttendanceCurrentPage = totalPages > 0 ? totalPages : 1;
            }
            const startIndex = (qrAttendanceCurrentPage - 1) * qrAttendanceItemsPerPage;
            const endIndex = startIndex + qrAttendanceItemsPerPage;
            const paginatedEmployees = sortedEmployees.slice(startIndex, endIndex);

            // --- DINGANA 3: Fampisehoana ny lisitra (mampiasa ny kaodinao teo aloha) ---
            let allEmployeesHTML = paginatedEmployees.map(employee => {
                const presenceData = dayAttendance[employee.id];
                const isPresent = presenceData && presenceData.arrivee;

                let statusHTML = '';
                if (isPresent) {
                    const arrivalTime = presenceData.arrivee || 'N/A';
                    const departureTime = presenceData.depart || '...';
                    const method = presenceData.method || 'MANUAL';
                    const methodColor = method === 'QR' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-secondary)';
                    const methodIcon = method === 'QR' ? 'qr_code_scanner' : 'edit';

                    statusHTML = `
                        <div class="qr-status present">
                            <span class="material-icons">check_circle</span>
                            <span>Pr√©sent</span>
                        </div>
                        <div style="font-size: 12px; text-align: right; margin-top: 4px;">
                            Arriv√©e: <strong>${arrivalTime}</strong> | D√©part: ${departureTime}
                            <span style="color: ${methodColor}; display: inline-flex; align-items: center; gap: 4px; font-size: 12px; margin-left: 8px; vertical-align: middle;">
                                <span class="material-icons" style="font-size: 14px;">${methodIcon}</span>
                                ${method}
                            </span>
                        </div>
                    `;
                } else {
                    statusHTML = `
                        <div class="qr-status absent">
                            <span class="material-icons">cancel</span>
                            <span>Absent</span>
                        </div>
                    `;
                }

                return `
                    <div class="employee-qr-item">
                        <div class="employee-qr-info">
                            <h4>${employee.name}</h4>
                            <p>${employee.position}</p>
                        </div>
                        <div>
                            ${statusHTML}
                        </div>
                    </div>
                `;
            }).join('');

            // --- DINGANA 4: Fampisehoana ny famintinana (tsy miova) ---
            const presentCount = Object.keys(dayAttendance).length;
            const absentCount = employees.length - presentCount;
            const summaryHTML = `
                <div style="display: flex; gap: 16px; margin-bottom: 16px; padding: 12px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">
                    <div style="color: var(--md-sys-color-success); font-weight: 500;">
                        <span class="material-icons" style="vertical-align: middle;">check_circle</span>
                        Pr√©sents: ${presentCount}
                    </div>
                    <div style="color: var(--md-sys-color-error); font-weight: 500;">
                        <span class="material-icons" style="vertical-align: middle;">cancel</span>
                        Absents: ${absentCount}
                    </div>
                    <div style="color: var(--md-sys-color-on-surface-variant); font-weight: 500;">
                        <span class="material-icons" style="vertical-align: middle;">people</span>
                        Total: ${employees.length}
                    </div>
                </div>
            `;

            container.innerHTML = summaryHTML + allEmployeesHTML;

            // --- DINGANA 5: Fampisehoana ny bokotra Pagination ---
            renderPaginationControls(
                'qrAttendancePagination',
                qrAttendanceCurrentPage,
                totalPages,
                totalItems,
                qrAttendanceItemsPerPage,
                (page) => {
                    qrAttendanceCurrentPage = page;
                    displayQRAttendance();
                }
            );
        }


        function refreshQRAttendance() {
            displayQRAttendance();
            showAlert('Liste des pr√©sences QR actualis√©e', 'success');
        }

        // Export PDF des pr√©sences QR
        function exportQRAttendancePDF() {
            const selectedDate = document.getElementById('qrAttendanceDate').value;
            if (!selectedDate) {
                alert('Veuillez s√©lectionner une date.');
                return;
            }

            const dayAttendance = qrAttendance.filter(att => att.date === selectedDate);
            
            if (dayAttendance.length === 0) {
                alert('Aucune pr√©sence QR √† exporter pour cette date.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // En-t√™te
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("PR√âSENCES QR CODE", 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text(`Date: ${formatDate(selectedDate + 'T00:00:00')}`, 105, 30, { align: 'center' });
            doc.text(`${dayAttendance.length} pr√©sence(s) enregistr√©e(s)`, 105, 40, { align: 'center' });

            // Trier par heure d'arriv√©e
            dayAttendance.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Pr√©parer les donn√©es du tableau
            const tableData = dayAttendance.map((att, index) => [
                index + 1,
                att.employeeName,
                att.employeePosition,
                formatTime(att.timestamp),
                'Scanner QR'
            ]);

            // Cr√©er le tableau
            doc.autoTable({
                startY: 50,
                head: [['#', 'Nom Complet', 'Poste', 'Heure Arriv√©e', 'M√©thode']],
                body: tableData,
                styles: {
                    fontSize: 10,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [103, 80, 164],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 15 },
                    1: { cellWidth: 50 },
                    2: { cellWidth: 40 },
                    3: { halign: 'center', cellWidth: 35 },
                    4: { halign: 'center', cellWidth: 35 }
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                }
            });

            // Pied de page
            const finalY = doc.lastAutoTable.finalY || 80;
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text(`G√©n√©r√© le ${new Date().toLocaleString()} - Syst√®me RH BEHAVANA`, 14, finalY + 20);

            // Sauvegarder
            doc.save(`presences-qr-${selectedDate}.pdf`);
            showAlert('PDF des pr√©sences QR export√© avec succ√®s!', 'success');
        }

        // T√©l√©charger QR Code individuel
        async function downloadQRCode(employeeId) {
            try {
                const qrCodeData = await dbManager.get('qr_codes', employeeId);
                if (!qrCodeData) {
                    showAlert('QR Code non trouv√©', 'error');
                    return;
                }

                const employee = employees.find(emp => emp.id === employeeId);
                if (!employee) return;

                // Cr√©er un lien de t√©l√©chargement
                const link = document.createElement('a');
                link.download = `qr-${employee.name.replace(/\s+/g, '-')}.png`;
                link.href = qrCodeData.dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert(`QR Code de ${employee.name} t√©l√©charg√©`, 'success');
            } catch (error) {
                console.error('Erreur t√©l√©chargement QR:', error);
                showAlert('Erreur lors du t√©l√©chargement', 'error');
            }
        }

        // Imprimer QR Code individuel
        // ===================================================
        //  FANONTANA QR CODE INDIVIDUEL (VERSION VOAHITSY)
        // ===================================================
        async function printQRCode(employeeId) {
            try {
                // 1. Alaina ny angon'ny QR code efa voatahiry ao amin'ny base de donn√©es
                const qrCodeData = await dbManager.get('qr_codes', employeeId);
                if (!qrCodeData || !qrCodeData.dataURL) {
                    showAlert('QR Code tsy hita ao amin\'ny base. Andramo aloha ny manao "G√©n√©rer Tous les QR".', 'error');
                    return;
                }

                const employee = employees.find(emp => emp.id === employeeId);
                if (!employee) return;

                // 2. Amboarina ny votoaty HTML ho an'ny fanontana
                // Mampiasa mivantana ny dataURL ao anaty <img>, izay fomba azo antoka indrindra
                const printContent = `
                    <html>
                        <head>
                            <title>Impression QR Code - ${employee.name}</title>
                            <style>
                                body { 
                                    margin: 0; 
                                    padding: 20px; 
                                    font-family: Arial, sans-serif; 
                                    text-align: center; 
                                }
                                .qr-print-card {
                                    border: 2px solid #333;
                                    padding: 20px;
                                    margin: 20px auto;
                                    width: 300px; /* Habeny voafaritra tsara */
                                    display: inline-block;
                                }
                                h2 { margin-bottom: 10px; font-size: 1.2em; }
                                p { margin: 5px 0; font-size: 0.9em; }
                                img { 
                                    margin: 15px 0; 
                                    width: 250px; /* Haben'ny sary voafaritra */
                                    height: 250px;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="qr-print-card">
                                <h2>${employee.name}</h2>
                                <p><strong>Poste:</strong> ${employee.position}</p>
                                <img src="${qrCodeData.dataURL}" alt="QR Code de ${employee.name}">
                                <p><strong>BEHAVANA HR SYSTEM</strong></p>
                                <p>Scanner pour marquer la pr√©sence</p>
                            </div>
                        </body>
                    </html>
                `;

                // 3. Amboarina ny varavarankely fanontana
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close(); // Ilaina ity mba hamaranana ny fanoratana

                // 4. Omena fotoana kely ny navigateur hampiditra tsara ilay sary
                setTimeout(() => {
                    printWindow.focus();  // Atao focus ilay varavarankely
                    printWindow.print();  // Alefa ny fanontana
                    printWindow.close();  // Akatona avy eo
                }, 500); // 500ms dia ampy matetika

            } catch (error) {
                console.error('Erreur lors de l\'impression du QR Code:', error);
                showAlert('Nisy olana teo am-panontana ny QR code.', 'error');
            }
        }

        // T√©l√©charger tous les QR codes
        async function downloadAllQRCodes() {
            try {
                const zip = new JSZip(); // Note: JSZip n'est pas inclus, utiliser une alternative simple
                
                showAlert('Fonctionnalit√© de t√©l√©chargement group√© en cours de d√©veloppement', 'warning');
                
                // Alternative: t√©l√©charger un par un
                for (const employee of employees) {
                    await downloadQRCode(employee.id);
                    await new Promise(resolve => setTimeout(resolve, 500)); // D√©lai entre t√©l√©chargements
                }
                
            } catch (error) {
                console.error('Erreur t√©l√©chargement group√©:', error);
                showAlert('Erreur lors du t√©l√©chargement group√©', 'error');
            }
        }

        // Imprimer tous les QR codes
        // ===================================================
        //  FANONTANA NY QR CODE REHETRA (VERSION VOAHITSY)
        // ===================================================
        async function printAllQRCodes() {
            try {
                // 1. Alaina ny QR code rehetra efa voatahiry
                const allQrCodes = await dbManager.getAll('qr_codes');
                
                if (allQrCodes.length === 0) {
                    showAlert('Tsy misy QR code hontaina. Tsindrio aloha ny "G√©n√©rer Tous les QR".', 'error');
                    return;
                }

                // 2. Amboarina ny votoaty HTML ho an'ny pejy fanontana
                let printContent = `
                    <html>
                        <head>
                            <title>Impression QR Codes - Tous les Employ√©s</title>
                            <style>
                                body { font-family: Arial, sans-serif; }
                                .page-container {
                                    display: grid;
                                    grid-template-columns: 1fr 1fr; /* Tsanganana roa */
                                    gap: 20px;
                                    padding: 15px;
                                }
                                .qr-item-print {
                                    border: 1px solid #666;
                                    padding: 15px;
                                    text-align: center;
                                    page-break-inside: avoid; /* Mba tsy ho tapaka eo ampovoan'ny pejy */
                                }
                                h3 { margin: 0 0 10px 0; font-size: 14px; }
                                p { margin: 5px 0; font-size: 12px; }
                                img { max-width: 180px; max-height: 180px; margin: 10px 0; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; } /* Mba ho azo antoka ny loko */
                                }
                            </style>
                        </head>
                        <body>
                            <h1 style="text-align: center; margin-bottom: 20px;">QR CODES - BEHAVANA HR SYSTEM</h1>
                            <div class="page-container">
                `;

                // 3. Ampidirina isaky ny QR code
                for (const qrCode of allQrCodes) {
                    const employee = employees.find(emp => emp.id === qrCode.employeeId);
                    if (employee && qrCode.dataURL) {
                        printContent += `
                            <div class="qr-item-print">
                                <h3>${employee.name}</h3>
                                <p><strong>Poste:</strong> ${employee.position}</p>
                                <img src="${qrCode.dataURL}" alt="QR Code de ${employee.name}">
                                <p><strong>Scanner pour pr√©sence</strong></p>
                            </div>
                        `;
                    }
                }

                printContent += `
                            </div>
                        </body>
                    </html>
                `;

                // 4. Amboarina ny varavarankely fanontana (mitovy amin'ny etsy ambony)
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();

                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                }, 500);

            } catch (error) {
                console.error('Erreur lors de l\'impression de tous les QR codes:', error);
                showAlert('Nisy olana teo am-panontana ny QR code rehetra.', 'error');
            }
        }

        // Mettre √† jour les param√®tres QR
        function updateQRSettings() {
            qrSettings.size = parseInt(document.getElementById('qrSizeSelect').value);
            qrSettings.color = document.getElementById('qrColorSelect').value;
            
            showAlert('Param√®tres QR mis √† jour. Reg√©n√©rez les codes pour appliquer les changements.', 'success');
        }

        // ===============================
        // DATA MANAGEMENT MODIFI√â POUR QR
        // ===============================
        async function saveData() {
            try {
                // Sauvegarder les donn√©es existantes (identique √† l'original)
                await dbManager.clear('employees');
                for (const employee of employees) {
                    await dbManager.add('employees', employee);
                }

                // ... aorian'ny for (const employee of employees) { ... }
                await dbManager.clear('groups');
                for (const group of groups) {
                    await dbManager.add('groups', group);
                }


                await dbManager.clear('attendance');
                for (const [date, dayAttendance] of Object.entries(attendance)) {
                    await dbManager.put('attendance', { date, data: dayAttendance });
                }

                await dbManager.clear('payrolls');
                for (const payroll of payrolls) {
                    await dbManager.add('payrolls', payroll);
                }

                await dbManager.clear('advances');
                for (const advance of advances) {
                    await dbManager.add('advances', advance);
                }

                // Sauvegarder les param√®tres
                await dbManager.put('settings', { key: 'theme', value: currentTheme });
                await dbManager.put('settings', { key: 'qrSettings', value: qrSettings });
                await dbManager.put('settings', { key: 'lastUpdated', value: new Date().toISOString() });

                console.log('Donn√©es sauvegard√©es dans IndexedDB avec QR');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showAlert('Erreur lors de la sauvegarde des donn√©es', 'error');
            }
        }

        // Sauvegarder seulement les donn√©es de pr√©sence
        async function saveAttendanceData() {
            try {
                // Fafana aloha ny angona taloha
                await dbManager.clear('attendance');
                
                // Tehirizina ny vaovao
                for (const [date, dayAttendance] of Object.entries(attendance)) {
                    // Ataovy azo antoka fa tsy misy "undefined" ny angona
                    const validDayAttendance = {};
                    for (const empId in dayAttendance) {
                        if (dayAttendance[empId]) {
                            validDayAttendance[empId] = dayAttendance[empId];
                        }
                    }
                    await dbManager.put('attendance', { date, data: validDayAttendance });
                }
            } catch (error) {
                console.error('Erreur sauvegarde pr√©sences:', error);
            }
        }


        async function loadData() {
            try {
                // Charger les donn√©es existantes (identique √† l'original)
                employees = await dbManager.getAll('employees');

                const attendanceRecords = await dbManager.getAll('attendance');
                attendance = {};
                attendanceRecords.forEach(record => {
                    attendance[record.date] = record.data;
                });

                payrolls = await dbManager.getAll('payrolls');
                advances = await dbManager.getAll('advances');
                // ... aorian'ny advances = ...
                groups = await dbManager.getAll('groups');
                console.log(`Groupes: ${groups.length}`);


                // Charger les nouvelles donn√©es QR
                qrAttendance = await dbManager.getAll('qr_attendance');

                // Charger les param√®tres
                const themeSettings = await dbManager.get('settings', 'theme');
                if (themeSettings) {
                    currentTheme = themeSettings.value;
                }

                const qrSettingsData = await dbManager.get('settings', 'qrSettings');
                if (qrSettingsData) {
                    qrSettings = qrSettingsData.value;
                }

                console.log('Donn√©es charg√©es depuis IndexedDB avec QR');
                console.log(`Employ√©s: ${employees.length}, Pr√©sences: ${Object.keys(attendance).length}, QR Pr√©sences: ${qrAttendance.length}`);
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                showAlert('Erreur lors du chargement des donn√©es', 'error');
            }
        }

        // ===============================
        // STATS MODIFI√âES POUR QR
        // ===================================================
        //  UPDATESTATS (VERSION 5 - KAJY MARINA MIARAKA AMIN'NY FAHARETANA)
        // ===================================================
        // ===================================================
        //  UPDATESTATS (VERSION 6 - FANITSIANA ARAKA NY NANGATAHINA)
        // ===================================================
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().slice(0, 7);

            // --- Fizarana 1: Fandraisana Elements (Misy fanampiny) ---
            const totalEmployeesEl = document.getElementById('totalEmployees');
            const checkedInTodayEl = document.getElementById('checkedInToday'); // Element vaovao
            const presentTodayEl = document.getElementById('presentToday');
            const totalSalariesEl = document.getElementById('totalSalaries');
            const qrScansTodayEl = document.getElementById('qrScansToday');

            // --- Fizarana 2: Kajy Statistika Fototra (Tsy miova) ---
            const totalEmployeeCount = employees.length;
            if (totalEmployeesEl) totalEmployeesEl.textContent = totalEmployeeCount;

            // --- Fizarana 3: KAJY VAOVAO ARAKA NY FEPETRA ---
            const dayAttendance = attendance[today] || {};
            
            // 3.1: Isaina ny mpiasa rehetra nanao "pointage" (nahavita arriv√©e sy d√©part)
            const checkedInCount = Object.values(dayAttendance).filter(att => {
                return att && att.arrivee && att.depart;
            }).length;

            // 3.2: Isaina ny mpiasa nahavita "journ√©e compl√®te" (>= 4 ora)
            const MINIMUM_HOURS_FOR_FULL_DAY = 4;
            const completedPresenceCount = Object.values(dayAttendance).filter(att => {
                if (!att || !att.arrivee || !att.depart) {
                    return false; // Tsy isaina raha tsy feno
                }
                const duration = calculateWorkDuration(att.arrivee, att.depart);
                const durationInHours = duration.totalMinutes / 60;
                return durationInHours >= MINIMUM_HOURS_FOR_FULL_DAY;
            }).length;

            // --- Fizarana 4: Fampisehoana ny valiny eo amin'ny Dashboard ---
            if (checkedInTodayEl) {
                checkedInTodayEl.textContent = checkedInCount;
            }
            if (presentTodayEl) {
                presentTodayEl.textContent = completedPresenceCount;
            }

            // --- Fizarana 5: Kajy ny Scans QR (Tsy miova) ---
            let qrScanCountToday = 0;
            if (dayAttendance) {
                qrScanCountToday = Object.values(dayAttendance).filter(att => att && att.method === 'QR').length;
            }
            if (qrScansTodayEl) {
                qrScansTodayEl.textContent = qrScanCountToday;
            }

            // --- Fizarana 6: Kajy vola sy grafika (Tsy miova, fa mampiasa ny kajy vaovao) ---
            // Ny tohin'ny fonction dia tsy misy fiovana lehibe, fa efa miankina amin'ny `countPresenceDays` izay hamboarintsika manaraka.
            let totalNetSalariesThisMonth = 0;
            const [year, month] = currentMonth.split('-');
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
            
            employees.forEach(employee => {
                // Ity fonction ity no hamboarintsika manaraka mba hanaraka ny lojika vaovao
                const workDays = countPresenceDays(employee.id, currentMonth); 
                const dailySalary = employee.salary / daysInMonth;
                const grossSalary = dailySalary * workDays;
                
                const employeeAdvances = getEmployeeAdvancesForMonth(employee.id, currentMonth);
                const totalAdvances = employeeAdvances.reduce((sum, adv) => sum + adv.amount, 0);
                const netSalary = Math.max(0, grossSalary - totalAdvances);
                totalNetSalariesThisMonth += netSalary;
            });

            if (totalSalariesEl) {
                totalSalariesEl.textContent = formatCurrency(totalNetSalariesThisMonth);
            }

            // Havaozina ny grafika raha eo amin'ny dashboard
            if (document.getElementById('dashboard').classList.contains('active')) {
                displayDashboardCharts();
            }
        }




        // ===================================================
        //         FONCTIONS HO AN'NY GRAFIKA DASHBOARD
        // ===================================================

        /**
         * Ity no fonction lehibe miantso ny famoronana ny grafika roa.
         */
        function displayDashboardCharts() {
            // Raha tsy ao amin'ny dashboard isika, dia ajanona mba tsy hanao kajy tsy ilaina
            if (!document.getElementById('dashboard').classList.contains('active')) {
                return;
            }

            // --- Grafika 1: Pr√©sence de la Semaine ---
            const weeklyCtx = document.getElementById('weeklyAttendanceChart');
            if (weeklyCtx) {
                const weeklyData = getWeeklyAttendanceData();
                
                // Fafana aloha ny grafika taloha raha misy
                if (weeklyAttendanceChartInstance) {
                    weeklyAttendanceChartInstance.destroy();
                }
                
                weeklyAttendanceChartInstance = new Chart(weeklyCtx, {
                    type: 'bar',
                    data: {
                        labels: weeklyData.labels,
                        datasets: [{
                            label: 'Taux de Pr√©sence (%)',
                            data: weeklyData.data,
                            backgroundColor: 'rgba(103, 80, 164, 0.6)',
                            borderColor: 'rgba(103, 80, 164, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // --- Grafika 2: R√©partition par Groupe ---
            const groupCtx = document.getElementById('groupDistributionChart');
            if (groupCtx) {
                const groupData = getGroupDistributionData();

                if (groupDistributionChartInstance) {
                    groupDistributionChartInstance.destroy();
                }
                
                groupDistributionChartInstance = new Chart(groupCtx, {
                    type: 'doughnut',
                    data: {
                        labels: groupData.labels,
                        datasets: [{
                            label: 'Employ√©s',
                            data: groupData.data,
                            backgroundColor: [ // Palita-loko mifanaraka amin'ny temanao
                                '#6750A4', '#EADDFF', '#625B71', '#E8DEF8', 
                                '#7D5260', '#FFD8E4', '#49454F'
                            ],
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }

            // ===================================================
            //         FANAMPINY: Grafika 3: R√©partition par Genre
            // ===================================================
            const genderCtx = document.getElementById('genderDistributionChart');
            if (genderCtx) {
                const genderData = getGenderDistributionData();

                if (genderDistributionChartInstance) {
                    genderDistributionChartInstance.destroy();
                }
                
                genderDistributionChartInstance = new Chart(genderCtx, {
                    type: 'pie', // Ovaina ho 'pie' (camembert)
                    data: {
                        labels: genderData.labels,
                        datasets: [{
                            label: 'Employ√©s',
                            data: genderData.data,
                            backgroundColor: [
                                '#6750A4', // Loko ho an'ny lehilahy
                                '#FFD8E4', // Loko ho an'ny vehivavy
                                '#CAC4D0'  // Loko ho an'ny "Autre"
                            ],
                            borderColor: [ // Sisiny fotsy mba hisy fiavahana
                                '#FFFFFF',
                                '#FFFFFF',
                                '#FFFFFF'
                            ],
                            borderWidth: 2,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }

        }

        /**
         * Maka ny angona ho an'ny tahan'ny fahatongavana nandritra ny 7 andro farany.
         * @returns {{labels: string[], data: number[]}}
         */
        function getWeeklyAttendanceData() {
            const labels = [];
            const data = [];
            const totalEmployeeCount = employees.length > 0 ? employees.length : 1;

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
                
                labels.push(dayName.charAt(0).toUpperCase() + dayName.slice(1));
                
                const presentCount = attendance[dateString] ? Object.keys(attendance[dateString]).filter(key => attendance[dateString][key]).length : 0;
                const percentage = (presentCount / totalEmployeeCount) * 100;
                data.push(percentage.toFixed(1));
            }
            return { labels, data };
        }

        /**
         * Maka ny angona momba ny fitsinjarana araka ny lahy sy vavy.
         * @returns {{labels: string[], data: number[]}}
         */
        function getGenderDistributionData() {
            let maleCount = 0;
            let femaleCount = 0;
            let otherCount = 0;

            employees.forEach(emp => {
                if (emp.gender === 'Homme') {
                    maleCount++;
                } else if (emp.gender === 'Femme') {
                    femaleCount++;
                } else {
                    otherCount++; // Raha misy genre hafa
                }
            });

            const labels = ['Hommes', 'Femmes'];
            const data = [maleCount, femaleCount];

            if (otherCount > 0) {
                labels.push('Autre');
                data.push(otherCount);
            }

            return { labels, data };
        }


        /**
         * Maka ny angona momba ny fitsinjaran'ny mpiasa isaky ny vondrona.
         * @returns {{labels: string[], data: number[]}}
         */
        function getGroupDistributionData() {
            const groupCounts = {};
            // Ataovy azo antoka fa misy daholo ny vondrona na dia tsy misy mpikambana aza
            groups.forEach(g => groupCounts[g.name] = 0);
            
            let noGroupCount = 0;

            employees.forEach(emp => {
                const group = groups.find(g => g.id === emp.groupId);
                if (group) {
                    groupCounts[group.name]++;
                } else {
                    noGroupCount++;
                }
            });

            const labels = Object.keys(groupCounts);
            const data = Object.values(groupCounts);

            if (noGroupCount > 0) {
                labels.push("Sans Groupe");
                data.push(noGroupCount);
            }
            
            return { labels, data };
        }


        // ===============================
        // FONCTIONS UTILITAIRES
        // ===============================
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===================================================
        //  formatDate (VERSION NOHATSARAINA MISY ANDRO)
        // ===================================================
        function formatDate(dateString, withDayName = true) {
            if (!dateString) return 'N/A';

            const date = new Date(dateString);
            // Manampy ny elanelan'ny timezone mba hisorohana ny fiovan'ny daty
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const correctedDate = new Date(date.getTime() + userTimezoneOffset);

            const options = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            };

            if (withDayName) {
                options.weekday = 'long'; // 'long' = Lundi, 'short' = Lun.
            }

            // Mampiasa 'fr-FR' mba hahazoana ny endrika frantsay
            return new Intl.DateTimeFormat('fr-FR', options).format(correctedDate);
        }


        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount) + ' Ar';
        }

        // ===============================
        // FONCTIONS EXISTANTES (partielles pour l'exemple)
        // ===============================
        
        // Navigation
        function showSection(sectionId) {
            // 1. Afenina daholo aloha ny fizarana rehetra
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 2. Asehoy fotsiny ilay fizarana voatsindry
            document.getElementById(sectionId).classList.add('active');
            
            // 3. Ovaina ny endriky ny bokotra fitetezana (nav-tab)
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Ny `event.currentTarget` dia azo antoka kokoa noho ny `event.target` raha misy `<span>` ao anaty bokotra
            event.currentTarget.classList.add('active');
            
            // 4. Antsoina ny fonction mifanaraka amin'ny fizarana aseho
            //    mba hamenoana azy amin'ny angona vaovao.
            switch (sectionId) {
                case 'dashboard':
                    // Rehefa miverina eo amin'ny dashboard, dia havaozina ny statistika sy ny grafika
                    updateStats();
                    displayDashboardCharts();
                    break;
                case 'employees':
                    displayEmployees();
                    break;
                case 'groups':
                    displayGroups();
                    break;
                case 'employee-stats':
                    // Tsy misy atao amin'ny voalohany, miandry ny fikarohana
                    break;
                case 'attendance':
                    displayAttendance();
                    break;
                case 'qr-presence':
                    displayQRAttendance();
                    break;
                case 'qr-codes':
                    generateAllQRCodes();
                    break;
                case 'advances':
                    displayAdvances();
                    break;
                case 'payroll':
                    // Azo avela banga na asiana hafatra famporisihana
                    document.getElementById('payrollResults').innerHTML = '<p style="text-align: center; padding: 20px;">Veuillez s√©lectionner un mois et cliquer sur "Calculer Paie".</p>';
                    document.getElementById('payrollSummary').style.display = 'none';
                    break;
                case 'payments':
                    displayPayments();
                    break;
                case 'stc':
                    populateSTCEmployeeSelect(); // Ity no mameno ny lisitra
                    // Diovina koa ny vokatry ny kajy teo aloha
                    const stcContainer = document.getElementById('stcResultsContainer');
                    if (stcContainer) {
                        stcContainer.style.display = 'none';
                    }
                    break;
                case 'reports':
                    updateReportStats();
                    break;
                // Azo ampiana 'default' raha ilaina
                // default:
                //     console.log(`Navigu√© vers la section: ${sectionId}`);
            }
        }


        // Fonctions simplifi√©es (garder la logique de l'original)
        function displayEmployees() {
            const container = document.getElementById('employeeList');
            const groupFilter = document.getElementById('employeeGroupFilter').value;
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();

            // Sivana ny mpiasa (tsy miova)
            let filteredEmployees = employees.filter(e => e.status !== 'inactif');
            if (groupFilter === 'none') {
                filteredEmployees = filteredEmployees.filter(emp => !emp.groupId);
            } else if (groupFilter !== 'all') {
                filteredEmployees = filteredEmployees.filter(emp => emp.groupId === groupFilter);
            }
            if (searchTerm) {
                filteredEmployees = filteredEmployees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm) || 
                    emp.position.toLowerCase().includes(searchTerm)
                );
            }

            // Lojika pagination (tsy miova)
            const totalItems = filteredEmployees.length;
            const totalPages = Math.ceil(totalItems / employeeItemsPerPage);
            if (employeeCurrentPage > totalPages) {
                employeeCurrentPage = totalPages > 0 ? totalPages : 1;
            }
            const startIndex = (employeeCurrentPage - 1) * employeeItemsPerPage;
            const endIndex = startIndex + employeeItemsPerPage;
            const paginatedEmployees = filteredEmployees.slice(startIndex, endIndex);

            if (paginatedEmployees.length === 0) {
                container.innerHTML = "<p style='text-align: center; padding: 20px;'>Aucun employ√© trouv√© pour ces crit√®res.</p>";
                document.getElementById('employeePagination').innerHTML = '';
                return;
            }

            // Fampisehoana ny lisitra (tsy miova)
            container.innerHTML = paginatedEmployees.map(employee => {
                // ... (ny kaody fampisehoana ny employee-item dia tsy miova) ...
                const group = groups.find(g => g.id === employee.groupId);
                const groupName = group ? group.name : "<i>Sans groupe</i>";
                const currentMonth = new Date().toISOString().slice(0, 7);
                const totalAdvances = advances
                    .filter(adv => adv.employeeId === employee.id && adv.date.startsWith(currentMonth))
                    .reduce((sum, adv) => sum + adv.amount, 0);
                const advanceHTML = totalAdvances > 0 
                    ? `<p style="color: var(--md-sys-color-error); font-size: 12px; font-weight: 500; margin-top: 4px;"><span class="material-icons" style="font-size: 14px; vertical-align: middle;">trending_down</span>Avances ce mois: ${formatCurrency(totalAdvances)}</p>`
                    : `<p style="color: var(--md-sys-color-success); font-size: 12px; margin-top: 4px;"><span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span>Aucune avance ce mois</p>`;

                return `
                    <div class="employee-item">
                        <div class="employee-info">
                            <h4>${employee.name}</h4>
                            <p><strong>Poste:</strong> ${employee.position} | <strong>Groupe:</strong> ${groupName}</p>
                            <p><strong>Salaire:</strong> ${formatCurrency(employee.salary)}</p>
                            ${advanceHTML}
                        </div>
                        <div class="employee-actions">
                            <button class="btn-icon" onclick="editEmployee('${employee.id}')" title="Modifier"><span class="material-icons">edit</span></button>
                            <button class="btn-icon" onclick="deleteEmployee('${employee.id}')" title="Supprimer"><span class="material-icons">delete</span></button>
                        </div>
                    </div>
                `;
            }).join('');

            // FANITSIANA NY ANTSO NY RENDERPAGINATIONCONTROLS
            renderPaginationControls(
                'employeePagination', 
                employeeCurrentPage, 
                totalPages, 
                totalItems, // Ampiana ity
                employeeItemsPerPage, // Ampiana koa ity
                (page) => {
                    employeeCurrentPage = page;
                    displayEmployees();
                }
            );
        }




        // ===================================================
        //  UTILITY FUNCTION: DEBOUNCE
        //  Mampiato ny fandehanan'ny asa iray mandra-pisian'ny fiatoana kely
        // ===================================================
        function debounce(func, delay = 300) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function displayAttendance() {
            const container = document.getElementById('attendanceList');
            const selectedDate = document.getElementById('attendanceDate').value;
            const searchTerm = document.getElementById('attendanceEmployeeSearch').value.toLowerCase();

            if (!selectedDate) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Veuillez s√©lectionner une date pour commencer.</p>';
                document.getElementById('attendancePagination').innerHTML = ''; 
                return;
            }

            // Raha mbola tsy misy firaketana ho an'io daty io, dia amboarina ny "objet" banga
            if (!attendance[selectedDate]) {
                attendance[selectedDate] = {};
            }

            let activeEmployees = employees.filter(e => e.status !== 'inactif' || !e.status);

            const filteredEmployees = activeEmployees.filter(emp =>
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.position.toLowerCase().includes(searchTerm)
            );

            const totalItems = filteredEmployees.length;
            const totalPages = Math.ceil(totalItems / attendanceItemsPerPage);

            if (attendanceCurrentPage > totalPages) {
                attendanceCurrentPage = totalPages > 0 ? totalPages : 1;
            }
            const startIndex = (attendanceCurrentPage - 1) * attendanceItemsPerPage;
            const endIndex = startIndex + attendanceItemsPerPage;
            const paginatedEmployees = filteredEmployees.slice(startIndex, endIndex);

            if (paginatedEmployees.length === 0) {
                container.innerHTML = `<p style="text-align: center; padding: 20px;">Aucun employ√© trouv√© pour la date et les filtres s√©lectionn√©s.</p>`;
            } else {
            
                container.innerHTML = paginatedEmployees.map(employee => {
                    const presenceData = attendance[selectedDate]?.[employee.id];
                    let presenceHTML = '';

                    if (presenceData) {
                        const arrivalTime = presenceData.arrivee || 'N/A';
                        const departureTime = presenceData.depart || '...';
                        const method = presenceData.method || 'MANUAL';
                        const methodColor = method === 'QR' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-secondary)';
                        const methodIcon = method === 'QR' ? 'qr_code_scanner' : 'edit';

                        presenceHTML = `
                            <div style="text-align: right;">
                                <div style="font-size: 14px; margin-bottom: 8px;">
                                    <span>Arriv√©e: <b>${arrivalTime}</b></span> | <span>D√©part: <b>${departureTime}</b></span>
                                    <span style="color: ${methodColor}; display: inline-flex; align-items: center; gap: 4px; font-size: 12px; margin-left: 8px;">
                                        <span class="material-icons" style="font-size: 14px;">${methodIcon}</span> ${method}
                                    </span>
                                </div>
                                <!-- Asehoy ny bokotra "D√©part" raha mbola tsy nanao izy -->
                                ${!presenceData.depart ? `<button class="btn btn-warning" style="padding: 8px 12px;" onclick="recordTime('${employee.id}', 'depart', '${selectedDate}')"><span class="material-icons" style="font-size: 18px;">logout</span> D√©part</button>` : ''}
                                <button class="btn btn-danger" style="padding: 8px 12px;" onclick="clearAttendance('${employee.id}', '${selectedDate}')"><span class="material-icons" style="font-size: 18px;">clear</span> Annuler</button>
                            </div>
                        `;
                    } else {
                        // Raha mbola tsy nanao pointage
                        presenceHTML = `<button class="btn btn-success" style="padding: 8px 12px;" onclick="recordTime('${employee.id}', 'arrivee', '${selectedDate}')"><span class="material-icons" style="font-size: 18px;">login</span> Arriv√©e</button>`;
                    }

                    return `
                        <div class="attendance-item">
                            <div class="attendance-status">
                                <div class="status-indicator ${presenceData ? 'present' : ''}"></div>
                                <div>
                                    <h4 class="employee-name">${employee.name}</h4>
                                    <p class="employee-position">${employee.position}</p>
                                </div>
                            </div>
                            <div>${presenceHTML}</div>
                        </div>
                    `;
                }).join('');
            }

            renderPaginationControls(
                'attendancePagination',
                attendanceCurrentPage,
                totalPages,
                totalItems,
                attendanceItemsPerPage,
                (page) => {
                    attendanceCurrentPage = page;
                    displayAttendance(); 
                }
            );
        }

        function displayAdvances() {
            const container = document.getElementById('advancesList');
    
            // --- DINGANA 1: Alaina ny sandan'ny sivana REHETRA ---
            const searchTerm = document.getElementById('advanceSearchInput').value.toLowerCase();
            const monthFilter = document.getElementById('advanceMonthFilter').value;
            const groupFilter = document.getElementById('advanceGroupFilter').value; // Sivana vaovao

            // --- DINGANA 2: Sivana ny lisitry ny trosa ---
            let filteredAdvances = advances.filter(advance => {
                const employee = employees.find(emp => emp.id === advance.employeeId);
                if (!employee) return false;

                const matchesSearch = employee.name.toLowerCase().includes(searchTerm) ||
                                    employee.position.toLowerCase().includes(searchTerm) ||
                                    (advance.reason || '').toLowerCase().includes(searchTerm);
                
                const matchesMonth = !monthFilter || advance.date.startsWith(monthFilter);

                // Fanamarinana ny vondrona
                const matchesGroup = groupFilter === 'all' || employee.groupId === groupFilter;

                return matchesSearch && matchesMonth && matchesGroup;
            });

            // --- DINGANA 3: Kajiana ny totalin'ny trosa voasivana (tsy miova) ---
            const totalAmount = filteredAdvances.reduce((sum, advance) => sum + advance.amount, 0);
            document.getElementById('totalAdvancesMonth').textContent = formatCurrency(totalAmount);
            const advancesSummaryPeriodEl = document.getElementById('advancesSummaryPeriod');
            if (advancesSummaryPeriodEl) {
                if (monthFilter) {
                    const [year, month] = monthFilter.split('-');
                    const date = new Date(year, month - 1);
                    const monthName = date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
                    advancesSummaryPeriodEl.textContent = `P√©riode: ${monthName}`;
                } else {
                    advancesSummaryPeriodEl.textContent = "P√©riode: Toutes les avances";
                }
            }

            // Alahatra araka ny daty (tsy miova)
            filteredAdvances.sort((a, b) => new Date(b.date) - new Date(a.date));

            // --- DINGANA 4: Lojika Pagination (mampiasa ny filteredAdvances) ---
            const totalItems = filteredAdvances.length;
            const totalPages = Math.ceil(totalItems / advancesItemsPerPage);

            // Fanamarinana mba tsy hihoatra ny pejy misy
            if (advancesCurrentPage > totalPages && totalPages > 0) {
                advancesCurrentPage = totalPages;
            } else if (totalPages === 0) {
                advancesCurrentPage = 1;
            }

            const startIndex = (advancesCurrentPage - 1) * advancesItemsPerPage;
            const endIndex = startIndex + advancesItemsPerPage;
            const paginatedAdvances = filteredAdvances.slice(startIndex, endIndex);

            // --- DINGANA 5: Fampisehoana ny lisitra ---
            if (paginatedAdvances.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--md-sys-color-on-surface-variant);">Aucune avance trouv√©e pour ces crit√®res.</p>';
                document.getElementById('advancesPagination').innerHTML = ''; // Fafana koa ny pagination
                return;
            }

            container.innerHTML = paginatedAdvances.map(advance => {
                const employee = employees.find(emp => emp.id === advance.employeeId);
                const employeeName = employee ? employee.name : "Mpiasa voafafa";
                const employeePosition = employee ? employee.position : 'Poste tsy hita';
                return `
                    <div class="advance-item">
                        <div class="advance-info">
                            <h4>${employeeName}</h4>
                            <p><strong>Poste:</strong> ${employeePosition}</p>
                            <p><strong>Date:</strong> ${formatDate(advance.date, false)} | <strong>Motif:</strong> ${advance.reason || 'Non sp√©cifi√©'}</p>
                        </div>
                        <div class="amount-actions">
                            <div class="amount">${formatCurrency(advance.amount)}</div>
                            <div>
                                <button class="btn-icon" onclick="openEditAdvanceModal('${advance.id}')" title="Modifier l'avance"><span class="material-icons">edit</span></button>
                                <button class="btn-icon" onclick="deleteAdvance('${advance.id}')" title="Supprimer l'avance"><span class="material-icons">delete_outline</span></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // --- DINGANA 6: Fampisehoana ny bokotra Pagination ---
            renderPaginationControls(
                'advancesPagination', 
                advancesCurrentPage, 
                totalPages, 
                totalItems, 
                advancesItemsPerPage, 
                (page) => {
                    advancesCurrentPage = page;
                    displayAdvances();
                }
            );
        }




        // ===================================================
        //  FONCTION DE FILTRAGE POUR LA SECTION PR√âSENCE
        // ===================================================
        function filterAttendanceEmployees() {
            const searchTerm = document.getElementById('attendanceEmployeeSearch').value.toLowerCase();
            const attendanceItems = document.querySelectorAll('#attendanceList .attendance-item');
            
            attendanceItems.forEach(item => {
                const employeeName = item.querySelector('.employee-name')?.textContent.toLowerCase() || '';
                const employeePosition = item.querySelector('.employee-position')?.textContent.toLowerCase() || '';
                
                const matches = employeeName.includes(searchTerm) || employeePosition.includes(searchTerm);
                item.style.display = matches ? 'flex' : 'none';
            });
            
            // Afficher un message si aucun r√©sultat
            const visibleItems = document.querySelectorAll('#attendanceList .attendance-item[style*="flex"]');
            const noResultsMsg = document.getElementById('attendanceNoResults');
            
            if (visibleItems.length === 0 && searchTerm.length > 0) {
                if (!noResultsMsg) {
                    const msg = document.createElement('div');
                    msg.id = 'attendanceNoResults';
                    msg.className = 'no-results-message';
                    msg.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--md-sys-color-on-surface-variant);">
                            <span class="material-icons" style="font-size: 48px; opacity: 0.5;">search_off</span>
                            <p>Aucun employ√© trouv√© pour "${searchTerm}"</p>
                        </div>
                    `;
                    document.getElementById('attendanceList').appendChild(msg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }


        async function recordTime(employeeId, type, date) {
            const now = new Date();
            const currentTime = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            if (!attendance[date]) {
                attendance[date] = {};
            }

            if (type === 'arrivee') {
                attendance[date][employeeId] = {
                    status: 'journee', // Mbola heverina ho tontolo andro aloha
                    arrivee: currentTime,
                    depart: null,
                    method: 'MANUAL'
                };
                showAlert(`${employees.find(e=>e.id===employeeId).name} marqu√© arriv√© √† ${currentTime}`, 'success');
            } else if (type === 'depart' && attendance[date][employeeId]) {
                attendance[date][employeeId].depart = currentTime;
                showAlert(`${employees.find(e=>e.id===employeeId).name} marqu√© parti √† ${currentTime}`, 'success');
            }

            await saveAttendanceData();
            displayAttendance(); // Mba havaozina ny fampisehoana
            updateStats();
        }

        async function clearAttendance(employeeId, date) {
            if (confirm("Voulez-vous vraiment annuler la pr√©sence de cet employ√© pour aujourd'hui ?")) {
                if (attendance[date] && attendance[date][employeeId]) {
                    delete attendance[date][employeeId];
                }
                
                // Fafana koa ny ao amin'ny QR raha misy
                const qrIndex = qrAttendance.findIndex(att => att.employeeId === employeeId && att.date === date);
                if (qrIndex > -1) {
                    const recordToDelete = qrAttendance[qrIndex];
                    qrAttendance.splice(qrIndex, 1);
                    await dbManager.delete('qr_attendance', recordToDelete.id);
                }

                await saveAttendanceData();
                displayAttendance();
                updateStats();
                showAlert("Pr√©sence annul√©e.", "success");
            }
        }



        async function updateAttendance(employeeId, isPresent, date) {
            if (!attendance[date]) {
                attendance[date] = {};
            }
            
            // 1Ô∏è‚É£ Mise √† jour pr√©sence manuelle
            attendance[date][employeeId] = isPresent;

            // 2Ô∏è‚É£ Synchronisation avec pr√©sence QR
            const existingQR = qrAttendance.findIndex(att => att.employeeId === employeeId && att.date === date);
            
            if (isPresent && existingQR === -1) {
                // üîç Ajouter pr√©sence QR si coch√© manuellement
                const employee = employees.find(emp => emp.id === employeeId);
                const record = {
                    id: Date.now().toString(),
                    employeeId,
                    employeeName: employee.name,
                    employeePosition: employee.position,
                    date,
                    timestamp: new Date().toISOString(),
                    method: 'MANUAL'
                };
                qrAttendance.push(record);
                await dbManager.add('qr_attendance', record);

            } else if (!isPresent && existingQR !== -1) {
                // ‚ùå Supprimer pr√©sence QR si d√©coch√© manuellement
                const recordToDelete = qrAttendance[existingQR];
                qrAttendance.splice(existingQR, 1);
                await dbManager.delete('qr_attendance', recordToDelete.id);
            }

            await saveAttendanceData();
            if (document.getElementById('qr-presence').classList.contains('active')) {
                displayQRAttendance();
            }
            
            // Havaozina ny statistika
            updateStats();
             // Actualiser l'affichage QR
        }

        async function saveAttendance() {
            await saveData();
            updateStats();
            runSmartChecks();
            showAlert('Pr√©sences enregistr√©es avec succ√®s!', 'success');
        }

        // Fonctions d'employ√©s simplifi√©es
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;

            // Famenoana ireo sehatra fototra
            document.getElementById('editEmployeeId').value = employee.id;
            document.getElementById('editEmployeeName').value = employee.name;
            document.getElementById('editEmployeePosition').value = employee.position;
            document.getElementById('editEmployeeGender').value = employee.gender;
            setCurrencyValue('editEmployeeSalary', employee.salary);
            document.getElementById('editEmployeeGroup').value = employee.groupId || "";

            // Fandraisana ireo element vaovao
            const statusSelect = document.getElementById('editEmployeeStatus');
            const departureDateInput = document.getElementById('editEmployeeDepartureDate');
            const departureContainer = document.getElementById('editDepartureDateContainer'); // Mampiasa ny ID marina

            // Fanamarinana sao misy tsy hita ireo element
            if (!statusSelect || !departureDateInput || !departureContainer) {
                console.error("Erreur: Tsy hita ny sehatra status na date de d√©part ao amin'ny edit modal.");
                openModal('editEmployeeModal'); // Sokafana ihany ny modal fa misy fampitandremana
                return;
            }

            // Famenoana ny sata sy ny daty fialana
            statusSelect.value = employee.status || 'actif';
            departureDateInput.value = employee.departureDate || '';

            // Fampisehoana na fanafenana ny sehatry ny daty
            if (statusSelect.value === 'depart' || statusSelect.value === 'inactif') {
                departureContainer.style.display = 'block';
            } else {
                departureContainer.style.display = 'none';
            }
            
            // Sokafana ny modal rehefa vita daholo ny zava-drehetra
            openModal('editEmployeeModal');
        }



        async function deleteEmployee(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet employ√©?')) {
                employees = employees.filter(emp => emp.id !== id);
                Object.keys(attendance).forEach(date => {
                    delete attendance[date][id];
                });
                // Supprimer aussi les pr√©sences QR
                qrAttendance = qrAttendance.filter(att => att.employeeId !== id);
                await saveData();
                updateStats();
                displayEmployees();
                populateEmployeeSelects();
                showAlert('Employ√© supprim√© avec succ√®s!', 'success');
            }
        }

        // --- FONCTIONS VAOVAO HO AN'NY FANAVANA Trosa ---

        // Manokatra ny modal fanovana sy mameno ny fampahalalana
        function openEditAdvanceModal(advanceId) {
            const advance = advances.find(adv => adv.id === advanceId);
            if (!advance) {
                showAlert("Erreur: Avance non trouv√©e.", 'error');
                return;
            }

            document.getElementById('editAdvanceId').value = advance.id;
            document.getElementById('editAdvanceEmployeeName').textContent = advance.employeeName;
            setCurrencyValue('editAdvanceAmount', advance.amount);
            document.getElementById('editAdvanceDate').value = advance.date;
            document.getElementById('editAdvanceReason').value = advance.reason || '';
            
            openModal('editAdvanceModal');
        }

        // Manavao ny trosa rehefa voatsindry ny bokotra "Enregistrer"
        async function handleUpdateAdvance(event) {
            event.preventDefault();
            
            const advanceId = document.getElementById('editAdvanceId').value;
            const newAmount = getCurrencyValue('editAdvanceAmount');
            const newDate = document.getElementById('editAdvanceDate').value;
            const newReason = document.getElementById('editAdvanceReason').value.trim();

            const advanceIndex = advances.findIndex(adv => adv.id === advanceId);
            if (advanceIndex === -1) {
                showAlert("Erreur critique: Avance non trouv√©e lors de la sauvegarde.", 'error');
                return;
            }

            // Fanavaozana ny fampahalalana
            advances[advanceIndex].amount = newAmount;
            advances[advanceIndex].date = newDate;
            advances[advanceIndex].reason = newReason;

            await saveData(); // Tehirizina ny fanovana
            
            closeModal('editAdvanceModal');
            displayAdvances(); // Havaozina ny fampisehoana ny lisitra
            updateStats(); // Havaozina ny statistika ankapobeny
            
            showAlert("L'avance a √©t√© mise √† jour avec succ√®s!", 'success');
        }



        async function deleteAdvance(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette avance?')) {
                advances = advances.filter(adv => adv.id !== id);
                await saveData();
                updateStats();
                displayAdvances();
                showAlert('Avance supprim√©e avec succ√®s!', 'success');
            }
        }

        // Gestion des paies
        function displayPayrollResults(results = []) {
            const container = document.getElementById('payrollResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p>Aucun r√©sultat √† afficher. Effectuez un calcul de paie.</p>';
                return;
            }

            container.innerHTML = `
                <h3 style="margin: 24px 0 16px 0; color: var(--md-sys-color-primary);">
                    R√©sultats de Paie - ${results[0]?.month || ''}
                </h3>
                ${results.map(result => `
                    <div class="payroll-item ${result.status === 'PAID' ? 'paid' : ''}">
                        <div class="payroll-header">
                            <h4>${result.employee.name}</h4>
                            <div class="payroll-actions">
                                ${result.status === 'PAID' ? `
                                    <button class="btn btn-secondary" onclick="updatePayrollPrompt('${result.id}')">
                                        <span class="material-icons">edit</span>
                                        Modifier
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteExistingPayroll('${result.id}')">
                                        <span class="material-icons">delete</span>
                                        Supprimer
                                    </button>
                                ` : `
                                    <button class="btn" onclick="savePayroll('${result.employee.id}', '${result.month}', ${result.netSalary})">
                                        <span class="material-icons">save</span>
                                        Enregistrer
                                    </button>
                                `}
                            </div>
                        </div>
                        <div class="payroll-details">
                            <div><strong>Jours travaill√©s:</strong> ${result.workDays}/${result.daysInMonth}</div>
                            <div><strong>Salaire brut:</strong> ${formatCurrency(result.grossSalary)}</div>
                            <div><strong>Avances:</strong> ${formatCurrency(result.totalAdvances)}</div>
                            <div><strong>Salaire net:</strong> <span class="amount">${formatCurrency(result.netSalary)}</span></div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function updatePayrollPrompt(payrollId) {
            const payroll = payrolls.find(p => p.id === payrollId);
            if (!payroll) return;

            const newAmount = prompt(`Nouveau montant pour ${payroll.employeeName} (${formatCurrency(payroll.amount)} actuel)`, formatCurrency(payroll.amount));
            if (newAmount) {
                const amount = getCurrencyValueFromInput(newAmount);
                if (amount > 0) {
                    payroll.amount = amount;
                    payroll.date = new Date().toISOString();
                    payroll.status = 'UPDATED';
                    updatePayroll(payroll);
                } else {
                    showAlert('Montant invalide', 'error');
                }
            }
        }

        async function deleteExistingPayroll(payrollId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce paiement?')) {
                payrolls = payrolls.filter(p => p.id !== payrollId);
                await saveData();
                updateStats();
                displayPayrollResults();
                showAlert('Paiement supprim√© avec succ√®s!', 'success');
            }
        }

        // ===================================================
        //  calculatePayroll (VERSION FARANY - KAJY MARINA SY AZO ANTOKA)
        // ===================================================
        async function calculatePayroll() {
            const container = document.getElementById('payrollResults');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>V√©rification et calcul en cours...</p></div>';

            const selectedMonth = document.getElementById('payrollMonth').value;
            const selectedEmployeeId = document.getElementById('payrollEmployeeSelect').value;
            const selectedGroupId = document.getElementById('payrollGroupFilter').value;

            if (!selectedMonth) {
                showAlert('Veuillez s√©lectionner un mois', 'error');
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Veuillez s√©lectionner un mois pour commencer.</p>';
                return;
            }

            // Fizarana Famintinana
            const summaryContainer = document.getElementById('payrollSummary');
            const totalToPayEl = document.getElementById('totalToPay');
            const remainingToPayEl = document.getElementById('remainingToPay');
            const unpaidListEl = document.getElementById('unpaidEmployeesList');

            let totalNetToPay = 0;
            let unpaidEmployeesData = [];

            // Sivana ny mpiasa
            let employeesToProcess = employees.filter(e => e.status === 'actif' || e.status === 'depart' || !e.status);
            if (selectedGroupId !== 'all') {
                employeesToProcess = employeesToProcess.filter(emp => emp.groupId === selectedGroupId);
            }
            if (selectedEmployeeId) {
                employeesToProcess = employeesToProcess.filter(e => e.id === selectedEmployeeId);
            }

            if (employeesToProcess.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Aucun employ√© trouv√© pour ces crit√®res.</p>';
                summaryContainer.style.display = 'none';
                return;
            }

            const existingPayrollsForMonth = payrolls.filter(p => p.month === selectedMonth);
            const [year, month] = selectedMonth.split('-');
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
            const payrollHTML = [];

            // --- KAJY ISAKY NY MPIASA (Fizarana nohamafisina) ---
            for (let emp of employeesToProcess) {
                // 1. Fanamarinana ny karama fototra
                const baseSalary = parseFloat(emp.salary || 0);

                // 2. Kajy ny andro niasana
                const presenceDays = countPresenceDays(emp.id, selectedMonth);
                
                // 3. Kajy ny karama mifanaraka amin'ny andro niasana (Salaire Brut)
                const proportionalSalary = (baseSalary / daysInMonth) * presenceDays;

                // 4. Fanalana ny trosa (Avances)
                const totalAdvances = advances
                    .filter(a => a.employeeId === emp.id && a.date.startsWith(selectedMonth))
                    .reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);

                // 5. Kajy ny karama Net FARANY
                //    Math.max(0, ...) dia miantoka fa tsy hisy karama n√©gatif
                const netSalary = Math.max(0, proportionalSalary - totalAdvances);

                const existingPayment = existingPayrollsForMonth.find(p => p.employeeId === emp.id);
                const isPaid = !!existingPayment;

                if (!isPaid && netSalary > 0) {
                    totalNetToPay += netSalary;
                    unpaidEmployeesData.push({ id: emp.id, name: emp.name });
                }

                // --- Fampisehoana ny antsipiriany mazava kokoa ---
                payrollHTML.push(`
                    <div class="payroll-item ${isPaid ? 'paid' : ''}" id="payroll-item-${emp.id}" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; border: 1px solid var(--md-sys-color-outline-variant); border-left-width: 6px;">
                        <div>
                            <h4>${emp.name}</h4>
                            <p>${emp.position}</p>
                            <div class="payroll-status-container">
                                ${isPaid ? `
                                    <div class="employee-status present">
                                        <span class="material-icons">check_circle</span> Pay√© le ${formatDate(existingPayment.date, false)}
                                    </div>
                                    <small>Montant pay√©: <b class="amount" style="color: var(--md-sys-color-success);">${formatCurrency(existingPayment.amount)}</b></small>
                                ` : `
                                    <div class="employee-status absent">
                                        <span class="material-icons">hourglass_empty</span> Non pay√©
                                    </div>
                                    <div style="font-size: 0.9em; margin-top: 5px;">
                                        <span title="Jours de pr√©sence / Jours dans le mois">Pr√©sences: <b>${presenceDays} / ${daysInMonth} j</b></span> | 
                                        <span title="Salaire brut calcul√©" style="color: var(--md-sys-color-primary);">Brut: <b>${formatCurrency(proportionalSalary)}</b></span> | 
                                        <span title="Total des avances d√©duites" style="color: var(--md-sys-color-error);">Avances: <b>-${formatCurrency(totalAdvances)}</b></span>
                                        <hr style="margin: 4px 0; border-color: var(--md-sys-color-outline-variant);">
                                        <strong title="Salaire net final √† payer">Net √† payer: ${formatCurrency(netSalary)}</strong>
                                    </div>
                                `}
                            </div>
                        </div>
                        <div class="payroll-actions" style="text-align: right; display: flex; align-items: center; gap: 8px;">
                            ${isPaid ? `
                                <button class="btn-icon" onclick="deleteExistingPayroll('${existingPayment.id}')" title="Supprimer le paiement">
                                    <span class="material-icons" style="color: var(--md-sys-color-error);">delete</span>
                                </button>
                            ` : (netSalary > 0 ? `
                                <button class="btn btn-success" onclick="savePayroll('${emp.id}', '${selectedMonth}', ${netSalary})">
                                    <span class="material-icons">save</span> Payer
                                </button>
                            ` : '<small>Aucun paiement requis</small>')}
                        </div>
                    </div>
                `);
            }

            // Ny tohin'ny fonction (fampisehoana famintinana) dia tsy miova
            summaryContainer.style.display = 'block';
            totalToPayEl.textContent = formatCurrency(totalNetToPay);
            remainingToPayEl.textContent = formatCurrency(totalNetToPay);
            totalToPayEl.dataset.amount = totalNetToPay;
            remainingToPayEl.dataset.amount = totalNetToPay;

            if (unpaidEmployeesData.length > 0) {
                unpaidListEl.innerHTML = unpaidEmployeesData.map(emp => `<div id="unpaid-name-${emp.id}">- ${emp.name}</div>`).join('');
            } else {
                unpaidListEl.innerHTML = '<span style="color: var(--md-sys-color-success);">Tous les employ√©s pour cette p√©riode ont √©t√© pay√©s.</span>';
            }

            container.innerHTML = payrollHTML.join('');
        }




        // Sauvegarde d'une nouvelle paie (√©vite doublons)
        // ===================================================
        // ===================================================
        //  savePayroll (VERSION MISY FANITSIHANA NY ANARANA)
        // ===================================================
        async function savePayroll(employeeId, month, amount) {
            const existing = payrolls.find(p => p.employeeId === employeeId && p.month === month);
            if (existing) {
                showAlert("Cet employ√© a d√©j√† √©t√© pay√© pour ce mois", "error");
                return;
            }

            const emp = employees.find(e => e.id === employeeId);
            const payrollRecord = {
                id: Date.now().toString(),
                employeeId: employeeId,
                employeeName: emp ? emp.name : "Inconnu",
                position: emp ? emp.position : "",
                month: month,
                amount: parseFloat(amount),
                date: new Date().toISOString()
            };

            payrolls.push(payrollRecord);
            await dbManager.add('payrolls', payrollRecord);
            showAlert("Paie enregistr√©e avec succ√®s", "success");

            // --- Fizarana Fanavaozana ny Famintinana ---
            const remainingToPayEl = document.getElementById('remainingToPay');
            
            // FANITSIANA ETO: Alaina ilay anarana ao amin'ny lisitry ny tsy voaloa
            const unpaidNameEl = document.getElementById(`unpaid-name-${employeeId}`);

            if (remainingToPayEl) {
                let currentRemainingAmount = parseFloat(remainingToPayEl.dataset.amount || 0);
                currentRemainingAmount -= parseFloat(amount);
                remainingToPayEl.textContent = formatCurrency(currentRemainingAmount);
                remainingToPayEl.dataset.amount = currentRemainingAmount;
            }

            // FANITSIANA ETO: Raha hita ilay anarana, dia asiana tsipika
            if (unpaidNameEl) {
                unpaidNameEl.style.textDecoration = 'line-through';
                unpaidNameEl.style.opacity = '0.6';
            }

            // --- Fizarana Fanavaozana ny Andalana ao amin'ny Interface (tsy miova) ---
            const payrollItem = document.getElementById(`payroll-item-${employeeId}`);
            if (payrollItem) {
                payrollItem.classList.add('paid');
                const actionContainer = payrollItem.querySelector('.payroll-actions');
                const statusContainer = payrollItem.querySelector('.payroll-status-container');

                if (actionContainer) {
                    actionContainer.innerHTML = `
                        <button class="btn-icon" onclick="deleteExistingPayroll('${payrollRecord.id}')" title="Supprimer le paiement">
                            <span class="material-icons" style="color: var(--md-sys-color-error);">delete</span>
                        </button>
                    `;
                }
                
                if (statusContainer) {
                    statusContainer.innerHTML = `
                        <div class="employee-status present">
                            <span class="material-icons">check_circle</span> Pay√© le ${formatDate(payrollRecord.date, false)}
                        </div>
                        <small>Montant pay√©: <b class="amount" style="color: var(--md-sys-color-success);">${formatCurrency(payrollRecord.amount)}</b></small>
                    `;
                }
            }

            updateStats();
        }



        // Modifier une paie existante
        async function updatePayroll(payrollId) {
            const payroll = payrolls.find(p => p.id === payrollId);
            if (!payroll) return;

            const newAmount = prompt("Nouveau montant:", payroll.amount);
            if (newAmount === null || isNaN(parseFloat(newAmount))) {
                showAlert("Montant invalide", "error");
                return;
            }

            payroll.amount = parseFloat(newAmount);
            payroll.status = 'UPDATED';
            await dbManager.put('payrolls', payroll);
            showAlert("Paie mise √† jour", "success");

            calculatePayroll();
            updateStats();
        }

        // Supprimer une paie existante
        async function deleteExistingPayroll(payrollId) {
            if (!confirm("Voulez-vous vraiment supprimer cette paie ?")) return;

            const index = payrolls.findIndex(p => p.id === payrollId);
            if (index !== -1) {
                const payroll = payrolls[index];
                payrolls.splice(index, 1);
                await dbManager.delete('payrolls', payrollId);
                showAlert("Paie supprim√©e", "success");
            }

            calculatePayroll();
            updateStats();
        }

        async function deleteExistingPayroll(payrollId) {
            if (!confirm("Voulez-vous vraiment supprimer cette paie ?")) return;

            const index = payrolls.findIndex(p => p.id === payrollId);
            if (index !== -1) {
                payrolls.splice(index, 1);
                await dbManager.delete('payrolls', payrollId);
                showAlert("Paie supprim√©e", "success");
            }

            calculatePayroll();
            updateStats();
        }

        async function deletePayment(paymentId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce paiement?')) {
                payrolls = payrolls.filter(p => p.id !== paymentId);
                await saveData();
                displayPayments();
                showAlert('Paiement supprim√© avec succ√®s!', 'success');
            }
        }

        // Gestion des paiements
        function displayPayments() {
            const employeeFilter = document.getElementById('paymentEmployeeFilter').value;
            const searchValue = document.getElementById('paymentSearch').value.toLowerCase();
            const paymentList = document.getElementById('paymentList');

            let paymentsToShow = payrolls;

            if (employeeFilter) {
                paymentsToShow = paymentsToShow.filter(p => p.employeeId === employeeFilter);
            }

            if (searchValue) {
                paymentsToShow = paymentsToShow.filter(p =>
                    p.employeeName.toLowerCase().includes(searchValue) ||
                    p.month.toLowerCase().includes(searchValue)
                );
            }

            paymentList.innerHTML = paymentsToShow.length > 0 ? paymentsToShow.map(pay => `
                <div class="payment-item">
                    <div class="payment-info">
                        <h4>${pay.employeeName}</h4>
                        <p><strong>Mois:</strong> ${pay.month}</p>
                        <p><strong>Montant:</strong> ${formatCurrency(pay.amount)}</p>
                    </div>
                    <div class="payment-actions">
                        <button class="btn btn-danger" onclick="deletePayment('${pay.id}')">
                            <span class="material-icons">delete</span> Supprimer
                        </button>
                    </div>
                </div>
            `).join('') : '<p>Aucun paiement trouv√©.</p>';
        }

        function updateReportStats() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const reportPresentTodayEl = document.getElementById('reportPresentToday');
            const reportPresentMonthEl = document.getElementById('reportPresentMonth');
            const reportSalariesPaidEl = document.getElementById('reportSalariesPaid');
            const reportActiveEmployeesEl = document.getElementById('reportActiveEmployees');
            
            const presentToday = attendance[today] ? 
                Object.values(attendance[today]).filter(Boolean).length : 0;
            if (reportPresentTodayEl) reportPresentTodayEl.textContent = presentToday;
            
            let totalPresenceThisMonth = 0;
            Object.keys(attendance).forEach(date => {
                if (date.startsWith(currentMonth)) {
                    totalPresenceThisMonth += Object.values(attendance[date]).filter(Boolean).length;
                }
            });
            if (reportPresentMonthEl) reportPresentMonthEl.textContent = totalPresenceThisMonth;
            
            const totalSalariesPaid = payrolls.reduce((sum, p) => sum + p.amount, 0);
            if (reportSalariesPaidEl) reportSalariesPaidEl.textContent = formatCurrency(totalSalariesPaid);
            
            if (reportActiveEmployeesEl) reportActiveEmployeesEl.textContent = employees.length;
        }

        // ===============================
        // FONCTIONS UTILITAIRES COMPL√àTES
        // ===============================
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        // ===================================================
        //  countPresenceDays (VERSION NOHATSARAINA)
        //  Mahazaka ny angona taloha sy vaovao
        // ===================================================
        // ===================================================
        //  countPresenceDays (VERSION FARANY - STABLE SY UNIVERSAL - VOAHITSY)
        //  Mahazaka ny angona rehetra (taloha sy vaovao)
        // ===================================================
        function countPresenceDays(employeeId, month) {
            let totalDaysWorked = 0;
            const MINIMUM_HOURS_FOR_FULL_DAY = 4; // Ora farafahakeliny ho an'ny andro feno

            // Famakiana ny andro rehetra ao anatin'ny volana voafidy
            Object.keys(attendance).forEach(dateStr => {
                if (dateStr.startsWith(month)) {
                    const dayData = attendance[dateStr];
                    if (!dayData) return; // Raha tsy misy angona ho an'io andro io

                    const presenceData = dayData[employeeId];

                    // Raha misy firaketana ho an'io mpiasa io...
                    if (presenceData) {
                        
                        // --- FANDRAISANA AN-TANANA NY KARAZANA ANGONA REHETRA ---

                        // 1. Karazana VAOVAO (objet misy ora fahatongavana)
                        //    FANITSIANA LEHIBE ETO: Hamarinina aloha ny fisian'ny 'arrivee'
                        if (typeof presenceData === 'object' && presenceData !== null && presenceData.arrivee) {
                            
                            // Rehefa azo antoka fa misy ny 'arrivee', dia jerena indray ny 'depart'
                            if (presenceData.depart) {
                                // Raha feno ny ora roa, dia kajiana ny faharetany
                                const duration = calculateWorkDuration(presenceData.arrivee, presenceData.depart);
                                const durationInHours = duration.totalMinutes / 60;

                                if (durationInHours >= MINIMUM_HOURS_FOR_FULL_DAY) {
                                    totalDaysWorked += 1; // Andro feno
                                } else if (durationInHours > 0) {
                                    totalDaysWorked += 0.5; // Antsasaky ny andro
                                }
                            } 
                            // Raha 'arrivee' fotsiny no misy fa tsy misy 'depart'
                            else {
                                totalDaysWorked += 0.5; // Heverina ho antsasaky ny andro
                            }
                        } 
                        
                        // 2. Karazana TALOHA (boolean: true)
                        else if (presenceData === true) {
                            totalDaysWorked += 1; // Heverina ho andro feno avy hatrany
                        } 
                        
                        // 3. Karazana TALOHA (string: 'journee' na 'demi')
                        else if (typeof presenceData === 'string') {
                            if (presenceData === 'journee') {
                                totalDaysWorked += 1;
                            } else if (presenceData === 'demi') {
                                totalDaysWorked += 0.5;
                            }
                        }
                    }
                }
            });

            return totalDaysWorked;
        }



        function getWorkDaysInMonth(employeeId, year, month) {
            let workDays = 0;
            const daysInMonth = getDaysInMonth(year, month);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                if (attendance[date] && attendance[date][employeeId]) {
                    workDays++;
                }
            }
            
            return workDays;
        }

        function getEmployeeAdvancesForMonth(employeeId, month) {
            return advances.filter(adv => 
                adv.employeeId === employeeId && 
                adv.date.startsWith(month)
            );
        }

        function capitalizeWords(str) {
            return str.toLowerCase().split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // ===============================
        // CURRENCY ET FORM MANAGEMENT
        // ===============================
        function initializeCurrencyInputs() {
            const currencyInputs = document.querySelectorAll('[data-type="currency"]');
            currencyInputs.forEach(input => {
                input.addEventListener('input', formatCurrencyInput);
                input.addEventListener('blur', formatCurrencyInput);
                input.addEventListener('focus', function() {
                    const rawValue = this.value.replace(/[^\d]/g, '');
                    this.value = rawValue;
                });
            });
        }

        function formatCurrencyInput(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value && !isNaN(value)) {
                value = parseInt(value).toLocaleString('fr-FR');
            } else {
                value = '';
            }
            e.target.value = value;
        }

        function getCurrencyValue(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return 0;
            const raw = input.value.replace(/[^\d]/g, '');
            return raw ? parseInt(raw, 10) : 0;
        }

        function setCurrencyValue(inputId, value) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = value ? parseInt(value).toLocaleString('fr-FR') : '';
            }
        }

        // ===============================
        // THEME MANAGEMENT
        // ===============================
        function initializeTheme() {
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = currentTheme;
                changeTheme(currentTheme);
            }
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            changeTheme(newTheme);
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = newTheme;
            }
        }

        async function changeTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = theme === 'light' ? 'dark_mode' : 'light_mode';
            }
            
            try {
                await dbManager.put('settings', { key: 'theme', value: theme });
            } catch (error) {
                console.error('Erreur sauvegarde th√®me:', error);
            }
        }

        // ===============================
        // DATES ET NAVIGATION
        // ===============================
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const attendanceDateEl = document.getElementById('attendanceDate');
            if (attendanceDateEl) {
                attendanceDateEl.value = today;
            }
        }

        function setCurrentMonth() {
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            const payrollMonthEl = document.getElementById('payrollMonth');
            if (payrollMonthEl) {
                payrollMonthEl.value = currentMonth;
            }
        }

        function goToPreviousDay() {
            const currentDate = new Date(document.getElementById('attendanceDate').value);
            currentDate.setDate(currentDate.getDate() - 1);
            document.getElementById('attendanceDate').value = currentDate.toISOString().split('T')[0];
            displayAttendance();
        }

        function goToNextDay() {
            const currentDate = new Date(document.getElementById('attendanceDate').value);
            currentDate.setDate(currentDate.getDate() + 1);
            document.getElementById('attendanceDate').value = currentDate.toISOString().split('T')[0];
            displayAttendance();
        }

        // ===============================
        // SELECTS ET FORMULAIRES
        // ===============================
        /**
         * Mameno ny lisitra fisafidianana mpiasa rehetra.
         * Afaka mandray sivana vondrona mba hampisehoana mpiasa voafantina ihany.
         * @param {string | null} groupIdFilter - Ny ID an'ny vondrona hasivana. Raha null, dia ny mpiasa rehetra no alaina.
         */
        function populateEmployeeSelects(groupIdFilter = null) {
            let employeesToList = employees.filter(e => e.status === 'actif' || e.status === 'depart' || !e.status);

            // Raha misy sivana vondrona, dia ireo mpiasa ao anatiny ihany no alaina
            if (groupIdFilter) {
                employeesToList = employeesToList.filter(emp => emp.groupId === groupIdFilter);
            }

            const employeeOptionsHTML = employeesToList.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');

            // Ireo select rehetra mila fenoina
            const selectsToPopulate = {
                'advanceEmployee': '<option value="">S√©lectionner un employ√©</option>',
                'payrollEmployeeSelect': '<option value="">Tous les employ√©s</option>',
                'paymentEmployeeFilter': '<option value="">Tous les employ√©s</option>'
            };

            for (const selectId in selectsToPopulate) {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    const defaultOption = selectsToPopulate[selectId];
                    selectElement.innerHTML = defaultOption + employeeOptionsHTML;
                }
            }
        }



        // ===============================
        // FORM HANDLERS
        // ===============================
        // =======================================================================
        //  VERSION FARANY INDRINDRA - Mampiasa ID vaovao tanteraka
        // =======================================================================
        // IZAO NO TOKONY HO IZY
        document.getElementById('employeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const name = capitalizeWords(document.getElementById('employeeName_add').value.trim());
                const position = capitalizeWords(document.getElementById('employeePosition_add').value.trim());
                const gender = document.getElementById('employeeGender_add').value;
                const salary = getCurrencyValue('employeeSalary_add');
                const groupId = document.getElementById('employeeGroup_add').value;

                if (!name || !position || !gender || salary <= 0) {
                    showAlert("Veuillez remplir tous les champs correctement.", 'error');
                    return;
                }
                if (employees.some(emp => emp.name.toLowerCase() === name.toLowerCase())) {
                    showAlert('Un employ√© avec ce nom existe d√©j√†.', 'error');
                    return;
                }

                const newEmployee = {
                    id: Date.now().toString(),
                    name: name,
                    position: position,
                    gender: gender,
                    salary: salary,
                    groupId: groupId || null,
                    dateAdded: new Date().toISOString(),
                    status: 'actif', // Mpiasa vaovao dia 'actif' foana
                    departureDate: null // Tsy manana daty fialana
                };

                employees.push(newEmployee);
                await saveData();

                updateStats();
                populateEmployeeSelects();
                displayEmployees();

                this.reset();
                closeModal('addEmployeeModal');
                showAlert('Employ√© ajout√© avec succ√®s!', 'success');

            } catch (error) {
                console.error("Erreur critique lors de l'ajout de l'employ√©:", error);
                showAlert("Une erreur inattendue est survenue. V√©rifiez la console.", 'error');
            }
        });


        document.getElementById('advanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeId = document.getElementById('advanceEmployee').value;
            const amount = getCurrencyValue('advanceAmount');
            const date = document.getElementById('advanceDate').value;
            const reason = document.getElementById('advanceReason').value.trim();

            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            if (amount === 0) {
                showAlert('Veuillez saisir un montant valide!', 'error');
                return;
            }

            const advance = {
                id: Date.now().toString(),
                employeeId,
                employeeName: employee.name,
                amount,
                date,
                reason,
                dateCreated: new Date().toISOString()
            };

            advances.push(advance);
            await saveData();
            updateStats();
            displayAdvances();
            
            this.reset();
            showAlert('Avance ajout√©e avec succ√®s!', 'success');
        });

        // ===============================
        // MODAL MANAGEMENT
        // ===============================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Fonction hanokafana ny modal "Ajouter un Employ√©"
        function openAddEmployeeModal() {
            // Diovina aloha ny formulaire sao misy angona taloha
            document.getElementById('employeeForm').reset();
            // Havaozina ny lisitry ny vondrona ao amin'ny select
            populateGroupSelects();
            // Havaozina ny input momba ny vola
            initializeCurrencyInputs();
            // Sokafana ny modal
            openModal('addEmployeeModal');
        }


        // ===============================
        // SETTINGS PANEL
        // ===============================
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('settingsOverlay');
            
            if (panel && overlay) {
                panel.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

        // ===============================
        // EXPORT FUNCTIONS
        // ===============================
        // ===================================================
        //  exportData (VERSION NOHATSARAINA)
        // ===================================================
        async function exportData() {
            try {
                const exportTimestamp = new Date();
                const data = {
                    // Angona fototra
                    employees,
                    attendance,
                    payrolls,
                    advances,
                    qrAttendance,
                    groups, // Efa tafiditra tsara
                    
                    // Fampahalalana fanampiny
                    settings: {
                        theme: currentTheme,
                        qrSettings: qrSettings
                    },
                    
                    // Metadata
                    exportDate: exportTimestamp.toISOString(),
                    version: '3.0-groups',
                    dbType: 'IndexedDB-QR'
                };
                
                const filename = `sauvegarde-rh-behavana-${exportTimestamp.toISOString().split('T')[0]}.json`;
                
                // Ity function ity dia efa mandeha tsara
                downloadJSON(data, filename);
                
                await dbManager.put('settings', { key: 'lastBackupDate', value: exportTimestamp.toISOString() });
                updateLastBackupInfo();
                
                showAlert('Sauvegarde (avec groupes) t√©l√©charg√©e avec succ√®s!', 'success');

            } catch (error) {
                console.error("Erreur lors de la cr√©ation de la sauvegarde:", error);
                showAlert("Une erreur est survenue lors de l'exportation des donn√©es.", "error");
            }
        }


        // ===================================================
        //  importData (VERSION NOHATSARAINA SY AZO ANTOKA)
        // ===================================================
        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                handleImportedFile(file); // Miantso ilay fonction iraisana
            }
            // Diovina foana ny input mba hahafahana mampiditra rakitra mitovy anarana indray
            event.target.value = '';
        }


        function updateLastBackupInfo() {
            const infoElement = document.getElementById('lastBackupInfo');
            dbManager.get('settings', 'lastBackupDate').then(setting => {
                if (setting && setting.value) {
                    infoElement.textContent = `Derni√®re sauvegarde t√©l√©charg√©e le: ${formatDate(setting.value)}`;
                } else {
                    infoElement.textContent = "Aucune sauvegarde n'a encore √©t√© t√©l√©charg√©e.";
                }
            });
        }



        // üîç Statut employ√© par jour
        // ===================================================
        //  displayEmployeeStatus (VERSION 3 - KAJY VAOVAO)
        // ===================================================
        async function displayEmployeeStatus(employeeId) {
            const month = document.getElementById('statsMonth').value;
            const container = document.getElementById('employeeStatusResults');

            if (!employeeId || !month) {
                container.innerHTML = '';
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            // --- FANAMPIANA 1: Alaina ny anaran'ny vondrona ---
            const group = groups.find(g => g.id === employee.groupId);
            const groupName = group ? group.name : "<i>Sans groupe</i>"; // Mampiseho "Sans groupe" raha tsy manana izy

            const [year, monthNum] = month.split('-');
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(monthNum));

            const MINIMUM_HOURS_IN_MINUTES = 8 * 60;
            const HALF_DAY_IN_MINUTES = 4 * 60;

            let totalMonthlyMinutes = 0;
            let dailyDetails = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${monthNum}-${day.toString().padStart(2, '0')}`;
                const presenceData = attendance[dateStr]?.[employeeId];
                
                let duration = { totalMinutes: 0, displayText: "---" };
                if (presenceData) {
                    duration = calculateWorkDuration(presenceData.arrivee, presenceData.depart);
                    totalMonthlyMinutes += duration.totalMinutes;
                }
                dailyDetails.push({ dateStr, presenceData, duration });
            }

            const totalMonthlyHours = Math.floor(totalMonthlyMinutes / 60);
            const totalMonthlyRemainingMinutes = totalMonthlyMinutes % 60;
            const monthlyHoursText = `${totalMonthlyHours}h ${totalMonthlyRemainingMinutes}m`;

            const presenceDays = countPresenceDays(employee.id, month);
            const totalAdvances = advances
                .filter(adv => adv.employeeId === employee.id && adv.date.startsWith(month))
                .reduce((sum, adv) => sum + adv.amount, 0);
            const proportionalSalary = (employee.salary / daysInMonth) * presenceDays;
            const netSalaryToPay = proportionalSalary - totalAdvances;

            let tableHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: var(--md-sys-color-primary); margin-bottom: 4px;">
                        Rapport Mensuel D√©taill√© pour ${employee.name}
                    </h3>
                    
                    <!-- FANAMPIANA 2: Asehoy eto ny anaran'ny vondrona -->
                    <p style="margin-top: 0; color: var(--md-sys-color-on-surface-variant);">
                        <strong>Groupe:</strong> ${groupName}
                    </p>
                </div>
                
                <div style="margin-bottom: 24px; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px;">
                    <h4 style="margin-bottom: 12px; color: var(--md-sys-color-primary);">R√©sum√© du Mois</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; font-size: 1.1em;">
                        <div><strong>Jours de Pr√©sence:</strong> <span style="font-weight: bold;">${presenceDays} / ${daysInMonth} jours</span></div>
                        <div><strong>Total Heures Travaill√©es:</strong> <span style="font-weight: bold; color: var(--md-sys-color-primary);">${monthlyHoursText}</span></div>
                        <div><strong>Total Avances:</strong> <span style="font-weight: bold; color: var(--md-sys-color-error);">${formatCurrency(totalAdvances)}</span></div>
                        <div style="background-color: var(--md-sys-color-primary-container); padding: 8px; border-radius: 8px;">
                            <strong>Salaire Net √† Payer:</strong> 
                            <span style="font-weight: bold; color: var(--md-sys-color-on-primary-container); font-size: 1.2em;">${formatCurrency(netSalaryToPay)}</span>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--md-sys-color-outline-variant); border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background-color: var(--md-sys-color-surface);">
                            <tr style="background-color: var(--md-sys-color-primary-container);">
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Statut</th>
                                <th style="padding: 12px; text-align: center;">Total Heures</th>
                                <th style="padding: 12px; text-align: right;">Avance du Jour</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            dailyDetails.forEach(detail => {
                const { dateStr, presenceData, duration } = detail;
                const dayOfWeek = new Date(dateStr).getDay();
                const isWeekend = (dayOfWeek === 6 || dayOfWeek === 0);

                const advanceOnDay = advances
                    .filter(adv => adv.employeeId === employeeId && adv.date === dateStr)
                    .reduce((sum, adv) => sum + adv.amount, 0);

                let status = '<span style="color: var(--md-sys-color-error);">Absent</span>';
                if (presenceData) {
                    const arrival = presenceData.arrivee || 'N/A';
                    const departure = presenceData.depart || '...';
                    status = `<span style="color: var(--md-sys-color-success);">Pr√©sent (${arrival} - ${departure})</span>`;
                }

                let durationStyle = 'font-weight: 500;';
                if (duration.totalMinutes > 0 && duration.totalMinutes < HALF_DAY_IN_MINUTES) {
                    durationStyle += ' color: var(--md-sys-color-error);';
                } else if (duration.totalMinutes >= HALF_DAY_IN_MINUTES && duration.totalMinutes < MINIMUM_HOURS_IN_MINUTES) {
                    durationStyle += ' color: var(--md-sys-color-warning);';
                }

                let rowStyle = isWeekend ? 'background-color: var(--md-sys-color-surface-variant); opacity: 0.6;' : '';

                tableHTML += `
                    <tr style="${rowStyle}">
                        <td style="padding: 8px 12px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">${formatDate(dateStr)}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">${status}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid var(--md-sys-color-outline-variant); text-align: center; ${durationStyle}">${duration.displayText}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid var(--md-sys-color-outline-variant); text-align: right; color: var(--md-sys-color-error);">${advanceOnDay > 0 ? formatCurrency(advanceOnDay) : '-'}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;
        }




        /**
         * Mikajy ny faharetan'ny asa ary mamerina object misy ny antsipiriany.
         * @param {string | null} startTime - Ora fahatongavana (oh: "08:00")
         * @param {string | null} endTime - Ora fiaingana (oh: "17:30")
         * @returns {{totalMinutes: number, displayText: string}} - Object misy ny totalin'ny minitra sy ny lahatsoratra.
         */
        function calculateWorkDuration(startTime, endTime) {
            if (!startTime || !endTime) {
                return { totalMinutes: 0, displayText: "---" };
            }

            try {
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);

                const startTotalMinutes = startHour * 60 + startMinute;
                const endTotalMinutes = endHour * 60 + endMinute;

                if (endTotalMinutes < startTotalMinutes) {
                    return { totalMinutes: 0, displayText: "Erreur d'heure" };
                }

                const durationMinutes = endTotalMinutes - startTotalMinutes;
                const hours = Math.floor(durationMinutes / 60);
                const minutes = durationMinutes % 60;

                let displayText = "";
                if (hours > 0 && minutes > 0) {
                    displayText = `${hours}h ${minutes}m`;
                } else if (hours > 0) {
                    displayText = `${hours}h`;
                } else {
                    displayText = `${minutes}m`;
                }
                
                return { totalMinutes: durationMinutes, displayText: displayText };

            } catch (error) {
                console.error("Erreur de calcul de dur√©e:", error);
                return { totalMinutes: 0, displayText: "Erreur" };
            }
        }



        // ===================================================
        //  Fonction de recherche pour le Smart Search
        // ===================================================
        function handleSmartSearch() {
            const searchTerm = document.getElementById('smartSearchInput').value.toLowerCase();
            const resultsContainer = document.getElementById('smartSearchResults');
            const reportContainer = document.getElementById('employeeStatusResults');

            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '';
                reportContainer.innerHTML = '';
                return;
            }

            const results = employees.filter(emp => 
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.position.toLowerCase().includes(searchTerm)
            );

            if (results.length > 0) {
                // --- FANITSIANA ETO ---
                resultsContainer.innerHTML = results.map(emp => {
                    // 1. Alaina ny anaran'ny vondrona
                    const group = groups.find(g => g.id === emp.groupId);
                    const groupName = group ? group.name : "<i>Sans groupe</i>";

                    // 2. Ampidirina ao anatin'ny HTML ilay anarana
                    return `
                        <div class="employee-item" style="cursor: pointer;" onclick="selectEmployeeForStat('${emp.id}')">
                            <div class="employee-info">
                                <h4>${emp.name}</h4>
                                <p>${emp.position} - <strong>Groupe: ${groupName}</strong></p>
                            </div>
                            <span class="material-icons">arrow_forward_ios</span>
                        </div>
                    `;
                }).join('');
            } else {
                resultsContainer.innerHTML = `<p style="text-align: center; padding: 10px;">Aucun employ√© trouv√©.</p>`;
            }
        }


                // ===================================================
        //  Fonction appel√©e lors du clic sur un employ√©
        // ===================================================
        function selectEmployeeForStat(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (employee) {
                // Apetraka ao anaty input ilay anarana ary ajanona ny fampisehoana ny lisitra
                document.getElementById('smartSearchInput').value = employee.name;
                document.getElementById('smartSearchResults').innerHTML = '';
                
                // Alefa avy hatrany ny famoronana tatitra
                displayEmployeeStatus(employeeId);
            }
        }



        function exportGlobalReport() {
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            
            const reportData = {
                date: today.toISOString(),
                totalEmployees: employees.length,
                presentToday: attendance[today.toISOString().split('T')[0]] ? 
                    Object.values(attendance[today.toISOString().split('T')[0]]).filter(Boolean).length : 0,
                qrScansToday: qrAttendance.filter(att => att.date === today.toISOString().split('T')[0]).length,
                totalSalariesPaid: payrolls.reduce((sum, p) => sum + p.amount, 0),
                totalAdvances: advances.reduce((sum, adv) => sum + adv.amount, 0),
                employees: employees,
                monthlyPayrolls: payrolls.filter(p => p.month === currentMonth),
                monthlyAdvances: advances.filter(adv => adv.date.startsWith(currentMonth)),
                qrAttendance: qrAttendance // Inclure dans le rapport
            };

            downloadJSON(reportData, `rapport-global-qr-${formatDateForFilename(today)}.json`);
            showAlert('Rapport global avec QR export√© avec succ√®s!', 'success');
        }

        function exportAttendanceReport() {
            const attendanceReport = {
                date: new Date().toISOString(),
                attendanceData: attendance,
                qrAttendanceData: qrAttendance, // Inclure les pr√©sences QR
                employees: employees
            };

            downloadJSON(attendanceReport, `rapport-presences-qr-${formatDateForFilename(new Date())}.json`);
            showAlert('Rapport des pr√©sences avec QR export√© avec succ√®s!', 'success');
        }

        function exportPayrollReport() {
            const payrollReport = {
                date: new Date().toISOString(),
                payrolls: payrolls,
                employees: employees
            };

            downloadJSON(payrollReport, `rapport-paies-${formatDateForFilename(new Date())}.json`);
            showAlert('Rapport des paies export√© avec succ√®s!', 'success');
        }

        // ===============================
        // UTILITY FUNCTIONS
        // ===============================
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatDateForFilename(date) {
            return date.toISOString().split('T')[0];
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span>
                ${message}
            `;
            
            document.body.appendChild(alertDiv);
            
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '24px';
            alertDiv.style.right = '24px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.animation = 'slideInRight 0.3s ease';
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 300);
            }, 3000);
        }

        // ===================================================
        //  FONCTION VAOVAO: Fampisehoana Fampandrenesana Hendry
        // ===================================================
        /**
         * Mampiseho hafatra fampandrenesana eo an-tampon'ny pejy.
         * @param {string} message - Ny lahatsoratra ho aseho.
         * @param {string} type - Karazana fampandrenesana ('warning', 'info', 'error').
         * @param {string} icon - Ny anaran'ilay sary masina (Material Icon) hampiasaina.
         */
        function displayNotification(message, type = 'info', icon = 'info') {
            const container = document.getElementById('notificationsContainer');
            if (!container) return;

            // Amboarina ilay element vaovao
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `alert alert-${type}`; // Mampiasa ny style efa misy
            notificationDiv.style.display = 'flex';
            notificationDiv.style.alignItems = 'center';
            notificationDiv.style.justifyContent = 'space-between';
            notificationDiv.style.animation = 'fadeIn 0.5s ease';

            notificationDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="material-icons">${icon}</span>
                    <span>${message}</span>
                </div>
                <button class="close-btn" style="background: none; border: none; cursor: pointer;" onclick="this.parentElement.remove()">
                    <span class="material-icons">close</span>
                </button>
            `;

            // Ampidirina eo an-tampon'ny lisitra
            container.prepend(notificationDiv);
        }

        // ===================================================
        //  FONCTION VAOVAO: Fanamarinana Hendry (Smart Checks)
        // ===================================================
        function runSmartChecks() {
            const container = document.getElementById('notificationsContainer');
            if (!container) return;

            // Diovina aloha ny fampandrenesana taloha
            container.innerHTML = '';

            const today = new Date().toISOString().split('T')[0];
            const dayAttendance = attendance[today] || {};

            // --- Fanamarinana 1: Mpiasa tsy nanisy "D√©part" ---
            let missingDepartureCount = 0;
            for (const empId in dayAttendance) {
                const att = dayAttendance[empId];
                // Raha misy 'arrivee' nefa tsy misy 'depart'
                if (att && att.arrivee && !att.depart) {
                    missingDepartureCount++;
                }
            }

            if (missingDepartureCount > 0) {
                const message = `<strong>Attention:</strong> ${missingDepartureCount} employ√©(s) ont point√© leur arriv√©e mais n'ont pas encore point√© leur d√©part.`;
                displayNotification(message, 'warning', 'watch_later');
            }

            // --- Fanamarinana 2 (Ohatra fanampiny): Mpiasa tsy tonga nefa tsy misy fanazavana ---
            // (Ity dia azo ampidirina any aoriana rehefa misy fitantanana "Cong√©s")
            // const presentIds = new Set(Object.keys(dayAttendance));
            // const absentCount = employees.filter(emp => !presentIds.has(emp.id)).length;
            // if (absentCount > 0) {
            //     const message = `<strong>Info:</strong> ${absentCount} employ√©(s) sont marqu√©s absents aujourd'hui.`;
            //     displayNotification(message, 'info', 'person_off');
            // }
            
            // Azo ampiana fanamarinana hafa eto...
            // Ohatra: Fanamarinana raha efa voakajy ny karama, sns.
        }


        // ===============================
        // EVENT LISTENERS
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            displayPayments();
            // Set current date for advance form
            const today = new Date().toISOString().split('T')[0];
            const advanceDateEl = document.getElementById('advanceDate');
            if (advanceDateEl) {
                advanceDateEl.value = today;
            }
        });

        // üîç Filtrage automatique amin'ny liste employ√©s
        // Fikarohana mpiasa miaraka amin'ny Debounce
        const employeeSearchInput = document.getElementById('employeeSearch');
        if (employeeSearchInput) {
            employeeSearchInput.addEventListener('input', debounce(function () {
                const searchTerm = this.value.toLowerCase();
                const items = document.querySelectorAll('#employeeList .employee-item');
                items.forEach(item => {
                    const name = item.querySelector('h4')?.textContent.toLowerCase() || '';
                    const position = item.querySelector('p')?.textContent.toLowerCase() || '';
                    const match = name.includes(searchTerm) || position.includes(searchTerm);
                    item.style.display = match ? 'flex' : 'none';
                });
            }, 350)); // Miandry 350ms
        }

        window.addEventListener('load', () => {
            if ("launchQueue" in window) {
                launchQueue.setConsumer(async (launchParams) => {
                    if (!launchParams.files || launchParams.files.length === 0) {
                        return;
                    }

                    // Alaina ilay rakitra voalohany voazara
                    const fileHandle = launchParams.files[0];
                    const file = await fileHandle.getFile();
                    
                    // Ampiasaina ilay fonction importData efa anananao
                    // Fa milaamboarina kely izy mba handray "file object"
                    // fa tsy "event" intsony.
                    
                    // Antsoina ilay fonction vaovao (hamboarintsika eto ambany)
                    handleImportedFile(file);
                });
            }
        });

        document.getElementById('employeeSearch')?.addEventListener('input', () => displayEmployees());


        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveData().then(() => {
                    showAlert('Donn√©es sauvegard√©es!', 'success');
                }).catch(err => {
                    showAlert('Erreur de sauvegarde', 'error');
                });
            }
            
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
                
                if (document.getElementById('settingsPanel')?.classList.contains('active')) {
                    toggleSettings();
                }
                
                // Arr√™ter le scan QR si actif
                if (isScanning) {
                    stopQRScan();
                }
            }
        });

        // ===============================
        // DEBUG HELPERS
        // ===============================
        window.hrDebugQR = {
            employees: () => employees,
            attendance: () => attendance,
            qrAttendance: () => qrAttendance,
            payrolls: () => payrolls,
            advances: () => advances,
            qrSettings: () => qrSettings,
            dbManager: () => dbManager,
            exportAll: exportData
        };

        // ===================================================
        //  Fanatsarana UX: Mampifandray ny preview amin'ny formulaire
        // ===================================================
        document.getElementById('advanceEmployee').addEventListener('change', previewNetSalary);
        document.getElementById('advanceAmount').addEventListener('input', previewNetSalary);

        console.log('üí° Syst√®me RH avec QR Code pr√™t!');
        console.log('üîß Utilisez window.hrDebugQR pour les outils de d√©bogage');

        

        // ===================================================
        //  Fanatsarana UX: Fikajiana ny karama sisa rehefa manao avance
        // ===================================================
        async function previewNetSalary() {
            const employeeId = document.getElementById('advanceEmployee').value;
            const advanceAmount = getCurrencyValue('advanceAmount');
            const previewContainer = document.getElementById('netSalaryPreview');

            if (!employeeId) {
                previewContainer.style.display = 'none';
                return;
            }

            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            const currentMonth = new Date().toISOString().slice(0, 7);
            const [year, month] = currentMonth.split('-');

            // Kajiana ny karama tokony ho raisina (pro-rata)
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
            const presenceDays = countPresenceDays(employeeId, currentMonth);
            const grossSalary = (employee.salary / daysInMonth) * presenceDays;

            // Alaina ny totalin'ny trosa efa misy ho an'io volana io
            const existingAdvances = advances
                .filter(adv => adv.employeeId === employeeId && adv.date.startsWith(currentMonth))
                .reduce((sum, adv) => sum + adv.amount, 0);

            // Kajiana ny karama sisa
            const totalFutureAdvances = existingAdvances + advanceAmount;
            const netSalaryAfterAdvance = grossSalary - totalFutureAdvances;

            // Fampisehoana ny vokany
            previewContainer.style.display = 'block';
            previewContainer.innerHTML = `
                <span style="font-weight: 500;">Karama Net Tombanana:</span>  

                Salaire Brut (hatramin'izao): ${formatCurrency(grossSalary)}  

                Total Avances (miaraka amin'ity): <span style="color: var(--md-sys-color-error);">${formatCurrency(totalFutureAdvances)}</span>  

                <hr style="margin: 4px 0; border-color: var(--md-sys-color-outline-variant);">
                <strong style="color: var(--md-sys-color-primary);">Karama Sisa ho Raisina: ${formatCurrency(netSalaryAfterAdvance)}</strong>
            `;
        }


        // ===================================================
        //  Fanatsarana Tatitra: G√©n√©ration PDF ho an'ny Paie
        // ===================================================
        function generatePayrollPDFReport() {
            const reportMonth = document.getElementById('reportMonth').value;
            if (!reportMonth) {
                showAlert("Veuillez s√©lectionner un mois pour g√©n√©rer le rapport.", 'error');
                return;
            }

            const [year, month] = reportMonth.split('-');
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Loha-taratasy
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("Rapport de Paie Mensuel", 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Mois: ${reportMonth}`, 105, 28, { align: 'center' });

            const tableData = [];
            let totalGrossSalary = 0;
            let totalAdvances = 0;
            let totalNetSalary = 0;

            // Fanaovana kajy isaky ny mpiasa
            employees.forEach(emp => {
                const presenceDays = countPresenceDays(emp.id, reportMonth);
                const grossSalary = (emp.salary / daysInMonth) * presenceDays;
                const employeeAdvances = advances
                    .filter(adv => adv.employeeId === emp.id && adv.date.startsWith(reportMonth))
                    .reduce((sum, adv) => sum + adv.amount, 0);
                const netSalary = grossSalary - employeeAdvances;

                tableData.push([
                    emp.name,
                    presenceDays,
                    formatCurrency(grossSalary),
                    formatCurrency(employeeAdvances),
                    formatCurrency(netSalary)
                ]);

                totalGrossSalary += grossSalary;
                totalAdvances += employeeAdvances;
                totalNetSalary += netSalary;
            });

            // Famoronana ny tabilao
            doc.autoTable({
                startY: 40,
                head: [['Employ√©', 'Jours Travaill√©s', 'Salaire Brut', 'Avances', 'Salaire Net']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [103, 80, 164] }, // Loko volomparasy
                styles: { fontSize: 8 },
            });

            // Famintinana ny totaliny
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("R√©sum√© Global:", 14, finalY);
            
            doc.setFont("helvetica", "normal");
            doc.text(`Total Salaires Bruts: ${formatCurrency(totalGrossSalary)}`, 14, finalY + 7);
            doc.text(`Total Avances: ${formatCurrency(totalAdvances)}`, 14, finalY + 14);
            
            doc.setFont("helvetica", "bold");
            doc.text(`Total Salaires Nets Pay√©s: ${formatCurrency(totalNetSalary)}`, 14, finalY + 21);

            // Pejy farany
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Page ${i} sur ${pageCount}`, 195, 285, { align: 'right' });
                doc.text(`G√©n√©r√© le ${new Date().toLocaleString('fr-FR')}`, 14, 285);
            }

            // Famoahana ny rakitra
            doc.save(`rapport-paie-${reportMonth}.pdf`);
            showAlert("Le rapport de paie en PDF a √©t√© g√©n√©r√© avec succ√®s!", 'success');
        }


        // --- GESTION DES GROUPES ---

        function displayGroups() {
            populateGroupSelects();
            const container = document.getElementById('groupList');
            if (!container) return;

            if (groups.length === 0) {
                container.innerHTML = "<p style='text-align: center; padding: 20px;'>Aucun groupe cr√©√© pour le moment.</p>";
                return;
            }

            container.innerHTML = groups.map(group => {
                const members = employees.filter(emp => emp.groupId === group.id);
                const maleCount = members.filter(m => m.gender === 'Homme').length;
                const femaleCount = members.filter(m => m.gender === 'Femme').length;

                return `
                    <div class="employee-item">
                        <div class="employee-info">
                            <h4>${group.name}</h4>
                            <p>${group.description || 'Aucune description'}</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 8px; font-size: 14px;">
                                <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">people</span> Total: <strong>${members.length}</strong></span>
                                <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">male</span> Hommes: <strong>${maleCount}</strong></span>
                                <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">female</span> Femmes: <strong>${femaleCount}</strong></span>
                            </div>
                        </div>
                        <div class="employee-actions">
                            <button class="btn-icon" onclick="editGroup('${group.id}')" title="Modifier">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" onclick="deleteGroup('${group.id}')" title="Supprimer">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('groupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupId = document.getElementById('groupId').value;
            const groupName = document.getElementById('groupName').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();

            if (!groupName) return;

            if (groupId) {
                const groupIndex = groups.findIndex(g => g.id === groupId);
                if (groupIndex > -1) {
                    groups[groupIndex].name = groupName;
                    groups[groupIndex].description = groupDescription;
                    showAlert('Groupe mis √† jour avec succ√®s!', 'success');
                }
            } else {
                if (groups.some(g => g.name.toLowerCase() === groupName.toLowerCase())) {
                    showAlert('Un groupe avec ce nom existe d√©j√†.', 'error');
                    return;
                }
                const newGroup = {
                    id: Date.now().toString(),
                    name: groupName,
                    description: groupDescription
                };
                groups.push(newGroup);
                showAlert('Groupe ajout√© avec succ√®s!', 'success');
            }

            await saveData();
            displayGroups();
            cancelGroupEdit();
        });

        function editGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;

            document.getElementById('groupId').value = group.id;
            document.getElementById('groupName').value = group.name;
            document.getElementById('groupDescription').value = group.description || '';
            document.getElementById('groupFormBtnText').textContent = "Mettre √† jour le Groupe";
            document.getElementById('cancelEditGroupBtn').style.display = 'inline-flex';
            window.scrollTo(0, document.getElementById('groupForm').offsetTop);
        }

        function cancelGroupEdit() {
            document.getElementById('groupId').value = '';
            document.getElementById('groupForm').reset();
            document.getElementById('groupFormBtnText').textContent = "Ajouter le Groupe";
            document.getElementById('cancelEditGroupBtn').style.display = 'none';
            populateGroupSelects();

        }

        async function deleteGroup(id) {
            const membersCount = employees.filter(emp => emp.groupId === id).length;
            if (membersCount > 0) {
                showAlert(`Impossible de supprimer ce groupe. Il contient encore ${membersCount} employ√©(s).`, 'error');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce groupe? Cette action est irr√©versible.')) {
                groups = groups.filter(g => g.id !== id);
                await saveData();
                displayGroups();
                showAlert('Groupe supprim√© avec succ√®s!', 'success');
            }
        }

        function populateGroupSelects() {
            const selects = ['employeeGroup', 'editEmployeeGroup', 'employeeGroupFilter', 'payrollGroupFilter', 'advanceGroupFilter'];
            const optionsHTML = groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');

            selects.forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    // Tehirizina ny option voalohany (ohatra: "Aucun groupe")
                    const firstOption = selectElement.options[0].outerHTML;
                    selectElement.innerHTML = firstOption + optionsHTML;
                }
            });
        }

        /**
         * Mameno ny lisitra fisafidianana mpiasa ao amin'ny fizarana PAIE ihany.
         * Izy no lasa foiben'ny fanavaozana an'io select io.
         * @param {string | null} groupId - Ny ID an'ny vondrona hasivana. Raha 'all' na null, dia ny mpiasa rehetra no alaina.
         */
        function populatePayrollEmployeeSelect(groupId = 'all') {
            const employeeSelect = document.getElementById('payrollEmployeeSelect');
            if (!employeeSelect) return;

            let employeesToList = employees;

            if (groupId && groupId !== 'all') {
                employeesToList = employees.filter(emp => emp.groupId === groupId);
            }

            const employeeOptionsHTML = employeesToList.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
            
            // Foanana aloha ny lisitra taloha, afa-tsy ilay option voalohany
            employeeSelect.innerHTML = '<option value="">Tous les employ√©s</option>' + employeeOptionsHTML;
        }


        /**
         * Antsoina rehefa misafidy VONDROM-PIASA ao amin'ny fizarana PAIE.
         */
        function handlePayrollGroupChange() {
            const groupFilter = document.getElementById('payrollGroupFilter');
            const selectedGroupId = groupFilter.value;

            // 1. Havaozina ny lisitry ny mpiasa mba hifanaraka amin'ny vondrona voafidy
            populatePayrollEmployeeSelect(selectedGroupId);
            
            // 2. Diovina ny vokatry ny kajy teo aloha
            document.getElementById('payrollResults').innerHTML = '';
        }


        /**
         * Antsoina rehefa misafidy MPIASA ao amin'ny fizarana PAIE.
         */
        function handlePayrollEmployeeChange() {
            const groupFilterSelect = document.getElementById('payrollGroupFilter');
            const employeeSelect = document.getElementById('payrollEmployeeSelect');
            const selectedEmployeeId = employeeSelect.value;

            if (!selectedEmployeeId) {
                // Raha "Tous les employ√©s" no voafidy, dia averina amin'ny "Tous les Groupes" ny sivana
                groupFilterSelect.value = 'all';
                return;
            }

            const selectedEmployee = employees.find(emp => emp.id === selectedEmployeeId);
            if (!selectedEmployee) return;

            // Ovaina ho azy ny select-n'ny vondrona mba hifanaraka amin'ny vondron'ilay mpiasa
            groupFilterSelect.value = selectedEmployee.groupId || 'all';
            
            // Diovina ny vokatry ny kajy teo aloha
            document.getElementById('payrollResults').innerHTML = '';
        }

        /**
         * Mamorona sy mampiseho ny bokotra fitetezana pejy (pagination).
         * VERSION NOHATSARAINA: Mampiseho ny isan'ny singa.
         * @param {string} containerId - Ny ID an'ilay div handraisana ny bokotra.
         * @param {number} currentPage - Ny pejy misy ankehitriny.
         * @param {number} totalPages - Ny isan'ny pejy rehetra.
         * @param {number} totalItems - Ny isan'ny singa REHETRA (tsy voazarazara).
         * @param {number} itemsPerPage - Ny isan'ny singa isaky ny pejy.
         * @param {function} onPageChange - Ny fonction antsoina rehefa miova ny pejy.
         */
        function renderPaginationControls(containerId, currentPage, totalPages, totalItems, itemsPerPage, onPageChange) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            // Kajiana ny laharan'ny singa aseho
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            container.innerHTML = `
                <button id="${containerId}-prev" ${currentPage === 1 ? 'disabled' : ''}>
                    <span class="material-icons">chevron_left</span>
                    Teo aloha
                </button>
                <span class="pagination-info">
                    Mampiseho ${startItem}-${endItem} amin'ny ${totalItems}
                </span>
                <button id="${containerId}-next" ${currentPage === totalPages ? 'disabled' : ''}>
                    Manaraka
                    <span class="material-icons">chevron_right</span>
                </button>
            `;

            document.getElementById(`${containerId}-prev`).addEventListener('click', () => {
                if (currentPage > 1) {
                    onPageChange(currentPage - 1);
                }
            });

            document.getElementById(`${containerId}-next`).addEventListener('click', () => {
                if (currentPage < totalPages) {
                    onPageChange(currentPage + 1);
                }
            });
        }


        /**
         * Manova ny isan'ny singa aseho isaky ny pejy ary mamerina amin'ny pejy voalohany.
         * VERSION NOHATSARAINA: Mahazaka ny lisitra rehetra.
         */
        function changeItemsPerPage(listType, value) {
            const newValue = parseInt(value, 10);
            
            if (listType === 'employee') {
                employeeItemsPerPage = newValue;
                employeeCurrentPage = 1;
                displayEmployees();
            } else if (listType === 'attendance') {
                attendanceItemsPerPage = newValue;
                attendanceCurrentPage = 1;
                displayAttendance();
            } else if (listType === 'advances') {
                advancesItemsPerPage = newValue;
                advancesCurrentPage = 1;
                displayAdvances();
            }
        }

        /**
         * Manao export ny lisitry ny trosa voasivana ho PDF na Excel (.xlsx).
         * VERSION FARANY: Mampiasa SheetJS ho an'ny export Excel tena izy.
         */
        function exportAdvances(format) {
            // 1. Alaina indray ny sivana rehetra (tsy miova)
            const searchTerm = document.getElementById('advanceSearchInput').value.toLowerCase();
            const monthFilter = document.getElementById('advanceMonthFilter').value;
            const groupFilter = document.getElementById('advanceGroupFilter').value;

            let dataToExport = advances.filter(advance => {
                const employee = employees.find(emp => emp.id === advance.employeeId);
                if (!employee) return false;
                const matchesSearch = employee.name.toLowerCase().includes(searchTerm) ||
                                    employee.position.toLowerCase().includes(searchTerm) ||
                                    (advance.reason || '').toLowerCase().includes(searchTerm);
                const matchesMonth = !monthFilter || advance.date.startsWith(monthFilter);
                const matchesGroup = groupFilter === 'all' || employee.groupId === groupFilter;
                return matchesSearch && matchesMonth && matchesGroup;
            });

            if (dataToExport.length === 0) {
                showAlert("Aucune donn√©e √† exporter pour les filtres actuels.", 'warning');
                return;
            }

            dataToExport.sort((a, b) => new Date(a.date) - new Date(b.date));
            const filename = `export-avances-${new Date().toISOString().split('T')[0]}`;

            if (format === 'pdf') {
                // Ny export PDF dia tsy miova
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18);
                doc.text("Rapport des Avances", 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`Export√© le: ${new Date().toLocaleDateString('fr-FR')}`, 105, 26, { align: 'center' });
                const tableColumn = ["Date", "Employ√©", "Groupe", "Montant (Ar)", "Motif"];
                const tableRows = [];
                let totalAdvances = 0;
                dataToExport.forEach(adv => {
                    const employee = employees.find(e => e.id === adv.employeeId);
                    const group = groups.find(g => g.id === employee?.groupId);
                    const formattedAmount = adv.amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                    const rowData = [
                        formatDate(adv.date, false),
                        employee ? employee.name : 'N/A',
                        group ? group.name : 'Sans groupe',
                        formattedAmount,
                        adv.reason || ''
                    ];
                    tableRows.push(rowData);
                    totalAdvances += adv.amount;
                });
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 35,
                    theme: 'grid',
                    headStyles: { fillColor: [103, 80, 164] },
                    columnStyles: { 3: { halign: 'right' } }
                });
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                const formattedTotal = totalAdvances.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                doc.text(`Total des Avances: ${formattedTotal} Ar`, 14, finalY);
                doc.save(`${filename}.pdf`);
                showAlert('Export PDF des avances r√©ussi!', 'success');

            } else if (format === 'xlsx') {
                // ===================================================
                // DINGANA VAOVAO: FAMORONANA RAKITRA EXCEL (.xlsx)
                // ===================================================
                
                // 1. Fanomanana ny angona ho an'ny SheetJS
                const headers = ["Date", "Nom de l'Employ√©", "Groupe", "Montant (Ar)", "Motif"];
                const sheetData = [headers]; // Ampidirina voalohany ny lohateny

                let totalAdvances = 0;
                dataToExport.forEach(adv => {
                    const employee = employees.find(e => e.id === adv.employeeId);
                    const group = groups.find(g => g.id === employee?.groupId);
                    sheetData.push([
                        adv.date,
                        employee ? employee.name : 'N/A',
                        group ? group.name : 'Sans groupe',
                        adv.amount, // Ampidirina ho isa tsotra ny vola
                        adv.reason || ''
                    ]);
                    totalAdvances += adv.amount;
                });

                // Ampiana andalana farany ho an'ny totaly
                sheetData.push([]); // Andalana banga
                sheetData.push(["", "", "Total des Avances:", totalAdvances, ""]);

                // 2. Famoronana ny "worksheet" (takelaka)
                const worksheet = XLSX.utils.aoa_to_sheet(sheetData);

                // 3. Fanamboarana ny endriky ny sela (Styles)
                // Fomba fanoratra ny isa (ohatra: 10 000)
                const numberFormat = "#,##0"; 
                // Fomba fanoratra ny totaly (misy "Ar" eo aoriany)
                const totalFormat = `#,##0 "Ar"`;

                // Ampiharina amin'ny tsanganana "Montant" (tsanganana D, index 3)
                for (let i = 1; i < dataToExport.length + 1; i++) { // Manomboka amin'ny 1 fa tsy 0
                    const cellRef = XLSX.utils.encode_cell({r: i, c: 3});
                    if(worksheet[cellRef]) {
                        worksheet[cellRef].z = numberFormat;
                    }
                }
                
                // Ampiharina amin'ny selan'ny totaly
                const totalCellRef = XLSX.utils.encode_cell({r: dataToExport.length + 2, c: 3});
                if(worksheet[totalCellRef]) {
                    worksheet[totalCellRef].z = totalFormat;
                    worksheet[totalCellRef].s = { font: { bold: true } }; // Atao matavy
                }
                const totalLabelCellRef = XLSX.utils.encode_cell({r: dataToExport.length + 2, c: 2});
                if(worksheet[totalLabelCellRef]) {
                    worksheet[totalLabelCellRef].s = { font: { bold: true } }; // Atao matavy koa ny soratra
                }

                // 4. Fanamboarana ny sakan'ny tsanganana
                worksheet['!cols'] = [
                    { wch: 12 }, // Date
                    { wch: 30 }, // Nom de l'Employ√©
                    { wch: 20 }, // Groupe
                    { wch: 18 }, // Montant
                    { wch: 40 }  // Motif
                ];

                // 5. Famoronana ny "workbook" (rakitra Excel)
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Avances");

                // 6. Famoahana ny rakitra
                XLSX.writeFile(workbook, `${filename}.xlsx`);
                
                showAlert('Export Excel des avances r√©ussi!', 'success');
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
            // --- IZAO NO VAOVAO ---
            // Manampy "version" isika mba hanerena ny navigateur haka ny vaovao
            const version = 'v1.1.0'; // Ovay ity isaky ny misy fanovana lehibe
            navigator.serviceWorker.register(`/systeme-rh-behavana/service-worker.js?v=${version}`)
            // --- FARAN'NY FANAMPINY ---

                .then(registration => {
                console.log('ServiceWorker voasoratra anarana: ', registration);
                })
                .catch(error => {
                console.log('Fisoratana anarana ServiceWorker nisy olana: ', error);
                });
            });
        }

        async function handleImportedFile(file) {
            if (!file) {
                showAlert("Tsy nisy rakitra voafantina.", "warning");
                return;
            }

            try {
                const fileContent = await file.text();
                const data = JSON.parse(fileContent);

                if (!data.employees || !data.attendance || !data.dbType) {
                    showAlert("Erreur: Le fichier de sauvegarde semble invalide ou corrompu.", 'error');
                    return;
                }

                const confirmationMessage = `
                    Vous √™tes sur le point de restaurer une sauvegarde par partage.
                    ATTENTION: Toutes les donn√©es actuelles seront √©cras√©es.
                    
                    Date de la sauvegarde: ${formatDate(data.exportDate || new Date())}
                    Version: ${data.version || 'Inconnue'}
                    
                    √ätes-vous s√ªr de vouloir continuer ?
                `;

                if (confirm(confirmationMessage)) {
                    employees = data.employees || [];
                    attendance = data.attendance || {};
                    payrolls = data.payrolls || [];
                    advances = data.advances || [];
                    qrAttendance = data.qrAttendance || [];
                    qrSettings = data.qrSettings || { size: 256, color: '#6750A4' };
                    groups = data.groups || [];

                    await saveData();
                    
                    showAlert('Donn√©es import√©es avec succ√®s! La page va se rafra√Æchir.', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert("Importation annul√©e par l'utilisateur.", "info");
                }    
                
            } catch (error) {
                showAlert('Erreur lors de l\'importation: Fichier invalide ou corrompu.', 'error');
                console.error("Erreur d'importation:", error);
            }
        }
        // =======================================================================
        //  FONCTION VAOVAO ILAINA - Maka ny volana farany nandoavana karama
        // =======================================================================
        /**
         * Mitady ny volana farany nandoavana karama ho an'ny mpiasa iray.
         * @param {string} employeeId - Ny ID an'ilay mpiasa.
         * @returns {string|null} - Mamerina ny volana (oh: "2025-07") na null raha mbola tsy naloa.
         */
        function getLastPaidMonth(employeeId) {
            // Sivana alaina daholo ny karama efa voaloan'ilay mpiasa
            const employeePayments = payrolls.filter(p => p.employeeId === employeeId && p.month !== 'SOLDE_DE_TOUT_COMPTE');

            // Raha tsy mbola nisy karama voaloa mihitsy
            if (employeePayments.length === 0) {
                return null;
            }

            // Alahatra avy amin'ny volana vao haingana indrindra mankany amin'ny ela indrindra
            employeePayments.sort((a, b) => b.month.localeCompare(a.month));

            // Averina ilay volana voalohany ao anaty lisitra (izay vao haingana indrindra)
            return employeePayments[0].month;
        }

        /**
         * Mamantatra ny daty tokony hanombohana ny kajy ny STC.
         * @param {string|null} lastPayMonth - Ny volana farany naloa (oh: "2025-07").
         * @param {Date} departureDate - Ny daty hialan'ilay mpiasa.
         * @returns {Date} - Ny daty hanombohana ny kajy.
         */
        function getStartDateForCalculation(lastPayMonth, departureDate) {
            // Raha mbola tsy naloa karama mihitsy ilay mpiasa
            if (!lastPayMonth) {
                // Kajiana manomboka amin'ny fiandohan'ny volana hialany
                const startOfMonth = new Date(departureDate.getFullYear(), departureDate.getMonth(), 1);
                return startOfMonth;
            }

            // Raha efa naloa karama izy
            const [year, month] = lastPayMonth.split('-').map(Number);
            // Ny daty hanombohana dia ny andro voalohan'ny volana MANARAKA an'ilay volana farany naloa
            const startDate = new Date(year, month, 1); // Ny 'month' eto dia efa lasa volana manaraka satria ny index dia 0-11
            return startDate;
        }

        // Fonction vaovao tanteraka
        async function calculateSTC() {
            const employeeId = document.getElementById('stcEmployeeSelect').value;
            const container = document.getElementById('stcResultsContainer');

            if (!employeeId) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = '<div class="loading"></div><p>Calcul en cours...</p>';

            const employee = employees.find(e => e.id === employeeId);
            if (!employee || !employee.departureDate) {
                container.innerHTML = '<p class="alert alert-error">Erreur: Date de d√©part non d√©finie pour cet employ√©.</p>';
                return;
            }

            const departureDate = new Date(employee.departureDate);
            const lastPayMonth = getLastPaidMonth(employeeId); // Mila amboarina ity fonction ity
            const startDateForCalc = getStartDateForCalculation(lastPayMonth, departureDate);

            let totalDaysToPay = 0;
            let totalAdvancesToDeduct = 0;
            let detailsHTML = '';

            // Kajiana isan'andro manomboka amin'ny andro farany nandoavana karama
            for (let d = new Date(startDateForCalc); d <= departureDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const monthStr = dateStr.slice(0, 7);
                
                // Kajiana ny andro niasana
                const presence = countPresenceDays(employeeId, monthStr, dateStr); // Ovaina kely ny countPresenceDays
                totalDaysToPay += presence;

                // Kajiana ny trosa
                const advanceOnDay = advances.filter(adv => adv.employeeId === employeeId && adv.date === dateStr)
                                            .reduce((sum, adv) => sum + adv.amount, 0);
                totalAdvancesToDeduct += advanceOnDay;

                if (presence > 0 || advanceOnDay > 0) {
                    detailsHTML += `<li>${dateStr}: Pr√©sence: ${presence} jour(s) | Avance: ${formatCurrency(advanceOnDay)}</li>`;
                }
            }

            // Kajy farany
            const dailySalary = employee.salary / 30; // Heverina ho 30 andro ny volana
            const grossSalaryToPay = dailySalary * totalDaysToPay;
            const netSalaryToPay = grossSalaryToPay - totalAdvancesToDeduct;

            // Fampisehoana ny vokany
            container.innerHTML = `
                <h3>D√©tail du Solde pour ${employee.name}</h3>
                <p>P√©riode de calcul: du <strong>${startDateForCalc.toLocaleDateString()}</strong> au <strong>${departureDate.toLocaleDateString()}</strong></p>
                
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="stat-card">
                        <div class="stat-content"><h3>${totalDaysToPay.toFixed(2)}</h3><p>Jours √† Payer</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content"><h3>${formatCurrency(grossSalaryToPay)}</h3><p>Salaire Brut</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content"><h3>${formatCurrency(totalAdvancesToDeduct)}</h3><p>Avances √† D√©duire</p></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px; background-color: var(--md-sys-color-primary-container);">
                    <h2 style="color: var(--md-sys-color-on-primary-container);">Montant Final √† Payer: ${formatCurrency(netSalaryToPay)}</h2>
                </div>

                <h4>D√©tails journaliers:</h4>
                <ul style="max-height: 150px; overflow-y: auto; padding: 10px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">${detailsHTML}</ul>

                <button class="btn btn-success" style="margin-top: 24px;" onclick="finalizeSTC('${employee.id}', ${netSalaryToPay})">
                    <span class="material-icons">check_circle</span>
                    Valider et Payer le Solde
                </button>
            `;
        }

        // Fonction fanampiny ilaina
        function populateSTCEmployeeSelect() {
            const select = document.getElementById('stcEmployeeSelect');
            const employeesToLeave = employees.filter(e => e.status === 'depart');
            select.innerHTML = '<option value="">-- Choisir un employ√© --</option>' + 
                            employeesToLeave.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }

        async function finalizeSTC(employeeId, amount) {
            if (confirm(`Vous √™tes sur le point de payer un solde de ${formatCurrency(amount)} √† cet employ√©. Cette action est d√©finitive. Continuer ?`)) {
                // 1. Tehirizina ho toy ny karama manokana
                const stcRecord = {
                    id: `stc-${employeeId}-${Date.now()}`,
                    employeeId: employeeId,
                    month: 'SOLDE_DE_TOUT_COMPTE',
                    amount: amount,
                    date: new Date().toISOString()
                };
                payrolls.push(stcRecord);

                // 2. Ovaina ho "Inactif" ny satan'ilay mpiasa
                const employeeIndex = employees.findIndex(e => e.id === employeeId);
                if (employeeIndex > -1) {
                    employees[employeeIndex].status = 'inactif';
                }

                // 3. Tehirizina ny fanovana rehetra
                await saveData();

                // 4. Havaozina ny interface
                showAlert('Solde de tout compte pay√© et finalis√© avec succ√®s!', 'success');
                populateSTCEmployeeSelect(); // Esorina ao anaty lisitra ilay mpiasa
                document.getElementById('stcResultsContainer').style.display = 'none';
            }
        }
        // =======================================================================
        //  VERSION VOAHITSY - Mampiseho ny kalandrie rehefa miova ny sata
        // =======================================================================
        // Mampifandray ny hetsika amin'ilay SELECT marina ao anatin'ny MODAL FANovana
        document.getElementById('editEmployeeStatus').addEventListener('change', function() {
            // Alaina ilay DIV misy ilay kalandrie
            const departureDateContainer = document.getElementById('editDepartureDateContainer');
            
            // Hamarino aloha raha hita ilay DIV
            if (departureDateContainer) {
                // Raha "D√©part Programm√©" na "Inactif" no voafidy, dia ASEHOY ilay kalandrie
                if (this.value === 'depart' || this.value === 'inactif') {
                    departureDateContainer.style.display = 'block';
                } 
                // Raha "Actif" no voafidy, dia AFENO ilay kalandrie
                else {
                    departureDateContainer.style.display = 'none';
                }
            }
        });

    </script>
</body>
</html>
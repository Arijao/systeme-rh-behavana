<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Gestion RH - QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- TRANOMBOKY VAOVAO SY TOKANA HO AN'NY QR CODE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <link href="roboto.css" rel="stylesheet">
    <link href="icons.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-success: #4CAF50;
            --md-sys-color-warning: #FF9800;
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Roboto, sans-serif;
            /* Background gris sidéral avec gradient */
            background: linear-gradient(
                135deg,
                #0f172a 0%,
                #1e293b 25%,
                #334155 50%,
                #1e293b 75%,
                #0f172a 100%
            );
            background-attachment: fixed;
            color: #e2e8f0;
            line-height: 1.6;
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        /* Pattern subtil en arrière-plan */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(129, 140, 248, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(99, 102, 241, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            background: linear-gradient(
                135deg,
                rgba(71, 85, 105, 0.6) 0%,
                rgba(51, 65, 85, 0.7) 100%
            );
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #f1f5f9;
            padding: 24px;
            border-radius: 24px;
            margin-bottom: 24px;
            box-shadow: 
                0 8px 32px rgba(15, 23, 42, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle,
                rgba(129, 140, 248, 0.15) 0%,
                transparent 70%
            );
            animation: float 6s ease-in-out infinite;
        }


        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .theme-toggle, .settings-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--md-sys-color-on-primary);
            transition: all 0.3s ease;
            z-index: 2;
        }

        .settings-btn {
            right: 80px;
        }

        .theme-toggle:hover, .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* === NAV TABS GLASSMORPHISM STYLE === */

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 24px;
            gap: 8px;
            overflow-x: auto;
            box-shadow: 
                0 8px 32px rgba(103, 80, 164, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .nav-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: rgba(103, 80, 164, 0.2);
            border-radius: 3px;
        }

        .nav-tab {
            background: transparent;
            border: 1px solid transparent;
            padding: 12px 20px;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(28, 27, 31, 0.7);
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            white-space: nowrap;
            position: relative;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-color: rgba(103, 80, 164, 0.2);
            color: #6750A4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(103, 80, 164, 0.15);
        }

        .nav-tab.active {
            background: linear-gradient(
                135deg,
                rgba(103, 80, 164, 0.85) 0%,
                rgba(139, 109, 196, 0.85) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #FFFFFF;
            transform: translateY(-3px);
            box-shadow: 
                0 8px 24px rgba(103, 80, 164, 0.35),
                0 4px 8px rgba(103, 80, 164, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .nav-tab.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.25) 0%,
                transparent 100%
            );
            border-radius: 14px 14px 0 0;
            pointer-events: none;
        }

        .nav-tab:active {
            transform: translateY(-1px);
        }

        .nav-tab .material-icons {
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .nav-tab.active .material-icons {
            transform: scale(1.1);
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.2));
        }

        [data-theme="dark"] .nav-tabs {
            background: rgba(28, 27, 31, 0.4);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .nav-tab {
            color: rgba(230, 225, 229, 0.8);
        }

        [data-theme="dark"] .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(208, 188, 255, 0.3);
            color: #D0BCFF;
        }

        [data-theme="dark"] .nav-tab.active {
            background: linear-gradient(
                135deg,
                rgba(208, 188, 255, 0.3) 0%,
                rgba(139, 109, 196, 0.35) 100%
            );
            border-color: rgba(208, 188, 255, 0.4);
            color: #D0BCFF;
            box-shadow: 
                0 8px 24px rgba(208, 188, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* === RESPONSIVE BREAKPOINTS === */

        /* Écran moyen (tablettes) */
        @media (max-width: 768px) {
            .nav-menu-item {
                padding: 12px 14px;
                gap: 10px;
            }
            
            .nav-menu-item .material-icons {
                font-size: 22px;
            }
            
            .nav-menu-label {
                font-size: 14px;
            }
        }

        /* Petit écran (téléphones en mode paysage) */
        @media (max-width: 640px) {
            .nav-menu-item {
                padding: 10px 12px;
                gap: 8px;
            }
            
            .nav-menu-item .material-icons {
                font-size: 20px;
            }
            
            .nav-menu-label {
                font-size: 13px;
            }
        }

        /* Très petit écran - Masquer les labels, montrer seulement les icônes */
        @media (max-width: 480px) {
            .nav-menu-item {
                padding: 12px;
                justify-content: center;
                gap: 0;
            }
            
            .nav-menu-label {
                display: none !important; /* Afenina ny labels */
            }
            
            .nav-menu-item .material-icons {
                font-size: 24px;
            }
            
            /* Tooltip pour montrer le nom au survol */
            .nav-menu-item {
                position: relative;
            }
            
            .nav-menu-item:hover::after {
                content: attr(data-label);
                position: absolute;
                left: 100%;
                margin-left: 10px;
                background: rgba(30, 41, 59, 0.95);
                color: #e2e8f0;
                padding: 6px 12px;
                border-radius: 6px;
                white-space: nowrap;
                font-size: 12px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
        }
        /*======================================*/
        @media (max-width: 768px) {
            .nav-tabs {
                padding: 6px;
                gap: 6px;
                backdrop-filter: blur(15px);
            }
            
            .nav-tab {
                padding: 10px 14px;
                font-size: 13px;
            }
        }


        /* Indicator tsara ho an'ny active tab */
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            height: 3px;
            background: rgba(255,255,255,0.8);
            border-radius: 2px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(51, 65, 85, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: default;
            position: relative;
            overflow: visible !important;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.15);
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(129, 140, 248, 0.05),
                transparent
            );
            transition: left 0.5s ease;
        }

        .stat-card:hover {
            box-shadow: 0 4PX 12px rgba(15, 23, 42, 0.25);
            border-color: rgba(129, 140, 248, 0.25);
        }

        .stat-icon {
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(129, 140, 248, 0.4);
        }

        .stat-content h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #818cf8;
            margin-bottom: 4px;
            text-shadow: 0 2px 8px rgba(129, 140, 248, 0.3);
        }

        .stat-content p {
            color: rgba(203, 213, 225, 0.9);
            font-weight: 500;
        }


        .card {
            background: rgba(51, 65, 85, 0.4);
            backdrop-filter: blur(20px) saturate(140%);
            -webkit-backdrop-filter: blur(20px) saturate(140%);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 
                0 4px 16px rgba(15, 23, 42, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 
                0 8px 24px rgba(15, 23, 42, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            border-color: rgba(129, 140, 248, 0.3);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .card h2 .material-icons {
            color: #818cf8;
        }


        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            background: rgba(51, 65, 85, 0.4);
            backdrop-filter: blur(10px);
            color: #f1f5f9;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #818cf8;
            background: rgba(51, 65, 85, 0.6);
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
            color: white;
        }

        .form-control::placeholder {
            color: rgba(203, 213, 225, 0.5);
        }


        .btn {
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(129, 140, 248, 0.3);
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(129, 140, 248, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(129, 140, 248, 0.5);
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
        }

        .btn:active {
            transform: translateY(0);
        }


        .btn-secondary {
            background: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .btn-danger {
            background: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .btn-success {
            background: var(--md-sys-color-success);
        }

        .btn-warning {
            background: var(--md-sys-color-warning);
        }


        .employee-list {
            display: grid;
            gap: 12px;
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-on-surface-variant);
            font-size: 20px;
            z-index: 1;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 48px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 24px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.12);
        }

        .employee-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-top: 8px;
        }

        .employee-status.present {
            color: var(--md-sys-color-success);
        }

        .employee-status.absent {
            color: var(--md-sys-color-error);
        }

        .employee-status.qr-present {
            color: var(--md-sys-color-primary);
        }


        .employee-item {
            background: var(--md-sys-color-surface);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .employee-item:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .employee-info h4 {
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }

        .employee-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .employee-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            transform: scale(1.1);
        }

        .btn-icon:active {
            transform: scale(0.95); /* Ataovy kely kokoa rehefa tsindriana */
            background: var(--md-sys-color-outline-variant); /* Loko hafa kely */
        }


        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--md-sys-color-surface);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .attendance-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--md-sys-color-error);
        }

        .status-indicator.present {
            background: var(--md-sys-color-success);
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--md-sys-color-primary);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
        }

        .modal-content {
            background: linear-gradient(
                165deg,
                rgba(51, 65, 85, 0.85) 0%,
                rgba(30, 41, 59, 0.9) 100%
            );
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
            position: relative;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.6);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 600px) {
            .modal-content {
                padding: 16px;
                width: 95%;
                max-height: 95vh;
            }
            
            .modal-header h3 {
                font-size: 1.2rem;
            }
        }

        @media (max-height: 500px) {
            .modal.active {
                align-items: center;
                padding: 5px;
            }
            .modal-content {
                max-height: 98vh;
                padding: 12px;
                width: 98%;
                max-width: 600px;
            }
            .qr-modal-body {
                padding: 4px 0 !important;
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                align-items: center;
                justify-content: center;
                gap: 12px;
                text-align: left !important;
            }
            .qr-video-container {
                max-width: 160px !important;
                margin: 0 !important;
                flex-shrink: 0;
            }
            #qrScannerInstruction {
                margin-bottom: 0 !important;
                flex: 1;
                font-size: 0.85rem !important;
            }
            .modal-header {
                margin-bottom: 4px;
                padding-bottom: 4px;
            }
            .modal-header h3 {
                font-size: 1rem !important;
            }
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .modal-header h3 {
            color: var(--md-sys-color-primary);
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            padding: 4px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--md-sys-color-success);
            border: 1px solid var(--md-sys-color-success);
        }

        .alert-error {
            background: rgba(179, 38, 30, 0.1);
            color: var(--md-sys-color-error);
            border: 1px solid var(--md-sys-color-error);
        }

        /* ================== AMPIO IRETO ANDALANA VAOVAO IRETO ================== */
        .alert-warning {
            background: rgba(255, 152, 0, 0.1); /* Loko mavo manopy volomboasary (amber) */
            color: #FFA000; /* Loko matro-doko kely ho an'ny soratra */
            border: 1px solid var(--md-sys-color-warning);
            border-left: 5px solid var(--md-sys-color-warning); /* Tsipika matevina eo ankavia mba hisongadina */
        }

        .alert-info {
            background: rgba(103, 80, 164, 0.08); /* Loko volomparasy manify (primary) */
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-primary-container);
            border-left: 5px solid var(--md-sys-color-primary);
        }
        /* ======================================================================= */

        /* === QR CARDS IMPROVED === */
        .qr-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .qr-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(103, 80, 164, 0.15);
            border-color: var(--md-sys-color-primary);
        }

        /* HEADER avec infos */
        .qr-card-header {
            margin-bottom: 16px;
        }

        .qr-card h4 {
            margin: 0 0 6px 0;
            font-size: 20px;
            font-weight: 800;
            color: #0f172a !important;
            text-shadow: none !important;
            letter-spacing: 0.3px;
        }

        .qr-position {
            margin: 0 0 10px 0 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #64748b !important;
            text-shadow: none !important;
        }

        .qr-group-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, var(--md-sys-color-primary-dark) 100%);
            color: white !important;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(103, 80, 164, 0.3);
        }

        /* QR Code container */
        .qr-code-canvas {
            margin: 16px 0;
            background: white;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            display: inline-block;
        }

        .qr-code-canvas img {
            display: block;
            border-radius: 8px;
        }

        /* Actions buttons */
        .qr-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 16px;
        }

        .qr-actions .btn-icon {
            background: var(--md-sys-color-primary);
            color: white;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(103, 80, 164, 0.3);
            border: none;
            cursor: pointer;
        }

        .qr-actions .btn-icon:hover {
            background: var(--md-sys-color-primary-dark);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(103, 80, 164, 0.4);
        }

        .qr-actions .btn-icon .material-icons {
            font-size: 20px;
        }
        /*======================================*/


        /* === SEARCH BAR MODERN === */
        .search-input-modern {
            width: 100%;
            padding: 14px 50px 14px 50px;
            font-size: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .search-input-modern:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 4px 16px rgba(103, 80, 164, 0.2);
        }

        .search-icon-modern {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-primary);
            font-size: 22px;
            pointer-events: none;
        }

        .search-clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--md-sys-color-error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-clear-btn:hover {
            background: #dc2626;
            transform: translateY(-50%) scale(1.1);
        }

        .search-clear-btn .material-icons {
            font-size: 18px;
        }

        /*======================================*/

        /* Animation fadeIn */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .qr-card {
            animation: fadeIn 0.3s ease;
        }

        /* QR Code Styles */
        .qr-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        /* Fix pour les QR codes qui débordent */
        .qr-card {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            overflow: hidden; /* Ampiana ity */
            display: flex; /* Ampina ity */
            flex-direction: column; /* Ampiana ity */
            align-items: center; /* Ampiana ity */
        }

        .qr-code-canvas {
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden; /* Ampiana ity */
            display: flex; /* Ampiana ity */
            justify-content: center; /* Ampiana ity */
            align-items: center; /* Ampiana ity */
            max-width: 100%; /* Ampiana ity - IMPORTANTE! */
        }

        /* Mitantana ny haben'ny sary QR */
        .qr-code-canvas img {
            max-width: 100%; /* Tsy hihoatra ny card */
            height: auto; /* Mitazona ny proportions */
            display: block; /* Manafoana ny spacing */
            border-radius: 8px; /* Mifanaraka amin'ny container */
        }

        .qr-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }

        @media (max-height: 500px) {
            .video-container {
                max-width: 280px;
            }
        }

        #qrVideo {
            width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid var(--md-sys-color-primary);
            border-radius: 12px;
            background: rgba(103, 80, 164, 0.1);
            pointer-events: none;
        }

        .scan-overlay::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--md-sys-color-primary);
            border-radius: 12px;
            animation: scanPulse 2s ease-in-out infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .scan-result {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .scan-result.success {
            background: var(--md-sys-color-success);
            color: white;
        }

        .scan-result.error {
            background: var(--md-sys-color-error);
            color: white;
        }

        .qr-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .db-status {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .db-status.connected {
            background: rgba(76, 175, 80, 0.1);
            color: var(--md-sys-color-success);
            border: 1px solid var(--md-sys-color-success);
        }

        .db-status.error {
            background: rgba(179, 38, 30, 0.1);
            color: var(--md-sys-color-error);
            border: 1px solid var(--md-sys-color-error);
        }

        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .qr-container {
                grid-template-columns: 1fr;
            }
        }

        /* === SIDEBAR MODERNE GLASSMORPHISM GRIS SIDÉRAL === */

        .settings-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 420px;
            height: 100vh;
            /* Gris sidéral glassmorphism */
            background: linear-gradient(
                165deg,
                rgba(71, 85, 105, 0.75) 0%,
                rgba(51, 65, 85, 0.85) 50%,
                rgba(30, 41, 59, 0.9) 100%
            );
            backdrop-filter: blur(25px) saturate(160%);
            -webkit-backdrop-filter: blur(25px) saturate(160%);
            border-left: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 
                -8px 0 40px rgba(15, 23, 42, 0.5),
                inset 1px 0 0 rgba(255, 255, 255, 0.1);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 3000;
            padding: 32px 24px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .settings-panel.active {
            right: 0;
        }

        /* Scrollbar élégante pour le sidebar */
        .settings-panel::-webkit-scrollbar {
            width: 8px;
        }

        .settings-panel::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 4px;
        }

        .settings-panel::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 4px;
        }

        .settings-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.6);
        }

        /* Overlay amélioré */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 2999;
            display: none;
            transition: opacity 0.3s ease;
        }

        .settings-overlay.active {
            display: block;
            animation: overlayFadeIn 0.3s ease;
        }

        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Sections du sidebar stylisées */
        .settings-section {
            margin-bottom: 32px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .settings-section:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(148, 163, 184, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.3);
        }

        .settings-section h3 {
            color: rgba(226, 232, 240, 0.95);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .settings-section h3 .material-icons {
            color: rgba(129, 140, 248, 0.9);
            filter: drop-shadow(0 2px 4px rgba(129, 140, 248, 0.4));
        }

        /* Form controls dans le sidebar */
        .settings-section .form-control {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: rgba(241, 245, 249, 0.95);
            transition: all 0.3s ease;
        }

        .settings-section .form-control:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(129, 140, 248, 0.5);
        }

        .settings-section .form-control:focus {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(129, 140, 248, 0.8);
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
            color: white;
        }

        .settings-section label {
            color: rgba(203, 213, 225, 0.9);
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Boutons dans le sidebar */
        .settings-section .btn {
            background: linear-gradient(
                135deg,
                rgba(129, 140, 248, 0.85) 0%,
                rgba(99, 102, 241, 0.85) 100%
            );
            backdrop-filter: blur(10px);
            border: 1px solid rgba(129, 140, 248, 0.3);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(129, 140, 248, 0.3);
        }

        .settings-section .btn:hover {
            background: linear-gradient(
                135deg,
                rgba(129, 140, 248, 1) 0%,
                rgba(99, 102, 241, 1) 100%
            );
            box-shadow: 0 6px 16px rgba(129, 140, 248, 0.5);
            transform: translateY(-2px);
        }

        .settings-section .btn-danger {
            background: linear-gradient(
                135deg,
                rgba(239, 68, 68, 0.85) 0%,
                rgba(220, 38, 38, 0.85) 100%
            );
            border-color: rgba(239, 68, 68, 0.3);
        }

        .settings-section .btn-danger:hover {
            background: linear-gradient(
                135deg,
                rgba(239, 68, 68, 1) 0%,
                rgba(220, 38, 38, 1) 100%
            );
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.5);
        }

        /* Alert dans le sidebar */
        .settings-section .alert {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: rgba(226, 232, 240, 0.9);
        }

        /* Modal header dans le sidebar */
        .settings-panel .modal-header {
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            margin-bottom: 24px;
            padding-bottom: 16px;
        }

        .settings-panel .modal-header h3 {
            color: rgba(241, 245, 249, 0.95);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            font-size: 1.5rem;
        }

        .settings-panel .close-btn {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(226, 232, 240, 0.9);
        }

        .settings-panel .close-btn:hover {
            background: rgba(239, 68, 68, 0.8);
            color: white;
            transform: rotate(90deg);
        }

        /* Animation d'entrée */
        @keyframes slideInSidebar {
            from {
                right: -450px;
                opacity: 0;
            }
            to {
                right: 0;
                opacity: 1;
            }
        }

        /* Dark mode support */
        [data-theme="dark"] .settings-panel {
            background: linear-gradient(
                165deg,
                rgba(15, 23, 42, 0.85) 0%,
                rgba(30, 41, 59, 0.9) 50%,
                rgba(15, 23, 42, 0.95) 100%
            );
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }
            
            .settings-panel.active {
                right: 0;
            }
        }


        /* Présence QR Tab */
        .qr-scan-section {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .employee-qr-item {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .employee-qr-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .employee-qr-info h4 {
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }

        .employee-qr-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .qr-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .qr-status.present {
            color: var(--md-sys-color-success);
        }

        .qr-status.absent {
            color: var(--md-sys-color-error);
        }

        .payroll-item {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .payroll-item.paid {
            border-left-color: var(--md-sys-color-success);
        }

        .payroll-item.paid .amount {
            color: var(--md-sys-color-success);
        }

        .payroll-item.paid .material-icons {
            color: var(--md-sys-color-success);
        }

        .payroll-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        /* =================================================== */
        /*  FANATSARANA NY LIStE AVANCE (Trosa)                */
        /* =================================================== */

        /* Famaritana ankapobeny ny kaontenera misy ny trosa */
        #advancesList {
            display: flex;
            flex-direction: column;
            gap: 12px; /* Elanelana eo anelanelan'ny singa tsirairay */
            margin-top: 24px; /* Elanelana avy eo ambony */
        }

        /* Ny endriky ny singa tsirairay ao anaty lisitra */
        .advance-item {
            display: flex;
            justify-content: space-between; /* Mampifanelanelana ny atiny (ankavia sy ankavanana) */
            align-items: center; /* Mampifanitsy azy ireo eo afovoany mitsangana */
            background: var(--md-sys-color-surface); /* Loko fototra avy amin'ny lohahevitra */
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--md-sys-color-outline-variant); /* Sisiny manify mba hisy fiavahana */
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Aloka kely ho an'ny halalina */
        }

        /* Rehefa alefa eo amboniny ny totozy */
        .advance-item:hover {
            transform: translateY(-2px); /* Asondrotra kely */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Aloka lehibebe kokoa */
            border-left: 4px solid var(--md-sys-color-primary); /* Tsipika miloko eo ankavia mba hanamafisana */
            padding-left: 13px; /* Ahitsy kely ny padding mba tsy hihetsika ny lahatsoratra */
        }

        /* Fizarana misy ny fampahalalana (anarana, daty, sns.) */
        .advance-item .advance-info {
            display: flex;
            flex-direction: column; /* Atao mitsangana ny fampahalalana */
            gap: 4px; /* Elanelana kely eo anelanelan'ny andalana */
        }

        /* Ny anaran'ny mpiasa */
        .advance-item .advance-info h4 {
            color: var(--md-sys-color-primary);
            margin: 0;
            font-size: 1.1rem;
        }

        /* Ny lahatsoratra kely (daty, antony) */
        .advance-item .advance-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
            margin: 0;
        }

        /* Ny fizarana misy ny sandan'ny vola sy ny bokotra */
        .advance-item .amount-actions {
            text-align: right; /* Apetraka eo ankavanana ny atiny */
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Atao mifanitsy eo ankavanana daholo */
            gap: 8px;
        }

        /* Ny sandan'ny vola */
        .advance-item .amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--md-sys-color-error); /* Loko mena mba hanamafisana fa trosa io */
        }

        
        #editAdvanceEmployeeName {
            padding: 12px 16px;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 8px;
            color: var(--md-sys-color-on-surface-variant);
        }

        /*Pagination*/
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        .pagination-controls button {
            background: var(--md-sys-color-secondary-container); /* Loko volondavenona */
            color: var(--md-sys-color-on-secondary-container);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        /* Style vaovao ho an'ny fizarana sivana sy fikarohana */
        .filter-controls {
            display: flex;
            gap: 24px; /* Elanelana eo anelanelan'ny fikarohana sy ny safidy */
            align-items: flex-end; /* Mampifanitsy ny singa eo ambany */
            margin-bottom: 24px; /* Elanelana avy eo ambany */
            flex-wrap: wrap; /* Mba tsy hifandona amin'ny finday */
        }

        .filter-controls .search-group {
            flex-grow: 1; /* Mba haka ny toerana malalaka rehetra ny fikarohana */
        }

        .filter-controls .items-per-page-group {
            flex-shrink: 0; /* Mba tsy hihena ny sakan'ny safidy */
            min-width: 150px; /* Sakan'ny kely indrindra */
        }

        /* Fanitsiana kely ny search-container mba tsy hisy margin ambany intsony */
        .search-container {
            margin-bottom: 0; 
        }

        /* Style pour le badge de présence dans la paie */
        .attendance-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid var(--md-sys-color-success);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--md-sys-color-success);
            vertical-align: middle;
        }

        .attendance-badge .material-icons {
            font-size: 16px;
        }

        .attendance-badge.no-attendance {
            background: rgba(211, 47, 47, 0.1);
            border-color: var(--md-sys-color-error);
            color: var(--md-sys-color-error);
        }

    
        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .nav-tabs { padding: 8px; }
            .nav-tab { padding: 8px 12px; font-size: 14px; }
            .container { padding: 8px; }
            .card { padding: 16px; }
            .settings-btn { right: 70px; }
            .theme-toggle { right: 16px; }
            
            /* Optimisation caméra pour mobile */
            .video-container {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
            #qrVideo {
                width: 100% !important;
                height: auto !important;
            }
        }
    
        /* Fanalana ny effet miroir amin'ny camera + canvas landmarks */
        #enrollVideo,
        #pointageVideo, 
        #selectionVideo,
        #enrollCanvas {
            -webkit-transform: scaleX(-1);
            -moz-transform: scaleX(-1);
            -o-transform: scaleX(-1);
            transform: scaleX(-1);
        }


        /* ===gris sidéral glassmorphism!===*/
        label, .form-group label {
            color: rgba(203, 213, 225, 0.9);
            font-weight: 500;
        }

        h1, h2, h3, h4, h5, h6 {
            color: #e2e8f0;
        }

        p {
            color: rgba(203, 213, 225, 0.85);
        }

        /* ========================================
        FANATSARANA CONTRASTE - SORATRA HITA TSARA
        ======================================== */

        /* === TEXTES GÉNÉRAUX === */
        body {
            color: #f1f5f9 !important;
        }

        h1, h2, h3, h4, h5, h6 {
            color: #f1f5f9 !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        p {
            color: #e2e8f0 !important;
        }

        /* === LABELS & DESCRIPTIONS === */
        label,
        .form-group label {
            color: #e2e8f0 !important;
            font-weight: 600 !important;
        }

        /* Textes descriptifs */
        .header p,
        .card p,
        .qr-scan-section p {
            color: rgba(248, 250, 252, 0.95) !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* === EMPLOYEE ITEMS === */
        .employee-item,
        .employee-qr-item,
        .attendance-item,
        .advance-item {
            background: rgba(51, 65, 85, 0.6) !important;
            border: 1px solid rgba(148, 163, 184, 0.25) !important;
        }

        .employee-info h4,
        .employee-qr-info h4,
        .advance-info h4 {
            color: #93c5fd !important;
            font-weight: 700 !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .employee-info p,
        .employee-qr-info p,
        .advance-info p,
        .employee-position {
            color: #cbd5e1 !important;
            font-weight: 500 !important;
        }

        /* === STAT CARDS === */
        .stat-content p {
            color: #f1f5f9 !important;
            font-weight: 600 !important;
        }

        /* === FORM CONTROLS === */
        .form-control {
            color: #f1f5f9 !important;
            background: rgba(51, 65, 85, 0.6) !important;
            border-color: rgba(148, 163, 184, 0.4) !important;
        }

        .form-control::placeholder {
            color: rgba(203, 213, 225, 0.6) !important;
        }

        .form-control option {
            background: #1e293b !important;
            color: #f1f5f9 !important;
        }

        /* === ATTENDANCE STATUS === */
        .attendance-status,
        .employee-status,
        .qr-status {
            font-weight: 700 !important;
        }

        /* === GROUPS TEXT === */
        strong {
            color: #f8fafc !important;
        }

        /* Groupe: label */
        p[style*="color: var(--md-sys-color-secondary)"] {
            color: #cbd5e1 !important;
        }

        /* === MODAL CONTENT === */
        .modal-content h3,
        .modal-header h3 {
            color: #f1f5f9 !important;
        }

        .modal-content p,
        .modal-content label {
            color: #e2e8f0 !important;
        }

        /* === ALERT MESSAGES === */
        .alert {
            color: #f1f5f9 !important;
            font-weight: 600 !important;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.2) !important;
            border-color: rgba(147, 197, 253, 0.5) !important;
        }

        /* === TABLE & LIST TEXTS === */
        table {
            color: #e2e8f0 !important;
        }

        table th {
            color: #f1f5f9 !important;
            font-weight: 700 !important;
            background: rgba(51, 65, 85, 0.8) !important;
        }

        table td {
            color: #cbd5e1 !important;
        }

        /* === PAGINATION === */
        .pagination-info {
            color: #e2e8f0 !important;
            font-weight: 600 !important;
        }

        /* === SEARCH INPUT === */
        .search-input {
            color: #f1f5f9 !important;
            background: rgba(51, 65, 85, 0.6) !important;
        }

        /* === QR SCAN SECTION === */
        .qr-scan-section {
            background: rgba(59, 130, 246, 0.2) !important;
            backdrop-filter: blur(20px) !important;
        }

        .qr-scan-section h2,
        .qr-scan-section p {
            color: #f8fafc !important;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        }

        /* === BUTTONS TEXT === */
        .btn {
            color: white !important;
            font-weight: 700 !important;
        }

        /* === SIDEBAR/SETTINGS TEXT === */
        .settings-section p,
        .settings-section label,
        .settings-section strong {
            color: #e2e8f0 !important;
        }

        /* === MONTANTS & NOMBRES === */
        .amount {
            color: #fca5a5 !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        /* === SELECT DROPDOWN === */
        select {
            color: #f1f5f9 !important;
            font-weight: 500 !important;
        }

        /* === CHECKBOX & RADIO LABELS === */
        input[type="checkbox"] + label,
        input[type="radio"] + label {
            color: #e2e8f0 !important;
        }

        /* === ABSENCE TEXT === */
        .employee-item strong,
        .advance-item strong {
            color: #f8fafc !important;
        }

        /* === SMALL TEXT / METADATA === */
        small,
        .employee-item p[style*="font-size: 12px"],
        .employee-qr-item p[style*="font-size: 14px"] {
            color: #cbd5e1 !important;
        }

        /* ========================================
        CONTRASTE TSARA HO AN'NY MODAL ENROLLMENT
        ======================================== */

        /* Modal content facial (enrollment) */
        .modal-content-facial {
            background: white !important;
            color: #1e293b !important;
        }

        .modal-content-facial h2 {
            color: #1e293b !important;
            text-shadow: none !important;
        }

        /* Status enrollment */
        #enrollStatus {
            background: #f0f0f0 !important;
            color: #1e293b !important;
            font-weight: 600 !important;
            border: 1px solid #cbd5e1;
        }

        /* Buttons enrollment */
        #btnEnrollStart {
            background: #6750A4 !important;
            color: white !important;
            font-weight: 600 !important;
        }

        #btnEnrollCancel {
            background: #ccc !important;
            color: #1e293b !important;
            font-weight: 600 !important;
        }

        #btnEnrollStart:hover {
            background: #7C4DFF !important;
        }

        #btnEnrollCancel:hover {
            background: #94a3b8 !important;
        }

        /* Instructions text */
        .modal-content-facial p,
        .modal-content-facial div {
            color: #334155 !important;
        }

        /* Raha misy loading message */
        .modal-content-facial strong {
            color: #6750A4 !important;
        }

        /* ========================================
        HAMBURGER MENU - GLASSMORPHISM STYLE
        ======================================== */

        /* Bouton hamburger */
        .hamburger-btn {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 3001;
            background: rgba(51, 65, 85, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 50px;
            height: 50px;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(15, 23, 42, 0.4);
            transition: all 0.3s ease;
        }

        .hamburger-btn:hover {
            transform: translateY(-2px);
            background: rgba(51, 65, 85, 0.85);
            box-shadow: 0 12px 48px rgba(15, 23, 42, 0.6);
        }

        .hamburger-btn span {
            width: 24px;
            height: 3px;
            background: #e2e8f0;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        /* Animation hamburger */
        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translateY(8px);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translateY(-8px);
        }

        /* Menu latéral - GLASSMORPHISM */
        .nav-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 300px;
            height: 100vh;
            background: rgba(51, 65, 85, 0.75);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-right: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 8px 0 32px rgba(15, 23, 42, 0.5);
            z-index: 3000;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 90px 16px 20px 16px;
            overflow-y: auto;
        }

        .nav-menu.active {
            left: 0;
        }

        /* Overlay */
        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 2999;
            display: none;
            transition: opacity 0.3s ease;
        }

        .nav-overlay.active {
            display: block;
        }

        /* Menu item - AVEC TEXTE */
        .nav-menu-item {
            display: flex !important;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
            position: relative;
            overflow: hidden;
        }

        /* Hover effect */
        .nav-menu-item:hover {
            background: rgba(99, 102, 241, 0.25);
            border-color: rgba(129, 140, 248, 0.5);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Active state */
        .nav-menu-item.active {
            background: rgba(99, 102, 241, 0.35);
            border-color: rgba(129, 140, 248, 0.7);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
        }

        /* Active indicator line */
        .nav-menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #818cf8 0%, #6366f1 100%);
            border-radius: 0 4px 4px 0;
        }

        /* Icon */
        .nav-menu-item .material-icons {
            font-size: 24px;
            color: #cbd5e1 !important;
            transition: all 0.3s ease;
            min-width: 24px;
            flex-shrink: 0;
        }

        .nav-menu-item:hover .material-icons,
        .nav-menu-item.active .material-icons {
            color: #a5b4fc;
            transform: scale(1.1);
        }

        /* Label text */
        .nav-menu-label {
            font-size: 15px;
            font-weight: 600;
            color: #e2e8f0 !important;
            white-space: nowrap;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            display: inline-block !important;
            opacity: 1 !important;         
            visibility: visible !important;
            overflow: hidden;
            text-overflow: ellipsis;  
            margin-left: 12px;
        }

        .nav-menu-item:hover .nav-menu-label,
        .nav-menu-item.active .nav-menu-label {
            color: #f1f5f9;
        }

        /* Scrollbar custom */
        .nav-menu::-webkit-scrollbar {
            width: 6px;
        }

        .nav-menu::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 3px;
        }

        .nav-menu::-webkit-scrollbar-thumb {
            background: rgba(129, 140, 248, 0.5);
            border-radius: 3px;
        }

        .nav-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(129, 140, 248, 0.7);
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .nav-menu {
            background: rgba(30, 41, 59, 0.85);
        }

        [data-theme="dark"] .nav-menu-item {
            background: rgba(15, 23, 42, 0.4);
        }

        [data-theme="dark"] .hamburger-btn {
            background: rgba(30, 41, 59, 0.8);
        }

        /* Cacher l'ancien nav-tabs */
        .nav-tabs {
            display: none !important;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .hamburger-btn {
                top: 16px;
                left: 16px;
                width: 48px;
                height: 48px;
            }
            
            .nav-menu {
                width: 280px;
                left: -280px;
                padding-top: 80px;
            }
            
            .nav-menu-item {
                padding: 12px 14px;
                gap: 14px;
            }
            
            .nav-menu-item .material-icons {
                font-size: 24px;
            }
            
            .nav-menu-label {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .nav-menu {
                width: 260px;
                left: -260px;
            }
        }


        /* ========================================
        CONTRASTE TSARA - RÉSUMÉ & RAPPORTS
        ======================================== */

        /* Résumé du Mois - fond mazava */
        .card > div[style*="background"] p,
        .card > div[style*="padding"] p {
            color: #1e293b !important;
            text-shadow: none !important;
            font-weight: 700 !important;
        }

        /* Titre "Résumé du Mois" */
        .card > div h3:first-child,
        .card > div p:first-child {
            color: #1e293b !important;
            font-weight: 800 !important;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8) !important;
        }

        /* Table dans les rapports */
        table {
            background: rgba(30, 41, 59, 0.6) !important;
        }

        table th {
            background: rgba(51, 65, 85, 0.9) !important;
            color: #f1f5f9 !important;
            font-weight: 700 !important;
        }

        table td {
            color: #e2e8f0 !important;
            font-weight: 500 !important;
        }

        /* Statut "Absent" rouge */
        table td[style*="color: red"],
        td:contains("Absent") {
            color: #fca5a5 !important;
            font-weight: 700 !important;
        }

        /* Labels généraux dans les cards */
        .card label,
        .card strong {
            color: #e2e8f0 !important;
            font-weight: 600 !important;
        }

        /* Text label ao anatin'ny menu */
        .nav-menu-label {
            display: none;
            margin-left: 16px;
            font-size: 15px;
            font-weight: 600;
            color: #e2e8f0;
        }

        @media (max-width: 768px) {
            /* Hanisa ny menu rehefa mobile */
            .nav-menu {
                width: 200px;
            }
            
            .nav-menu-label {
                display: block;
            }
            
            /* Afeno ny tooltip rehefa mobile */
            .nav-tooltip {
                display: none;
            }
        }

        /* ========================================
        CORRECTION FORCÉE - RÉSUMÉ & LABELS
        Version FINALE avec !important partout
        ======================================== */

        /* === 1. RÉSUMÉ DU MOIS - Background blanc/rose === */

        /* Titre "Résumé du Mois" */
        div[style*="background"] h3:first-child,
        div[style*="background"] p:first-child {
            color: #1e293b !important;
            font-weight: 800 !important;
            text-shadow: none !important;
            font-size: 1.3rem !important;
        }

        /* TOUS les paragraphes dans les divs avec background */
        div[style*="background"] p,
        div[style*="background"] span,
        div[style*="background"] strong,
        div[style*="background"] div {
            color: #1e293b !important;
            font-weight: 700 !important;
            text-shadow: none !important;
        }

        /* Labels spécifiques */
        div[style*="background"] p:contains("Jours"),
        div[style*="background"] p:contains("Total"),
        div[style*="background"] p:contains("Avance"),
        div[style*="background"] p:contains("Salaire") {
            color: #334155 !important;
            font-weight: 600 !important;
        }

        /* === 2. INLINE STYLES - Override TOUS === */

        /* Force TOUS les éléments avec inline style */
        [style*="color: var("],
        [style*="color:var("] {
            color: #1e293b !important;
        }

        /* === 3. RAPPORT MENSUEL - Section entière === */

        /* Titre principal du rapport */
        #employeeStatusResults h3,
        #employeeStatusResults h2,
        .card h2,
        .card h3 {
            color: #f1f5f9 !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4) !important;
        }

        /* Groupe label */
        #employeeStatusResults p[style],
        #employeeStatusResults strong {
            color: #e2e8f0 !important;
        }

        /* === 4. OVERRIDE SPÉCIFIQUE PAR POSITION === */

        /* Tous les enfants directs d'un div avec background clair */
        div[style*="background: #"],
        div[style*="background:#"],
        div[style*="background: rgb"],
        div[style*="background:rgb"] {
            color: #1e293b !important;
        }

        div[style*="background: #"] *,
        div[style*="background:#"] *,
        div[style*="background: rgb"] *,
        div[style*="background:rgb"] * {
            color: #1e293b !important;
            text-shadow: none !important;
        }

        /* === 5. TABLE HEADERS & CELLS === */

        table th {
            background: rgba(51, 65, 85, 0.95) !important;
            color: #f1f5f9 !important;
            font-weight: 800 !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5) !important;
        }

        table td {
            color: #e2e8f0 !important;
            font-weight: 600 !important;
        }

        /* === 6. STATUT "Absent" rouge === */
        td:contains("Absent"),
        span:contains("Absent") {
            color: #ef4444 !important;
            font-weight: 700 !important;
        }

        /* === 7. CHIFFRES & MONTANTS === */

        /* Tous les spans contenant "Ar" ou des heures */
        span:contains("Ar"),
        span:contains("h"),
        strong:contains("Ar"),
        strong:contains("h") {
            font-weight: 800 !important;
        }

        /* Dans fond blanc - chiffres en dark */
        div[style*="background"] span:contains("Ar"),
        div[style*="background"] span:contains("h") {
            color: #1e293b !important;
        }

        /* === 8. MENU LABELS (bonus fix) === */

        .nav-menu-label {
            color: #e2e8f0 !important;
            font-weight: 600 !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4) !important;
        }

        /* === 9. FORME GÉNÉRALE - Si rien ne marche === */

        /* Target direct par ID */
        #employeeStatusResults p {
            color: #e2e8f0 !important;
        }

        #employeeStatusResults div[style] p {
            color: #1e293b !important;
        }

        /* === 10. UTILITY CLASS - Ajoutez ceci si besoin === */

        .text-dark-force {
            color: #1e293b !important;
            text-shadow: none !important;
            font-weight: 700 !important;
        }

        .text-light-force {
            color: #f1f5f9 !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4) !important;
            font-weight: 600 !important;
        }

        /* Badge Méthode Présence */
        .method-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .method-badge.qr {
            background: #6750A420;
            color: #6750A4;
        }

        .method-badge.facial {
            background: #0ea5e920;
            color: #0ea5e9;
        }

        .method-badge.manual {
            background: #f59e0b20;
            color: #f59e0b;
        }

        .method-badge .material-icons {
            font-size: 16px;
        }

        /* Animation fade-in pour les nouveaux items */
        .attendance-item {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /*=====NOTIFICATION PRÉSENCE==========*/
        /* Notification container */
        #notificationsContainer {
            position: relative;
            z-index: 1;
        }

        /* Alert smooth appearance */
        .alert {
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hover effect sur liste employés */
        #notificationsContainer .alert div[style*="border-left: 3px solid"] {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        #notificationsContainer .alert div[style*="border-left: 3px solid"]:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Notification compact hover effect */
        .alert-warning-compact:hover {
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
        }

        /* Animation smooth pour les détails */
        .alert-warning-compact [id$="-details"] {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /*========CARD STAT PRÉSENCE========*/
        /* Stat card 3 dots button hover */
        .stat-card {
            position: relative;
        }

        /* Transition smooth pour count */
        .stat-content h3 {
            transition: transform 0.2s ease;
        }

        /* Dropdown menu animation */
        #scanMethodMenu {
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /*=========================================*/

        /* =====================================================
        STAT CARD - OVERFLOW VISIBLE
        ===================================================== */
        .stat-card {
            position: relative;
            overflow: visible !important; /* IMPORTANTE! */
        }

        /* =====================================================
        DROPDOWN MENU - FIXED POSITION
        ===================================================== */
        #scanMethodMenu {
            animation: menuSlideDown 0.2s ease;
            backdrop-filter: blur(8px);
        }

        @keyframes menuSlideDown {
            from {
                opacity: 0;
                transform: translateY(-12px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Hover effect items */
        .menu-item:active {
            transform: scale(0.98);
        }

        /* Dark theme support */
        body.dark-mode #scanMethodMenu {
            background: #1f2937;
            border-color: #374151;
        }

        body.dark-mode .menu-item {
            border-color: #374151 !important;
        }

        body.dark-mode .menu-item:hover {
            background: #374151 !important;
        }

        body.dark-mode .menu-item div {
            color: #f3f4f6 !important;
        }

        /* =====================================================
        SCAN RESULT - MESSAGES AMÉLIORÉS
        ===================================================== */
        #scanResult {
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #scanResult strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        #scanResult s {
            color: #ef4444;
            text-decoration: line-through;
        }


    </style>

    <!-- Face Recognition Library -->
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js"></script>

</head>
<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="toggleSettings()">
                <span class="material-icons">settings</span>
            </button>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span class="material-icons" id="theme-icon">dark_mode</span>
            </button>
            <h1><span class="material-icons" style="font-size: 2.5rem; vertical-align: middle;">qr_code_scanner</span>RH RiseVanilla</h1>
            <p>La vanille à portée de main</p>
            
            <!-- Status de la base de données -->
            <div id="dbStatus" class="db-status">
                <span class="material-icons">database</span>
                <span id="dbStatusText">Initialisation de la base de données...</span>
            </div>
        </div>

        <!-- ================== BLOC VAOVAO HO AN'NY NOTIFICATIONS ================== -->
        <div id="notificationsContainer" style="margin-bottom: 16px; display: flex; flex-direction: column; gap: 8px;">
            <!-- Ho fenoina amin'ny alalan'ny JavaScript ity fizarana ity -->
        </div>
        <!-- ======================================================================= -->

        <!-- Hamburger Menu Button -->
        <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleNavMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Overlay -->
        <div class="nav-overlay" id="navOverlay" onclick="toggleNavMenu()"></div>

        <!-- Menu Navigation -->
        <div class="nav-menu" id="navMenu">
            <div class="nav-menu-item active" onclick="navigateToSection('dashboard')">
                <span class="material-icons">dashboard</span>
                <span class="nav-menu-label">Tableau de Bord</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('employees')">
                <span class="material-icons">people</span>
                <span class="nav-menu-label">Employés</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('groups')">
                <span class="material-icons">groups</span>
                <span class="nav-menu-label">Groupes</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('employee-stats')">
                <span class="material-icons">person_search</span>
                <span class="nav-menu-label">Statut Employé</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('attendance')">
                <span class="material-icons">schedule</span>
                <span class="nav-menu-label">Présence</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('qr-presence')">
                <span class="material-icons">qr_code</span>
                <span class="nav-menu-label">Présence QR</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('face-presence')">
                <span class="material-icons">face</span>
                <span class="nav-menu-label">Pointage Facial</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('qr-codes')">
                <span class="material-icons">qr_code_2</span>
                <span class="nav-menu-label">Codes QR</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('advances')">
                <span class="material-icons">savings</span>
                <span class="nav-menu-label">Avances</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('payroll')">
                <span class="material-icons">payments</span>
                <span class="nav-menu-label">Paie</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('stc')">
                <span class="material-icons">exit_to_app</span>
                <span class="nav-menu-label">Solde Tout Compte</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('payments')">
                <span class="material-icons">history</span>
                <span class="nav-menu-label">Paiements</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('reports')">
                <span class="material-icons">analytics</span>
                <span class="nav-menu-label">Rapports</span>
            </div>
            
            <div class="nav-menu-item" onclick="navigateToSection('estimation')">
                <span class="material-icons">request_quote</span>
                <span class="nav-menu-label">Estimation</span>
            </div>
        </div>



        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">
                <span class="material-icons">dashboard</span>
                Tableau de Bord
            </button>
            <button class="nav-tab" onclick="showSection('employees')">
                <span class="material-icons">people</span>
                Employés
            </button>

            <button class="nav-tab" onclick="showSection('groups')">
                <span class="material-icons">groups</span>
                Groupes
            </button>

            <button class="nav-tab" onclick="showSection('employee-stats')">
                <span class="material-icons">person_search</span>
                Statut Employé
            </button>
            <button class="nav-tab" onclick="showSection('attendance')">
                <span class="material-icons">schedule</span>
                Présence
            </button>
            <button class="nav-tab" onclick="showSection('qr-presence')">
                <span class="material-icons">qr_code</span>
                Présence QR
            </button>
            <button class="nav-tab" onclick="showSection('face-presence')">
                <span class="material-icons">face</span>
                Pointage Facial
            </button>

            <button class="nav-tab" onclick="showSection('qr-codes')">
                <span class="material-icons">qr_code_2</span>
                Codes QR
            </button>
            <button class="nav-tab" onclick="showSection('advances')">
                <span class="material-icons">savings</span>
                Avances
            </button>
            <button class="nav-tab" onclick="showSection('payroll')">
                <span class="material-icons">payments</span>
                Paie
            </button>
            
            <button class="nav-tab" onclick="showSection('stc')">
                <span class="material-icons">exit_to_app</span>
                Solde de Tout Compte
            </button>

            <button class="nav-tab" onclick="showSection('payments')">
                <span class="material-icons">history</span>
                Paiements
            </button>
            <button class="nav-tab" onclick="showSection('reports')">
                <span class="material-icons">analytics</span>
                Rapports
            </button>
            <button class="nav-tab" onclick="showSection('estimation')">
                <span class="material-icons">request_quote</span>
                Estimation
            </button>

        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">people</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalEmployees">0</h3>
                        <p>Total Employés</p>
                    </div>
                </div>

                <!-- ================== BLOC VAOVAO NAMPIDIRINA ================== -->
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--md-sys-color-secondary);">
                        <span class="material-icons">fact_check</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="checkedInToday">0</h3>
                        <p>Employés Ayant Pointé</p>
                    </div>
                </div>
                <!-- ============================================================ -->

                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">check_circle</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="presentToday">0</h3>
                        <!-- FANovana ny soratra -->
                        <p>Journées Complètes (>= 4h)</p>
                    </div>
                </div>
                
                <!-- Card Scans avec Menu Dropdown -->
                <div class="stat-card" style="overflow: visible !important; position: relative;">
                    <div class="stat-icon">
                        <span class="material-icons" id="scanMethodIcon">qr_code_scanner</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="qrScansToday">0</h3>
                        <p id="scanMethodLabel">Scans Aujourd'hui</p>
                    </div>
                    
                    <!-- 3 DOTS MENU -->
                    <div style="position: absolute; top: 12px; right: 12px; z-index: 10;">
                        <button onclick="toggleScanMethodMenu(event)" 
                                style="background: none; border: none; cursor: pointer; padding: 4px; 
                                    border-radius: 50%; transition: background 0.2s;"
                                onmouseover="this.style.background='rgba(0,0,0,0.1)'"
                                onmouseout="this.style.background='none'">
                            <span class="material-icons" style="color: var(--md-sys-color-on-surface); font-size: 20px;">
                                more_vert
                            </span>
                        </button>
                    </div>
                </div>

                <!-- DROPDOWN EO IVELANY CARD -->
                <div id="scanMethodMenu" 
                    style="display: none; position: fixed; 
                            background: white; border-radius: 12px; 
                            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                            min-width: 220px; z-index: 9999; 
                            overflow: hidden; border: 1px solid #e5e7eb;">
                    
                    <div onclick="filterScanMethod('all')" 
                        class="menu-item"
                        style="padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; 
                                border-bottom: 1px solid #f3f4f6; transition: background 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'"
                        onmouseout="this.style.background='white'">
                        <span class="material-icons" style="color: #6b7280; font-size: 22px;">apps</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px; color: #1f2937;">Tous</div>
                            <div style="font-size: 12px; color: #6b7280;" id="allCount">0 pointages</div>
                        </div>
                    </div>
                    
                    <div onclick="filterScanMethod('qr')" 
                        class="menu-item"
                        style="padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; 
                                border-bottom: 1px solid #f3f4f6; transition: background 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'"
                        onmouseout="this.style.background='white'">
                        <span class="material-icons" style="color: #6750A4; font-size: 22px;">qr_code_scanner</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px; color: #1f2937;">QR Code</div>
                            <div style="font-size: 12px; color: #6b7280;" id="qrCount">0 scans</div>
                        </div>
                    </div>
                    
                    <div onclick="filterScanMethod('manual')" 
                        class="menu-item"
                        style="padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; 
                                border-bottom: 1px solid #f3f4f6; transition: background 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'"
                        onmouseout="this.style.background='white'">
                        <span class="material-icons" style="color: #f59e0b; font-size: 22px;">edit</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px; color: #1f2937;">Manuel</div>
                            <div style="font-size: 12px; color: #6b7280;" id="manualCount">0 entrées</div>
                        </div>
                    </div>
                    
                    <div onclick="filterScanMethod('facial')" 
                        class="menu-item"
                        style="padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; 
                                transition: background 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'"
                        onmouseout="this.style.background='white'">
                        <span class="material-icons" style="color: #0ea5e9; font-size: 22px;">face</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px; color: #1f2937;">Facial</div>
                            <div style="font-size: 12px; color: #6b7280;" id="facialCount">0 reconnaissances</div>
                        </div>
                    </div>
                </div>


                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">payments</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalSalaries">0 Ar</h3>
                        <p>Salaires ce Mois</p>
                    </div>
                </div>
            </div>
            <!-- Ity bloc vaovao ity dia apetraka ao anatin'ny #dashboard, eo ambanin'ny stats-grid -->
            <div class="card" style="margin-top: 24px;">
                <h2 style="margin-bottom: 24px;"><span class="material-icons">analytics</span>Aperçu Visuel</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px;">
                    
                    <!-- Toerana ho an'ny Grafika 1: Présence -->
                    <div>
                        <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">Taux de Présence (7 derniers jours)</h3>
                        <div style="position: relative; height:300px;">
                            <canvas id="weeklyAttendanceChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Toerana ho an'ny Grafika 2: Groupes -->
                    <div>
                        <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">Répartition des Employés par Groupe</h3>
                        <div style="position: relative; height:300px;">
                            <canvas id="groupDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- =================================================== -->
                    <div>
                        <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">Répartition par Genre</h3>
                        <div style="position: relative; height:280px;">
                            <canvas id="genderDistributionChart"></canvas>
                        </div>
                    </div>
                    <!-- =================================================== -->

                </div>
            </div>

            
        </div>

        <!-- Employees Section -->
        <div id="employees" class="section">
            <div class="card">
                <h2><span class="material-icons">people</span>Liste des Employés</h2>
                <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
                    <button class="btn" onclick="openAddEmployeeModal()"> <!-- Mila manamboatra an'ity fonction ity ianao -->
                        <span class="material-icons">person_add</span>
                        Ajouter un Nouvel Employé
                    </button>
                </div>
                <!-- ... eo ambanin'ny <h2> ... </h2> ... -->
                <div class="form-group" style="max-width: 300px; margin-bottom: 16px;">
                    <label for="employeeGroupFilter">Filtrer par Groupe</label>
                    <div class="select-dropdown">
                        <select class="form-control" id="employeeGroupFilter" onchange="displayEmployees()">
                            <option value="all">Tous les Groupes</option>
                            <option value="none">Sans Groupe</option>
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </select>
                    </div>
                </div>
                <!-- ... eo ambonin'ny search-container ... -->

                <div class="search-container">
                    <span class="material-icons search-icon">search</span>
                    <input type="text" class="search-input" id="employeeSearch" placeholder="Rechercher un employé...">
                </div>
                <!-- FANAMPIANA VAOVAO -->
                <div class="form-group" style="max-width: 200px; margin-top: 16px;">
                    <label for="employeeItemsPerPageSelect">Eléments par page</label>
                    <select id="employeeItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('employee', this.value)">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>

                <div class="employee-list" id="employeeList"></div>
                <div class="pagination-controls" id="employeePagination">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>

            </div>
        </div>

        <!-- Groups Section -->
        <div id="groups" class="section">
            <div class="card">
                <h2><span class="material-icons">groups</span>Gestion des Groupes d'Employés</h2>
                <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                    Créez et gérez les équipes ou départements de votre organisation.
                </p>

                <form id="groupForm" style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="groupName">Nom du Groupe</label>
                            <input type="text" id="groupName" class="form-control" placeholder="Ex: Équipe Technique, Vente, Administration" required>
                        </div>
                        <div class="form-group">
                            <label for="groupDescription">Description (Optionnel)</label>
                            <input type="text" id="groupDescription" class="form-control" placeholder="Courte description du rôle du groupe">
                        </div>
                    </div>
                    <input type="hidden" id="groupId">
                    <button type="submit" class="btn">
                        <span class="material-icons">add</span>
                        <span id="groupFormBtnText">Ajouter le Groupe</span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelEditGroupBtn" style="display: none;" onclick="cancelGroupEdit()">
                        <span class="material-icons">cancel</span>
                        Annuler
                    </button>
                </form>

                <h3>Liste des Groupes</h3>
                <div id="groupList" class="employee-list">
                    <!-- Ho fenoina amin'ny alalan'ny JavaScript -->
                </div>
            </div>
        </div>


        <!-- Statut Employées-->
                <!-- Statut Employé (Smart Search) Section - VERSION NOHATSARAINA -->
        <div id="employee-stats" class="section">
            <div class="card">
                <h2><span class="material-icons">person_search</span>Recherche Intelligente de Statut</h2>
                <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                    Recherchez un employé par son nom pour voir son statut en temps réel.
                </p>

                <div class="form-row" style="align-items: flex-end;">
                    <!-- Sehatra Fikarohana vaovao -->
                    <div class="form-group">
                        <label for="smartSearchInput">Nom de l'employé</label>
                        <div class="search-container" style="margin-bottom: 0;">
                            <span class="material-icons search-icon">search</span>
                            <input type="text" class="search-input" id="smartSearchInput" placeholder="Commencez à taper un nom...">
                        </div>
                    </div>
                    <!-- Safidy volana (tsy miova) -->
                    <div class="form-group">
                        <label for="statsMonth">Mois</label>
                        <input type="month" class="form-control" id="statsMonth">
                    </div>
                </div>

                <!-- Fampisehoana ny vokatry ny fikarohana -->
                <div id="smartSearchResults" style="margin-top: 16px;"></div>
                
                <!-- Fampisehoana ny tatitra rehefa misy voafidy -->
                <div id="employeeStatusResults" style="margin-top: 24px;"></div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- SECTION: POINTAGE FACIAL -->
        <!-- ========================================== -->
        <div id="face-presence" class="section">
            <div class="card">
                <h2>
                    <span class="material-icons">face</span>
                    Pointage par Reconnaissance Faciale
                </h2>
                <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                    Système de pointage automatique par reconnaissance faciale avec détection de vivacité.
                </p>

                <!-- Instructions -->
                <div style="margin-bottom: 24px; padding: 16px; background: rgba(103, 80, 164, 0.08); border-radius: 12px; border-left: 4px solid var(--md-sys-color-primary);">
                    <h3 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="color: var(--md-sys-color-primary);">info</span>
                        Comment ça marche?
                    </h3>
                    <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>Enrollment</strong>: Chaque employé doit d'abord enregistrer son visage (bouton 📸 dans la liste employés)</li>
                        <li><strong>Pointage</strong>: Cliquez sur le bouton ci-dessous et regardez la caméra</li>
                        <li><strong>Reconnaissance</strong>: Le système identifie automatiquement l'employé</li>
                        <li><strong>Sécurité</strong>: La détection de vivacité empêche l'utilisation de photos</li>
                    </ol>
                </div>

                <!-- Bouton principal -->
                <div style="text-align: center; margin-bottom: 32px;">
                    <button 
                        onclick="openFacePointageModal()" 
                        style="
                            padding: 20px 40px;
                            background: linear-gradient(135deg, #6750A4 0%, #7C4DFF 100%);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 18px;
                            font-weight: 600;
                            display: inline-flex;
                            align-items: center;
                            gap: 12px;
                            box-shadow: 0 4px 12px rgba(103, 80, 164, 0.3);
                            transition: all 0.3s ease;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(103, 80, 164, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(103, 80, 164, 0.3)';"
                    >
                        <span class="material-icons" style="font-size: 32px;">face_retouching_natural</span>
                        <span>Démarrer le Pointage Facial</span>
                    </button>
                    
                    <p style="margin-top: 16px; color: var(--md-sys-color-on-surface-variant); font-size: 14px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">verified_user</span>
                        Reconnaissance faciale sécurisée avec détection de vivacité
                    </p>
                </div>
            </div>

            <!-- Employés Enrolled -->
            <div class="card">
                <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons" style="color: var(--md-sys-color-primary);">people</span>
                    Employés Enrolled (<span id="enrolledCount">0</span>)
                </h3>
                <div id="enrolledEmployeesList">
                    <!-- Rempli par JavaScript -->
                </div>
            </div>

            <!-- Pointages du jour -->
            <div class="card">
                <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons" style="color: var(--md-sys-color-success);">check_circle</span>
                    Pointages Faciaux du Jour
                </h3>
                <div id="todayFaceAttendance">
                    <!-- Rempli par JavaScript -->
                </div>
            </div>
        </div>


        <!-- QR Presence Section -->
        <!-- =================================================== -->
        <!--      QR Presence Section (VERSION NOHATSARAINA)     -->
        <!-- =================================================== -->
        <div id="qr-presence" class="section">
            <div class="qr-scan-section">
                <h2><span class="material-icons">qr_code_scanner</span>Scanner QR Code pour Présence</h2>
                <p>Tsindrio ny bokotra hanombohana ny scan.</p>
                
                <!-- 
                    NAFANA DAHOLO IREO SINGA TALOHA (video, canvas, overlay, sns.)
                    SATRIA EFA AO ANATIN'ILAY MODAL IZY IREO ANKEHITRINY.
                    BOKOTRA TOKANA SISA NO ILAINA ETO.
                -->
                <div style="margin-top: 16px;">
                    <button class="btn" onclick="startQRScan('attendance')">
                        <span class="material-icons">camera_alt</span>
                        Démarrer le Scanner
                    </button>
                    
                    <button class="btn btn-secondary" onclick="document.getElementById('qrImageInput').click()">
                        <span class="material-icons">photo_library</span>
                        Choisir une Image
                    </button>
                    <input type="file" id="qrImageInput" accept="image/*" capture="environment" style="display: none;" onchange="handleQRImageUpload(event)">

                </div>
            </div>

            <div class="card">
                <h2><span class="material-icons">today</span>Présences QR d'Aujourd'hui</h2>
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <input type="date" class="form-control" id="qrAttendanceDate" style="max-width: 200px; flex: 1; min-width: 150px;" onchange="qrAttendanceCurrentPage = 1; displayQRAttendance()">
                    <button class="btn btn-secondary" onclick="refreshQRAttendance()" style="flex: 1; min-width: 120px;">
                        <span class="material-icons">refresh</span>
                        Actualiser
                    </button>
                    <button class="btn btn-warning" onclick="exportQRAttendancePDF()" style="flex: 1; min-width: 120px;">
                        <span class="material-icons">picture_as_pdf</span>
                        Export PDF
                    </button>
                </div>
                <div id="qrAttendanceList"></div>
                <!-- FANAMPIANA VAOVAO HO AN'NY PAGINATION -->
                <div class="pagination-controls" id="qrAttendancePagination" style="margin-top: 16px;">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>

            </div>
        </div>


        <!-- QR Codes Section -->
        <div id="qr-codes" class="section">
            <div class="card">
                <h2><span class="material-icons">qr_code_2</span>Codes QR des Employés</h2>
                
                <!-- Boutons actions -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" onclick="generateAllQRCodes()">
                        <span class="material-icons">refresh</span>
                        Générer Tous les QR
                    </button>
                    <button class="btn btn-secondary" onclick="downloadAllQRCodes()">
                        <span class="material-icons">download</span>
                        Télécharger Tous
                    </button>
                    <button class="btn btn-warning" onclick="printAllQRCodes()">
                        <span class="material-icons">print</span>
                        Imprimer Tous
                    </button>
                </div>
                
                <!-- SEARCH BAR VAOVAO -->
                <div style="margin-bottom: 24px;">
                    <div style="position: relative; max-width: 600px; margin: 0 auto;">
                        <input 
                            type="text" 
                            id="qrSearchInput" 
                            class="search-input-modern" 
                            placeholder="Rechercher un employé..."
                            oninput="filterQRCodes()"
                        >
                        <span class="material-icons search-icon-modern">search</span>
                        <button class="search-clear-btn" onclick="clearQRSearch()" id="qrClearBtn" style="display: none;">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    
                    <!-- Compteur de résultats -->
                    <div id="qrSearchResults" style="text-align: center; margin-top: 12px; font-size: 14px; font-weight: 600; color: var(--md-sys-color-primary); display: none;">
                        <span id="qrResultCount"></span>
                    </div>
                </div>

                
                <!-- Container QR Codes -->
                <div class="qr-container" id="qrContainer">
                    <p style="text-align: center; padding: 40px; color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons" style="font-size: 48px; opacity: 0.5;">qr_code_scanner</span><br>
                        Cliquez sur "Générer Tous les QR" pour commencer
                    </p>
                </div>
            </div>
        </div>


        <!-- Attendance Section (Original) -->
        <div id="attendance" class="section">
            <div class="card">
                <h2><span class="material-icons">schedule</span>Gestion des Présences (Manuel)</h2>
                <div class="form-row" style="margin-bottom: 16px;">
                    <div class="form-group">
                        <label>Date de Présence</label>
                        <input type="date" class="form-control" id="attendanceDate" onchange="displayAttendance()">
                    </div>
                    <div class="form-group">
                        <label style="visibility: hidden;">Actions</label>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="goToPreviousDay()">
                                <span class="material-icons">chevron_left</span>
                                Jour Précédent
                            </button>
                            <button class="btn btn-secondary" onclick="goToNextDay()">
                                <span class="material-icons">chevron_right</span>
                                Jour Suivant
                            </button>
                        </div>
                    </div>
                                    <!-- Champ de recherche d'employés pour la présence -->
                    <!-- RAFITRA VAOVAO NOHATSARAINA -->
                    <div class="filter-controls">
                        <!-- Fizarana Fikarohana -->
                        <div class="form-group search-group">
                            <label for="attendanceEmployeeSearch">Rechercher un employé</label>
                            <div class="search-container">
                                <span class="material-icons search-icon">search</span>
                                <input type="text" class="search-input" id="attendanceEmployeeSearch" placeholder="Taper un nom..." oninput="filterAttendanceEmployees()">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="attendanceGroupFilter">Filtrer par Groupe</label>
                            <select class="form-control" id="attendanceGroupFilter" onchange="displayAttendance()">
                                <option value="all">Tous les Groupes</option>
                                <!-- Ho fenoina ho azy amin'ny JavaScript -->
                            </select>
                        </div>

                        <!-- Fizarana Safidy Isan'ny Singa -->
                        <div class="form-group items-per-page-group">
                            <label for="attendanceItemsPerPageSelect">Éléments par page</label>
                            <select id="attendanceItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('attendance', this.value)">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>


                </div>
                <div id="attendanceList"></div>
                <div class="pagination-controls" id="attendancePagination">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>

                <button class="btn" onclick="saveAttendance()" style="margin-top: 16px;">
                    <span class="material-icons">save</span>
                    Enregistrer Présences
                </button>
            </div>
        </div>

        <!-- Advances Section -->
        <div id="advances" class="section">
            <div class="card">
                <h2><span class="material-icons">savings</span>Gestion des Avances</h2>
                <form id="advanceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Employé</label>
                            <div class="select-dropdown">
                                <select class="form-control" id="advanceEmployee" required>
                                    <option value="">Sélectionner un employé</option>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="startQRScan('advance')" title="Scanner QR">

                                    <span class="material-icons">qr_code_scanner</span>
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="startFaceScanForSelection('advance')" title="Scanner Visage">
                                    <span class="material-icons">face</span>
                                </button>

                            </div>
                        </div>

                        
                        <div class="form-group">
                            <label>Montant (Ar)</label>
                            <input type="text" class="form-control currency-input" id="advanceAmount" required data-type="currency">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-control" id="advanceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Motif/Observation</label>
                        <textarea class="form-control" id="advanceReason" rows="3" placeholder="Motif de l'avance..."></textarea>
                    </div>

                    <div id="netSalaryPreview" style="margin-bottom: 16px; padding: 10px; border-radius: 8px; background-color: var(--md-sys-color-surface); display: none;"></div>

                    <button type="submit" class="btn">
                        <span class="material-icons">add</span>
                        Ajouter Avance
                    </button>
                </form>
                <!-- ================== BLOC VAOVAO NAMPIDIRINA ================== -->
                <div id="advancesSummary" style="margin-top: 24px; margin-bottom: 16px; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px; border-left: 5px solid var(--md-sys-color-primary);">
                    <h4 style="margin-top: 0; margin-bottom: 8px; color: var(--md-sys-color-primary);">Résumé des Avances pour le Mois Sélectionné</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.1em; font-weight: 500;">Total des Avances:</span>
                        <span id="totalAdvancesMonth" style="font-size: 1.5em; font-weight: 700; color: var(--md-sys-color-error);">0 Ar</span>
                    </div>
                    <p id="advancesSummaryPeriod" style="font-size: 0.9em; color: var(--md-sys-color-on-surface-variant); margin: 8px 0 0 0; text-align: right;"></p>
                </div>

                <!-- FANAMPIANA VAOVAO: Bokotra Export -->
                <div style="margin-top: 24px; margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="exportAdvances('pdf')">
                        <span class="material-icons">picture_as_pdf</span>
                        Export PDF
                    </button>
                    <button class="btn btn-success" onclick="exportAdvances('xlsx')">
                        <span class="material-icons">table_view</span>
                        Export Excel
                    </button>

                </div>

                <!-- ============================================================ -->
                <!-- Fikarohana sy lisitra vaovao -->
                <div class="form-row" style="margin-top: 24px; align-items: flex-end;">
                    <div class="form-group">
                        <label for="advanceSearchInput">Rechercher par nom, poste ou motif</label>
                        <div class="search-container" style="margin-bottom: 0; position: relative;">
                            <span class="material-icons search-icon">search</span>
                            <input type="text" class="search-input" id="advanceSearchInput" placeholder="Taper pour filtrer..." style="padding-right: 60px;">
                            <!-- FANAMPIANA VAOVAO: Bokotra QR Scanner -->
                            <button type="button" class="btn btn-secondary" onclick="startQRScan('advances-search')" 
                                    title="Rechercher par QR Code" 
                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 8px; border-radius: 50%; min-width: 40px; height: 40px;">
                                <span class="material-icons">qr_code_scanner</span>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="advanceMonthFilter">Filtrer par mois</label>
                        <input type="month" class="form-control" id="advanceMonthFilter">
                    </div>
                    <div class="form-group">
                        <label for="advanceGroupFilter">Filtrer par Groupe</label>
                        <select class="form-control" id="advanceGroupFilter">
                            <option value="all">Tous les Groupes</option>
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </select>
                    </div>
                </div>

                <!-- FANAMPIANA VAOVAO HO AN'NY AVANCES -->
                <div class="form-group" style="max-width: 200px; margin-top: 16px;">
                    <label for="advancesItemsPerPageSelect">Éléments par page</label>
                    <select id="advancesItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('advances', this.value)">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                    </select>
                </div>


                <div id="advancesList" style="margin-top: 16px;"></div>
                <div class="pagination-controls" id="advancesPagination">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>


            </div>
        </div>

        <!-- Payroll Section -->
        <div id="payroll" class="section">
            <div class="card">
                <h2><span class="material-icons">payments</span>Gestion de la Paie</h2>
                
                <!-- Ovaina ity div ity -->
                <div class="form-row" style="align-items: flex-end;">

                    <!-- Fizarana 1: Fisafidianana Mpiasa (Tsy miova) -->
                    <div class="form-group">
                        <label>Sélectionner Employé</label>
                        <div class="select-dropdown" style="display: flex;">
                            <select class="form-control" id="payrollEmployeeSelect" onchange="handlePayrollEmployeeChange()">
                                <option value="">Tous les employés</option>
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="startQRScan('payroll')" title="Scanner QR">
                                <span class="material-icons">qr_code_scanner</span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="startFaceScanForSelection('payroll')" title="Scanner Visage">
                                <span class="material-icons">face</span>
                            </button>

                        </div>
                    </div>

                    <!-- Fizarana 2: FANAMPIANA SIVANA VONDROM-PIASA -->
                    <div class="form-group">
                        <label>Filtrer par Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="payrollGroupFilter" onchange="handlePayrollGroupChange()">
                                <option value="all">Tous les Groupes</option>
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </select>
                        </div>
                    </div>

                    <!-- Fizarana 3: Fisafidianana Volana (Tsy miova) -->
                    <div class="form-group">
                        <label>Mois</label>
                        <input type="month" class="form-control" id="payrollMonth" value="">
                    </div>

                    <!-- =================================================== -->
                    <!--         FANAMPIANA VAOVAO HO AN'NY ACOMPTE          -->
                    <!-- =================================================== -->
                    <div class="form-group" style="margin-top: 16px; padding: 12px; background-color: rgba(103, 80, 164, 0.08); border-radius: 8px;">
                        <label for="includeAdvanceCheckbox" style="display: flex; align-items: center; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="includeAdvanceCheckbox" class="checkbox" style="width: 20px; height: 20px; margin-right: 12px;" onchange="toggleAdvanceDaysInput()">
                            Inclure un acompte pour le mois suivant
                        </label>
                        <div id="advanceDaysContainer" class="form-group" style="display: none; margin-top: 12px; margin-bottom: 0;">
                            <label for="advanceDaysInput">Nombre de jours d'acompte</label>
                            <input type="number" id="advanceDaysInput" class="form-control" value="0" min="0" style="max-width: 150px;">
                        </div>
                    </div>
                    <!-- =================================================== -->

                </div>

                <button class="btn" onclick="calculatePayroll()">
                    <span class="material-icons">calculate</span>
                    Calculer Paie
                </button>

                <!-- =================================================== -->
                <!--      FIZARANA FAMINTINANA NOHATSARAINA (HTML)       -->
                <!-- =================================================== -->
                <div id="payrollSummary" style="margin-top: 24px; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px; display: none;">
                    <h3 style="color: var(--md-sys-color-primary); margin-top: 0; margin-bottom: 16px;">Résumé de la Paie pour la Période</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <p style="margin: 0; font-size: 0.9em; color: var(--md-sys-color-on-surface-variant);">Total Brut Calculé</p>
                            <strong id="summaryTotalGross" style="color: var(--md-sys-color-primary); font-size: 1.2em;">0 Ar</strong>
                        </div>
                        <div>
                            <p style="margin: 0; font-size: 0.9em; color: var(--md-sys-color-on-surface-variant);">Total Avances Déduites</p>
                            <strong id="summaryTotalAdvances" style="color: var(--md-sys-color-error); font-size: 1.2em;">0 Ar</strong>
                        </div>
                        <div>
                            <p style="margin: 0; font-size: 0.9em; color: var(--md-sys-color-on-surface-variant);">Total Net à Payer</p>
                            <strong id="summaryTotalNet" style="color: var(--md-sys-color-success); font-size: 1.3em; font-weight: 700;">0 Ar</strong>
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <p style="margin: 0; font-size: 0.8em; color: var(--md-sys-color-on-surface-variant);">Employés non payés:</p>
                        <div id="unpaidEmployeesList" style="font-size: 0.9em; max-height: 100px; overflow-y: auto;">
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </div>
                    </div>
                </div>
                <!-- =================================================== -->


                <div id="payrollResults"></div>
            </div>
        </div>


        <!-- Payments Section -->
        <div id="payments" class="section">
            <div class="card">
                <h2><span class="material-icons">history</span>Historique de Paiement</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Filtrer par Employé</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="paymentEmployeeFilter" onchange="displayPayments()">
                                <option value="">Tous les employés</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Recherche</label>
                        <input type="text" class="form-control" id="paymentSearch" placeholder="Rechercher...">
                    </div>
                </div>
                <div id="paymentList"></div>
            </div>
        </div>

        <!-- Solde de Tout Compte Section -->
        <div id="stc" class="section">
            <div class="card">
                <h2><span class="material-icons">exit_to_app</span>Calcul du Solde de Tout Compte</h2>
                <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                    Calculez et finalisez le paiement pour les employés qui quittent l'entreprise.
                </p>

                <div class="form-group">
                    <label>Sélectionner l'Employé (Départ Programmé)</label>
                    <div class="select-dropdown">
                        <select class="form-control" id="stcEmployeeSelect" onchange="calculateSTC()">
                            <option value="">-- Choisir un employé --</option>
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </select>
                    </div>
                </div>

                <div id="stcResultsContainer" style="margin-top: 24px; display: none;">
                    <!-- Ho fenoina amin'ny JavaScript ny vokatry ny kajy -->
                </div>
            </div>
        </div>


        <!-- Reports Section -->
        <div id="reports" class="section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">today</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="reportPresentToday">0</h3>
                        <p>Présents Aujourd'hui</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">calendar_month</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="reportPresentMonth">0</h3>
                        <p>Présences ce Mois</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">payments</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="reportSalariesPaid">0 Ar</h3>
                        <p>Salaires Payés</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-icons">people</span>
                    </div>
                    <div class="stat-content">
                        <h3 id="reportActiveEmployees">0</h3>
                        <p>Employés Actifs</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><span class="material-icons">analytics</span>Génération de Rapports</h2>
                
                <div class="form-group" style="max-width: 300px;">
                    <label for="reportMonth">Sélectionner le mois pour les rapports</label>
                    <input type="month" class="form-control" id="reportMonth">
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px;">
                    <button class="btn" onclick="exportGlobalReport()">
                        <span class="material-icons">download</span>
                        Export Global (JSON)
                    </button>
                    <button class="btn btn-secondary" onclick="exportAttendanceReport()">
                        <span class="material-icons">schedule</span>
                        Export Présences (JSON)
                    </button>
                    <button class="btn btn-warning" onclick="generatePayrollPDFReport()">
                        <span class="material-icons">picture_as_pdf</span>
                        Rapport de Paie (PDF)
                    </button>
                </div>
            </div>

        </div>
                <!-- ======================================================================= -->
        <!--            SECTION : ESTIMATION DES SALAIRES                      -->
        <!-- ======================================================================= -->
        <div id="estimation" class="section">
            <div class="card">
                <h2><span class="material-icons">request_quote</span>Estimation des Salaires</h2>
                <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                    Calculez une estimation du coût salarial total pour une période future.
                </p>

                <!-- Sehatra fisafidianana -->
                <div class="form-row" style="align-items: flex-end; margin-bottom: 16px;">
                    <div class="form-group">
                        <label for="estimationStartDate">Date de Début</label>
                        <input type="date" class="form-control" id="estimationStartDate">
                    </div>
                    <div class="form-group">
                        <label for="estimationEndDate">Date de Fin</label>
                        <input type="date" class="form-control" id="estimationEndDate">
                    </div>
                    <div class="form-group">
                        <label for="estimationGroupFilter">Filtrer par Groupe</label>
                        <select class="form-control" id="estimationGroupFilter">
                            <option value="all">Tous les Groupes</option>
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="calculateSalaryEstimation()">
                    <span class="material-icons">calculate</span>
                    Lancer l'Estimation
                </button>

                <!-- Fizarana fampisehoana ny valiny -->
                <div id="estimationResultsContainer" style="margin-top: 24px; display: none;">
                    <!-- Ho fenoina amin'ny JavaScript -->
                </div>
            </div>
        </div>

    </div>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="modal-header">
            <h3><span class="material-icons">settings</span>Paramètres</h3>
            <button class="close-btn" onclick="toggleSettings()">
                <span class="material-icons">close</span>
            </button>
        </div>

        <div class="settings-section">
            <h3><span class="material-icons">palette</span>Apparence</h3>
            <div class="form-group">
                <label>Thème</label>
                <div class="select-dropdown">
                    <select class="form-control" id="themeSelect" onchange="changeTheme(this.value)">
                        <option value="light">Clair</option>
                        <option value="dark">Sombre</option>
                        <option value="auto">Automatique</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3><span class="material-icons">qr_code</span>QR Code</h3>
            <div class="form-group">
                <label>Taille des QR Codes</label>
                <select class="form-control" id="qrSizeSelect" onchange="updateQRSettings()">
                    <option value="128">Petit (128px)</option>
                    <option value="256" selected>Moyen (256px)</option>
                    <option value="512">Grand (512px)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Couleur QR Code</label>
                <input type="color" class="form-control" id="qrColorSelect" value="#6750A4" onchange="updateQRSettings()">
            </div>
        </div>

        <div class="settings-section">
            

            <!-- =================================================== -->
            <!--       FIZARANA VAOVAO HO AN'NY SYNCHRONISATION       -->
            <!-- =================================================== -->
            <div class="settings-section">
                <h3><span class="material-icons">import_export</span>Synchronisation & Sauvegarde</h3>
                
                <div class="alert alert-info">
                    <span class="material-icons">info</span>
                    <div>
                        <strong>Fomba Fampiasana (Synchronisation):</strong>  

                        1. <strong>(Source)</strong> Tsindrio "Télécharger les Données" hamorona rakitra.  

                        2. Alefaso amin'ny fitaovana hafa ilay rakitra (USB, Email, sns).  

                        3. <strong>(Destination)</strong> Tsindrio "Importer les Données" ary safidio ilay rakitra.
                    </div>
                </div>

                <button class="btn" onclick="exportData()" style="width: 100%; margin-bottom: 12px; background-color: var(--md-sys-color-primary);">
                    <span class="material-icons">file_download</span>
                    Télécharger les Données (Export)
                </button>
                
                <div class="form-group">
                    <label for="importFile" style="cursor: pointer; display: block; padding: 12px; background-color: var(--md-sys-color-secondary-container); text-align: center; border-radius: 8px;">
                        <span class="material-icons">file_upload</span>
                        Importer les Données (Import)
                    </label>
                    <input type="file" class="form-control" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
                </div>
                <p id="lastBackupInfo" style="font-size: 12px; text-align: center; color: var(--md-sys-color-on-surface-variant);"></p>
            </div>

        </div>

        <div class="settings-section">
            <h3><span class="material-icons">delete_forever</span>Réinitialisation</h3>
            <p style="
                margin-bottom:8px;
                font-size: 11px;
                color: var(--md-sys-color-on-surface-variant);
                font-style: italic;
            ">
                Hamafa tanteraka ny angona rehetra ao amin'ny rafitra
                (employés, présences, paie, avances, groupes, QR, paramètres).
            </p>

            <button class="btn btn-danger" onclick="resetAllData()" style="width:100%;">
                <span class="material-icons">delete_forever</span>
                Reset total des données
            </button>
        </div>

        <!-- FANAMPIANA VAOVAO: Fizarana "À Propos" ao anatin'ny Settings -->
        <div class="settings-section" style="margin-top: 40px; text-align: center; opacity: 0.8;">
            <h3 style="justify-content: center;">
                <span class="material-icons">code</span>
                Mombamomba ny Fampiharana
            </h3>
            <p style="font-size: 14px; margin-top: 8px;">
                Noforonin'i Rado Arijao tamim-pitiavana.
            </p>
            <p style="font-size: 12px; margin-top: 4px;">
                Version 1.0.0 &copy; 2025
            </p>
            <!-- Azonao ampiana rohy mankany amin'ny portfolio-nao raha tianao -->
            <!-- <a href="https://www.ny-tranokalanao.com" target="_blank" class="btn" style="margin-top: 12px;">Portfolio</a> -->
        </div>

    </div>

    <!-- Modals -->
    <div class="modal" id="editEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier Employé</h3>
                <button class="close-btn" onclick="closeModal('editEmployeeModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="editEmployeeForm">
                <input type="hidden" id="editEmployeeId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom Complet</label>
                        <input type="text" class="form-control" id="editEmployeeName" required>
                    </div>
                    <div class="form-group">
                        <label>Poste</label>
                        <input type="text" class="form-control" id="editEmployeePosition" required>
                    </div>
                    <!-- ... aorian'ny div-n'ny editEmployeePosition ... -->
                    <div class="form-group">
                        <label>Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="editEmployeeGroup">
                                <option value="">Aucun groupe</option>
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </select>
                        </div>
                    </div>
                    <!-- ... alohan'ny div-n'ny editEmployeeGender ... -->

                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Genre</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="editEmployeeGender" required>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Salaire Mensuel (Ar)</label>
                        <input type="text" class="form-control currency-input" id="editEmployeeSalary" required data-type="currency">
                    </div>
                </div>
                <div class="form-group">
                    <label>Statut de l'Employé</label>
                    <div class="select-dropdown">
                        <select class="form-control" id="editEmployeeStatus">
                            <option value="actif">Actif</option>
                            <option value="depart">Départ Programmé</option>
                            <option value="inactif">Inactif (A quitté)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="editDepartureDateContainer" style="display: none;">
                    <label>Date de Départ</label>
                    <input type="date" class="form-control" id="editEmployeeDepartureDate">
                </div>
                <button type="submit" class="btn">
                    <span class="material-icons">save</span>
                    Sauvegarder
                </button>
            </form>
        </div>
    </div>

    <!-- Modal ho an'ny Fanovana Trosa (Avance) -->
    <div class="modal" id="editAdvanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier une Avance</h3>
                <button class="close-btn" onclick="closeModal('editAdvanceModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="editAdvanceForm">
                <input type="hidden" id="editAdvanceId">
                
                <div class="form-group">
                    <label>Employé</label>
                    <p id="editAdvanceEmployeeName" style="font-weight: 500; font-size: 1.1rem;"></p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nouveau Montant (Ar)</label>
                        <input type="text" class="form-control currency-input" id="editAdvanceAmount" required data-type="currency">
                    </div>
                    <div class="form-group">
                        <label>Date de l'avance</label>
                        <input type="date" class="form-control" id="editAdvanceDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Motif/Observation</label>
                    <textarea class="form-control" id="editAdvanceReason" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn">
                    <span class="material-icons">save</span>
                    Enregistrer les modifications
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL VAOVAO HO AN'NY FANAMPIANA MPIASA -->
    <div class="modal" id="addEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><span class="material-icons">person_add</span> Ajouter un Nouvel Employé</h3>
                <button class="close-btn" onclick="closeModal('addEmployeeModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="employeeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom Complet</label>
                        <input type="text" class="form-control" id="employeeName_add" required>
                    </div>
                    <div class="form-group">
                        <label>Poste</label>
                        <input type="text" class="form-control" id="employeePosition_add" required>
                    </div>
                    <div class="form-group">
                        <label>Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="employeeGroup_add">
                                <option value="">Aucun groupe</option>
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Genre</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="employeeGender_add" required>
                                <option value="">Sélectionner</option>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Salaire Mensuel (Ar)</label>
                        <input type="text" class="form-control currency-input" id="employeeSalary_add" required data-type="currency">
                    </div>
                </div>
                <button type="submit" class="btn">
                    <span class="material-icons">add</span>
                    Ajouter Employé
                </button>
            </form>
        </div>
    </div>

    <!-- ========================================================== -->
    <!--      MODAL VAOVAO HO AN'NY SCANNER QR (IRAIZAN'NY REHETRA)      -->
    <!-- ========================================================== -->    <div class="modal" id="qrScannerModal">
        <div class="modal-content qr-modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="qrScannerTitle" style="display: flex; align-items: center; gap: 8px; font-size: clamp(1rem, 4vw, 1.3rem);"><span class="material-icons">qr_code_scanner</span> Scanner le QR Code</h3>
                <button class="close-btn" onclick="stopQRScan()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <div class="qr-modal-body" style="text-align: center; padding: 12px 0;">
                <p id="qrScannerInstruction" style="margin-bottom: 12px; color: var(--md-sys-color-on-surface-variant); font-size: 0.9rem; line-height: 1.2;">
                    Veuillez pointer la caméra vers le QR Code de l'employé.
                </p>

                <div class="video-container qr-video-container">
                    <video id="qrVideo" playsinline autoplay muted style="width: 100%; border-radius: 8px; display: none;"></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                    <div class="scan-overlay" id="scanOverlay" style="display: none;"></div>
                </div>
                
                <div id="cameraPermissionMessage" class="alert alert-warning" style="display: none; justify-content: center; margin-top: 12px; padding: 8px; font-size: 0.85rem;">
                    <span class="material-icons" style="font-size: 18px;">videocam_off</span>
                    <span>Mila fahazoan-dàlana hampiasa ny fakantsary.</span>
                </div>

                <div id="scanResult" class="scan-result" style="display: none; margin-top: 12px; padding: 8px; font-size: 0.9rem;"></div>
            </div>

            <div style="text-align: center; margin-top: 8px; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 12px;">
                <button class="btn btn-danger" onclick="stopQRScan()" style="width: 100%; max-width: 200px; padding: 10px;">
                    <span class="material-icons">cancel</span>
                    Annuler le Scan
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // INDEXEDDB MANAGER CLASS (identique à l'original)
        // ===============================
        class IndexedDBManager {
            constructor() {
                this.db = null;
                this.dbName = 'BehavanaHRSystem';
                this.version = 4; // Augmenter la version pour les nouvelles tables
                this.isInitialized = false;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => {
                        console.error('Erreur lors de l\'ouverture de la base de données:', request.error);
                        this.updateDBStatus('Erreur de connexion à la base de données', 'error');
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        this.isInitialized = true;
                        this.updateDBStatus('Base de données connectée', 'connected');
                        console.log('Base de données IndexedDB initialisée avec succès');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // 1. Famoronana ny table "groups"
                        if (!db.objectStoreNames.contains('groups')) {
                            const groupStore = db.createObjectStore('groups', { keyPath: 'id' });
                            groupStore.createIndex('name', 'name', { unique: true });
                            console.log('✅ ObjectStore "groups" créé.');
                        }

                        // 2. Fanamarinana sy fanampiana index "groupId" amin'ny table "employees"
                        // Ity fomba ity dia miantoka fa tsy misy erreur na efa misy aza ny table employees
                        if (db.objectStoreNames.contains('employees')) {
                            const employeeStore = event.target.transaction.objectStore('employees');
                            if (!employeeStore.indexNames.contains('groupId')) {
                                employeeStore.createIndex('groupId', 'groupId', { unique: false });
                                console.log('✅ Index "groupId" ajouté à "employees".');
                            }
                        }
                        
                        // Créer les stores (tables) existantes
                        if (!db.objectStoreNames.contains('employees')) {
                            const employeeStore = db.createObjectStore('employees', { keyPath: 'id' });
                            employeeStore.createIndex('name', 'name', { unique: false });
                            employeeStore.createIndex('position', 'position', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('attendance')) {
                            const attendanceStore = db.createObjectStore('attendance', { keyPath: 'date' });
                            attendanceStore.createIndex('date', 'date', { unique: true });
                        }

                        if (!db.objectStoreNames.contains('payrolls')) {
                            const payrollStore = db.createObjectStore('payrolls', { keyPath: 'id' });
                            payrollStore.createIndex('employeeId', 'employeeId', { unique: false });
                            payrollStore.createIndex('month', 'month', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('advances')) {
                            const advanceStore = db.createObjectStore('advances', { keyPath: 'id' });
                            advanceStore.createIndex('employeeId', 'employeeId', { unique: false });
                            advanceStore.createIndex('date', 'date', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }

                        // Nouvelles tables pour QR Code
                        if (!db.objectStoreNames.contains('qr_attendance')) {
                            const qrAttendanceStore = db.createObjectStore('qr_attendance', { keyPath: 'id' });
                            qrAttendanceStore.createIndex('employeeId', 'employeeId', { unique: false });
                            qrAttendanceStore.createIndex('date', 'date', { unique: false });
                            qrAttendanceStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('qr_codes')) {
                            const qrCodesStore = db.createObjectStore('qr_codes', { keyPath: 'employeeId' });
                            qrCodesStore.createIndex('generated', 'generated', { unique: false });
                        }

                        console.log('Structures de base de données créées avec support QR Code');
                    };
                });
            }

            updateDBStatus(message, type = 'connected') {
                const statusElement = document.getElementById('dbStatus');
                const textElement = document.getElementById('dbStatusText');
                
                if (statusElement && textElement) {
                    statusElement.className = `db-status ${type}`;
                    textElement.textContent = message;
                } else {
                    console.log(`Status DB: ${message} (${type})`);
                }
            }

            // Méthodes CRUD génériques (identiques à l'original)
            async add(storeName, data) {
                if (!this.isInitialized) {
                    throw new Error('Base de données non initialisée');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async put(storeName, data) {
                if (!this.isInitialized) {
                    throw new Error('Base de données non initialisée');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async get(storeName, key) {
                if (!this.isInitialized) {
                    throw new Error('Base de données non initialisée');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                if (!this.isInitialized) {
                    throw new Error('Base de données non initialisée');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, key) {
                if (!this.isInitialized) {
                    throw new Error('Base de données non initialisée');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                if (!this.isInitialized) {
                    throw new Error('Base de données non initialisée');
                }

                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // ===============================
        // APPLICATION STATE & VARIABLES
        // ===============================
        let dbManager = new IndexedDBManager();
        let weeklyAttendanceChartInstance = null;
        let genderDistributionChartInstance = null;
        let groupDistributionChartInstance = null;
        let employees = [];
        // Variables ho an'ny pagination
        let employeeCurrentPage = 1;
        let employeeItemsPerPage = 20;

        let attendanceCurrentPage = 1;
        let attendanceItemsPerPage = 20;

        let advancesCurrentPage = 1;
        let advancesItemsPerPage = 15;

        let qrAttendanceCurrentPage = 1;
        let qrAttendanceItemsPerPage = 15; // Azo ovaina raha tiana


        let groups = [];
        let attendance = {};
        let payrolls = [];
        let advances = [];
        let qrAttendance = []; // Nouvelles données QR
        let qrCodes = {}; // Stockage des QR codes générés
        let currentTheme = 'light';
        let isScanning = false;
        let scanInterval = null;
        let qrSettings = {
            size: 256,
            color: '#6750A4'
        };


        // ===============================
        // APPLICATION STATE & VARIABLES (FANAMPIANA)
        // ===============================
        let currentScanPurpose = null; // 'attendance', 'advance', 'payroll'
        let scanStream = null; // Tehirizina eto ny stream-n'ny caméra

        // Fanomanana ny feo
        let audioContext;
        let successSoundBuffer;
        let nextSoundBuffer;


        //========================================================
        //  PERFORMANCE: Virtualization ho an'ny lisitry ny mpiasa
        //========================================================
        let displayedEmployeesCount = 0;
        const employeesPerPage = 25; // Isan'ny mpiasa aseho isaky ny mandeha
        // =================================================================
        //  GESTION DU SON (VERSION 6 - "TRITONE" STYLE IPHONE NATAO TAMIN'NY JS)
        // =================================================================

        // Ity fonction ity dia antsoina indray mandeha fotsiny
        function initializeAudio() {
            try {
                // Amboarina mba tsy hisy "warning" amin'ny navigateur sasany
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Ny navigateur sasany (Chrome) dia mitaky "interaction" avy amin'ny mpampiasa
                // vao mamela ny feo handeha. Ity no mamaha an'izany.
                if (audioContext.state === 'suspended') {
                    const resume = () => {
                        audioContext.resume();
                        document.body.removeEventListener('click', resume);
                        document.body.removeEventListener('touchstart', resume);
                    };
                    document.body.addEventListener('click', resume);
                    document.body.addEventListener('touchstart', resume);
                }
            } catch (e) {
                console.error("Tsy afaka namorona AudioContext:", e);
            }
        }

        // =====================================================
        // === AUDIO FUNCTIONS - VERSION FINALE ===
        // =====================================================

        // Ity no mamorona sy mandefa ny feo "Tritone"
        function playSuccessSound() {
            if (!audioContext) {
                console.warn("AudioContext tsy vonona, tsy misy feo.");
                return;
            }

            try {
                const now = audioContext.currentTime;
                const gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.5, now); // Hamafin'ny feo (tsy mafy loatra)

                // Ireo naoty telo mandrafitra ny "Tritone"
                // Naoty 1: A4 (La) - 440 Hz
                const osc1 = audioContext.createOscillator();
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(440, now);
                osc1.connect(gainNode);
                osc1.start(now);
                osc1.stop(now + 0.1); // Maharitra 0.1 segondra

                // Naoty 2: C#5 (Do dièse) - 554.37 Hz
                const osc2 = audioContext.createOscillator();
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(554.37, now + 0.1);
                osc2.connect(gainNode);
                osc2.start(now + 0.1);
                osc2.stop(now + 0.2);

                // Naoty 3: F#5 (Fa dièse) - 739.99 Hz
                const osc3 = audioContext.createOscillator();
                osc3.type = 'sine';
                osc3.frequency.setValueAtTime(739.99, now + 0.2);
                osc3.connect(gainNode);
                osc3.start(now + 0.2);
                osc3.stop(now + 0.5); // Maharitra kely kokoa ity farany

            } catch (e) {
                console.error("Tsy afaka nandefa feo:", e);
            }
        }

        // =====================================================
        // PLAY ERROR SOUND - efateo.mp3
        // =====================================================
        function playErrorSound() {
            try {
                // ✅ FANITSIANA 1: Hampiasa audio player miaraka amin'ny error handling
                let audioPlayer = document.getElementById('audioPlayerError');
                
                if (!audioPlayer) {
                    audioPlayer = new Audio('efateo.mp3');
                    audioPlayer.id = 'audioPlayerError';
                    audioPlayer.style.display = 'none';
                    audioPlayer.volume = 0.7; // 70% volume
                    document.body.appendChild(audioPlayer);
                }
                
                // Reset position
                audioPlayer.currentTime = 0;
                
                // Play with promise handling
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn('⚠️ Erreur lecture efateo.mp3:', error);
                        
                        // Fallback: Son error synthétique
                        if (audioContext && audioContext.state === 'running') {
                            const now = audioContext.currentTime;
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.value = 300;
                            oscillator.type = 'sawtooth';
                            
                            gainNode.gain.setValueAtTime(0.3, now);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                            
                            oscillator.start(now);
                            oscillator.stop(now + 0.5);
                        }
                    });
                }
                
            } catch (e) {
                console.error('❌ Audio error:', e);
            }
        }

        // =====================================================
        // PLAY AU SUIVANT SOUND - suivant.mp3
        // =====================================================
        function playAuSuivantSound() {
            try {
                // Hamarino aloha raha efa noforonina ilay singa audio
                let audioPlayer = document.getElementById('audioPlayerAuSuivant');
                
                if (!audioPlayer) {
                    // Raha mbola tsy misy dia amboary izy ary afeno.
                    audioPlayer = new Audio('suivant.mp3'); 
                    audioPlayer.id = 'audioPlayerAuSuivant';
                    audioPlayer.style.display = 'none';
                    audioPlayer.volume = 0.8; // 80% volume
                    document.body.appendChild(audioPlayer);
                }

                // Mba hahafahana mamerina mandefa azy avy hatrany raha vao avy nandeha teo
                audioPlayer.currentTime = 0; 
                
                // Alefa ny feo
                const playPromise = audioPlayer.play();

                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn("⚠️ Tsy afaka nandefa ny feo 'suivant.mp3':", error);
                        
                        // Fallback: Tritone sound
                        if (audioContext && audioContext.state === 'suspended') {
                            audioContext.resume().then(() => {
                                audioPlayer.play().catch(() => {
                                    // Si toujours erreur, utiliser playSuccessSound
                                    playSuccessSound();
                                });
                            });
                        } else {
                            // Utiliser le son synthétique
                            playSuccessSound();
                        }
                    });
                }
                
            } catch (e) {
                console.error('❌ Audio error:', e);
                // Fallback final
                playSuccessSound();
            }
        }

        async function resetAllData() {
            if (!dbManager || !dbManager.isInitialized) {
                alert("Base de données non initialisée.");
                return;
            }

            if (!confirm(
                "Hamafa tanteraka ny angona rehetra (employés, présences, paie, avances, groupes, QR, paramètres) ve ianao ?"
            )) {
                return;
            }

            try {
                const stores = [
                    "groups",
                    "employees",
                    "attendance",
                    "payrolls",
                    "advances",
                    "settings",
                    "qr_attendance",
                    "qr_codes"
                ];

                // 1. Fafao ao amin'ny IndexedDB
                for (const store of stores) {
                    await dbManager.clear(store);
                }

                // 2. Diovy ny variables en mémoire
                employees      = [];
                groups         = [];
                attendance     = {};
                payrolls       = [];
                advances       = [];
                qr_attendance  = [];
                qr_codes       = [];

                // 3. Havaozy avy hatrany ny UI (sections rehetra)
                if (typeof updateStatistics      === "function") updateStatistics();
                if (typeof displayEmployees      === "function") displayEmployees();
                if (typeof displayAttendance     === "function") displayAttendance();
                if (typeof displayAdvances       === "function") displayAdvances();
                if (typeof displayQRAttendance   === "function") displayQRAttendance();
                if (typeof displayPayments       === "function") displayPayments();
                if (typeof displayGroups         === "function") displayGroups();
                if (typeof updateReportStats     === "function") updateReportStats();

                // 4. Fafao ny containers sasany raha ilaina
                ["payrollResults",
                "payrollSummary",
                "employeeStatusResults",
                "smartSearchResults",
                "advancesSummary",
                "qrContainer"
                ].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = "";
                });

                showAlert("Remise à zéro vita soa aman-tsara.", "success");
                console.log("Existing stores:", Array.from(dbManager.db.objectStoreNames));
            } catch (e) {
                console.error("Erreur reset:", e);
                showAlert("Nisy olana tamin'ny reset.", "error");
            }
        }


        // ===============================
        // INITIALIZATION
        // ===============================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('🔄 Initialisation du système RH avec QR Code...');
                initializeAudio();
                await dbManager.init();
                console.log('✅ IndexedDB initialisé');
                
                await loadData();
                console.log('✅ Données chargées');
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                updateStats();
                setCurrentDate();
                setCurrentMonth();
                populateEmployeeSelects(); // Antsoina tsy misy sivana mba hampisehoana ny mpiasa rehetra amin'ny voalohany
                populateGroupSelects();
                initializeTheme();
                initializeCurrencyInputs();
                initializeQRFunctionality();
                updateLastBackupInfo();
                displayDashboardCharts();
                runSmartChecks();
                console.log('🚀 Système RH avec QR Code initialisé avec succès');

                console.log('✅ Interface initialisée avec QR Code');

                const nameInput = document.getElementById('employeeName');
                if (nameInput) {
                    nameInput.addEventListener('input', function () {
                        this.value = capitalizeWords(this.value);
                    });
                }

                const positionInput = document.getElementById('employeePosition');
                if (positionInput) {
                    positionInput.addEventListener('input', function () {
                        this.value = capitalizeWords(this.value);
                    });
                }

                console.log('🚀 Système RH avec QR Code initialisé avec succès');
                
            } catch (error) {
                console.error('❌ Erreur lors de l\'initialisation:', error);
                dbManager.updateDBStatus('Erreur d\'initialisation', 'error');
                showAlert('Erreur lors de l\'initialisation de la base de données', 'error');
            }

            // ===================================================
            //  FANITSINA: Mampifandray ny formulaire fanovana
            // ==================================================
            document.getElementById('editEmployeeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const employeeId = document.getElementById('editEmployeeId').value;
                const newName = capitalizeWords(document.getElementById('editEmployeeName').value.trim());
                const newPosition = capitalizeWords(document.getElementById('editEmployeePosition').value.trim());
                const newGender = document.getElementById('editEmployeeGender').value;
                const newSalary = getCurrencyValue('editEmployeeSalary');
                const newGroupId = document.getElementById('editEmployeeGroup').value;

                // Alaina ny sanda avy amin'ireo sehatra voaitsy
                const newStatus = document.getElementById('editEmployeeStatus').value;
                const newDepartureDate = document.getElementById('editEmployeeDepartureDate').value || null;

                if (!employeeId || !newName || !newPosition || newSalary === 0) {
                    showAlert("Veuillez remplir tous les champs correctement.", 'error');
                    return;
                }

                const employeeIndex = employees.findIndex(emp => emp.id === employeeId);
                if (employeeIndex === -1) {
                    showAlert("Erreur: Employé non trouvé.", 'error');
                    return;
                }

                // Havaozina ny fampahalalana rehetra
                employees[employeeIndex].name = newName;
                employees[employeeIndex].position = newPosition;
                employees[employeeIndex].gender = newGender;
                employees[employeeIndex].salary = newSalary;
                employees[employeeIndex].groupId = newGroupId || null;
                employees[employeeIndex].status = newStatus;
                employees[employeeIndex].departureDate = newDepartureDate;

                await saveData();
                closeModal('editEmployeeModal');
                displayEmployees();
                updateStats();
                populateEmployeeSelects();
                showAlert("Les informations de l'employé ont été mises à jour avec succès!", 'success');
            });


            // ===================================================
            //  FANAMPINY HO AN'NY SMART SEARCH (STATUT EMPLOYÉ)
            // ===================================================
            const smartSearchInput = document.getElementById('smartSearchInput');
            const statsMonthInput = document.getElementById('statsMonth');

            // Mametraka ny volana ankehitriny ho default
            if (statsMonthInput) {
                statsMonthInput.value = new Date().toISOString().slice(0, 7);
            }

            // Mampifandray ny hetsika amin'ny sehatra fikarohana
            if (smartSearchInput) {
                smartSearchInput.addEventListener('input', debounce(handleSmartSearch, 300));
            }
            
            // Mampifandray ny hetsika amin'ny fanovana volana
            if (statsMonthInput) {
                statsMonthInput.addEventListener('change', () => {
                    // Raha efa misy tatitra miseho, havaozina izany
                    if (document.getElementById('employeeStatusResults').innerHTML !== '' && document.getElementById('employeeStatusResults').innerText.trim() !== '') {
                        const currentEmployeeName = document.getElementById('smartSearchInput').value;
                        const employee = employees.find(e => e.name === currentEmployeeName);
                        if (employee) {
                            displayEmployeeStatus(employee.id);
                        }
                    }
                });
            }
            // --- FARAN'NY FANAMPINY ---

            // Mampifandray ny formulaire fanovana trosa
            document.getElementById('editAdvanceForm').addEventListener('submit', handleUpdateAdvance);

            // Mampifandray ny sehatra fikarohana mba hi-filtrer avy hatrany
            document.getElementById('advanceSearchInput').addEventListener('input', displayAdvances);
            document.getElementById('advanceMonthFilter').addEventListener('change', displayAdvances);

            // Mametraka ny volana ankehitriny ho default
            const advanceMonthFilter = document.getElementById('advanceMonthFilter');
            if (advanceMonthFilter) {
                advanceMonthFilter.value = new Date().toISOString().slice(0, 7);
            }

            // Averina amin'ny pejy 1 rehefa misy fikarohana vaovao
            document.getElementById('employeeSearch').addEventListener('input', () => {
                employeeCurrentPage = 1;
                displayEmployees();
            });

            document.getElementById('employeeGroupFilter').addEventListener('change', () => {
                employeeCurrentPage = 1;
                displayEmployees();
            });

            // --- Event Listeners ho an'ny Fizarana Présence ---
            document.getElementById('attendanceDate').addEventListener('change', () => {
                attendanceCurrentPage = 1;
                displayAttendance();
            });
            document.getElementById('attendanceEmployeeSearch').addEventListener('input', () => {
                attendanceCurrentPage = 1;
                displayAttendance();
            });

            // --- Event Listeners ho an'ny Fizarana Avances ---
            document.getElementById('advanceSearchInput').addEventListener('input', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });
            document.getElementById('advanceMonthFilter').addEventListener('change', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });

            // Ampio ity ao amin'ny lisitry ny event listeners
            document.getElementById('advanceGroupFilter').addEventListener('change', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });
        });


        // ===============================
        // QR CODE FUNCTIONALITY
        // ===============================
        function initializeQRFunctionality() {
            // Définir la date actuelle pour le scanner QR
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('qrAttendanceDate').value = today;
            
            // Charger les présences QR d'aujourd'hui
            displayQRAttendance();
        }

        // Générer QR Code pour un employé (version alternative qui fonctionne)
        // =================================================================
        //  NOUVELLE FONCTION generateQRCode AVEC LA LIBRAIRIE QRCode.js
        // =================================================================
        // === GÉNÉRATION QR CODE - ANDROID COMPATIBLE VERSION ===
        function generateQRCode(employee, size = 256, color = '#6750A4') {
            return new Promise((resolve, reject) => {
                try {
                    // Créer conteneur temporaire
                    const tempDiv = document.createElement('div');
                    tempDiv.style.display = 'none';
                    tempDiv.id = `qr-temp-${employee.id}`;
                    document.body.appendChild(tempDiv);
                    
                    // Données QR
                    const qrDataString = `BEHAVANAHR:${employee.id}`;
                    
                    // Générer QR code
                    new QRCode(tempDiv, {
                        text: qrDataString,
                        width: size,
                        height: size,
                        colorDark: color,
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    
                    // Attendre et récupérer
                    setTimeout(() => {
                        try {
                            const canvas = tempDiv.querySelector('canvas');
                            
                            if (canvas) {
                                const dataURL = canvas.toDataURL('image/png', 0.9);
                                document.body.removeChild(tempDiv);
                                resolve(dataURL);
                            } else {
                                console.error('Canvas non trouvé pour', employee.name);
                                document.body.removeChild(tempDiv);
                                resolve(null);
                            }
                        } catch (err) {
                            console.error('Erreur canvas:', err);
                            if (document.body.contains(tempDiv)) {
                                document.body.removeChild(tempDiv);
                            }
                            resolve(null);
                        }
                    }, 300);
                    
                } catch (error) {
                    console.error('Erreur QR pour', employee.name, ':', error);
                    resolve(null);
                }
            });
        }



        // Alternative complète sans bibliothèque externe - QR Code simple
        function generateSimpleQRCode(employee, size = 256, color = '#6750A4') {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;

                // Créer un QR code visuel simple avec pattern
                const qrData = `${employee.id}|${employee.name}|BEHAVANA`;
                
                // Fond blanc
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, size, size);
                
                // Bordure
                ctx.strokeStyle = color;
                ctx.lineWidth = 8;
                ctx.strokeRect(4, 4, size-8, size-8);
                
                // Pattern de QR Code simplifié
                const cellSize = (size - 40) / 15; // 15x15 grid
                ctx.fillStyle = color;
                
                // Coins de positionnement (comme un vrai QR code)
                function drawPositionMarker(x, y) {
                    // Carré extérieur
                    ctx.fillRect(x, y, cellSize * 7, cellSize * 7);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(x + cellSize, y + cellSize, cellSize * 5, cellSize * 5);
                    ctx.fillStyle = color;
                    ctx.fillRect(x + cellSize * 2, y + cellSize * 2, cellSize * 3, cellSize * 3);
                }
                
                drawPositionMarker(20, 20); // Coin haut-gauche
                drawPositionMarker(20, size - 20 - cellSize * 7); // Coin bas-gauche
                drawPositionMarker(size - 20 - cellSize * 7, 20); // Coin haut-droit
                
                // Pattern central basé sur l'ID de l'employé
                const hash = employee.id.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0);
                
                // Générer un pattern unique basé sur le hash
                for (let i = 0; i < 15; i++) {
                    for (let j = 0; j < 15; j++) {
                        // Éviter les coins de positionnement
                        const isCorner = (i < 9 && j < 9) || (i < 9 && j > 5) || (i > 5 && j < 9);
                        if (!isCorner) {
                            // Pattern pseudo-aléatoire basé sur position et hash
                            if ((i + j + hash) % 3 === 0) {
                                ctx.fillRect(20 + i * cellSize, 20 + j * cellSize, cellSize, cellSize);
                            }
                        }
                    }
                }
                
                // Texte centré
                ctx.fillStyle = color;
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(employee.name, size/2, size - 15);
                
                // ID en petit
                ctx.font = '8px Arial';
                ctx.fillText(`ID: ${employee.id}`, size/2, size - 5);
                
                resolve(canvas);
            });
        }

        // =================================================================
        
        // === GÉNÉRATION TOUS LES QR - VERSION ROBUSTE ===
        async function generateAllQRCodes() {
            const container = document.getElementById('qrContainer');
            
            console.log('🚀 Début génération, Employés:', employees.length);
            
            // Vérification préalable
            if (!employees || employees.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <span class="material-icons" style="font-size: 64px; color: #94a3b8; opacity: 0.5;">person_off</span>
                        <h3 style="margin-top: 20px; color: #475569;">Aucun employé trouvé</h3>
                        <p style="color: #94a3b8; margin-top: 10px;">Ajoutez des employés d'abord</p>
                    </div>
                `;
                return;
            }
            
            // État chargement
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div class="loading"></div>
                    <h3 style="margin-top: 20px; color: var(--md-sys-color-primary); font-weight: 700;">
                        Génération en cours...
                    </h3>
                    <p style="color: var(--md-sys-color-on-surface-variant); margin-top: 10px; font-size: 15px;">
                        ⏳ ${employees.length} employé${employees.length > 1 ? 's' : ''} à traiter
                    </p>
                    <p id="progressText" style="color: var(--md-sys-color-primary); margin-top: 8px; font-weight: 600;">
                        0 / ${employees.length}
                    </p>
                </div>
            `;
            
            try {
                const qrCardsHTML = [];
                let successCount = 0;
                let errorCount = 0;
                
                // Générer un par un
                for (let i = 0; i < employees.length; i++) {
                    const employee = employees[i];
                    
                    // Mise à jour progrès
                    const progressText = document.getElementById('progressText');
                    if (progressText) {
                        progressText.textContent = `${i + 1} / ${employees.length}`;
                    }
                    
                    try {
                        console.log(`📝 Génération QR pour: ${employee.name}`);
                        
                        // Générer QR
                        const dataURL = await generateQRCode(employee, qrSettings.size, qrSettings.color);
                        
                        if (dataURL && dataURL.startsWith('data:image')) {
                            console.log(`✅ QR généré pour ${employee.name}`);
                            
                            // Sauvegarder dans DB
                            try {
                                await dbManager.put('qr_codes', {
                                    employeeId: employee.id,
                                    employeeName: employee.name,
                                    employeePosition: employee.position,
                                    employeeGroupId: employee.groupId,
                                    dataURL: dataURL,
                                    generated: new Date().toISOString(),
                                    size: qrSettings.size,
                                    color: qrSettings.color
                                });
                                console.log(`💾 QR sauvegardé pour ${employee.name}`);
                            } catch (dbErr) {
                                console.warn(`⚠️ Sauvegarde DB échouée pour ${employee.name}:`, dbErr);
                            }
                            
                            // Récupérer groupe
                            const group = groups.find(g => g.id === employee.groupId);
                            const groupName = group ? group.name : 'Sans groupe';
                            
                            // HTML
                            qrCardsHTML.push(`
                                <div class="qr-card" data-employee-id="${employee.id}">
                                    <div class="qr-card-header">
                                        <h4>${employee.name}</h4>
                                        <p class="qr-position">${employee.position}</p>
                                        <span class="qr-group-badge">
                                            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">group</span>
                                            ${groupName}
                                        </span>
                                    </div>
                                    
                                    <div class="qr-code-canvas">
                                        <img src="${dataURL}" 
                                            alt="QR ${employee.name}" 
                                            width="${qrSettings.size}" 
                                            height="${qrSettings.size}"
                                            style="display: block; width: 100%; max-width: ${qrSettings.size}px; height: auto; margin: 0 auto;">
                                    </div>
                                    
                                    <div class="qr-actions">
                                        <button class="btn-icon" onclick="downloadQRCodeFromDB('${employee.id}')" title="Télécharger">
                                            <span class="material-icons">download</span>
                                        </button>
                                        <button class="btn-icon" onclick="printQRCodeFromDB('${employee.id}')" title="Imprimer">
                                            <span class="material-icons">print</span>
                                        </button>
                                    </div>
                                </div>
                            `);
                            
                            successCount++;
                        } else {
                            console.error(`❌ QR invalide pour ${employee.name}`);
                            errorCount++;
                        }
                        
                    } catch (err) {
                        console.error(`❌ Erreur pour ${employee.name}:`, err);
                        errorCount++;
                    }
                }
                
                // Affichage résultats
                console.log(`📊 Résultats: ${successCount} succès, ${errorCount} erreurs`);
                
                if (qrCardsHTML.length > 0) {
                    container.innerHTML = qrCardsHTML.join('');
                    showAlert(`✅ ${successCount} QR code${successCount > 1 ? 's' : ''} généré${successCount > 1 ? 's' : ''}!`, 'success');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <span class="material-icons" style="font-size: 64px; color: var(--md-sys-color-error);">error</span>
                            <h3 style="margin-top: 20px; color: var(--md-sys-color-error);">Échec de génération</h3>
                            <p style="margin-top: 10px; color: var(--md-sys-color-on-surface-variant);">
                                ${errorCount} erreur${errorCount > 1 ? 's' : ''} survenue${errorCount > 1 ? 's' : ''}
                            </p>
                            <button class="btn" onclick="generateAllQRCodes()" style="margin-top: 20px;">
                                <span class="material-icons">refresh</span>
                                Réessayer
                            </button>
                        </div>
                    `;
                    showAlert(`Échec: ${errorCount} erreurs`, 'error');
                }
                
            } catch (error) {
                console.error('❌ Erreur critique:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <span class="material-icons" style="font-size: 64px; color: var(--md-sys-color-error);">error</span>
                        <h3 style="margin-top: 20px; color: var(--md-sys-color-error);">Erreur critique</h3>
                        <p style="margin-top: 10px;">${error.message}</p>
                        <button class="btn" onclick="generateAllQRCodes()" style="margin-top: 20px;">
                            <span class="material-icons">refresh</span>
                            Réessayer
                        </button>
                    </div>
                `;
            }
        }


        // === TÉLÉCHARGER QR depuis DB ===
        async function downloadQRCodeFromDB(employeeId) {
            try {
                // AMPIASAO 'qr_codes' (misy underscore)
                const qrData = await dbManager.get('qr_codes', employeeId);
                
                if (!qrData) {
                    showAlert('QR Code non trouvé. Veuillez le générer.', 'error');
                    return;
                }
                
                const link = document.createElement('a');
                link.href = qrData.dataURL;
                link.download = `qr-${qrData.employeeName.replace(/\s+/g, '-')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert(`✅ QR Code téléchargé: ${qrData.employeeName}`, 'success');
                
            } catch (error) {
                console.error('Erreur téléchargement:', error);
                showAlert('Erreur lors du téléchargement', 'error');
            }
        }

        // === IMPRIMER QR depuis DB ===
        async function printQRCodeFromDB(employeeId) {
            try {
                // AMPIASAO 'qr_codes' (misy underscore)
                const qrData = await dbManager.get('qr_codes', employeeId);
                
                if (!qrData) {
                    showAlert('QR Code non trouvé. Veuillez le générer.', 'error');
                    return;
                }
                
                const group = groups.find(g => g.id === qrData.employeeGroupId);
                const groupName = group ? group.name : 'Sans groupe';
                
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>QR Code - ${qrData.employeeName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background: #f5f5f5; }
                            .card { background: white; border: 3px solid #1e293b; padding: 35px; width: 400px; margin: 0 auto; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                            h2 { font-size: 1.8em; color: #1e293b; margin: 0 0 10px 0; font-weight: 800; }
                            .position { font-size: 1.1em; color: #64748b; margin-bottom: 15px; font-weight: 600; }
                            .badge { background: linear-gradient(135deg, #6750A4, #5a4594); color: white; padding: 10px 18px; border-radius: 25px; display: inline-flex; align-items: center; gap: 8px; font-size: 1em; font-weight: 700; box-shadow: 0 2px 8px rgba(103,80,164,0.3); }
                            .qr-wrapper { margin: 25px 0; padding: 20px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 12px; }
                            img { width: 280px; height: 280px; border: 4px solid #6750A4; border-radius: 12px; padding: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                            .footer { margin-top: 25px; border-top: 2px solid #e2e8f0; padding-top: 20px; }
                            .company { font-size: 1.3em; color: #6750A4; font-weight: 800; margin-bottom: 10px; }
                            .instructions { font-size: 0.95em; color: #64748b; line-height: 1.6; }
                            @media print {
                                body { background: white; padding: 0; }
                                .card { box-shadow: none; page-break-inside: avoid; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="card">
                            <h2>${qrData.employeeName}</h2>
                            <div class="position">${qrData.employeePosition}</div>
                            <div class="badge">
                                <span style="font-size: 1.1em;">👥</span>
                                <span>${groupName}</span>
                            </div>
                            <div class="qr-wrapper">
                                <img src="${qrData.dataURL}" alt="QR Code">
                            </div>
                            <div class="footer">
                                <div class="company">🏢 BEHAVANA HR SYSTEM</div>
                                <div class="instructions">
                                    <strong>Scanner ce QR code</strong><br>
                                    pour marquer votre présence
                                </div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank', 'width=900,height=1000');
                if (!printWindow) {
                    showAlert('Veuillez autoriser les pop-ups', 'error');
                    return;
                }
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                }, 600);
                
            } catch (error) {
                console.error('Erreur impression:', error);
                showAlert('Erreur lors de l\'impression', 'error');
            }
        }

        // === DOWNLOAD DEPUIS MÉMOIRE ===
        function downloadQRCodeMemory(employeeId) {
            try {
                if (!window.generatedQRCodes || !window.generatedQRCodes[employeeId]) {
                    showAlert('QR Code non trouvé. Veuillez régénérer les QR codes.', 'error');
                    return;
                }
                
                const employee = employees.find(emp => emp.id === employeeId);
                if (!employee) {
                    showAlert('Employé non trouvé', 'error');
                    return;
                }
                
                const qrData = window.generatedQRCodes[employeeId];
                
                // Créer un lien de téléchargement
                const link = document.createElement('a');
                link.href = qrData.dataURL;
                link.download = `qr-${employee.name.replace(/\s+/g, '-').toLowerCase()}.png`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert(`✅ QR Code de ${employee.name} téléchargé`, 'success');
                
            } catch (error) {
                console.error('Erreur téléchargement:', error);
                showAlert('Erreur lors du téléchargement', 'error');
            }
        }

        // === PRINT DEPUIS MÉMOIRE ===
        // === PRINT QR CODE - VERSION AMÉLIORÉE ===
        function printQRCodeMemory(employeeId) {
            try {
                // 1. Vérifier que le QR code existe
                if (!window.generatedQRCodes || !window.generatedQRCodes[employeeId]) {
                    showAlert('QR Code non trouvé. Veuillez régénérer les QR codes.', 'error');
                    return;
                }
                
                // 2. Récupérer les infos employé
                const employee = employees.find(emp => emp.id === employeeId);
                if (!employee) {
                    showAlert('Employé non trouvé', 'error');
                    return;
                }
                
                // 3. Récupérer les données QR et groupe
                const qrData = window.generatedQRCodes[employeeId];
                const group = groups.find(g => g.id === employee.groupId);
                const groupName = group ? group.name : 'Sans groupe';
                
                // 4. Construire le HTML d'impression
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>QR Code - ${employee.name}</title>
                        <style>
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }
                            
                            body {
                                font-family: 'Arial', sans-serif;
                                background: #f8fafc;
                                padding: 30px;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                min-height: 100vh;
                            }
                            
                            .qr-print-card {
                                background: white;
                                border: 3px solid #1e293b;
                                padding: 35px;
                                width: 420px;
                                border-radius: 16px;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                                text-align: center;
                            }
                            
                            .header {
                                border-bottom: 2px solid #e2e8f0;
                                padding-bottom: 20px;
                                margin-bottom: 25px;
                            }
                            
                            h2 {
                                font-size: 1.8em;
                                color: #1e293b;
                                margin-bottom: 10px;
                                font-weight: 800;
                                letter-spacing: 0.3px;
                            }
                            
                            .position {
                                font-size: 1.15em;
                                color: #475569;
                                font-weight: 600;
                                margin-bottom: 15px;
                            }
                            
                            .group-badge {
                                display: inline-flex;
                                align-items: center;
                                gap: 8px;
                                background: linear-gradient(135deg, #6750A4 0%, #5a4594 100%);
                                color: white;
                                padding: 10px 18px;
                                border-radius: 25px;
                                font-size: 1em;
                                font-weight: 700;
                                box-shadow: 0 2px 8px rgba(103, 80, 164, 0.3);
                            }
                            
                            .qr-container {
                                margin: 30px 0;
                                padding: 20px;
                                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                                border-radius: 12px;
                            }
                            
                            .qr-container img {
                                width: 300px;
                                height: 300px;
                                border: 4px solid #6750A4;
                                border-radius: 12px;
                                padding: 12px;
                                background: white;
                                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            }
                            
                            .footer {
                                border-top: 2px solid #e2e8f0;
                                padding-top: 20px;
                                margin-top: 25px;
                            }
                            
                            .company-name {
                                font-size: 1.3em;
                                color: #6750A4;
                                font-weight: 800;
                                margin-bottom: 10px;
                                letter-spacing: 0.5px;
                            }
                            
                            .instructions {
                                font-size: 0.95em;
                                color: #64748b;
                                line-height: 1.6;
                                margin-bottom: 12px;
                            }
                            
                            .date-generated {
                                font-size: 0.85em;
                                color: #94a3b8;
                                font-style: italic;
                            }
                            
                            /* Print styles */
                            @media print {
                                body {
                                    background: white;
                                    padding: 0;
                                }
                                
                                .qr-print-card {
                                    border: 3px solid #1e293b;
                                    box-shadow: none;
                                    page-break-inside: avoid;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="qr-print-card">
                            <div class="header">
                                <h2>${employee.name}</h2>
                                <div class="position">${employee.position}</div>
                                <div class="group-badge">
                                    <span style="font-size: 1.1em;">👥</span>
                                    <span>${groupName}</span>
                                </div>
                            </div>
                            
                            <div class="qr-container">
                                <img src="${qrData.dataURL}" alt="QR Code de ${employee.name}">
                            </div>
                            
                            <div class="footer">
                                <div class="company-name">🏢 BEHAVANA HR SYSTEM</div>
                                <div class="instructions">
                                    <strong>Scanner ce QR code pour marquer</strong><br>
                                    votre présence (arrivée/départ)
                                </div>
                                <div class="date-generated">
                                    Généré le ${new Date().toLocaleDateString('fr-FR', { 
                                        day: '2-digit', 
                                        month: 'long', 
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}
                                </div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
                
                // 5. Ouvrir la fenêtre d'impression
                const printWindow = window.open('', '_blank', 'width=900,height=1000');
                if (!printWindow) {
                    showAlert('Veuillez autoriser les pop-ups pour imprimer', 'error');
                    return;
                }
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // 6. Lancer l'impression après chargement complet
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.focus();
                        printWindow.print();
                        // Ne pas fermer automatiquement
                    }, 600);
                };
                
            } catch (error) {
                console.error('Erreur impression:', error);
                showAlert('Erreur lors de l\'impression: ' + error.message, 'error');
            }
        }


        // Scanner QR Code
        // ===================================================
        //  GESTION DU SCANNER QR (VERSION 3.0 - UNIFIÉE)
        // ===================================================

        async function startQRScan(purpose) {
            if (isScanning) {
                console.log('⚠️ Scan précédent arrêté');
                stopQRScan(false);
            }

            currentScanPurpose = purpose;
            console.log(`Tanjon'ny scan napetraka: ${currentScanPurpose}`);

            const video = document.getElementById('qrVideo');
            const overlay = document.getElementById('scanOverlay');
            const permissionMsg = document.getElementById('cameraPermissionMessage');
            const scannerTitle = document.getElementById('qrScannerTitle');
            const scannerInstruction = document.getElementById('qrScannerInstruction');
            const scanResult = document.getElementById('scanResult');

            // Diovina ny hafatra taloha
            scanResult.style.display = 'none';
            permissionMsg.style.display = 'none';

            // Switch statement nohatsaraina miaraka amin'ny advances-search case
            switch (purpose) {
                case 'attendance':
                    scannerTitle.innerHTML = `<span class="material-icons">qr_code_scanner</span> Scanner pour Présence`;
                    scannerInstruction.textContent = "Marquer l'arrivée ou le départ d'un employé.";
                    break;
                    
                case 'payroll':
                    scannerTitle.innerHTML = `<span class="material-icons">payments</span> Scanner pour la Paie`;
                    scannerInstruction.textContent = "Sélectionner un employé pour le calcul de la paie.";
                    break;
                    
                case 'advance':
                    scannerTitle.innerHTML = `<span class="material-icons">savings</span> Scanner pour Avance`;
                    scannerInstruction.textContent = "Sélectionner un employé pour une demande d'avance.";
                    break;
                    
                case 'advances-search':
                    scannerTitle.innerHTML = `<span class="material-icons">search</span> Scanner pour Rechercher`;
                    scannerInstruction.textContent = "Scannez le QR Code pour rechercher les avances de cet employé.";
                    break;
                    
                default:
                    scannerTitle.innerHTML = `<span class="material-icons">qr_code_scanner</span> Scanner QR Code`;
                    scannerInstruction.textContent = "Veuillez pointer la caméra vers le QR Code.";
                    break;
            }

            isScanning = true;
            openModal('qrScannerModal');

            try {
                // ========== FANATSARANA 1: Configuration tsara kokoa ========== 
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                scanStream = await navigator.mediaDevices.getUserMedia(constraints);

                // ========== FANATSARANA 2: iOS compatibility ========== 
                video.srcObject = scanStream;

                // Ampio ireto attribute ireto ho an'ny iOS
                video.setAttribute('playsinline', '');
                video.setAttribute('autoplay', '');
                video.setAttribute('muted', '');

                // Alefaso ny video
                await video.play().catch(err => {
                    console.error('Erreur lecture vidéo:', err);
                });

                video.style.display = 'block';
                overlay.style.display = 'block';

                const canvas = document.getElementById('qrCanvas');
                scanInterval = setInterval(() => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        scanQRFromVideo(video, canvas);
                    }
                }, 500);

            } catch (error) {
                // ========== FANATSARANA 3: Error handling tsara kokoa ========== 
                console.error("Erreur d'accès à la caméra:", error);
                permissionMsg.style.display = 'flex';
                
                let errorMessage = '';
                if (error.name === 'NotAllowedError') {
                    errorMessage = "Permission refusée. Sur iPhone: Réglages > Safari > Caméra > Autoriser.";
                } else if (error.name === 'NotFoundError') {
                    errorMessage = "Aucune caméra trouvée sur cet appareil.";
                } else if (error.name === 'NotReadableError') {
                    errorMessage = "Caméra déjà utilisée. Fermez les autres apps utilisant la caméra.";
                } else {
                    errorMessage = "Erreur: " + error.message;
                }
                
                permissionMsg.querySelector('span').textContent = errorMessage;
                stopQRScan();
            }
        }

        // ===================================================
        //  STOP SCAN (VERSION 4.0 - MIKATONA NY MODAL)
        //  ITY NO SOLON'ILAY TALOHA
        // ===================================================
        function stopQRScan(showMsg = true) {
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }

            const video = document.getElementById('qrVideo');
            if(video) video.style.display = 'none';
            
            const overlay = document.getElementById('scanOverlay');
            if(overlay) overlay.style.display = 'none';

            closeModal('qrScannerModal');

            if (showMsg && isScanning) {
                showAlert("Scan annulé.", "warning");
            }
            
            isScanning = false;
        }

        function scanQRFromVideo(video, canvas) {
            const context = canvas.getContext('2d', { willReadFrequently: true });
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                playSuccessSound(); // Alefa ny feo
                handleQRScanResult(code.data);
            }
        }

        // =================================================================
        //  HANDLEQRSCANRESULT - VERSION FARANY INDRINDRA (MAHAZAKA TALOHA SY VAOVAO)
        // =================================================================
        async function handleQRScanResult(qrData) {
            const purpose = currentScanPurpose;
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            let employeeId = null;
            
            console.log('🔍 QR Code reçu:', qrData);
            
            try {
                // ========================================
                // FORMAT 1: BEHAVANAHR:id (VAOVAO)
                // ========================================
                if (qrData.startsWith('BEHAVANAHR:')) {
                    employeeId = qrData.replace('BEHAVANAHR:', '');
                    console.log('✅ Format BEHAVANAHR détecté, ID:', employeeId);
                }
                // ========================================
                // FORMAT 2: BEHAVANA:id (TALOHA)
                // ========================================
                else if (qrData.startsWith('BEHAVANA:')) {
                    employeeId = qrData.replace('BEHAVANA:', '');
                    console.log('✅ Format BEHAVANA détecté, ID:', employeeId);
                }
                // ========================================
                // FORMAT 3: JSON (TALOHA KOKOA)
                // ========================================
                else if (qrData.startsWith('{') && qrData.endsWith('}')) {
                    try {
                        const parsedData = JSON.parse(qrData);
                        if (parsedData.type === 'BEHAVANA_ATTENDANCE' && parsedData.employeeId) {
                            employeeId = parsedData.employeeId;
                            console.log('✅ Format JSON détecté, ID:', employeeId);
                        }
                    } catch (jsonError) {
                        console.warn('⚠️ Erreur parse JSON:', jsonError);
                    }
                }
                // ========================================
                // FORMAT 4: Base64 (TALOHA INDRINDRA)
                // ========================================
                else {
                    try {
                        const decodedString = decodeURIComponent(escape(atob(qrData)));
                        if (decodedString.startsWith('{')) {
                            const parsedData = JSON.parse(decodedString);
                            if (parsedData.type === 'BEHAVANA_ATTENDANCE' && parsedData.employeeId) {
                                employeeId = parsedData.employeeId;
                                console.log('✅ Format Base64 détecté, ID:', employeeId);
                            }
                        }
                    } catch (base64Error) {
                        console.log('ℹ️ Pas en Base64, format non reconnu');
                    }
                }
                
                // ========================================
                // VALIDATION FINALE
                // ========================================
                if (!employeeId) {
                    console.error('❌ Format QR invalide:', qrData);
                    showScanResult('QRCode non valide pour ce système.', 'error');
                    playErrorSound();
                    return false;
                }
                
                // Vérifier que l'employé existe
                const employee = employees.find(emp => emp.id === employeeId);
                
                if (!employee) {
                    console.error('❌ Employé non trouvé, ID:', employeeId);
                    showScanResult(`Employé non trouvé (ID: ${employeeId})`, 'error');
                    playErrorSound();
                    return false;
                }
                
                console.log('✅ Employé trouvé:', employee.name);
                
                // ========================================
                // TRAITEMENT SELON LE PURPOSE
                // ========================================
                switch (purpose) {
                    case 'attendance':
                        return await processAttendanceScan(employee);
                        
                    case 'payroll':
                        document.getElementById('payrollEmployeeSelect').value = employeeId;
                        if (typeof handlePayrollEmployeeChange === 'function') {
                            handlePayrollEmployeeChange();
                        }
                        showScanResult(`✅ Employé sélectionné: ${employee.name}`, 'success');
                        setTimeout(() => stopQRScan(), 1500);
                        return true;
                        
                    case 'advance':
                        document.getElementById('advanceEmployee').value = employeeId;
                        showScanResult(`✅ Employé sélectionné: ${employee.name}`, 'success');
                        setTimeout(() => stopQRScan(), 1500);
                        return true;
                        
                    case 'advances-search':
                        if (typeof handleAdvancesSearchQRScan === 'function') {
                            handleAdvancesSearchQRScan(employee);
                        }
                        return true;
                        
                    default:
                        console.warn('⚠️ Purpose non géré:', purpose);
                        return false;
                }
                
            } catch (error) {
                console.error('❌ Erreur traitement QR:', error);
                showScanResult('Erreur lors du traitement du QR Code', 'error');
                playErrorSound();
                return false;
            }
        }



        // === RECHERCHE AVANCE PAR QR ===
        function handleAdvancesSearchQRScan(employee) {
            try {
                console.log(`🔍 Recherche avances pour ${employee.name}`);
                
                // Remplir le champ de recherche avec le nom
                const searchInput = document.getElementById('advanceSearchInput');
                if (searchInput) {
                    searchInput.value = employee.name;
                    searchInput.dispatchEvent(new Event('input'));
                }
                
                playSuccessSound();
                showScanResult(
                    `✅ <strong>RECHERCHE</strong><br>
                    Affichage des avances de:<br>
                    <strong>${employee.name}</strong>`, 
                    'success'
                );
                
                // Fermer le scanner
                setTimeout(() => {
                    stopQRScan();
                    
                    // Scroller vers les résultats
                    const advancesList = document.getElementById('advancesList');
                    if (advancesList) {
                        advancesList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 1500);
                
            } catch (error) {
                console.error('❌ Erreur recherche avances:', error);
                showScanResult('Erreur lors de la recherche', 'error');
            }
        }


        // =====================================================
        // === PROCESS ATTENDANCE SCAN - VERSION MULTIPLE CHECKS ===
        // =====================================================

        async function processAttendanceScan(employee) {
            try {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);
                
                console.log('✅ Traitement présence pour', employee.name);
                
                // Initialiser si nécessaire
                if (!attendance[today]) {
                    attendance[today] = {};
                }
                
                const existingAttendance = attendance[today][employee.id];
                
                // =====================================================
                // CAS 1: PREMIÈRE FOIS → ARRIVÉE
                // =====================================================
                if (!existingAttendance) {
                    attendance[today][employee.id] = {
                        arrivee: currentTime,
                        depart: null,
                        method: 'FACIAL',
                        checks: [{
                            type: 'arrivee',
                            time: currentTime,
                            timestamp: now.toISOString()
                        }]
                    };
                    
                    // Enregistrer dans qrAttendance
                    qrAttendance.push({
                        id: `${employee.id}_${now.getTime()}`,
                        employeeId: employee.id,
                        employeeName: employee.name,
                        date: today,
                        timestamp: now.toISOString(),
                        type: 'arrival',
                        time: currentTime
                    });
                    
                    await saveAttendanceData();
                    playSuccessSound();
                    
                    showScanResult(
                        `<strong>✅ ARRIVÉE ENREGISTRÉE</strong><br>
                        <span style="font-size: 1.2em; font-weight: 700;">${employee.name}</span><br>
                        <span style="font-size: 0.95em;">Heure: <strong>${currentTime}</strong></span>`,
                        'success'
                    );
                    
                    // Rafraîchir
                    if (document.getElementById('qr-presence').classList.contains('active')) {
                        displayQRAttendance();
                    }
                    if (document.getElementById('attendance').classList.contains('active')) {
                        displayAttendance();
                    }
                    updateStats();
                    runSmartChecks();
                    
                    setTimeout(() => stopQRScan(), 2000);
                    return true;
                }
                
                // =====================================================
                // CAS 2: DEUXIÈME FOIS → DÉPART
                // =====================================================
                else if (existingAttendance && !existingAttendance.depart) {
                    attendance[today][employee.id].depart = currentTime;
                    
                    // Ajouter dans checks
                    if (!attendance[today][employee.id].checks) {
                        attendance[today][employee.id].checks = [];
                    }
                    attendance[today][employee.id].checks.push({
                        type: 'depart',
                        time: currentTime,
                        timestamp: now.toISOString()
                    });
                    
                    // Enregistrer dans qrAttendance
                    qrAttendance.push({
                        id: `${employee.id}_${now.getTime()}`,
                        employeeId: employee.id,
                        employeeName: employee.name,
                        date: today,
                        timestamp: now.toISOString(),
                        type: 'departure',
                        time: currentTime
                    });
                    
                    await saveAttendanceData();
                    playSuccessSound();
                    
                    showScanResult(
                        `<strong>✅ DÉPART ENREGISTRÉ</strong><br>
                        <span style="font-size: 1.2em; font-weight: 700;">${employee.name}</span><br>
                        <span style="font-size: 0.95em;">Heure: <strong>${currentTime}</strong></span>`,
                        'success'
                    );
                    
                    // Rafraîchir
                    if (document.getElementById('qr-presence').classList.contains('active')) {
                        displayQRAttendance();
                    }
                    if (document.getElementById('attendance').classList.contains('active')) {
                        displayAttendance();
                    }
                    updateStats();
                    runSmartChecks();
                    
                    setTimeout(() => stopQRScan(), 2000);
                    return true;
                }
                
                // =====================================================
                // CAS 3: DÉJÀ 2 CHECKS → VÉRIFIER TIMING
                // =====================================================
                else {
                    // Calculer le temps depuis le dernier départ
                    const lastDeparture = new Date(`${today}T${existingAttendance.depart}:00`);
                    const minutesSinceDeparture = Math.floor((now - lastDeparture) / 1000 / 60);
                    
                    console.log(`⏱️ Minutes depuis départ: ${minutesSinceDeparture}`);
                    
                    // ===== SI > 30 MINUTES → PROPOSER UPDATE =====
                    if (minutesSinceDeparture >= 30) {
                        // Message de confirmation
                        const confirmMessage = `⚠️ ${employee.name} a déjà pointé:\n\n` +
                            `• Arrivée: ${existingAttendance.arrivee}\n` +
                            `• Départ: ${existingAttendance.depart}\n\n` +
                            `🕐 Il y a ${minutesSinceDeparture} minutes\n\n` +
                            `Mettre à jour le départ avec ${currentTime}?`;
                        
                        if (confirm(confirmMessage)) {
                            // ✅ USER A CONFIRMÉ → UPDATE
                            const oldDepart = attendance[today][employee.id].depart;
                            attendance[today][employee.id].depart = currentTime;
                            
                            // Ajouter dans historique
                            if (!attendance[today][employee.id].checks) {
                                attendance[today][employee.id].checks = [];
                            }
                            attendance[today][employee.id].checks.push({
                                type: 'depart_update',
                                time: currentTime,
                                oldTime: oldDepart,
                                timestamp: now.toISOString()
                            });
                            
                            // Enregistrer dans qrAttendance
                            qrAttendance.push({
                                id: `${employee.id}_${now.getTime()}`,
                                employeeId: employee.id,
                                employeeName: employee.name,
                                date: today,
                                timestamp: now.toISOString(),
                                type: 'departure_update',
                                time: currentTime,
                                oldTime: oldDepart
                            });
                            
                            await saveAttendanceData();
                            playSuccessSound();
                            
                            showScanResult(
                                `<strong>✅ DÉPART MIS À JOUR</strong><br>
                                <span style="font-size: 1.2em; font-weight: 700;">${employee.name}</span><br>
                                <span style="font-size: 0.9em;">
                                    Ancien: <s>${oldDepart}</s><br>
                                    Nouveau: <strong style="color: #10b981;">${currentTime}</strong>
                                </span>`,
                                'success'
                            );
                            
                            // Rafraîchir
                            if (document.getElementById('qr-presence').classList.contains('active')) {
                                displayQRAttendance();
                            }
                            if (document.getElementById('attendance').classList.contains('active')) {
                                displayAttendance();
                            }
                            updateStats();
                            runSmartChecks();
                            
                            setTimeout(() => stopQRScan(), 2500);
                            return true;
                            
                        } else {
                            // ❌ USER A ANNULÉ
                            playErrorSound();
                            
                            showScanResult(
                                `<strong>⚠️ ANNULÉ</strong><br>
                                <span style="font-size: 1.1em; font-weight: 600;">${employee.name}</span><br>
                                <span style="font-size: 0.9em;">Départ non modifié: <strong>${existingAttendance.depart}</strong></span>`,
                                'warning'
                            );
                            
                            setTimeout(() => stopQRScan(), 2000);
                            return false;
                        }
                    }
                    
                    // ===== SI < 30 MINUTES → REFUSER =====
                    else {
                        console.log('❌ < 30 min → Refusé');
                        
                        playErrorSound(); // ← AMPIANA
                        
                        showScanResult(
                            `<strong>❌ POINTAGE TROP RAPPROCHÉ</strong><br>
                            <span style="font-size: 1.1em; font-weight: 600;">${employee.name}</span><br>
                            <div style="font-size: 0.9em; margin-top: 12px; line-height: 1.6;">
                                <div style="color: #cbd5e1;">Derniers pointages:</div>
                                <div style="margin: 6px 0;">
                                    Arrivée: <strong style="color: #10b981;">${existingAttendance.arrivee}</strong><br>
                                    Départ: <strong style="color: #ef4444;">${existingAttendance.depart}</strong>
                                </div>
                            </div>
                            <div style="margin-top: 12px; padding: 10px; background: rgba(239, 68, 68, 0.15); border-radius: 8px; border-left: 3px solid #ef4444;">
                                <div style="font-size: 0.85em; color: #fca5a5;">
                                    ⏱️ <strong>Seulement ${minutesSinceDeparture} min</strong> depuis le départ
                                </div>
                                <div style="font-size: 0.8em; color: #fca5a5; margin-top: 4px;">
                                    Minimum requis: <strong>30 minutes</strong>
                                </div>
                            </div>`,
                            'error'
                        );
                        
                        setTimeout(() => stopQRScan(), 4000);
                        return false;
                    }

                }
                
            } catch (error) {
                console.error('❌ Erreur traitement présence:', error);
                playErrorSound();
                showScanResult(`Erreur lors de l'enregistrement`, 'error');
                return false;
            }
        }


        // ===================================================
        //  showScanResult (FANITSARANA: Mampiasa innerHTML)
        //  showScanResult (VERSION FARANY - TSY MANAFINA INTSONY)
        // ===================================================
        // === AFFICHAGE RÉSULTAT SCAN - VERSION AMÉLIORÉE ===
        function showScanResult(message, type) {
            const scanResult = document.getElementById('scanResult');
            
            if (!scanResult) return;
            
            // Icon selon le type
            let icon = '';
            let bgColor = '';
            
            switch(type) {
                case 'success':
                    icon = '<span class="material-icons" style="font-size: 48px; color: #10b981;">check_circle</span>';
                    bgColor = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                    break;
                case 'error':
                    icon = '<span class="material-icons" style="font-size: 48px; color: #ef4444;">error</span>';
                    bgColor = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                    break;
                case 'warning':
                    icon = '<span class="material-icons" style="font-size: 48px; color: #f59e0b;">warning</span>';
                    bgColor = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
                    break;
                default:
                    icon = '<span class="material-icons" style="font-size: 48px; color: #6750A4;">info</span>';
                    bgColor = 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%)';
            }
            
            scanResult.innerHTML = `
                <div style="background: ${bgColor}; padding: 20px; border-radius: 12px; text-align: center;">
                    ${icon}
                    <div style="margin-top: 12px; font-size: 15px; line-height: 1.6; color: #1e293b;">
                        ${message}
                    </div>
                </div>
            `;
            
            scanResult.style.display = 'block';
        }




        // Afficher les présences QR
        // ===================================================
        function displayQRAttendance() {
            const container = document.getElementById('qrAttendanceList');
            const selectedDate = document.getElementById('qrAttendanceDate').value;

            if (!selectedDate) {
                container.innerHTML = '<p>Veuillez sélectionner une date.</p>';
                document.getElementById('qrAttendancePagination').innerHTML = ''; // Fafana ny pagination
                return;
            }

            const dayAttendance = attendance[selectedDate] || {};

            // --- DINGANA 1: Fandaharana ny lisitry ny mpiasa rehetra ---
            let sortedEmployees = [...employees].sort((a, b) => {
                const aIsPresent = dayAttendance[a.id] && dayAttendance[a.id].arrivee;
                const bIsPresent = dayAttendance[b.id] && dayAttendance[b.id].arrivee;

                if (aIsPresent && !bIsPresent) {
                    return -1; // 'a' (tonga) alohan'ny 'b' (tsy tonga)
                }
                if (!aIsPresent && bIsPresent) {
                    return 1; // 'b' (tonga) alohan'ny 'a' (tsy tonga)
                }
                if (aIsPresent && bIsPresent) {
                    // Raha samy tonga, dia alahatra araka ny ora
                    return dayAttendance[a.id].arrivee.localeCompare(dayAttendance[b.id].arrivee);
                }
                // Raha samy tsy tonga, dia alahatra araka ny anarana
                return a.name.localeCompare(b.name);
            });

            // --- DINGANA 2: Lojika Pagination ---
            const totalItems = sortedEmployees.length;
            const totalPages = Math.ceil(totalItems / qrAttendanceItemsPerPage);
            if (qrAttendanceCurrentPage > totalPages) {
                qrAttendanceCurrentPage = totalPages > 0 ? totalPages : 1;
            }
            const startIndex = (qrAttendanceCurrentPage - 1) * qrAttendanceItemsPerPage;
            const endIndex = startIndex + qrAttendanceItemsPerPage;
            const paginatedEmployees = sortedEmployees.slice(startIndex, endIndex);

            // --- DINGANA 3: Fampisehoana ny lisitra (mampiasa ny kaodinao teo aloha) ---
            let allEmployeesHTML = paginatedEmployees.map(employee => {
                const presenceData = dayAttendance[employee.id];
                const isPresent = presenceData && presenceData.arrivee;

                let statusHTML = '';
                if (isPresent) {
                    const arrivalTime = formatDisplayTime(presenceData.arrivee); 
                    const departureTime = formatDisplayTime(presenceData.depart);
                    const method = presenceData.method || 'MANUAL';
                    const methodColor = method === 'QR' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-secondary)';
                    const methodIcon = method === 'QR' ? 'qr_code_scanner' : 'edit';

                    statusHTML = `
                        <div class="qr-status present">
                            <span class="material-icons">check_circle</span>
                            <span>Présent</span>
                        </div>
                        <div style="font-size: 12px; text-align: right; margin-top: 4px;">
                            Arrivée: <strong>${arrivalTime}</strong> | Départ: <strong>${departureTime}</strong>
                            <span style="color: ${methodColor}; display: inline-flex; align-items: center; gap: 4px; font-size: 12px; margin-left: 8px; vertical-align: middle;">
                                <span class="material-icons" style="font-size: 14px;">${methodIcon}</span>
                                ${method}
                            </span>
                        </div>
                    `;
                } else {
                    statusHTML = `
                        <div class="qr-status absent">
                            <span class="material-icons">cancel</span>
                            <span>Absent</span>
                        </div>
                    `;
                }

                return `
                    <div class="employee-qr-item">
                        <div class="employee-qr-info">
                            <h4>${employee.name}</h4>
                            <p>${employee.position}</p>
                        </div>
                        <div>
                            ${statusHTML}
                        </div>
                    </div>
                `;
            }).join('');

            // --- DINGANA 4: Fampisehoana ny famintinana (tsy miova) ---
            const presentCount = Object.keys(dayAttendance).length;
            const absentCount = employees.length - presentCount;
            const summaryHTML = `
                <div style="display: flex; gap: 16px; margin-bottom: 16px; padding: 12px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">
                    <div style="color: var(--md-sys-color-success); font-weight: 500;">
                        <span class="material-icons" style="vertical-align: middle;">check_circle</span>
                        Présents: ${presentCount}
                    </div>
                    <div style="color: var(--md-sys-color-error); font-weight: 500;">
                        <span class="material-icons" style="vertical-align: middle;">cancel</span>
                        Absents: ${absentCount}
                    </div>
                    <div style="color: var(--md-sys-color-on-surface-variant); font-weight: 500;">
                        <span class="material-icons" style="vertical-align: middle;">people</span>
                        Total: ${employees.length}
                    </div>
                </div>
            `;

            container.innerHTML = summaryHTML + allEmployeesHTML;

            // --- DINGANA 5: Fampisehoana ny bokotra Pagination ---
            renderPaginationControls(
                'qrAttendancePagination',
                qrAttendanceCurrentPage,
                totalPages,
                totalItems,
                qrAttendanceItemsPerPage,
                (page) => {
                    qrAttendanceCurrentPage = page;
                    displayQRAttendance();
                }
            );
        }


        function refreshQRAttendance() {
            displayQRAttendance();
            showAlert('Liste des présences QR actualisée', 'success');
        }

        // Export PDF des présences QR
        function exportQRAttendancePDF() {
            const selectedDate = document.getElementById('qrAttendanceDate').value;
            if (!selectedDate) {
                alert('Veuillez sélectionner une date.');
                return;
            }

            const dayAttendance = qrAttendance.filter(att => att.date === selectedDate);
            
            if (dayAttendance.length === 0) {
                alert('Aucune présence QR à exporter pour cette date.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // En-tête
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("PRÉSENCES QR CODE", 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text(`Date: ${formatDate(selectedDate + 'T00:00:00')}`, 105, 30, { align: 'center' });
            doc.text(`${dayAttendance.length} présence(s) enregistrée(s)`, 105, 40, { align: 'center' });

            // Trier par heure d'arrivée
            dayAttendance.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Préparer les données du tableau
            const tableData = dayAttendance.map((att, index) => [
                index + 1,
                att.employeeName,
                att.employeePosition,
                formatTime(att.timestamp),
                'Scanner QR'
            ]);

            // Créer le tableau
            doc.autoTable({
                startY: 50,
                head: [['#', 'Nom Complet', 'Poste', 'Heure Arrivée', 'Méthode']],
                body: tableData,
                styles: {
                    fontSize: 10,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [103, 80, 164],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 15 },
                    1: { cellWidth: 50 },
                    2: { cellWidth: 40 },
                    3: { halign: 'center', cellWidth: 35 },
                    4: { halign: 'center', cellWidth: 35 }
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                }
            });

            // Pied de page
            const finalY = doc.lastAutoTable.finalY || 80;
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text(`Généré le ${new Date().toLocaleString()} - Système RH BEHAVANA`, 14, finalY + 20);

            // Sauvegarder
            doc.save(`presences-qr-${selectedDate}.pdf`);
            showAlert('PDF des présences QR exporté avec succès!', 'success');
        }

        // Télécharger QR Code individuel
        async function downloadQRCode(employeeId) {
            try {
                const qrCodeData = await dbManager.get('qr_codes', employeeId);
                if (!qrCodeData) {
                    showAlert('QR Code non trouvé', 'error');
                    return;
                }

                const employee = employees.find(emp => emp.id === employeeId);
                if (!employee) return;

                // Créer un lien de téléchargement
                const link = document.createElement('a');
                link.download = `qr-${employee.name.replace(/\s+/g, '-')}.png`;
                link.href = qrCodeData.dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert(`QR Code de ${employee.name} téléchargé`, 'success');
            } catch (error) {
                console.error('Erreur téléchargement QR:', error);
                showAlert('Erreur lors du téléchargement', 'error');
            }
        }

        // Imprimer QR Code individuel
        // ===================================================
        //  FANONTANA QR CODE INDIVIDUEL (VERSION VOAHITSY)
        // ===================================================
        async function printQRCode(employeeId) {
            try {
                // 1. Alaina ny angon'ny QR code efa voatahiry ao amin'ny base de données
                const qrCodeData = await dbManager.get('qr_codes', employeeId);
                if (!qrCodeData || !qrCodeData.dataURL) {
                    showAlert('QR Code tsy hita ao amin\'ny base. Andramo aloha ny manao "Générer Tous les QR".', 'error');
                    return;
                }

                const employee = employees.find(emp => emp.id === employeeId);
                if (!employee) return;

                // 2. Amboarina ny votoaty HTML ho an'ny fanontana
                // Mampiasa mivantana ny dataURL ao anaty <img>, izay fomba azo antoka indrindra
                const printContent = `
                    <html>
                        <head>
                            <title>Impression QR Code - ${employee.name}</title>
                            <style>
                                body { 
                                    margin: 0; 
                                    padding: 20px; 
                                    font-family: Arial, sans-serif; 
                                    text-align: center; 
                                }
                                .qr-print-card {
                                    border: 2px solid #333;
                                    padding: 20px;
                                    margin: 20px auto;
                                    width: 300px; /* Habeny voafaritra tsara */
                                    display: inline-block;
                                }
                                h2 { margin-bottom: 10px; font-size: 1.2em; }
                                p { margin: 5px 0; font-size: 0.9em; }
                                img { 
                                    margin: 15px 0; 
                                    width: 250px; /* Haben'ny sary voafaritra */
                                    height: 250px;
                                }
                            
        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .nav-tabs { padding: 8px; }
            .nav-tab { padding: 8px 12px; font-size: 14px; }
            .container { padding: 8px; }
            .card { padding: 16px; }
            .settings-btn { right: 70px; }
            .theme-toggle { right: 16px; }
            
            /* Optimisation caméra pour mobile */
            .video-container {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
            #qrVideo {
                width: 100% !important;
                height: auto !important;
            }
        }
    
    </style>
                        </head>
                        <body>
                            <div class="qr-print-card">
                                <h2>${employee.name}</h2>
                                <p><strong>Poste:</strong> ${employee.position}</p>
                                <img src="${qrCodeData.dataURL}" alt="QR Code de ${employee.name}">
                                <p><strong>BEHAVANA HR SYSTEM</strong></p>
                                <p>Scanner pour marquer la présence</p>
                            </div>
                        </body>
                    </html>
                `;

                // 3. Amboarina ny varavarankely fanontana
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close(); // Ilaina ity mba hamaranana ny fanoratana

                // 4. Omena fotoana kely ny navigateur hampiditra tsara ilay sary
                setTimeout(() => {
                    printWindow.focus();  // Atao focus ilay varavarankely
                    printWindow.print();  // Alefa ny fanontana
                    printWindow.close();  // Akatona avy eo
                }, 500); // 500ms dia ampy matetika

            } catch (error) {
                console.error('Erreur lors de l\'impression du QR Code:', error);
                showAlert('Nisy olana teo am-panontana ny QR code.', 'error');
            }
        }

        // Télécharger tous les QR codes
        async function downloadAllQRCodes() {
            try {
                const zip = new JSZip(); // Note: JSZip n'est pas inclus, utiliser une alternative simple
                
                showAlert('Fonctionnalité de téléchargement groupé en cours de développement', 'warning');
                
                // Alternative: télécharger un par un
                for (const employee of employees) {
                    await downloadQRCode(employee.id);
                    await new Promise(resolve => setTimeout(resolve, 500)); // Délai entre téléchargements
                }
                
            } catch (error) {
                console.error('Erreur téléchargement groupé:', error);
                showAlert('Erreur lors du téléchargement groupé', 'error');
            }
        }

        // Imprimer tous les QR codes
        // ===================================================
        //  FANONTANA NY QR CODE REHETRA (VERSION VOAHITSY)
        // ===================================================
        async function printAllQRCodes() {
            try {
                // 1. Alaina ny QR code rehetra efa voatahiry
                const allQrCodes = await dbManager.getAll('qr_codes');
                
                if (allQrCodes.length === 0) {
                    showAlert('Tsy misy QR code hontaina. Tsindrio aloha ny "Générer Tous les QR".', 'error');
                    return;
                }

                // 2. Amboarina ny votoaty HTML ho an'ny pejy fanontana
                let printContent = `
                    <html>
                        <head>
                            <title>Impression QR Codes - Tous les Employés</title>
                            <style>
                                body { font-family: Arial, sans-serif; }
                                .page-container {
                                    display: grid;
                                    grid-template-columns: 1fr 1fr; /* Tsanganana roa */
                                    gap: 20px;
                                    padding: 15px;
                                }
                                .qr-item-print {
                                    border: 1px solid #666;
                                    padding: 15px;
                                    text-align: center;
                                    page-break-inside: avoid; /* Mba tsy ho tapaka eo ampovoan'ny pejy */
                                }
                                h3 { margin: 0 0 10px 0; font-size: 14px; }
                                p { margin: 5px 0; font-size: 12px; }
                                img { max-width: 180px; max-height: 180px; margin: 10px 0; }
                                @media print {
                                    body { -webkit-print-color-adjust: exact; } /* Mba ho azo antoka ny loko */
                                }
                            
        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .nav-tabs { padding: 8px; }
            .nav-tab { padding: 8px 12px; font-size: 14px; }
            .container { padding: 8px; }
            .card { padding: 16px; }
            .settings-btn { right: 70px; }
            .theme-toggle { right: 16px; }
            
            /* Optimisation caméra pour mobile */
            .video-container {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
            #qrVideo {
                width: 100% !important;
                height: auto !important;
            }
        }
    
    </style>
                        </head>
                        <body>
                            <h1 style="text-align: center; margin-bottom: 20px;">QR CODES - BEHAVANA HR SYSTEM</h1>
                            <div class="page-container">
                `;

                // 3. Ampidirina isaky ny QR code
                for (const qrCode of allQrCodes) {
                    const employee = employees.find(emp => emp.id === qrCode.employeeId);
                    if (employee && qrCode.dataURL) {
                        printContent += `
                            <div class="qr-item-print">
                                <h3>${employee.name}</h3>
                                <p><strong>Poste:</strong> ${employee.position}</p>
                                <img src="${qrCode.dataURL}" alt="QR Code de ${employee.name}">
                                <p><strong>Scanner pour présence</strong></p>
                            </div>
                        `;
                    }
                }

                printContent += `
                            </div>
                        </body>
                    </html>
                `;

                // 4. Amboarina ny varavarankely fanontana (mitovy amin'ny etsy ambony)
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();

                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                }, 500);

            } catch (error) {
                console.error('Erreur lors de l\'impression de tous les QR codes:', error);
                showAlert('Nisy olana teo am-panontana ny QR code rehetra.', 'error');
            }
        }

        // Mettre à jour les paramètres QR
        function updateQRSettings() {
            qrSettings.size = parseInt(document.getElementById('qrSizeSelect').value);
            qrSettings.color = document.getElementById('qrColorSelect').value;
            
            showAlert('Paramètres QR mis à jour. Regénérez les codes pour appliquer les changements.', 'success');
        }

        // ===============================
        // DATA MANAGEMENT MODIFIÉ POUR QR
        // ===============================
        async function saveData() {
            try {
                // Sauvegarder les données existantes (identique à l'original)
                await dbManager.clear('employees');
                for (const employee of employees) {
                    await dbManager.add('employees', employee);
                }

                // ... aorian'ny for (const employee of employees) { ... }
                await dbManager.clear('groups');
                for (const group of groups) {
                    await dbManager.add('groups', group);
                }


                await dbManager.clear('attendance');
                for (const [date, dayAttendance] of Object.entries(attendance)) {
                    await dbManager.put('attendance', { date, data: dayAttendance });
                }

                await dbManager.clear('payrolls');
                for (const payroll of payrolls) {
                    await dbManager.add('payrolls', payroll);
                }

                await dbManager.clear('advances');
                for (const advance of advances) {
                    await dbManager.add('advances', advance);
                }

                // Sauvegarder les paramètres
                await dbManager.put('settings', { key: 'theme', value: currentTheme });
                await dbManager.put('settings', { key: 'qrSettings', value: qrSettings });
                await dbManager.put('settings', { key: 'lastUpdated', value: new Date().toISOString() }); 
                console.log('Données sauvegardées dans IndexedDB avec QR');
                
                console.log('Données sauvegardées dans IndexedDB avec QR');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showAlert('Erreur lors de la sauvegarde des données', 'error');
            }
        }

        // Sauvegarder seulement les données de présence
        async function saveAttendanceData() {
            try {
                // Fafana aloha ny angona taloha
                await dbManager.clear('attendance');
                
                // Tehirizina ny vaovao
                for (const [date, dayAttendance] of Object.entries(attendance)) {
                    // Ataovy azo antoka fa tsy misy "undefined" ny angona
                    const validDayAttendance = {};
                    for (const empId in dayAttendance) {
                        if (dayAttendance[empId]) {
                            validDayAttendance[empId] = dayAttendance[empId];
                        }
                    }
                    await dbManager.put('attendance', { date, data: validDayAttendance });
                }
            } catch (error) {
                console.error('Erreur sauvegarde présences:', error);
            }
        }


        async function loadData() {
            try {
                // Charger les données existantes (identique à l'original)
                employees = await dbManager.getAll('employees');

                const attendanceRecords = await dbManager.getAll('attendance');
                attendance = {};
                attendanceRecords.forEach(record => {
                    attendance[record.date] = record.data;
                });

                payrolls = await dbManager.getAll('payrolls');
                advances = await dbManager.getAll('advances');
                // ... aorian'ny advances = ...
                groups = await dbManager.getAll('groups');
                console.log(`Groupes: ${groups.length}`);


                // Charger les nouvelles données QR
                qrAttendance = await dbManager.getAll('qr_attendance');

                // Charger les paramètres
                const themeSettings = await dbManager.get('settings', 'theme');
                if (themeSettings) {
                    currentTheme = themeSettings.value;
                }

                const qrSettingsData = await dbManager.get('settings', 'qrSettings');
                if (qrSettingsData) {
                    qrSettings = qrSettingsData.value;
                }

                console.log('Données chargées depuis IndexedDB avec QR');
                console.log(`Employés: ${employees.length}, Présences: ${Object.keys(attendance).length}, QR Présences: ${qrAttendance.length}`);
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                showAlert('Erreur lors du chargement des données', 'error');
            }
        }

        // ===============================
        // STATS MODIFIÉES POUR QR
        // ===================================================
        
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().slice(0, 7);

            // --- Fizarana 1: Fandraisana Elements ---
            const totalEmployeesEl = document.getElementById('totalEmployees');
            const checkedInTodayEl = document.getElementById('checkedInToday');
            const presentTodayEl = document.getElementById('presentToday');
            const totalSalariesEl = document.getElementById('totalSalaries');
            const qrScansTodayEl = document.getElementById('qrScansToday');

            // --- Fizarana 2: Kajy Statistika Fototra ---
            const totalEmployeeCount = employees.length;
            if (totalEmployeesEl) {
                totalEmployeesEl.textContent = totalEmployeeCount;
            }

            // --- Fizarana 3: KAJY PRÉSENCE ---
            const dayAttendance = attendance[today] || {};
            
            // 3.1: Isaina ny mpiasa rehetra nanao pointage (arrivée sy départ)
            const checkedInCount = Object.values(dayAttendance).filter(att => {
                return att && att.arrivee && att.depart;
            }).length;

            // 3.2: Isaina ny mpiasa nahavita journée complète (>= 4 ora)
            const MINIMUM_HOURS_FOR_FULL_DAY = 4;
            const completedPresenceCount = Object.values(dayAttendance).filter(att => {
                if (!att || !att.arrivee || !att.depart) {
                    return false;
                }
                const duration = calculateWorkDuration(att.arrivee, att.depart);
                const durationInHours = duration.totalMinutes / 60;
                return durationInHours >= MINIMUM_HOURS_FOR_FULL_DAY;
            }).length;

            // Affichage
            if (checkedInTodayEl) {
                checkedInTodayEl.textContent = checkedInCount;
            }
            if (presentTodayEl) {
                presentTodayEl.textContent = completedPresenceCount;
            }

            // =====================================================
            // FIZARANA VAOVAO: COUNT BY METHOD (QR/MANUEL/FACIAL)
            // =====================================================
            let qrCount = 0;
            let manualCount = 0;
            let facialCount = 0;
            
            Object.values(dayAttendance).forEach(att => {
                if (!att || !att.arrivee) return; // Tsy isaina raha tsy misy arrivée
                
                const method = att.method || 'MANUAL'; // Default = MANUAL
                
                if (method === 'QR') {
                    qrCount++;
                } else if (method === 'FACIAL') {
                    facialCount++;
                } else {
                    manualCount++;
                }
            });
            
            // Stockage global pour usage amin'ny dropdown menu
            window.attendanceMethodCounts = {
                qr: qrCount,
                manual: manualCount,
                facial: facialCount,
                total: qrCount + manualCount + facialCount
            };
            
            // =====================================================
            // AFFICHAGE: Selon filtre actif
            // =====================================================
            if (qrScansTodayEl) {
                const currentFilter = window.currentMethodFilter || 'all';
                
                let displayCount = 0;
                switch(currentFilter) {
                    case 'qr':
                        displayCount = qrCount;
                        break;
                    case 'manual':
                        displayCount = manualCount;
                        break;
                    case 'facial':
                        displayCount = facialCount;
                        break;
                    case 'all':
                    default:
                        displayCount = qrCount + manualCount + facialCount;
                        break;
                }
                
                qrScansTodayEl.textContent = displayCount;
            }
            
            // Update counts ao @ dropdown menu (raha misokatra)
            updateMethodCounts();

            // --- Fizarana 6: Kajy Salaires ---
            let totalNetSalariesThisMonth = 0;
            const [year, month] = currentMonth.split('-');
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
            
            employees.forEach(employee => {
                const workDays = countPresenceDays(employee.id, currentMonth); 
                const dailySalary = employee.salary / daysInMonth;
                const grossSalary = dailySalary * workDays;
                
                const employeeAdvances = getEmployeeAdvancesForMonth(employee.id, currentMonth);
                const totalAdvances = employeeAdvances.reduce((sum, adv) => sum + adv.amount, 0);
                const netSalary = Math.max(0, grossSalary - totalAdvances);
                totalNetSalariesThisMonth += netSalary;
            });

            if (totalSalariesEl) {
                totalSalariesEl.textContent = formatCurrency(totalNetSalariesThisMonth);
            }

            // Havaozina ny grafika raha eo amin'ny dashboard
            if (document.getElementById('dashboard')?.classList.contains('active')) {
                displayDashboardCharts();
            }
        }





        // ===================================================
        //         FONCTIONS HO AN'NY GRAFIKA DASHBOARD
        // ===================================================

        /**
         * Ity no fonction lehibe miantso ny famoronana ny grafika roa.
         */
        function displayDashboardCharts() {
            // Raha tsy ao amin'ny dashboard isika, dia ajanona mba tsy hanao kajy tsy ilaina
            if (!document.getElementById('dashboard').classList.contains('active')) {
                return;
            }

            // --- Grafika 1: Présence de la Semaine ---
            const weeklyCtx = document.getElementById('weeklyAttendanceChart');
            if (weeklyCtx) {
                const weeklyData = getWeeklyAttendanceData();
                
                // Fafana aloha ny grafika taloha raha misy
                if (weeklyAttendanceChartInstance) {
                    weeklyAttendanceChartInstance.destroy();
                }
                
                weeklyAttendanceChartInstance = new Chart(weeklyCtx, {
                    type: 'bar',
                    data: {
                        labels: weeklyData.labels,
                        datasets: [{
                            label: 'Taux de Présence (%)',
                            data: weeklyData.data,
                            backgroundColor: 'rgba(103, 80, 164, 0.6)',
                            borderColor: 'rgba(103, 80, 164, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // --- Grafika 2: Répartition par Groupe ---
            const groupCtx = document.getElementById('groupDistributionChart');
            if (groupCtx) {
                const groupData = getGroupDistributionData();

                if (groupDistributionChartInstance) {
                    groupDistributionChartInstance.destroy();
                }
                
                groupDistributionChartInstance = new Chart(groupCtx, {
                    type: 'doughnut',
                    data: {
                        labels: groupData.labels,
                        datasets: [{
                            label: 'Employés',
                            data: groupData.data,
                            backgroundColor: [ // Palita-loko mifanaraka amin'ny temanao
                                '#6750A4', '#EADDFF', '#625B71', '#E8DEF8', 
                                '#7D5260', '#FFD8E4', '#49454F'
                            ],
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }

            // ===================================================
            //         FANAMPINY: Grafika 3: Répartition par Genre
            // ===================================================
            const genderCtx = document.getElementById('genderDistributionChart');
            if (genderCtx) {
                const genderData = getGenderDistributionData();

                if (genderDistributionChartInstance) {
                    genderDistributionChartInstance.destroy();
                }
                
                genderDistributionChartInstance = new Chart(genderCtx, {
                    type: 'pie', // Ovaina ho 'pie' (camembert)
                    data: {
                        labels: genderData.labels,
                        datasets: [{
                            label: 'Employés',
                            data: genderData.data,
                            backgroundColor: [
                                '#6750A4', // Loko ho an'ny lehilahy
                                '#FFD8E4', // Loko ho an'ny vehivavy
                                '#CAC4D0'  // Loko ho an'ny "Autre"
                            ],
                            borderColor: [ // Sisiny fotsy mba hisy fiavahana
                                '#FFFFFF',
                                '#FFFFFF',
                                '#FFFFFF'
                            ],
                            borderWidth: 2,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }

        }

        /**
         * Maka ny angona ho an'ny tahan'ny fahatongavana nandritra ny 7 andro farany.
         * @returns {{labels: string[], data: number[]}}
         */
        function getWeeklyAttendanceData() {
            const labels = [];
            const data = [];
            const totalEmployeeCount = employees.length > 0 ? employees.length : 1;

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
                
                labels.push(dayName.charAt(0).toUpperCase() + dayName.slice(1));
                
                const presentCount = attendance[dateString] ? Object.keys(attendance[dateString]).filter(key => attendance[dateString][key]).length : 0;
                const percentage = (presentCount / totalEmployeeCount) * 100;
                data.push(percentage.toFixed(1));
            }
            return { labels, data };
        }

        /**
         * Maka ny angona momba ny fitsinjarana araka ny lahy sy vavy.
         * @returns {{labels: string[], data: number[]}}
         */
        function getGenderDistributionData() {
            let maleCount = 0;
            let femaleCount = 0;
            let otherCount = 0;

            employees.forEach(emp => {
                if (emp.gender === 'Homme') {
                    maleCount++;
                } else if (emp.gender === 'Femme') {
                    femaleCount++;
                } else {
                    otherCount++; // Raha misy genre hafa
                }
            });

            const labels = ['Hommes', 'Femmes'];
            const data = [maleCount, femaleCount];

            if (otherCount > 0) {
                labels.push('Autre');
                data.push(otherCount);
            }

            return { labels, data };
        }


        /**
         * Maka ny angona momba ny fitsinjaran'ny mpiasa isaky ny vondrona.
         * @returns {{labels: string[], data: number[]}}
         */
        function getGroupDistributionData() {
            const groupCounts = {};
            // Ataovy azo antoka fa misy daholo ny vondrona na dia tsy misy mpikambana aza
            groups.forEach(g => groupCounts[g.name] = 0);
            
            let noGroupCount = 0;

            employees.forEach(emp => {
                const group = groups.find(g => g.id === emp.groupId);
                if (group) {
                    groupCounts[group.name]++;
                } else {
                    noGroupCount++;
                }
            });

            const labels = Object.keys(groupCounts);
            const data = Object.values(groupCounts);

            if (noGroupCount > 0) {
                labels.push("Sans Groupe");
                data.push(noGroupCount);
            }
            
            return { labels, data };
        }


        // ===============================
        // FONCTIONS UTILITAIRES
        // ===============================
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===================================================
        //  formatDate (VERSION NOHATSARAINA MISY ANDRO)
        // ===================================================
        function formatDate(dateString, withDayName = true) {
            if (!dateString) return 'N/A';

            const date = new Date(dateString);
            // Manampy ny elanelan'ny timezone mba hisorohana ny fiovan'ny daty
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const correctedDate = new Date(date.getTime() + userTimezoneOffset);

            const options = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            };

            if (withDayName) {
                options.weekday = 'long'; // 'long' = Lundi, 'short' = Lun.
            }

            // Mampiasa 'fr-FR' mba hahazoana ny endrika frantsay
            return new Intl.DateTimeFormat('fr-FR', options).format(correctedDate);
        }


        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount) + ' Ar';
        }

        // =================================================================
        //  FUNCTION VAOVAO: Manamboatra ny fampisehoana ny ora
        // =================================================================
        /**
         * Manova ny endriky ny ora avy amin'ny "20:09:47" ho "20h 09min 47s".
         * @param {string | null} timeString - Ny ora ho avadika (ohatra: "20:09:47").
         * @returns {string} - Ny ora voamboatra na "..." raha tsy misy.
         */
        function formatDisplayTime(timeString) {
            if (!timeString || typeof timeString !== 'string' || !timeString.includes(':')) {
                return "..."; // Averina ity raha tsy misy ora na tsy ara-dalàna
            }
            
            try {
                const parts = timeString.split(':');
                const h = parts[0] || "00";
                const min = parts[1] || "00";
                const s = parts[2] || "00";
                
                return `${h}h ${min}min ${s}s`;
            } catch (e) {
                console.error("Erreur formatage heure:", timeString, e);
                return timeString; // Averina ilay tany am-boalohany raha misy olana
            }
        }

        // ===============================
        // FONCTIONS EXISTANTES (partielles pour l'exemple)
        // ===============================
        
        // =======================================================================
        //  showSection (VERSION FARANY INDRINDRA - TSY MILA MANOVA HTML)
        // =======================================================================
        function showSection(sectionId, event = null) { // Ampiana 'event = null'
            // 1. Afenina daholo aloha ny fizarana rehetra
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 2. Asehoy fotsiny ilay fizarana voatsindry
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                sectionToShow.classList.add('active');
            }
            
            // 3. Ovaina ny endriky ny bokotra fitetezana (nav-tab)
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // --- FANITSIANA LEHIBE ETO ---
            if (event && event.currentTarget) {
                // Raha avy amin'ny clic, dia ampiasaina ny event
                event.currentTarget.classList.add('active');
            } else {
                // Raha avy amin'ny code (toy ny import), dia tadiavina ilay bokotra
                const tabToActivate = document.querySelector(`.nav-tab[onclick*="showSection('${sectionId}')"]`);
                if (tabToActivate) {
                    tabToActivate.classList.add('active');
                }
            }
            // --- FARAN'NY FANITSIANA ---
            
            // 4. Antsoina ny fonction mifanaraka amin'ny fizarana aseho
            switch (sectionId) {
                case 'dashboard':
                    updateStats();
                    displayDashboardCharts();
                    break;
                case 'employees':
                    displayEmployees();
                    break;
                case 'groups':
                    displayGroups();
                    break;
                case 'employee-stats':
                    // Tsy misy atao
                    break;
                case 'attendance':
                    displayAttendance();
                    break;
                case 'qr-presence':
                    displayQRAttendance();
                    break;
                case 'face-presence': 
                    displayEnrolledEmployees();
                    displayTodayFaceAttendance();
                    break;    
                case 'qr-codes':
                    generateAllQRCodes();
                    break;
                case 'advances':
                    displayAdvances();
                    break;
                case 'payroll':
                    document.getElementById('payrollResults').innerHTML = '<p style="text-align: center; padding: 20px;">Veuillez sélectionner un mois et cliquer sur "Calculer Paie".</p>';
                    document.getElementById('payrollSummary').style.display = 'none';
                    break;
                case 'payments':
                    displayPayments();
                    break;
                case 'stc':
                    populateSTCEmployeeSelect();
                    const stcContainer = document.getElementById('stcResultsContainer');
                    if (stcContainer) {
                        stcContainer.style.display = 'none';
                    }
                    break;
                case 'reports':
                    updateReportStats();
                    break;
                case 'estimation':
                    populateGroupSelects();
                    const today = new Date();
                    const startDateInput = document.getElementById('estimationStartDate');
                    const endDateInput = document.getElementById('estimationEndDate');
                    if(startDateInput && endDateInput) {
                        startDateInput.value = today.toISOString().slice(0, 10);
                        const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        endDateInput.value = endOfMonth.toISOString().slice(0, 10);
                    }
                    break;
            }
        }



        // Fonctions simplifiées (garder la logique de l'original)
        function displayEmployees() {
            const container = document.getElementById('employeeList');
            const groupFilter = document.getElementById('employeeGroupFilter').value;
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();

            // Sivana ny mpiasa (tsy miova)
            let filteredEmployees = employees.filter(e => e.status !== 'inactif');
            if (groupFilter === 'none') {
                filteredEmployees = filteredEmployees.filter(emp => !emp.groupId);
            } else if (groupFilter !== 'all') {
                filteredEmployees = filteredEmployees.filter(emp => emp.groupId === groupFilter);
            }
            if (searchTerm) {
                filteredEmployees = filteredEmployees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm) || 
                    emp.position.toLowerCase().includes(searchTerm)
                );
            }

            // Lojika pagination (tsy miova)
            const totalItems = filteredEmployees.length;
            const totalPages = Math.ceil(totalItems / employeeItemsPerPage);
            if (employeeCurrentPage > totalPages) {
                employeeCurrentPage = totalPages > 0 ? totalPages : 1;
            }
            const startIndex = (employeeCurrentPage - 1) * employeeItemsPerPage;
            const endIndex = startIndex + employeeItemsPerPage;
            const paginatedEmployees = filteredEmployees.slice(startIndex, endIndex);

            if (paginatedEmployees.length === 0) {
                container.innerHTML = "<p style='text-align: center; padding: 20px;'>Aucun employé trouvé pour ces critères.</p>";
                document.getElementById('employeePagination').innerHTML = '';
                return;
            }

            // Fampisehoana ny lisitra (tsy miova)
            container.innerHTML = paginatedEmployees.map(employee => {
                // ... (ny kaody fampisehoana ny employee-item dia tsy miova) ...
                const group = groups.find(g => g.id === employee.groupId);
                const groupName = group ? group.name : "<i>Sans groupe</i>";
                const currentMonth = new Date().toISOString().slice(0, 7);
                const totalAdvances = advances
                    .filter(adv => adv.employeeId === employee.id && adv.date.startsWith(currentMonth))
                    .reduce((sum, adv) => sum + adv.amount, 0);
                const advanceHTML = totalAdvances > 0 
                    ? `<p style="color: var(--md-sys-color-error); font-size: 12px; font-weight: 500; margin-top: 4px;"><span class="material-icons" style="font-size: 14px; vertical-align: middle;">trending_down</span>Avances ce mois: ${formatCurrency(totalAdvances)}</p>`
                    : `<p style="color: var(--md-sys-color-success); font-size: 12px; margin-top: 4px;"><span class="material-icons" style="font-size: 14px; vertical-align: middle;">check</span>Aucune avance ce mois</p>`;

                return `
                    <div class="employee-item">
                        <div class="employee-info">
                            <h4>${employee.name}</h4>
                            <p><strong>Poste:</strong> ${employee.position} | <strong>Groupe:</strong> ${groupName}</p>
                            <p><strong>Salaire:</strong> ${formatCurrency(employee.salary)}</p>
                            ${advanceHTML}
                        </div>
                        <div class="employee-actions">
                            <button class="btn-icon" onclick="editEmployee('${employee.id}')" title="Modifier"><span class="material-icons">edit</span></button>
                            <button class="btn-icon" onclick="deleteEmployee('${employee.id}')" title="Supprimer"><span class="material-icons">delete</span></button>
                        </div>
                    </div>
                `;
            }).join('');

            // FANITSIANA NY ANTSO NY RENDERPAGINATIONCONTROLS
            renderPaginationControls(
                'employeePagination', 
                employeeCurrentPage, 
                totalPages, 
                totalItems, // Ampiana ity
                employeeItemsPerPage, // Ampiana koa ity
                (page) => {
                    employeeCurrentPage = page;
                    displayEmployees();
                }
            );
        }


        // ===================================================
        //  UTILITY FUNCTION: DEBOUNCE
        //  Mampiato ny fandehanan'ny asa iray mandra-pisian'ny fiatoana kely
        // ===================================================
        function debounce(func, delay = 300) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

                // =======================================================================
        //  displayAttendance (VERSION FARANY - MISY SIVANA VONDROM-PIASA)
        // =======================================================================
        function displayAttendance() {
            const container = document.getElementById('attendanceList');
            const selectedDate = document.getElementById('attendanceDate').value;
            const searchTerm = document.getElementById('attendanceEmployeeSearch').value.toLowerCase();
            const groupFilter = document.getElementById('attendanceGroupFilter').value;

            if (!selectedDate) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Veuillez sélectionner une date pour commencer.</p>';
                document.getElementById('attendancePagination').innerHTML = ''; 
                return;
            }

            if (!attendance[selectedDate]) {
                attendance[selectedDate] = {};
            }

            let activeEmployees = employees.filter(e => e.status !== 'inactif');

            // Sivana vondrona
            if (groupFilter && groupFilter !== 'all') {
                activeEmployees = activeEmployees.filter(emp => emp.groupId === groupFilter);
            }

            const filteredEmployees = activeEmployees.filter(emp =>
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.position.toLowerCase().includes(searchTerm)
            );

            // ============================================
            // === TRI FIFO: Voalohany tonga eo ambony ===
            // ============================================
            const sortedEmployees = [...filteredEmployees].sort((a, b) => {
                const aPresence = attendance[selectedDate][a.id];
                const bPresence = attendance[selectedDate][b.id];
                
                // Hamarino raha misy arrivée (na boolean na object)
                const aHasArrival = aPresence && (typeof aPresence === 'object' ? aPresence.arrivee : true);
                const bHasArrival = bPresence && (typeof bPresence === 'object' ? bPresence.arrivee : true);
                
                // 1. Présents eo ambony
                if (aHasArrival && !bHasArrival) return -1;
                if (!aHasArrival && bHasArrival) return 1;
                
                // 2. Raha samy présent → Tri par heure (voalohany tonga eo ambony)
                if (aHasArrival && bHasArrival) {
                    if (typeof aPresence === 'object' && aPresence.arrivee && 
                        typeof bPresence === 'object' && bPresence.arrivee) {
                        return aPresence.arrivee.localeCompare(bPresence.arrivee);
                    }
                }
                
                // 3. Raha samy absent → Tri par nom
                return a.name.localeCompare(b.name);
            });

            const totalItems = sortedEmployees.length;
            const totalPages = Math.ceil(totalItems / attendanceItemsPerPage);

            if (attendanceCurrentPage > totalPages) {
                attendanceCurrentPage = totalPages > 0 ? totalPages : 1;
            }
            
            const startIndex = (attendanceCurrentPage - 1) * attendanceItemsPerPage;
            const endIndex = startIndex + attendanceItemsPerPage;
            const paginatedEmployees = sortedEmployees.slice(startIndex, endIndex);

            if (paginatedEmployees.length === 0) {
                container.innerHTML = `<p style="text-align: center; padding: 20px;">Aucun employé trouvé pour les filtres sélectionnés.</p>`;
            } else {
                container.innerHTML = paginatedEmployees.map(employee => {
                    const presenceData = attendance[selectedDate]?.[employee.id];
                    const isPresent = !!presenceData;
                    const isSimplePresence = (typeof presenceData === 'boolean' || typeof presenceData === 'string');
                    const isDetailedPresence = (typeof presenceData === 'object' && presenceData !== null && presenceData.arrivee);
                    const group = groups.find(g => g.id === employee.groupId);
                    const groupName = group ? group.name : "<i>Sans groupe</i>";

                    // ============================================
                    // === BADGE MÉTHODE (Vaovao) ===
                    // ============================================
                    let methodBadge = '';
                    if (isDetailedPresence) {
                        const method = presenceData.method || 'MANUAL';
                        
                        if (method === 'QR') {
                            methodBadge = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; color: #6750A4; margin-left: 8px;">qr_code_scanner</span><span style="font-size: 12px; color: #6750A4; font-weight: 600;">QR</span>';
                        } else if (method === 'FACIAL') {
                            methodBadge = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; color: #0ea5e9; margin-left: 8px;">face</span><span style="font-size: 12px; color: #0ea5e9; font-weight: 600;">FACIAL</span>';
                        } else {
                            methodBadge = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; color: #f59e0b; margin-left: 8px;">edit</span><span style="font-size: 12px; color: #f59e0b; font-weight: 600;">Manuel</span>';
                        }
                    }

                    return `
                        <div class="attendance-item">
                            <div class="attendance-status">
                                <div class="status-indicator ${isPresent ? 'present' : ''}"></div>
                                <div>
                                    <h4 class="employee-name">${employee.name}</h4>
                                    <p class="employee-position">${employee.position}</p>
                                    <p style="font-size: 12px; color: var(--md-sys-color-secondary);"><strong>Groupe:</strong> ${groupName}</p>
                                </div>
                            </div>
                            <div style="width: 50%; text-align: right;">
                                <div style="margin-bottom: 8px; font-size: 12px;">
                                    <label style="margin-right: 16px;">
                                        <input type="radio" name="att-type-${employee.id}" value="simple" onchange="toggleAttendanceType('${employee.id}', 'simple')" ${isSimplePresence || !isPresent ? 'checked' : ''}> Simple
                                    </label>
                                    <label>
                                        <input type="radio" name="att-type-${employee.id}" value="detailed" onchange="toggleAttendanceType('${employee.id}', 'detailed')" ${isDetailedPresence ? 'checked' : ''}> Détaillé
                                    </label>
                                </div>
                                <div id="simple-att-${employee.id}" style="display: ${isSimplePresence || !isPresent ? 'flex' : 'none'}; align-items: center; justify-content: flex-end; gap: 8px;">
                                    <label for="att-check-${employee.id}" style="cursor: pointer; font-weight: 500; color: ${isPresent ? 'var(--md-sys-color-success)' : 'var(--md-sys-color-error)'};">
                                        ${isPresent ? 'Présent (Journée)' : 'Absent'}
                                    </label>
                                    <input type="checkbox" class="checkbox" id="att-check-${employee.id}" ${isPresent ? 'checked' : ''} onchange="updateAttendanceCheckbox('${employee.id}', '${selectedDate}', this.checked)">
                                </div>
                                <div id="detailed-att-${employee.id}" style="display: ${isDetailedPresence ? 'block' : 'none'};">
                                    ${isDetailedPresence ? `
                                        <div style="font-size: 14px; margin-bottom: 8px;">
                                            <span>Arrivée: <b>${formatDisplayTime(presenceData.arrivee)}</b></span> | 
                                            <span>Départ: <b>${formatDisplayTime(presenceData.depart)}</b></span>
                                            ${methodBadge}
                                        </div>
                                        ${!presenceData.depart ? `<button class="btn btn-warning" style="padding: 8px 12px;" onclick="recordTime('${employee.id}', 'depart', '${selectedDate}')"><span class="material-icons" style="font-size: 18px;">logout</span> Départ</button>` : ''}
                                        <button class="btn btn-danger" style="padding: 8px 12px;" onclick="clearAttendance('${employee.id}', '${selectedDate}')"><span class="material-icons" style="font-size: 18px;">clear</span> Annuler</button>
                                    ` : `
                                        <button class="btn btn-success" style="padding: 8px 12px;" onclick="recordTime('${employee.id}', 'arrivee', '${selectedDate}')"><span class="material-icons" style="font-size: 18px;">login</span> Arrivée</button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderPaginationControls(
                'attendancePagination',
                attendanceCurrentPage,
                totalPages,
                totalItems,
                attendanceItemsPerPage,
                (page) => {
                    attendanceCurrentPage = page;
                    displayAttendance(); 
                }
            );
        }


                // =======================================================================
        //  FONCTION VAOVAO: Manova ny karazana fampidirana présence
        // =======================================================================
        function toggleAttendanceType(employeeId, type) {
            const simpleDiv = document.getElementById(`simple-att-${employeeId}`);
            const detailedDiv = document.getElementById(`detailed-att-${employeeId}`);

            if (type === 'simple') {
                simpleDiv.style.display = 'flex';
                detailedDiv.style.display = 'none';
            } else {
                simpleDiv.style.display = 'none';
                detailedDiv.style.display = 'block';
            }
        }


        function displayAdvances() {
            const container = document.getElementById('advancesList');
            
            // Alaina ny sivana rehetra (tsy miova)
            const searchTerm = document.getElementById('advanceSearchInput').value.toLowerCase();
            const monthFilter = document.getElementById('advanceMonthFilter').value;
            const groupFilter = document.getElementById('advanceGroupFilter').value;

            let filteredAdvances = advances.filter(advance => {
                const employee = employees.find(emp => emp.id === advance.employeeId);
                if (!employee) return false;

                const matchesSearch = employee.name.toLowerCase().includes(searchTerm) ||
                                    employee.position.toLowerCase().includes(searchTerm) ||
                                    (advance.reason || '').toLowerCase().includes(searchTerm);
                
                const matchesMonth = !monthFilter || advance.date.startsWith(monthFilter);
                const matchesGroup = groupFilter === 'all' || employee.groupId === groupFilter;

                return matchesSearch && matchesMonth && matchesGroup;
            });

            // Alahatra araka ny daty (tsy miova)
            filteredAdvances.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Lojika Pagination (tsy miova)
            const totalItems = filteredAdvances.length;
            const totalPages = Math.ceil(totalItems / advancesItemsPerPage);
            if (advancesCurrentPage > totalPages && totalPages > 0) {
                advancesCurrentPage = totalPages;
            } else if (totalPages === 0) {
                advancesCurrentPage = 1;
            }
            const startIndex = (advancesCurrentPage - 1) * advancesItemsPerPage;
            const endIndex = startIndex + advancesItemsPerPage;
            const paginatedAdvances = filteredAdvances.slice(startIndex, endIndex);

            if (paginatedAdvances.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--md-sys-color-on-surface-variant);">Aucune avance trouvée pour ces critères.</p>';
                document.getElementById('advancesPagination').innerHTML = '';
                return;
            }

            // ================== FANITSIANA LEHIBE ETO ==================
            container.innerHTML = paginatedAdvances.map(advance => {
                const employee = employees.find(emp => emp.id === advance.employeeId);
                const employeeName = employee ? employee.name : "Mpiasa voafafa";
                const employeePosition = employee ? employee.position : 'Poste tsy hita';
                
                // Famaritana ny sata sy ny loko mifanaraka aminy
                const status = advance.status || 'En attente'; // Raha tsy misy dia 'En attente'
                const isConfirmed = status === 'Confirmé';
                const statusColor = isConfirmed ? 'var(--md-sys-color-success)' : 'var(--md-sys-color-warning)';
                const statusIcon = isConfirmed ? 'check_circle' : 'hourglass_top';
                const statusText = isConfirmed ? 'Confirmé' : 'En attente';

                // Famaritana ny bokotra aseho arakaraka ny sata
                let actionButtonsHTML = '';
                if (!isConfirmed) {
                    actionButtonsHTML = `
                        <button class="btn btn-success" style="padding: 8px 12px;" onclick="confirmAdvance('${advance.id}')" title="Confirmer le paiement de cette avance">
                            <span class="material-icons" style="font-size: 18px;">check</span> Confirmer
                        </button>
                        <button class="btn-icon" onclick="openEditAdvanceModal('${advance.id}')" title="Modifier l'avance">
                            <span class="material-icons">edit</span>
                        </button>
                    `;
                }

                return `
                    <div class="advance-item" style="border-left: 5px solid ${statusColor};">
                        <div class="advance-info">
                            <h4>${employeeName}</h4>
                            <p><strong>Poste:</strong> ${employeePosition}</p>
                            <p><strong>Date:</strong> ${formatDate(advance.date, false)} | <strong>Motif:</strong> ${advance.reason || 'Non spécifié'}</p>
                            
                            <!-- Fampisehoana ny sata vaovao -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-weight: 500; color: ${statusColor};">
                                <span class="material-icons">${statusIcon}</span>
                                <span>Statut: ${statusText}</span>
                            </div>
                        </div>
                        <div class="amount-actions">
                            <div class="amount">${formatCurrency(advance.amount)}</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${actionButtonsHTML}
                                <button class="btn-icon" onclick="deleteAdvance('${advance.id}')" title="Supprimer l'avance">
                                    <span class="material-icons">delete_outline</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            // ================== FARAN'NY FANITSIANA ==================

            // Fampisehoana ny famintinana sy ny pagination (tsy miova)
            const totalAmount = filteredAdvances.reduce((sum, advance) => sum + advance.amount, 0);
            document.getElementById('totalAdvancesMonth').textContent = formatCurrency(totalAmount);
            // ... (ny tohin'ny function dia tsy miova)
            
            renderPaginationControls(
                'advancesPagination', 
                advancesCurrentPage, 
                totalPages, 
                totalItems, 
                advancesItemsPerPage, 
                (page) => {
                    advancesCurrentPage = page;
                    displayAdvances();
                }
            );
        }





        // ===================================================
        //  FONCTION DE FILTRAGE POUR LA SECTION PRÉSENCE
        // ===================================================
        function filterAttendanceEmployees() {
            const searchTerm = document.getElementById('attendanceEmployeeSearch').value.toLowerCase();
            const attendanceItems = document.querySelectorAll('#attendanceList .attendance-item');
            
            attendanceItems.forEach(item => {
                const employeeName = item.querySelector('.employee-name')?.textContent.toLowerCase() || '';
                const employeePosition = item.querySelector('.employee-position')?.textContent.toLowerCase() || '';
                
                const matches = employeeName.includes(searchTerm) || employeePosition.includes(searchTerm);
                item.style.display = matches ? 'flex' : 'none';
            });
            
            // Afficher un message si aucun résultat
            const visibleItems = document.querySelectorAll('#attendanceList .attendance-item[style*="flex"]');
            const noResultsMsg = document.getElementById('attendanceNoResults');
            
            if (visibleItems.length === 0 && searchTerm.length > 0) {
                if (!noResultsMsg) {
                    const msg = document.createElement('div');
                    msg.id = 'attendanceNoResults';
                    msg.className = 'no-results-message';
                    msg.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--md-sys-color-on-surface-variant);">
                            <span class="material-icons" style="font-size: 48px; opacity: 0.5;">search_off</span>
                            <p>Aucun employé trouvé pour "${searchTerm}"</p>
                        </div>
                    `;
                    document.getElementById('attendanceList').appendChild(msg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }


                // --- Fanitsiana ny recordTime ---
        async function recordTime(employeeId, type, date, method = 'MANUAL') {
            const now = new Date();
            const currentTime = now.toLocaleTimeString('fr-FR', { hour12: false });

            if (!attendance[date]) {
                attendance[date] = {};
            }

            // Fafana aloha ny mety ho angona "simple" (true) taloha
            if (typeof attendance[date][employeeId] !== 'object') {
                delete attendance[date][employeeId];
            }

            if (type === 'arrivee') {
                attendance[date][employeeId] = { 
                    arrivee: currentTime, 
                    depart: null, 
                    method: method  // ← MANDRAY METHOD AVY ANY IVELANY
                };
                showAlert(`${employees.find(e=>e.id===employeeId).name} marqué arrivé à ${currentTime}`, 'success');
            } else if (type === 'depart' && attendance[date][employeeId]) {
                attendance[date][employeeId].depart = currentTime;
                showAlert(`${employees.find(e=>e.id===employeeId).name} marqué parti à ${currentTime}`, 'success');
            }

            await saveAttendanceData();
            displayAttendance();
            updateStats();
            runSmartChecks();
        }


        // --- Fanitsiana ny clearAttendance ---
        async function clearAttendance(employeeId, date) {
            if (confirm("Voulez-vous vraiment annuler la présence de cet employé pour aujourd'hui ?")) {
                if (attendance[date] && attendance[date][employeeId]) {
                    delete attendance[date][employeeId];
                }
                await saveAttendanceData();
                displayAttendance();
                updateStats();
                runSmartChecks();
                showAlert("Présence annulée.", "success");
            }
        }


                // =======================================================================
        //  FONCTION VAOVAO: Manavao ny présence avy amin'ny Checkbox
        // =======================================================================
        async function updateAttendanceCheckbox(employeeId, date, isChecked) {
            if (!attendance[date]) {
                attendance[date] = {};
            }

            // Raha voatsindry ilay checkbox
            if (isChecked) {
                // Fafana aloha ny mety ho angona "détaillé" (misy ora) taloha
                if (typeof attendance[date][employeeId] === 'object') {
                    delete attendance[date][employeeId];
                }
                // Apetraka ho "true" ny sandany, izay midika hoe "journée entière"
                attendance[date][employeeId] = true; 
            } 
            // Raha nesorina ny "check"
            else {
                // Fafana ny firaketana ho an'io mpiasa io amin'io daty io
                delete attendance[date][employeeId];
            }

            // Tehirizina avy hatrany ny fanovana mba tsy ho very
            await saveAttendanceData();
            
            // Havaozina ny fampisehoana mba hiova ny loko sy ny soratra
            displayAttendance();
            
            // Havaozina ny statistika ankapobeny
            updateStats();
            runSmartChecks();
        }


        async function updateAttendance(employeeId, isPresent, date) {
            if (!attendance[date]) {
                attendance[date] = {};
            }
            
            // 1️⃣ Mise à jour présence manuelle
            attendance[date][employeeId] = isPresent;

            // 2️⃣ Synchronisation avec présence QR
            const existingQR = qrAttendance.findIndex(att => att.employeeId === employeeId && att.date === date);
            
            if (isPresent && existingQR === -1) {
                // 🔍 Ajouter présence QR si coché manuellement
                const employee = employees.find(emp => emp.id === employeeId);
                const record = {
                    id: Date.now().toString(),
                    employeeId,
                    employeeName: employee.name,
                    employeePosition: employee.position,
                    date,
                    timestamp: new Date().toISOString(),
                    method: 'MANUAL'
                };
                qrAttendance.push(record);
                await dbManager.add('qr_attendance', record);

            } else if (!isPresent && existingQR !== -1) {
                // ❌ Supprimer présence QR si décoché manuellement
                const recordToDelete = qrAttendance[existingQR];
                qrAttendance.splice(existingQR, 1);
                await dbManager.delete('qr_attendance', recordToDelete.id);
            }

            await saveAttendanceData();
            if (document.getElementById('qr-presence').classList.contains('active')) {
                displayQRAttendance();
            }
            
            // Havaozina ny statistika
            updateStats();
             // Actualiser l'affichage QR
        }

        async function saveAttendance() {
            await saveData();
            updateStats();
            runSmartChecks();
            showAlert('Présences enregistrées avec succès!', 'success');
        }

        // Fonctions d'employés simplifiées
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;

            // Famenoana ireo sehatra fototra
            document.getElementById('editEmployeeId').value = employee.id;
            document.getElementById('editEmployeeName').value = employee.name;
            document.getElementById('editEmployeePosition').value = employee.position;
            document.getElementById('editEmployeeGender').value = employee.gender;
            setCurrencyValue('editEmployeeSalary', employee.salary);
            document.getElementById('editEmployeeGroup').value = employee.groupId || "";

            // Fandraisana ireo element vaovao
            const statusSelect = document.getElementById('editEmployeeStatus');
            const departureDateInput = document.getElementById('editEmployeeDepartureDate');
            const departureContainer = document.getElementById('editDepartureDateContainer'); // Mampiasa ny ID marina

            // Fanamarinana sao misy tsy hita ireo element
            if (!statusSelect || !departureDateInput || !departureContainer) {
                console.error("Erreur: Tsy hita ny sehatra status na date de départ ao amin'ny edit modal.");
                openModal('editEmployeeModal'); // Sokafana ihany ny modal fa misy fampitandremana
                return;
            }

            // Famenoana ny sata sy ny daty fialana
            statusSelect.value = employee.status || 'actif';
            departureDateInput.value = employee.departureDate || '';

            // Fampisehoana na fanafenana ny sehatry ny daty
            if (statusSelect.value === 'depart' || statusSelect.value === 'inactif') {
                departureContainer.style.display = 'block';
            } else {
                departureContainer.style.display = 'none';
            }
            
            // Sokafana ny modal rehefa vita daholo ny zava-drehetra
            openModal('editEmployeeModal');
        }



        async function deleteEmployee(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet employé?')) {
                employees = employees.filter(emp => emp.id !== id);
                Object.keys(attendance).forEach(date => {
                    delete attendance[date][id];
                });
                // Supprimer aussi les présences QR
                qrAttendance = qrAttendance.filter(att => att.employeeId !== id);
                await saveData();
                updateStats();
                displayEmployees();
                populateEmployeeSelects();
                showAlert('Employé supprimé avec succès!', 'success');
            }
        }

        // --- FONCTIONS VAOVAO HO AN'NY FANAVANA Trosa ---

        // Manokatra ny modal fanovana sy mameno ny fampahalalana
        function openEditAdvanceModal(advanceId) {
            const advance = advances.find(adv => adv.id === advanceId);
            if (!advance) {
                showAlert("Erreur: Avance non trouvée.", 'error');
                return;
            }

            document.getElementById('editAdvanceId').value = advance.id;
            document.getElementById('editAdvanceEmployeeName').textContent = advance.employeeName;
            setCurrencyValue('editAdvanceAmount', advance.amount);
            document.getElementById('editAdvanceDate').value = advance.date;
            document.getElementById('editAdvanceReason').value = advance.reason || '';
            
            openModal('editAdvanceModal');
        }

        // Manavao ny trosa rehefa voatsindry ny bokotra "Enregistrer"
        async function handleUpdateAdvance(event) {
            event.preventDefault();
            
            const advanceId = document.getElementById('editAdvanceId').value;
            const newAmount = getCurrencyValue('editAdvanceAmount');
            const newDate = document.getElementById('editAdvanceDate').value;
            const newReason = document.getElementById('editAdvanceReason').value.trim();

            const advanceIndex = advances.findIndex(adv => adv.id === advanceId);
            if (advanceIndex === -1) {
                showAlert("Erreur critique: Avance non trouvée lors de la sauvegarde.", 'error');
                return;
            }

            // Fanavaozana ny fampahalalana
            advances[advanceIndex].amount = newAmount;
            advances[advanceIndex].date = newDate;
            advances[advanceIndex].reason = newReason;

            await saveData(); // Tehirizina ny fanovana
            
            closeModal('editAdvanceModal');
            displayAdvances(); // Havaozina ny fampisehoana ny lisitra
            updateStats(); // Havaozina ny statistika ankapobeny
            showAlert("L'avance a été mise à jour avec succès!", 'success');
        }



        async function deleteAdvance(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette avance?')) {
                advances = advances.filter(adv => adv.id !== id);
                await saveData();
                updateStats();
                displayAdvances();
                showAlert('Avance supprimée avec succès!', 'success');
            }
        }

        // Gestion des paies
        function displayPayrollResults(results = []) {
            const container = document.getElementById('payrollResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p>Aucun résultat à afficher. Effectuez un calcul de paie.</p>';
                return;
            }

            container.innerHTML = `
                <h3 style="margin: 24px 0 16px 0; color: var(--md-sys-color-primary);">
                    Résultats de Paie - ${results[0]?.month || ''}
                </h3>
                ${results.map(result => {
                    // ⭐ VAOVAO: Manisa ny andro nisy
                    const attendanceDays = result.workDays || 0;
                    const attendanceBadgeHTML = createAttendanceBadge(attendanceDays);
                    
                    return `
                        <div class="payroll-item ${result.status === 'PAID' ? 'paid' : ''}">
                            <div class="payroll-header">
                                <h4>
                                    ${result.employee.name}
                                    ${attendanceBadgeHTML}
                                </h4>
                                <div class="payroll-actions">
                                    ${result.status === 'PAID' ? `
                                        <button class="btn btn-secondary" onclick="updatePayrollPrompt('${result.id}')">
                                            <span class="material-icons">edit</span>
                                            Modifier
                                        </button>
                                        <button class="btn btn-danger" onclick="deleteExistingPayroll('${result.id}')">
                                            <span class="material-icons">delete</span>
                                            Supprimer
                                        </button>
                                    ` : `
                                        <button class="btn" onclick="savePayroll('${result.employee.id}', '${result.month}', ${result.netSalary})">
                                            <span class="material-icons">save</span>
                                            Enregistrer
                                        </button>
                                    `}
                                </div>
                            </div>
                            <div class="payroll-details">
                                <div><strong>Jours travaillés:</strong> ${result.workDays}/${result.daysInMonth}</div>
                                <div><strong>Salaire brut:</strong> ${formatCurrency(result.grossSalary)}</div>
                                <div><strong>Avances:</strong> ${formatCurrency(result.totalAdvances)}</div>
                                <div><strong>Salaire net:</strong> <span class="amount">${formatCurrency(result.netSalary)}</span></div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function updatePayrollPrompt(payrollId) {
            const payroll = payrolls.find(p => p.id === payrollId);
            if (!payroll) return;

            const newAmount = prompt(`Nouveau montant pour ${payroll.employeeName} (${formatCurrency(payroll.amount)} actuel)`, formatCurrency(payroll.amount));
            if (newAmount) {
                const amount = getCurrencyValueFromInput(newAmount);
                if (amount > 0) {
                    payroll.amount = amount;
                    payroll.date = new Date().toISOString();
                    payroll.status = 'UPDATED';
                    updatePayroll(payroll);
                } else {
                    showAlert('Montant invalide', 'error');
                }
            }
        }

        async function deleteExistingPayroll(payrollId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce paiement?')) {
                payrolls = payrolls.filter(p => p.id !== payrollId);
                await saveData();
                updateStats();
                displayPayrollResults();
                showAlert('Paiement supprimé avec succès!', 'success');
            }
        }

        // ===================================================
        //  calculatePayroll (VERSION FARANY - KAJY MARINA SY AZO ANTOKA)
        // ===================================================
        async function calculatePayroll() {
            const container = document.getElementById('payrollResults');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>Vérification et calcul en cours...</p></div>';

            const selectedMonth = document.getElementById('payrollMonth').value;
            const selectedEmployeeId = document.getElementById('payrollEmployeeSelect').value;
            const selectedGroupId = document.getElementById('payrollGroupFilter').value;
            // ===================================================
            const includeAdvance = document.getElementById('includeAdvanceCheckbox').checked;
            const advanceDays = parseInt(document.getElementById('advanceDaysInput').value) || 0;
            // ===================================================

            if (!selectedMonth) {
                showAlert('Veuillez sélectionner un mois', 'error');
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Veuillez sélectionner un mois pour commencer.</p>';
                return;
            }

            // ===================================================
            //      FAMINTINANA
            // ===================================================
            const summaryContainer = document.getElementById('payrollSummary');
            const summaryGrossEl = document.getElementById('summaryTotalGross');
            const summaryAdvancesEl = document.getElementById('summaryTotalAdvances');
            const summaryNetEl = document.getElementById('summaryTotalNet');
            const unpaidListEl = document.getElementById('unpaidEmployeesList');
            // ===================================================


            let totalNetToPay = 0;
            let unpaidEmployeesData = [];

            // Sivana ny mpiasa
            let employeesToProcess = employees.filter(e => e.status === 'actif' || e.status === 'depart' || !e.status);
            if (selectedGroupId !== 'all') {
                employeesToProcess = employeesToProcess.filter(emp => emp.groupId === selectedGroupId);
            }
            if (selectedEmployeeId) {
                employeesToProcess = employeesToProcess.filter(e => e.id === selectedEmployeeId);
            }

            if (employeesToProcess.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Aucun employé trouvé pour ces critères.</p>';
                summaryContainer.style.display = 'none';
                return;
            }

            const existingPayrollsForMonth = payrolls.filter(p => p.month === selectedMonth);
            const [year, month] = selectedMonth.split('-');
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
            const payrollHTML = [];

            // --- KAJY ISAKY NY MPIASA (Fizarana nohamafisina) ---
            // =======================================================================
            //  KAODY VAOVAO HASOLO ILAY TALOHA
            // =======================================================================
            for (let emp of employeesToProcess) {
                // 1. Kajy ny karama ho an'ny volana voafidy (tsy miova)
                const presenceDays = countPresenceDays(emp.id, selectedMonth);
                const proportionalSalary = (emp.salary / daysInMonth) * presenceDays;
                const totalAdvances = advances
                    .filter(a => a.employeeId === emp.id && a.date.startsWith(selectedMonth))
                    .reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
                const netSalaryForMonth = Math.max(0, proportionalSalary - totalAdvances);

                // 2. Kajy ny Acompte (raha voatsindry ilay safidy)
                let advanceAmountForNextMonth = 0;
                if (includeAdvance && advanceDays > 0) {
                    // Kajiana ny karama isan'andro amin'ny volana manaraka
                    const [year, month] = selectedMonth.split('-').map(Number);
                    const nextMonthDate = new Date(year, month, 1); // Volana manaraka (ny JS dia manitsy ho azy ny taona raha ilaina)
                    const nextMonthYear = nextMonthDate.getFullYear();
                    const nextMonthMonth = nextMonthDate.getMonth() + 1;
                    const daysInNextMonth = getDaysInMonth(nextMonthYear, nextMonthMonth);
                    
                    advanceAmountForNextMonth = (emp.salary / daysInNextMonth) * advanceDays;
                }

                // 3. Kajy ny totaly farany horaisina
                const finalNetToPay = netSalaryForMonth + advanceAmountForNextMonth;

                const existingPayment = existingPayrollsForMonth.find(p => p.employeeId === emp.id);
                const isPaid = !!existingPayment;

                if (!isPaid && finalNetToPay > 0) {
                    totalNetToPay += finalNetToPay;
                    unpaidEmployeesData.push({ id: emp.id, name: emp.name });
                }

                // 4. Fampisehoana ny antsipiriany (misy fanovana)
                payrollHTML.push(`
                    <div class="payroll-item ${isPaid ? 'paid' : ''}" id="payroll-item-${emp.id}" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; border: 1px solid var(--md-sys-color-outline-variant); border-left-width: 6px;">
                        <div>
                            <h4>
                                ${emp.name}
                                <span class="attendance-badge ${presenceDays === 0 ? 'no-attendance' : ''}">
                                    <span class="material-icons">${presenceDays === 0 ? 'event_busy' : 'check_circle'}</span>
                                    <span>${presenceDays} jour${presenceDays > 1 ? 's' : ''}</span>
                                </span>
                            </h4>
                            <p>${emp.position}</p>
                            <div class="payroll-status-container">
                                ${isPaid ? `
                                    <div class="employee-status present">
                                        <span class="material-icons">check_circle</span> Payé le ${formatDate(existingPayment.date, false)}
                                    </div>
                                    <small>Montant payé: <b class="amount" style="color: var(--md-sys-color-success);">${formatCurrency(existingPayment.amount)}</b></small>
                                ` : `
                                    <div style="font-size: 0.9em; margin-top: 5px;">
                                        <span title="Détail du salaire pour ${selectedMonth}">Salaire ${selectedMonth}: <b>${formatCurrency(netSalaryForMonth)}</b></span>
                                        
                                        <!-- Ity no andalana vaovao mampiseho ny acompte -->
                                        ${ includeAdvance && advanceAmountForNextMonth > 0 ? `
                                            <br>
                                            <span title="Acompte pour le mois suivant" style="color: var(--md-sys-color-primary);">+ Acompte (${advanceDays}j): <b>${formatCurrency(advanceAmountForNextMonth)}</b></span>
                                        ` : '' }
                                        
                                        <hr style="margin: 4px 0; border-color: var(--md-sys-color-outline-variant);">
                                        <strong title="Salaire net final à payer">Net Total à Payer: ${formatCurrency(finalNetToPay)}</strong>
                                    </div>
                                `}
                            </div>
                        </div>
                        <div class="payroll-actions" style="text-align: right; display: flex; align-items: center; gap: 8px;">
                            ${isPaid ? `
                                <button class="btn-icon" onclick="deleteExistingPayroll('${existingPayment.id}')" title="Supprimer le paiement">
                                    <span class="material-icons" style="color: var(--md-sys-color-error);">delete</span>
                                </button>
                            ` : (finalNetToPay > 0 ? `
                                <button class="btn btn-success" onclick="savePayroll('${emp.id}', '${selectedMonth}', ${finalNetToPay}, ${advanceAmountForNextMonth})">
                                    <span class="material-icons">save</span> Payer
                                </button>
                            ` : '<small>Aucun paiement requis</small>')}
                        </div>
                    </div>
                `);
            }
            // ===================================================
            //      KAODY VAOVAO HASOLO ILAY TEBOKA FAHA-5
            // ===================================================
            // Kajiana ny totalin'ny trosa ho an'ny famintinana
            let totalAdvancesForSummary = 0;
            employeesToProcess.forEach(emp => {
                const advancesInMonth = advances
                    .filter(a => a.employeeId === emp.id && a.date.startsWith(selectedMonth))
                    .reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
                totalAdvancesForSummary += advancesInMonth;
            });

            // Ny totalin'ny karama brut dia ny totaly net ampiana ny trosa efa nesorina
            const totalGrossForSummary = totalNetToPay + totalAdvancesForSummary;

            summaryContainer.style.display = 'block';
            summaryGrossEl.textContent = formatCurrency(totalGrossForSummary);
            summaryAdvancesEl.textContent = formatCurrency(totalAdvancesForSummary);
            summaryNetEl.textContent = formatCurrency(totalNetToPay);
            summaryNetEl.dataset.amount = totalNetToPay; // Tehirizina foana ity mba hiasan'ny fanalana vola rehefa mandoa

            if (unpaidEmployeesData.length > 0) {
                unpaidListEl.innerHTML = unpaidEmployeesData.map(emp => `<div id="unpaid-name-${emp.id}">- ${emp.name}</div>`).join('');
            } else {
                unpaidListEl.innerHTML = '<span style="color: var(--md-sys-color-success);">Tous les employés pour cette période ont été payés.</span>';
            }

            container.innerHTML = payrollHTML.join('');
            // ===================================================

        }

        // Sauvegarde d'une nouvelle paie (évite doublons)
        // =======================================================================
        //  DINGANA 4: Soloina manontolo ity fiasa ity
        // =======================================================================
        async function savePayroll(employeeId, month, totalAmount, advanceAmount = 0) {
            const existing = payrolls.find(p => p.employeeId === employeeId && p.month === month);
            if (existing) {
                showAlert("Cet employé a déjà été payé pour ce mois", "error");
                return;
            }

            const emp = employees.find(e => e.id === employeeId);
            if (!emp) return;

            // 1. Fandraiketana ny karaman'ny volana ankehitriny
            const payrollRecord = {
                id: Date.now().toString(),
                employeeId: employeeId,
                employeeName: emp.name,
                position: emp.position,
                month: month,
                amount: parseFloat(totalAmount), // Raketina ny totalin'ny vola nomena
                date: new Date().toISOString()
            };
            payrolls.push(payrollRecord);
            await dbManager.add('payrolls', payrollRecord);

            // 2. Fandraiketana ny Acompte ho "Avance" ho an'ny volana manaraka (raha misy)
            if (advanceAmount > 0) {
                const [year, monthNum] = month.split('-').map(Number);
                const nextMonthDate = new Date(year, monthNum, 1);
                const nextMonthString = `${nextMonthDate.getFullYear()}-${(nextMonthDate.getMonth() + 1).toString().padStart(2, '0')}`;
                
                const advanceRecord = {
                    id: `adv-${Date.now().toString()}`,
                    employeeId: employeeId,
                    employeeName: emp.name,
                    amount: advanceAmount,
                    date: `${nextMonthString}-01`, // Apetraka amin'ny andro voalohan'ny volana manaraka
                    reason: `Acompte payé avec le salaire de ${month}`,
                    dateCreated: new Date().toISOString()
                };
                advances.push(advanceRecord);
                await dbManager.add('advances', advanceRecord);
            }

            showAlert("Paie enregistrée avec succès!", "success");

            // Ny tohin'ny kaody manavao ny interface dia tsy miova
            const remainingToPayEl = document.getElementById('remainingToPay');
            const unpaidNameEl = document.getElementById(`unpaid-name-${employeeId}`);

            if (remainingToPayEl) {
                let currentRemainingAmount = parseFloat(remainingToPayEl.dataset.amount || 0);
                currentRemainingAmount -= parseFloat(totalAmount);
                remainingToPayEl.textContent = formatCurrency(currentRemainingAmount);
                remainingToPayEl.dataset.amount = currentRemainingAmount;
            }

            if (unpaidNameEl) {
                unpaidNameEl.style.textDecoration = 'line-through';
                unpaidNameEl.style.opacity = '0.6';
            }

            const payrollItem = document.getElementById(`payroll-item-${employeeId}`);
            if (payrollItem) {
                payrollItem.classList.add('paid');
                const actionContainer = payrollItem.querySelector('.payroll-actions');
                const statusContainer = payrollItem.querySelector('.payroll-status-container');

                if (actionContainer) {
                    actionContainer.innerHTML = `
                        <button class="btn-icon" onclick="deleteExistingPayroll('${payrollRecord.id}')" title="Supprimer le paiement">
                            <span class="material-icons" style="color: var(--md-sys-color-error);">delete</span>
                        </button>
                    `;
                }
                
                if (statusContainer) {
                    statusContainer.innerHTML = `
                        <div class="employee-status present">
                            <span class="material-icons">check_circle</span> Payé le ${formatDate(payrollRecord.date, false)}
                        </div>
                        <small>Montant payé: <b class="amount" style="color: var(--md-sys-color-success);">${formatCurrency(payrollRecord.amount)}</b></small>
                    `;
                }
            }

            updateStats();
        }
        // =======================================================================

        // Modifier une paie existante
        async function updatePayroll(payrollId) {
            const payroll = payrolls.find(p => p.id === payrollId);
            if (!payroll) return;

            const newAmount = prompt("Nouveau montant:", payroll.amount);
            if (newAmount === null || isNaN(parseFloat(newAmount))) {
                showAlert("Montant invalide", "error");
                return;
            }

            payroll.amount = parseFloat(newAmount);
            payroll.status = 'UPDATED';
            await dbManager.put('payrolls', payroll);
            showAlert("Paie mise à jour", "success");

            calculatePayroll();
            updateStats();
        }

        // Supprimer une paie existante
        async function deleteExistingPayroll(payrollId) {
            if (!confirm("Voulez-vous vraiment supprimer cette paie ?")) return;

            const index = payrolls.findIndex(p => p.id === payrollId);
            if (index !== -1) {
                const payroll = payrolls[index];
                payrolls.splice(index, 1);
                await dbManager.delete('payrolls', payrollId);
                showAlert("Paie supprimée", "success");
            }

            calculatePayroll();
            updateStats();
        }

        async function deleteExistingPayroll(payrollId) {
            if (!confirm("Voulez-vous vraiment supprimer cette paie ?")) return;

            const index = payrolls.findIndex(p => p.id === payrollId);
            if (index !== -1) {
                payrolls.splice(index, 1);
                await dbManager.delete('payrolls', payrollId);
                showAlert("Paie supprimée", "success");
            }

            calculatePayroll();
            updateStats();
        }

        async function deletePayment(paymentId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce paiement?')) {
                payrolls = payrolls.filter(p => p.id !== paymentId);
                await saveData();
                displayPayments();
                showAlert('Paiement supprimé avec succès!', 'success');
            }
        }

        // Gestion des paiements
        function displayPayments() {
            const employeeFilter = document.getElementById('paymentEmployeeFilter').value;
            const searchValue = document.getElementById('paymentSearch').value.toLowerCase();
            const paymentList = document.getElementById('paymentList');

            let paymentsToShow = payrolls;

            if (employeeFilter) {
                paymentsToShow = paymentsToShow.filter(p => p.employeeId === employeeFilter);
            }

            if (searchValue) {
                paymentsToShow = paymentsToShow.filter(p =>
                    p.employeeName.toLowerCase().includes(searchValue) ||
                    p.month.toLowerCase().includes(searchValue)
                );
            }

            paymentList.innerHTML = paymentsToShow.length > 0 ? paymentsToShow.map(pay => `
                <div class="payment-item">
                    <div class="payment-info">
                        <h4>${pay.employeeName}</h4>
                        <p><strong>Mois:</strong> ${pay.month}</p>
                        <p><strong>Montant:</strong> ${formatCurrency(pay.amount)}</p>
                    </div>
                    <div class="payment-actions">
                        <button class="btn btn-danger" onclick="deletePayment('${pay.id}')">
                            <span class="material-icons">delete</span> Supprimer
                        </button>
                    </div>
                </div>
            `).join('') : '<p>Aucun paiement trouvé.</p>';
        }

        function updateReportStats() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const reportPresentTodayEl = document.getElementById('reportPresentToday');
            const reportPresentMonthEl = document.getElementById('reportPresentMonth');
            const reportSalariesPaidEl = document.getElementById('reportSalariesPaid');
            const reportActiveEmployeesEl = document.getElementById('reportActiveEmployees');
            
            const presentToday = attendance[today] ? 
                Object.values(attendance[today]).filter(Boolean).length : 0;
            if (reportPresentTodayEl) reportPresentTodayEl.textContent = presentToday;
            
            let totalPresenceThisMonth = 0;
            Object.keys(attendance).forEach(date => {
                if (date.startsWith(currentMonth)) {
                    totalPresenceThisMonth += Object.values(attendance[date]).filter(Boolean).length;
                }
            });
            if (reportPresentMonthEl) reportPresentMonthEl.textContent = totalPresenceThisMonth;
            
            const totalSalariesPaid = payrolls.reduce((sum, p) => sum + p.amount, 0);
            if (reportSalariesPaidEl) reportSalariesPaidEl.textContent = formatCurrency(totalSalariesPaid);
            
            if (reportActiveEmployeesEl) reportActiveEmployeesEl.textContent = employees.length;
        }

        // ===============================
        // FONCTIONS UTILITAIRES COMPLÈTES
        // ===============================
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

                // =======================================================================
        //  countPresenceDays (VERSION FARANY INDRINDRA - Azo Antoka)
        //  - Mamaha ny olan'ny "timezone" (Septambra, sns.)
        //  - Mahazaka ny angona taloha (boolean, string) sy vaovao (objet misy ora)
        //  - Manisa ny Alahady ho andro feno foana
        // =======================================================================
        function countPresenceDays(employeeId, month) {
            let totalDaysWorked = 0;
            const MINIMUM_HOURS_FOR_FULL_DAY = 4;

            // Famakiana ny andro rehetra ao anatin'ny firaketana
            Object.keys(attendance).forEach(dateStr => {
                
                // 1. Fanamarinana raha ao anatin'ny volana kajiana ilay daty
                //    Ohatra: "2025-09-01".startsWith("2025-09") -> Marina
                if (dateStr.startsWith(month)) {
                    const dayData = attendance[dateStr];
                    if (!dayData) return;

                    const presenceData = dayData[employeeId];

                    // 2. Fanamarinana raha nisy fahatongavana ho an'ilay mpiasa
                    if (presenceData) {
                        
                        // 3. Fanamarinana manokana ho an'ny Alahady (mampiasa UTC mba tsy hisy diso)
                        // Tsy maintsy ampiana 'T00:00:00' mba ho raisiny ho daty marina
                        const currentDate = new Date(dateStr + 'T00:00:00Z'); // Ampiana 'Z' mba hilazana fa UTC
                        const dayOfWeek = currentDate.getUTCDay(); // Mampiasa getUTCDay()
                        const isSunday = (dayOfWeek === 0);

                        if (isSunday) {
                            totalDaysWorked += 1; // Raha Alahady dia andro feno avy hatrany
                            return; // Ary ajanona ny kajy ho an'io andro io
                        }

                        // 4. Raha TSY ALAHADY, dia eto no mandeha ny kajy mahazatra
                        //    Ity fizarana ity no miantoka fa voavaky ny angona taloha

                        // ==> RAHA ANGONA VAOVAO (objet misy ora)
                        if (typeof presenceData === 'object' && presenceData !== null && presenceData.arrivee) {
                            if (presenceData.depart) {
                                const duration = calculateWorkDuration(presenceData.arrivee, presenceData.depart);
                                const durationInHours = duration.totalMinutes / 60;
                                if (durationInHours >= MINIMUM_HOURS_FOR_FULL_DAY) {
                                    totalDaysWorked += 1;
                                } else if (durationInHours > 0) {
                                    totalDaysWorked += 0.5;
                                }
                            } else {
                                totalDaysWorked += 0.5;
                            }
                        } 
                        // ==> RAHA ANGONA TALOHA (boolean: "true")
                        else if (presenceData === true) {
                            totalDaysWorked += 1; // Heverina ho andro feno
                        } 
                        // ==> RAHA ANGONA TALOHA (string: "journee" na "demi")
                        else if (typeof presenceData === 'string') {
                            if (presenceData === 'journee') {
                                totalDaysWorked += 1;
                            } else if (presenceData === 'demi') {
                                totalDaysWorked += 0.5;
                            }
                        }
                    }
                }
            });

            return totalDaysWorked;
        }





        function getWorkDaysInMonth(employeeId, year, month) {
            let workDays = 0;
            const daysInMonth = getDaysInMonth(year, month);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                if (attendance[date] && attendance[date][employeeId]) {
                    workDays++;
                }
            }
            
            return workDays;
        }

        function getEmployeeAdvancesForMonth(employeeId, month) {
            return advances.filter(adv => 
                adv.employeeId === employeeId && 
                adv.date.startsWith(month)
            );
        }

        function capitalizeWords(str) {
            return str.toLowerCase().split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // ===============================
        // CURRENCY ET FORM MANAGEMENT
        // ===============================
        function initializeCurrencyInputs() {
            const currencyInputs = document.querySelectorAll('[data-type="currency"]');
            currencyInputs.forEach(input => {
                input.addEventListener('input', formatCurrencyInput);
                input.addEventListener('blur', formatCurrencyInput);
                input.addEventListener('focus', function() {
                    const rawValue = this.value.replace(/[^\d]/g, '');
                    this.value = rawValue;
                });
            });
        }

        function formatCurrencyInput(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value && !isNaN(value)) {
                value = parseInt(value).toLocaleString('fr-FR');
            } else {
                value = '';
            }
            e.target.value = value;
        }

        function getCurrencyValue(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return 0;
            const raw = input.value.replace(/[^\d]/g, '');
            return raw ? parseInt(raw, 10) : 0;
        }

        function setCurrencyValue(inputId, value) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = value ? parseInt(value).toLocaleString('fr-FR') : '';
            }
        }

        // ===============================
        // THEME MANAGEMENT
        // ===============================
        function initializeTheme() {
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = currentTheme;
                changeTheme(currentTheme);
            }
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            changeTheme(newTheme);
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = newTheme;
            }
        }

        async function changeTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = theme === 'light' ? 'dark_mode' : 'light_mode';
            }
            
            try {
                await dbManager.put('settings', { key: 'theme', value: theme });
            } catch (error) {
                console.error('Erreur sauvegarde thème:', error);
            }
        }

        // ===============================
        // DATES ET NAVIGATION
        // ===============================
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const attendanceDateEl = document.getElementById('attendanceDate');
            if (attendanceDateEl) {
                attendanceDateEl.value = today;
            }
        }

        function setCurrentMonth() {
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            const payrollMonthEl = document.getElementById('payrollMonth');
            if (payrollMonthEl) {
                payrollMonthEl.value = currentMonth;
            }
        }

        function goToPreviousDay() {
            const currentDate = new Date(document.getElementById('attendanceDate').value);
            currentDate.setDate(currentDate.getDate() - 1);
            document.getElementById('attendanceDate').value = currentDate.toISOString().split('T')[0];
            displayAttendance();
        }

        function goToNextDay() {
            const currentDate = new Date(document.getElementById('attendanceDate').value);
            currentDate.setDate(currentDate.getDate() + 1);
            document.getElementById('attendanceDate').value = currentDate.toISOString().split('T')[0];
            displayAttendance();
        }

        // ===============================
        // SELECTS ET FORMULAIRES
        // ===============================
        /**
         * Mameno ny lisitra fisafidianana mpiasa rehetra.
         * Afaka mandray sivana vondrona mba hampisehoana mpiasa voafantina ihany.
         * @param {string | null} groupIdFilter - Ny ID an'ny vondrona hasivana. Raha null, dia ny mpiasa rehetra no alaina.
         */
        function populateEmployeeSelects(groupIdFilter = null) {
            let employeesToList = employees.filter(e => e.status === 'actif' || e.status === 'depart' || !e.status);

            // Raha misy sivana vondrona, dia ireo mpiasa ao anatiny ihany no alaina
            if (groupIdFilter) {
                employeesToList = employeesToList.filter(emp => emp.groupId === groupIdFilter);
            }

            const employeeOptionsHTML = employeesToList.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');

            // Ireo select rehetra mila fenoina
            const selectsToPopulate = {
                'advanceEmployee': '<option value="">Sélectionner un employé</option>',
                'payrollEmployeeSelect': '<option value="">Tous les employés</option>',
                'paymentEmployeeFilter': '<option value="">Tous les employés</option>'
            };

            for (const selectId in selectsToPopulate) {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    const defaultOption = selectsToPopulate[selectId];
                    selectElement.innerHTML = defaultOption + employeeOptionsHTML;
                }
            }
        }



        // ===============================
        // FORM HANDLERS
        // ===============================
        // =======================================================================
        //  VERSION FARANY INDRINDRA - Mampiasa ID vaovao tanteraka
        // =======================================================================
        // IZAO NO TOKONY HO IZY
        document.getElementById('employeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const name = capitalizeWords(document.getElementById('employeeName_add').value.trim());
                const position = capitalizeWords(document.getElementById('employeePosition_add').value.trim());
                const gender = document.getElementById('employeeGender_add').value;
                const salary = getCurrencyValue('employeeSalary_add');
                const groupId = document.getElementById('employeeGroup_add').value;

                if (!name || !position || !gender || salary <= 0) {
                    showAlert("Veuillez remplir tous les champs correctement.", 'error');
                    return;
                }
                if (employees.some(emp => emp.name.toLowerCase() === name.toLowerCase())) {
                    showAlert('Un employé avec ce nom existe déjà.', 'error');
                    return;
                }

                const newEmployee = {
                    id: Date.now().toString(),
                    name: name,
                    position: position,
                    gender: gender,
                    salary: salary,
                    groupId: groupId || null,
                    dateAdded: new Date().toISOString(),
                    status: 'actif', // Mpiasa vaovao dia 'actif' foana
                    departureDate: null // Tsy manana daty fialana
                };

                employees.push(newEmployee);
                await saveData();

                updateStats();
                populateEmployeeSelects();
                displayEmployees();

                this.reset();
                closeModal('addEmployeeModal');
                showAlert('Employé ajouté avec succès!', 'success');

            } catch (error) {
                console.error("Erreur critique lors de l'ajout de l'employé:", error);
                showAlert("Une erreur inattendue est survenue. Vérifiez la console.", 'error');
            }
        });


        document.getElementById('advanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeId = document.getElementById('advanceEmployee').value;
            const amount = getCurrencyValue('advanceAmount');
            const date = document.getElementById('advanceDate').value;
            const reason = document.getElementById('advanceReason').value.trim();

            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            if (amount === 0) {
                showAlert('Veuillez saisir un montant valide!', 'error');
                return;
            }

            const advance = {
                id: Date.now().toString(),
                employeeId,
                employeeName: employee.name,
                amount,
                date,
                reason,
                dateCreated: new Date().toISOString()
            };

            advances.push(advance);
            await saveData();
            updateStats();
            displayAdvances();
            
            this.reset();
            showAlert('Avance ajoutée avec succès!', 'success');
        });

        // ===============================
        // MODAL MANAGEMENT
        // ===============================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Fonction hanokafana ny modal "Ajouter un Employé"
        function openAddEmployeeModal() {
            // Diovina aloha ny formulaire sao misy angona taloha
            document.getElementById('employeeForm').reset();
            // Havaozina ny lisitry ny vondrona ao amin'ny select
            populateGroupSelects();
            // Havaozina ny input momba ny vola
            initializeCurrencyInputs();
            // Sokafana ny modal
            openModal('addEmployeeModal');
        }


        // ===============================
        // SETTINGS PANEL
        // ===============================
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('settingsOverlay');
            
            if (panel && overlay) {
                panel.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

        // ===============================
        // EXPORT FUNCTIONS
        // ===============================
        // ===================================================
        //  exportData (VERSION NOHATSARAINA)
        // ===================================================
        async function exportData() {
            try {
                const exportTimestamp = new Date();
                const data = {
                    // Angona fototra
                    employees,
                    attendance,
                    payrolls,
                    advances,
                    qrAttendance,
                    groups, // Efa tafiditra tsara
                    
                    // Fampahalalana fanampiny
                    settings: {
                        theme: currentTheme,
                        qrSettings: qrSettings
                    },
                    
                    // Metadata
                    exportDate: exportTimestamp.toISOString(),
                    version: '3.0-groups',
                    dbType: 'IndexedDB-QR'
                };
                
                const filename = `sauvegarde-rh-behavana-${exportTimestamp.toISOString().split('T')[0]}.json`;
                
                // Ity function ity dia efa mandeha tsara
                downloadJSON(data, filename);
                
                await dbManager.put('settings', { key: 'lastBackupDate', value: exportTimestamp.toISOString() });
                updateLastBackupInfo();
                
                showAlert('Sauvegarde (avec groupes) téléchargée avec succès!', 'success');

            } catch (error) {
                console.error("Erreur lors de la création de la sauvegarde:", error);
                showAlert("Une erreur est survenue lors de l'exportation des données.", "error");
            }
        }


        // ===================================================
        //  importData (VERSION NOHATSARAINA SY AZO ANTOKA)
        // ===================================================
        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                handleImportedFile(file); // Miantso ilay fonction iraisana
            }
            // Diovina foana ny input mba hahafahana mampiditra rakitra mitovy anarana indray
            event.target.value = '';
        }


        function updateLastBackupInfo() {
            const infoElement = document.getElementById('lastBackupInfo');
            dbManager.get('settings', 'lastBackupDate').then(setting => {
                if (setting && setting.value) {
                    infoElement.textContent = `Dernière sauvegarde téléchargée le: ${formatDate(setting.value)}`;
                } else {
                    infoElement.textContent = "Aucune sauvegarde n'a encore été téléchargée.";
                }
            });
        }

        const MINIMUMHOURSINMINUTES = 8 * 60;
        const HALFDAYINMINUTES = 4 * 60;
        const MINIMUMHOURSFORFULLDAY = 4;

        // 🔍 Statut employé par jour
        // ===================================================
        //  displayEmployeeStatus (VERSION 3 - KAJY VAOVAO)
        // ===================================================
        async function displayEmployeeStatus(employeeId) {
            const month = document.getElementById('statsMonth').value;
            const container = document.getElementById('employeeStatusResults');

            if (!employeeId || !month) {
                container.innerHTML = '';
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            // --- FANAMPIANA 1: Alaina ny anaran'ny vondrona ---
            const group = groups.find(g => g.id === employee.groupId);
            const groupName = group ? group.name : "<i>Sans groupe</i>"; // Mampiseho "Sans groupe" raha tsy manana izy

            const [year, monthNum] = month.split('-');
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(monthNum));

            

            let totalMonthlyMinutes = 0;
            let dailyDetails = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${monthNum}-${day.toString().padStart(2, '0')}`;
                const presenceData = attendance[dateStr]?.[employeeId];
                
                let duration = { totalMinutes: 0, displayText: "---" };
                if (presenceData) {
                    duration = calculateWorkDuration(presenceData.arrivee, presenceData.depart);
                    totalMonthlyMinutes += duration.totalMinutes;
                }
                dailyDetails.push({
                    dateStr: dateStr,
                    presenceData: presenceData,
                    duration: duration
                });
            }

            const totalMonthlyHours = Math.floor(totalMonthlyMinutes / 60);
            const totalMonthlyRemainingMinutes = totalMonthlyMinutes % 60;
            const monthlyHoursText = `${totalMonthlyHours}h ${totalMonthlyRemainingMinutes}m`;

            const presenceDays = countPresenceDays(employee.id, month);
            const totalAdvances = advances
                .filter(adv => adv.employeeId === employee.id && adv.date.startsWith(month))
                .reduce((sum, adv) => sum + adv.amount, 0);
            const proportionalSalary = (employee.salary / daysInMonth) * presenceDays;
            const netSalaryToPay = proportionalSalary - totalAdvances;

            let tableHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #f1f5f9 !important; margin-bottom: 4px; text-shadow: 0 2px 4px rgba(0,0,0,0.4);">📋 Rapport Mensuel Détaillé pour ${employee.name}</h3>
                    <p style="margin-top: 0; color: #e2e8f0 !important; font-weight: 600;"><strong>Groupe:</strong> ${groupName}</p>
                </div>
                
                <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, rgba(226, 232, 240, 0.95), rgba(241, 245, 249, 0.95)); border-radius: 12px; border: 2px solid rgba(129, 140, 248, 0.3);">
                    <h4 style="margin-bottom: 16px; color: #1e293b !important; font-weight: 800; font-size: 1.2rem;">✨ Résumé du Mois</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; font-size: 1.05em;">
                        <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; border-left: 4px solid #6366f1;">
                            <strong style="color: #334155 !important; display: block; margin-bottom: 4px;">📅 Jours de Présence:</strong>
                            <span style="font-weight: bold; color: #1e293b !important; font-size: 1.2em;">${presenceDays} / ${daysInMonth} jours</span>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; border-left: 4px solid #6366f1;">
                            <strong style="color: #334155 !important; display: block; margin-bottom: 4px;">⏰ Total Heures Travaillées:</strong>
                            <span style="font-weight: bold; color: #6366f1 !important; font-size: 1.2em;">${monthlyHoursText}</span>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; border-left: 4px solid #ef4444;">
                            <strong style="color: #334155 !important; display: block; margin-bottom: 4px;">💰 Total Avances:</strong>
                            <span style="font-weight: bold; color: #ef4444 !important; font-size: 1.2em;">${formatCurrency(totalAdvances)}</span>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #6366f1, #818cf8); padding: 16px; border-radius: 10px; margin-top: 16px; text-align: center; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);">
                        <strong style="color: white !important; font-size: 1.1em; display: block; margin-bottom: 4px;">💵 Salaire Net à Payer</strong>
                        <span style="font-weight: 800; color: white !important; font-size: 1.6em; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${formatCurrency(netSalaryToPay)}</span>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--md-sys-color-outline-variant); border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background-color: var(--md-sys-color-surface); z-index: 1;">
                            <tr style="background: linear-gradient(135deg, rgba(51, 65, 85, 0.95), rgba(30, 41, 59, 0.95));">
                                <th style="padding: 12px; text-align: left; color: #f1f5f9 !important; font-weight: 800;">Date</th>
                                <th style="padding: 12px; text-align: left; color: #f1f5f9 !important; font-weight: 800;">Statut</th>
                                <th style="padding: 12px; text-align: center; color: #f1f5f9 !important; font-weight: 800;">Total Heures</th>
                                <th style="padding: 12px; text-align: right; color: #f1f5f9 !important; font-weight: 800;">Avance du Jour</th>
                            </tr>
                        </thead>
                        <tbody>
            `;


            dailyDetails.forEach(detail => {
                // OVANA: Destructure object fa tsy array
                const { dateStr, presenceData, duration } = detail;
                
                const dayOfWeek = new Date(dateStr).getDay();
                const isWeekend = (dayOfWeek === 6 || dayOfWeek === 0);
                
                const advanceOnDay = advances
                    .filter(adv => adv.employeeId === employeeId && adv.date === dateStr)
                    .reduce((sum, adv) => sum + adv.amount, 0);
                
                let status = `<span style="color: #ef4444 !important; font-weight: 700;">❌ Absent</span>`;
                if (presenceData) {
                    const arrival = formatDisplayTime(presenceData.arrivee);
                    const departure = formatDisplayTime(presenceData.depart);
                    status = `<span style="color: #10b981 !important; font-weight: 700;">✅ Présent (${arrival} - ${departure})</span>`;
                }
                
                let durationStyle = 'font-weight: 600; color: #64748b;';
                if (duration.totalMinutes > 0 && duration.totalMinutes < HALFDAYINMINUTES) {
                    durationStyle = 'color: #ef4444 !important; font-weight: 700;';
                } else if (duration.totalMinutes >= HALFDAYINMINUTES && duration.totalMinutes < MINIMUMHOURSINMINUTES) {
                    durationStyle = 'color: #f59e0b !important; font-weight: 700;';
                } else if (duration.totalMinutes >= MINIMUMHOURSINMINUTES) {
                    durationStyle = 'color: #10b981 !important; font-weight: 700;';
                }
                
                let rowStyle = isWeekend ? 'background-color: rgba(148, 163, 184, 0.2); opacity: 0.7;' : '';
                
                tableHTML += `
                    <tr style="${rowStyle}">
                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--md-sys-color-outline-variant); color: #e2e8f0 !important; font-weight: 600;">${formatDate(dateStr)}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">${status}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--md-sys-color-outline-variant); text-align: center; ${durationStyle}">${duration.displayText}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--md-sys-color-outline-variant); text-align: right; color: ${advanceOnDay > 0 ? '#ef4444' : '#64748b'} !important; font-weight: 700;">${advanceOnDay > 0 ? formatCurrency(advanceOnDay) : '-'}</td>
                    </tr>
                `;
            });


            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        function fixTextVisibility() {
            // Target tous les divs avec background clair
            const lightBgDivs = document.querySelectorAll('[style*="background"]');
            
            lightBgDivs.forEach(div => {
                const bgColor = window.getComputedStyle(div).backgroundColor;
                
                // Si le background est clair (rgb > 200)
                if (bgColor) {
                    const rgb = bgColor.match(/\d+/g);
                    if (rgb && parseInt(rgb[0]) > 200) {
                        // Force tous les enfants en dark
                        div.querySelectorAll('*').forEach(el => {
                            el.style.color = '#1e293b';
                            el.style.textShadow = 'none';
                            el.style.fontWeight = '700';
                        });
                    }
                }
            });
        }

        // Appeler après l'affichage
        setTimeout(fixTextVisibility, 100);



        /**
         * Mikajy ny faharetan'ny asa ary mamerina object misy ny antsipiriany.
         * @param {string | null} startTime - Ora fahatongavana (oh: "08:00")
         * @param {string | null} endTime - Ora fiaingana (oh: "17:30")
         * @returns {{totalMinutes: number, displayText: string}} - Object misy ny totalin'ny minitra sy ny lahatsoratra.
         */
        function calculateWorkDuration(startTime, endTime) {
            if (!startTime || !endTime) {
                return { totalMinutes: 0, displayText: "---" };
            }

            try {
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);

                const startTotalMinutes = startHour * 60 + startMinute;
                const endTotalMinutes = endHour * 60 + endMinute;

                if (endTotalMinutes < startTotalMinutes) {
                    return { totalMinutes: 0, displayText: "Erreur d'heure" };
                }

                const durationMinutes = endTotalMinutes - startTotalMinutes;
                const hours = Math.floor(durationMinutes / 60);
                const minutes = durationMinutes % 60;

                let displayText = "";
                if (hours > 0 && minutes > 0) {
                    displayText = `${hours}h ${minutes}m`;
                } else if (hours > 0) {
                    displayText = `${hours}h`;
                } else {
                    displayText = `${minutes}m`;
                }
                
                return { totalMinutes: durationMinutes, displayText: displayText };

            } catch (error) {
                console.error("Erreur de calcul de durée:", error);
                return { totalMinutes: 0, displayText: "Erreur" };
            }
        }



        // ===================================================
        //  Fonction de recherche pour le Smart Search
        // ===================================================
        function handleSmartSearch() {
            const searchTerm = document.getElementById('smartSearchInput').value.toLowerCase();
            const resultsContainer = document.getElementById('smartSearchResults');
            const reportContainer = document.getElementById('employeeStatusResults');

            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '';
                reportContainer.innerHTML = '';
                return;
            }

            const results = employees.filter(emp => 
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.position.toLowerCase().includes(searchTerm)
            );

            if (results.length > 0) {
                // --- FANITSIANA ETO ---
                resultsContainer.innerHTML = results.map(emp => {
                    // 1. Alaina ny anaran'ny vondrona
                    const group = groups.find(g => g.id === emp.groupId);
                    const groupName = group ? group.name : "<i>Sans groupe</i>";

                    // 2. Ampidirina ao anatin'ny HTML ilay anarana
                    return `
                        <div class="employee-item" style="cursor: pointer;" onclick="selectEmployeeForStat('${emp.id}')">
                            <div class="employee-info">
                                <h4>${emp.name}</h4>
                                <p>${emp.position} - <strong>Groupe: ${groupName}</strong></p>
                            </div>
                            <span class="material-icons">arrow_forward_ios</span>
                        </div>
                    `;
                }).join('');
            } else {
                resultsContainer.innerHTML = `<p style="text-align: center; padding: 10px;">Aucun employé trouvé.</p>`;
            }
        }


                // ===================================================
        //  Fonction appelée lors du clic sur un employé
        // ===================================================
        function selectEmployeeForStat(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (employee) {
                // Apetraka ao anaty input ilay anarana ary ajanona ny fampisehoana ny lisitra
                document.getElementById('smartSearchInput').value = employee.name;
                document.getElementById('smartSearchResults').innerHTML = '';
                
                // Alefa avy hatrany ny famoronana tatitra
                displayEmployeeStatus(employeeId);
            }
        }



        function exportGlobalReport() {
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            
            const reportData = {
                date: today.toISOString(),
                totalEmployees: employees.length,
                presentToday: attendance[today.toISOString().split('T')[0]] ? 
                    Object.values(attendance[today.toISOString().split('T')[0]]).filter(Boolean).length : 0,
                qrScansToday: qrAttendance.filter(att => att.date === today.toISOString().split('T')[0]).length,
                totalSalariesPaid: payrolls.reduce((sum, p) => sum + p.amount, 0),
                totalAdvances: advances.reduce((sum, adv) => sum + adv.amount, 0),
                employees: employees,
                monthlyPayrolls: payrolls.filter(p => p.month === currentMonth),
                monthlyAdvances: advances.filter(adv => adv.date.startsWith(currentMonth)),
                qrAttendance: qrAttendance // Inclure dans le rapport
            };

            downloadJSON(reportData, `rapport-global-qr-${formatDateForFilename(today)}.json`);
            showAlert('Rapport global avec QR exporté avec succès!', 'success');
        }

        function exportAttendanceReport() {
            const attendanceReport = {
                date: new Date().toISOString(),
                attendanceData: attendance,
                qrAttendanceData: qrAttendance, // Inclure les présences QR
                employees: employees
            };

            downloadJSON(attendanceReport, `rapport-presences-qr-${formatDateForFilename(new Date())}.json`);
            showAlert('Rapport des présences avec QR exporté avec succès!', 'success');
        }

        function exportPayrollReport() {
            const payrollReport = {
                date: new Date().toISOString(),
                payrolls: payrolls,
                employees: employees
            };

            downloadJSON(payrollReport, `rapport-paies-${formatDateForFilename(new Date())}.json`);
            showAlert('Rapport des paies exporté avec succès!', 'success');
        }

        // ===============================
        // UTILITY FUNCTIONS
        // ===============================
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatDateForFilename(date) {
            return date.toISOString().split('T')[0];
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span>
                ${message}
            `;
            
            document.body.appendChild(alertDiv);
            
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '24px';
            alertDiv.style.right = '24px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.animation = 'slideInRight 0.3s ease';
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 300);
            }, 3000);
        }

        // ===================================================
        //  FONCTION VAOVAO: Fampisehoana Fampandrenesana Hendry
        // ===================================================
        /**
         * Mampiseho hafatra fampandrenesana eo an-tampon'ny pejy.
         * @param {string} message - Ny lahatsoratra ho aseho.
         * @param {string} type - Karazana fampandrenesana ('warning', 'info', 'error').
         * @param {string} icon - Ny anaran'ilay sary masina (Material Icon) hampiasaina.
         */
        function displayNotification(message, type = 'info', icon = 'info') {
            const container = document.getElementById('notificationsContainer');
            if (!container) return;

            // Amboarina ilay element vaovao
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `alert alert-${type}`; // Mampiasa ny style efa misy
            notificationDiv.style.display = 'flex';
            notificationDiv.style.alignItems = 'center';
            notificationDiv.style.justifyContent = 'space-between';
            notificationDiv.style.animation = 'fadeIn 0.5s ease';

            notificationDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="material-icons">${icon}</span>
                    <span>${message}</span>
                </div>
                <button class="close-btn" style="background: none; border: none; cursor: pointer;" onclick="this.parentElement.remove()">
                    <span class="material-icons">close</span>
                </button>
            `;

            // Ampidirina eo an-tampon'ny lisitra
            container.prepend(notificationDiv);
        }

        // ===================================================
        // === SMART CHECKS - VERSION intelligent ===
        // ===================================================
        // === SMART CHECKS - VERSION COMPACT CLICKABLE ===
        function runSmartChecks() {
            const container = document.getElementById('notificationsContainer');
            if (!container) return;

            // Diovina aloha ny notifications taloha
            container.innerHTML = '';

            const today = new Date().toISOString().split('T')[0];
            const dayAttendance = attendance[today];

            if (!dayAttendance) return;

            // ===================================================
            // FANAMARINANA: Employés tsy nanao départ
            // ===================================================
            let missingDepartureEmployees = [];

            for (const empId in dayAttendance) {
                const att = dayAttendance[empId];
                
                if (typeof att === 'object' && att !== null) {
                    if (att.arrivee && !att.depart) {
                        const employee = employees.find(e => e.id === empId);
                        if (employee) {
                            missingDepartureEmployees.push({
                                id: empId,
                                name: employee.name,
                                position: employee.position,
                                arrivee: att.arrivee,
                                method: att.method || 'MANUAL'
                            });
                        }
                    }
                }
            }

            // ===================================================
            // AFFICHAGE: CARD COMPACT CLICKABLE
            // ===================================================
            if (missingDepartureEmployees.length > 0) {
                // Alahatra araka ny ora arrivée
                missingDepartureEmployees.sort((a, b) => a.arrivee.localeCompare(b.arrivee));
                
                // Génération ID unique
                const notifId = `notif-${Date.now()}`;
                
                const message = `
                    <div class="alert alert-warning-compact" 
                        style="margin: 0; padding: 12px 16px; border-radius: 10px; 
                                border-left: 4px solid #f59e0b; background: rgba(245, 158, 11, 0.08);
                                cursor: pointer; transition: all 0.2s ease;"
                        onclick="toggleNotificationDetails('${notifId}')"
                        onmouseover="this.style.background='rgba(245, 158, 11, 0.15)'"
                        onmouseout="this.style.background='rgba(245, 158, 11, 0.08)'">
                        
                        <!-- EN-TÊTE COMPACT -->
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <span class="material-icons" style="color: #f59e0b; font-size: 24px;">watch_later</span>
                                <div>
                                    <strong style="font-size: 14px; color: #92400e; display: block;">
                                        ⚠️ ${missingDepartureEmployees.length} employé(s) en attente de départ
                                    </strong>
                                    <span style="font-size: 12px; color: #78716c;">Cliquez pour voir les détails</span>
                                </div>
                            </div>
                            <span class="material-icons" id="${notifId}-icon" 
                                style="color: #f59e0b; font-size: 20px; transition: transform 0.2s;">
                                expand_more
                            </span>
                        </div>
                        
                        <!-- DÉTAILS EXPANDABLE (masqué par défaut) -->
                        <div id="${notifId}-details" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #fde68a;">
                            ${missingDepartureEmployees.map(emp => {
                                const methodIcon = emp.method === 'QR' ? 'qr_code_scanner' : 
                                                emp.method === 'FACIAL' ? 'face' : 'edit';
                                const methodColor = emp.method === 'QR' ? '#6750A4' : 
                                                emp.method === 'FACIAL' ? '#0ea5e9' : '#f59e0b';
                                
                                return `
                                    <div style="display: flex; align-items: center; justify-content: space-between; 
                                                padding: 8px 10px; background: white; border-radius: 6px; 
                                                margin-bottom: 6px; border-left: 3px solid ${methodColor};">
                                        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                            <span class="material-icons" style="color: ${methodColor}; font-size: 18px;">
                                                ${methodIcon}
                                            </span>
                                            <div>
                                                <strong style="display: block; font-size: 13px; color: #1e293b;">${emp.name}</strong>
                                                <span style="font-size: 11px; color: #64748b;">${emp.position}</span>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 11px; color: #64748b;">Arrivée</div>
                                            <strong style="font-size: 13px; color: #0f172a;">${emp.arrivee}</strong>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            
                            <!-- Action rapide -->
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #fde68a; text-align: center;">
                                <a href="#" onclick="showSection('attendance'); return false;" 
                                style="color: #6750A4; text-decoration: none; font-weight: 600; font-size: 12px;
                                        display: inline-flex; align-items: center; gap: 4px;">
                                    <span class="material-icons" style="font-size: 16px;">arrow_forward</span>
                                    Marquer les départs
                                </a>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML += message;
            }
        }

        // === FONCTION TOGGLE DETAILS ===
        function toggleNotificationDetails(notifId) {
            const details = document.getElementById(`${notifId}-details`);
            const icon = document.getElementById(`${notifId}-icon`);
            
            if (!details || !icon) return;
            
            if (details.style.display === 'none') {
                // HAMASINA
                details.style.display = 'block';
                icon.textContent = 'expand_less';
                icon.style.transform = 'rotate(180deg)';
            } else {
                // HAFENINA
                details.style.display = 'none';
                icon.textContent = 'expand_more';
                icon.style.transform = 'rotate(0deg)';
            }
        }



        // ===============================
        // EVENT LISTENERS
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            displayPayments();
            setInterval(fixTextVisibility, 1000); // Check toutes les secondes
            // Set current date for advance form
            const today = new Date().toISOString().split('T')[0];
            const advanceDateEl = document.getElementById('advanceDate');
            if (advanceDateEl) {
                advanceDateEl.value = today;
            }
        });

        // 🔍 Filtrage automatique amin'ny liste employés
        // Fikarohana mpiasa miaraka amin'ny Debounce
        const employeeSearchInput = document.getElementById('employeeSearch');
        if (employeeSearchInput) {
            employeeSearchInput.addEventListener('input', debounce(function () {
                const searchTerm = this.value.toLowerCase();
                const items = document.querySelectorAll('#employeeList .employee-item');
                items.forEach(item => {
                    const name = item.querySelector('h4')?.textContent.toLowerCase() || '';
                    const position = item.querySelector('p')?.textContent.toLowerCase() || '';
                    const match = name.includes(searchTerm) || position.includes(searchTerm);
                    item.style.display = match ? 'flex' : 'none';
                });
            }, 350)); // Miandry 350ms
        }

        window.addEventListener('load', () => {
            if ("launchQueue" in window) {
                launchQueue.setConsumer(async (launchParams) => {
                    if (!launchParams.files || launchParams.files.length === 0) {
                        return;
                    }

                    // Alaina ilay rakitra voalohany voazara
                    const fileHandle = launchParams.files[0];
                    const file = await fileHandle.getFile();
                    
                    // Ampiasaina ilay fonction importData efa anananao
                    // Fa milaamboarina kely izy mba handray "file object"
                    // fa tsy "event" intsony.
                    
                    // Antsoina ilay fonction vaovao (hamboarintsika eto ambany)
                    handleImportedFile(file);
                });
            }
        });

        document.getElementById('employeeSearch')?.addEventListener('input', () => displayEmployees());


        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveData().then(() => {
                    showAlert('Données sauvegardées!', 'success');
                }).catch(err => {
                    showAlert('Erreur de sauvegarde', 'error');
                });
            }
            
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
                
                if (document.getElementById('settingsPanel')?.classList.contains('active')) {
                    toggleSettings();
                }
                
                // Arrêter le scan QR si actif
                if (isScanning) {
                    stopQRScan();
                }
            }
        });

        // ===============================
        // DEBUG HELPERS
        // ===============================
        window.hrDebugQR = {
            employees: () => employees,
            attendance: () => attendance,
            qrAttendance: () => qrAttendance,
            payrolls: () => payrolls,
            advances: () => advances,
            qrSettings: () => qrSettings,
            dbManager: () => dbManager,
            exportAll: exportData
        };

        // ===================================================
        //  Fanatsarana UX: Mampifandray ny preview amin'ny formulaire
        // ===================================================
        document.getElementById('advanceEmployee').addEventListener('change', previewNetSalary);
        document.getElementById('advanceAmount').addEventListener('input', previewNetSalary);

        console.log('💡 Système RH avec QR Code prêt!');
        console.log('🔧 Utilisez window.hrDebugQR pour les outils de débogage');

        

        // ===================================================
        //  Fanatsarana UX: Fikajiana ny karama sisa rehefa manao avance
        // ===================================================
        async function previewNetSalary() {
            const employeeId = document.getElementById('advanceEmployee').value;
            const advanceAmount = getCurrencyValue('advanceAmount');
            const previewContainer = document.getElementById('netSalaryPreview');

            if (!employeeId) {
                previewContainer.style.display = 'none';
                return;
            }

            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            const currentMonth = new Date().toISOString().slice(0, 7);
            const [year, month] = currentMonth.split('-');

            // Kajiana ny karama tokony ho raisina (pro-rata)
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
            const presenceDays = countPresenceDays(employeeId, currentMonth);
            const grossSalary = (employee.salary / daysInMonth) * presenceDays;

            // Alaina ny totalin'ny trosa efa misy ho an'io volana io
            const existingAdvances = advances
                .filter(adv => adv.employeeId === employeeId && adv.date.startsWith(currentMonth))
                .reduce((sum, adv) => sum + adv.amount, 0);

            // Kajiana ny karama sisa
            const totalFutureAdvances = existingAdvances + advanceAmount;
            const netSalaryAfterAdvance = grossSalary - totalFutureAdvances;

            // Fampisehoana ny vokany
            previewContainer.style.display = 'block';
            previewContainer.innerHTML = `
                <span style="font-weight: 500;">Karama Net Tombanana:</span>  

                Salaire Brut (hatramin'izao): ${formatCurrency(grossSalary)}  

                Total Avances (miaraka amin'ity): <span style="color: var(--md-sys-color-error);">${formatCurrency(totalFutureAdvances)}</span>  

                <hr style="margin: 4px 0; border-color: var(--md-sys-color-outline-variant);">
                <strong style="color: var(--md-sys-color-primary);">Karama Sisa ho Raisina: ${formatCurrency(netSalaryAfterAdvance)}</strong>
            `;
        }


        // ===================================================
        //  Fanatsarana Tatitra: Génération PDF ho an'ny Paie
        // ===================================================
        function generatePayrollPDFReport() {
            const reportMonth = document.getElementById('reportMonth').value;
            if (!reportMonth) {
                showAlert("Veuillez sélectionner un mois pour générer le rapport.", 'error');
                return;
            }

            const [year, month] = reportMonth.split('-');
            const daysInMonth = getDaysInMonth(parseInt(year), parseInt(month));
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Loha-taratasy
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("Rapport de Paie Mensuel", 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Mois: ${reportMonth}`, 105, 28, { align: 'center' });

            const tableData = [];
            let totalGrossSalary = 0;
            let totalAdvances = 0;
            let totalNetSalary = 0;

            // Fanaovana kajy isaky ny mpiasa
            employees.forEach(emp => {
                const presenceDays = countPresenceDays(emp.id, reportMonth);
                const grossSalary = (emp.salary / daysInMonth) * presenceDays;
                const employeeAdvances = advances
                    .filter(adv => adv.employeeId === emp.id && adv.date.startsWith(reportMonth))
                    .reduce((sum, adv) => sum + adv.amount, 0);
                const netSalary = grossSalary - employeeAdvances;

                tableData.push([
                    emp.name,
                    presenceDays,
                    formatCurrency(grossSalary),
                    formatCurrency(employeeAdvances),
                    formatCurrency(netSalary)
                ]);

                totalGrossSalary += grossSalary;
                totalAdvances += employeeAdvances;
                totalNetSalary += netSalary;
            });

            // Famoronana ny tabilao
            doc.autoTable({
                startY: 40,
                head: [['Employé', 'Jours Travaillés', 'Salaire Brut', 'Avances', 'Salaire Net']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [103, 80, 164] }, // Loko volomparasy
                styles: { fontSize: 8 },
            });

            // Famintinana ny totaliny
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("Résumé Global:", 14, finalY);
            
            doc.setFont("helvetica", "normal");
            doc.text(`Total Salaires Bruts: ${formatCurrency(totalGrossSalary)}`, 14, finalY + 7);
            doc.text(`Total Avances: ${formatCurrency(totalAdvances)}`, 14, finalY + 14);
            
            doc.setFont("helvetica", "bold");
            doc.text(`Total Salaires Nets Payés: ${formatCurrency(totalNetSalary)}`, 14, finalY + 21);

            // Pejy farany
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Page ${i} sur ${pageCount}`, 195, 285, { align: 'right' });
                doc.text(`Généré le ${new Date().toLocaleString('fr-FR')}`, 14, 285);
            }

            // Famoahana ny rakitra
            doc.save(`rapport-paie-${reportMonth}.pdf`);
            showAlert("Le rapport de paie en PDF a été généré avec succès!", 'success');
        }


        // --- GESTION DES GROUPES ---

        function displayGroups() {
            populateGroupSelects();
            const container = document.getElementById('groupList');
            if (!container) return;

            if (groups.length === 0) {
                container.innerHTML = "<p style='text-align: center; padding: 20px;'>Aucun groupe créé pour le moment.</p>";
                return;
            }

            container.innerHTML = groups.map(group => {
                const members = employees.filter(emp => emp.groupId === group.id);
                const maleCount = members.filter(m => m.gender === 'Homme').length;
                const femaleCount = members.filter(m => m.gender === 'Femme').length;

                return `
                    <div class="employee-item">
                        <div class="employee-info">
                            <h4>${group.name}</h4>
                            <p>${group.description || 'Aucune description'}</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 8px; font-size: 14px;">
                                <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">people</span> Total: <strong>${members.length}</strong></span>
                                <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">male</span> Hommes: <strong>${maleCount}</strong></span>
                                <span><span class="material-icons" style="font-size: 16px; vertical-align: middle;">female</span> Femmes: <strong>${femaleCount}</strong></span>
                            </div>
                        </div>
                        <div class="employee-actions">
                            <button class="btn-icon" onclick="editGroup('${group.id}')" title="Modifier">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" onclick="deleteGroup('${group.id}')" title="Supprimer">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('groupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupId = document.getElementById('groupId').value;
            const groupName = document.getElementById('groupName').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();

            if (!groupName) return;

            if (groupId) {
                const groupIndex = groups.findIndex(g => g.id === groupId);
                if (groupIndex > -1) {
                    groups[groupIndex].name = groupName;
                    groups[groupIndex].description = groupDescription;
                    showAlert('Groupe mis à jour avec succès!', 'success');
                }
            } else {
                if (groups.some(g => g.name.toLowerCase() === groupName.toLowerCase())) {
                    showAlert('Un groupe avec ce nom existe déjà.', 'error');
                    return;
                }
                const newGroup = {
                    id: Date.now().toString(),
                    name: groupName,
                    description: groupDescription
                };
                groups.push(newGroup);
                showAlert('Groupe ajouté avec succès!', 'success');
            }

            await saveData();
            displayGroups();
            cancelGroupEdit();
        });

        function editGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;

            document.getElementById('groupId').value = group.id;
            document.getElementById('groupName').value = group.name;
            document.getElementById('groupDescription').value = group.description || '';
            document.getElementById('groupFormBtnText').textContent = "Mettre à jour le Groupe";
            document.getElementById('cancelEditGroupBtn').style.display = 'inline-flex';
            window.scrollTo(0, document.getElementById('groupForm').offsetTop);
        }

        function cancelGroupEdit() {
            document.getElementById('groupId').value = '';
            document.getElementById('groupForm').reset();
            document.getElementById('groupFormBtnText').textContent = "Ajouter le Groupe";
            document.getElementById('cancelEditGroupBtn').style.display = 'none';
            populateGroupSelects();

        }

        async function deleteGroup(id) {
            const membersCount = employees.filter(emp => emp.groupId === id).length;
            if (membersCount > 0) {
                showAlert(`Impossible de supprimer ce groupe. Il contient encore ${membersCount} employé(s).`, 'error');
                return;
            }

            if (confirm('Êtes-vous sûr de vouloir supprimer ce groupe? Cette action est irréversible.')) {
                groups = groups.filter(g => g.id !== id);
                await saveData();
                displayGroups();
                showAlert('Groupe supprimé avec succès!', 'success');
            }
        }

        function populateGroupSelects() {
            // Lisitry ny ID an'ireo SELECT rehetra mila fenoina
            const selects = [
                'employeeGroup_add',      // <--- Ity no ho an'ny fanampiana mpiasa vaovao
                'editEmployeeGroup',      // Ho an'ny fanovana mpiasa
                'employeeGroupFilter',    // Ho an'ny sivana ao amin'ny lisitry ny mpiasa
                'payrollGroupFilter',     // Ho an'ny sivana ao amin'ny karama
                'advanceGroupFilter',
                'estimationGroupFilter',
                'attendanceGroupFilter'      // Ho an'ny sivana ao amin'ny trosa
            ];
            
            // Amboarina ny HTML ho an'ny options (tsy miova)
            const optionsHTML = groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');

            // Fenoina tsirairay ireo select
            selects.forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    // Tehirizina ny option voalohany (ohatra: "Aucun groupe" na "Tous les groupes")
                    const firstOption = selectElement.options[0].outerHTML;
                    // Fenoina ny select miaraka amin'ny option voalohany sy ny lisitry ny vondrona
                    selectElement.innerHTML = firstOption + optionsHTML;
                }
            });
        }

        /**
         * Mameno ny lisitra fisafidianana mpiasa ao amin'ny fizarana PAIE ihany.
         * Izy no lasa foiben'ny fanavaozana an'io select io.
         * @param {string | null} groupId - Ny ID an'ny vondrona hasivana. Raha 'all' na null, dia ny mpiasa rehetra no alaina.
         */
        function populatePayrollEmployeeSelect(groupId = 'all') {
            const employeeSelect = document.getElementById('payrollEmployeeSelect');
            if (!employeeSelect) return;

            let employeesToList = employees;

            if (groupId && groupId !== 'all') {
                employeesToList = employees.filter(emp => emp.groupId === groupId);
            }

            const employeeOptionsHTML = employeesToList.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
            
            // Foanana aloha ny lisitra taloha, afa-tsy ilay option voalohany
            employeeSelect.innerHTML = '<option value="">Tous les employés</option>' + employeeOptionsHTML;
        }


        /**
         * Antsoina rehefa misafidy VONDROM-PIASA ao amin'ny fizarana PAIE.
         */
        function handlePayrollGroupChange() {
            const groupFilter = document.getElementById('payrollGroupFilter');
            const selectedGroupId = groupFilter.value;

            // 1. Havaozina ny lisitry ny mpiasa mba hifanaraka amin'ny vondrona voafidy
            populatePayrollEmployeeSelect(selectedGroupId);
            
            // 2. Diovina ny vokatry ny kajy teo aloha
            document.getElementById('payrollResults').innerHTML = '';
        }


        /**
         * Antsoina rehefa misafidy MPIASA ao amin'ny fizarana PAIE.
         */
        function handlePayrollEmployeeChange() {
            const groupFilterSelect = document.getElementById('payrollGroupFilter');
            const employeeSelect = document.getElementById('payrollEmployeeSelect');
            const selectedEmployeeId = employeeSelect.value;

            if (!selectedEmployeeId) {
                // Raha "Tous les employés" no voafidy, dia averina amin'ny "Tous les Groupes" ny sivana
                groupFilterSelect.value = 'all';
                return;
            }

            const selectedEmployee = employees.find(emp => emp.id === selectedEmployeeId);
            if (!selectedEmployee) return;

            // Ovaina ho azy ny select-n'ny vondrona mba hifanaraka amin'ny vondron'ilay mpiasa
            groupFilterSelect.value = selectedEmployee.groupId || 'all';
            
            // Diovina ny vokatry ny kajy teo aloha
            document.getElementById('payrollResults').innerHTML = '';
        }

        /**
         * Mamorona sy mampiseho ny bokotra fitetezana pejy (pagination).
         * VERSION NOHATSARAINA: Mampiseho ny isan'ny singa.
         * @param {string} containerId - Ny ID an'ilay div handraisana ny bokotra.
         * @param {number} currentPage - Ny pejy misy ankehitriny.
         * @param {number} totalPages - Ny isan'ny pejy rehetra.
         * @param {number} totalItems - Ny isan'ny singa REHETRA (tsy voazarazara).
         * @param {number} itemsPerPage - Ny isan'ny singa isaky ny pejy.
         * @param {function} onPageChange - Ny fonction antsoina rehefa miova ny pejy.
         */
        function renderPaginationControls(containerId, currentPage, totalPages, totalItems, itemsPerPage, onPageChange) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            // Kajiana ny laharan'ny singa aseho
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            container.innerHTML = `
                <button id="${containerId}-prev" ${currentPage === 1 ? 'disabled' : ''}>
                    <span class="material-icons">chevron_left</span>
                    Teo aloha
                </button>
                <span class="pagination-info">
                    Mampiseho ${startItem}-${endItem} amin'ny ${totalItems}
                </span>
                <button id="${containerId}-next" ${currentPage === totalPages ? 'disabled' : ''}>
                    Manaraka
                    <span class="material-icons">chevron_right</span>
                </button>
            `;

            document.getElementById(`${containerId}-prev`).addEventListener('click', () => {
                if (currentPage > 1) {
                    onPageChange(currentPage - 1);
                }
            });

            document.getElementById(`${containerId}-next`).addEventListener('click', () => {
                if (currentPage < totalPages) {
                    onPageChange(currentPage + 1);
                }
            });
        }


        /**
         * Manova ny isan'ny singa aseho isaky ny pejy ary mamerina amin'ny pejy voalohany.
         * VERSION NOHATSARAINA: Mahazaka ny lisitra rehetra.
         */
        function changeItemsPerPage(listType, value) {
            const newValue = parseInt(value, 10);
            
            if (listType === 'employee') {
                employeeItemsPerPage = newValue;
                employeeCurrentPage = 1;
                displayEmployees();
            } else if (listType === 'attendance') {
                attendanceItemsPerPage = newValue;
                attendanceCurrentPage = 1;
                displayAttendance();
            } else if (listType === 'advances') {
                advancesItemsPerPage = newValue;
                advancesCurrentPage = 1;
                displayAdvances();
            }
        }

        /**
         * Manao export ny lisitry ny trosa voasivana ho PDF na Excel (.xlsx).
         * VERSION FARANY INDRINDRA: Nalehibeazina ny haavon'ny andalana ho an'ny sonia.
         */
        function exportAdvances(format) {
            // 1. Fakan-tsivana (tsy miova)
            const searchTerm = document.getElementById('advanceSearchInput').value.toLowerCase();
            const monthFilter = document.getElementById('advanceMonthFilter').value;
            const groupFilter = document.getElementById('advanceGroupFilter').value;

            let dataToExport = advances.filter(advance => {
                const employee = employees.find(emp => emp.id === advance.employeeId);
                if (!employee) return false;
                const matchesSearch = employee.name.toLowerCase().includes(searchTerm) ||
                                    employee.position.toLowerCase().includes(searchTerm) ||
                                    (advance.reason || '').toLowerCase().includes(searchTerm);
                const matchesMonth = !monthFilter || advance.date.startsWith(monthFilter);
                const matchesGroup = groupFilter === 'all' || employee.groupId === groupFilter;
                
                if (format === 'pdf') {
                    const isPending = (advance.status || 'En attente') === 'En attente';
                    return matchesSearch && matchesMonth && matchesGroup && isPending;
                }
                return matchesSearch && matchesMonth && matchesGroup;
            });

            if (dataToExport.length === 0) {
                showAlert(format === 'pdf' ? "Aucune avance 'En attente' à imprimer." : "Aucune donnée à exporter.", 'warning');
                return;
            }

            // 2. Fandaharana (tsy miova)
            dataToExport.sort((a, b) => {
                const employeeA = employees.find(e => e.id === a.employeeId);
                const employeeB = employees.find(e => e.id === b.employeeId);
                const groupA = groups.find(g => g.id === employeeA?.groupId);
                const groupB = groups.find(g => g.id === employeeB?.groupId);
                const groupNameA = groupA ? groupA.name : 'zzz_Sans Groupe';
                const groupNameB = groupB ? groupB.name : 'zzz_Sans Groupe';
                if (groupNameA < groupNameB) return -1;
                if (groupNameA > groupNameB) return 1;
                const nameA = employeeA?.name || '';
                const nameB = employeeB?.name || '';
                return nameA.localeCompare(nameB);
            });

            const filename = `export-avances-${new Date().toISOString().split('T')[0]}`;

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text("Liste des Avances à Payer", doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                const periodText = monthFilter ? `Période: ${monthFilter}` : "Toutes les périodes";
                doc.text(periodText, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });

                const tableData = [];
                let totalAdvances = 0;
                
                dataToExport.forEach(adv => {
                    const employee = employees.find(e => e.id === adv.employeeId);
                    const group = groups.find(g => g.id === employee?.groupId);
                    const amount = adv.amount || 0;
                    
                    let formattedAmount = formatCurrency(amount).replace(' Ar', '').trim();
                    formattedAmount = formattedAmount.replace(/\s/g, ' ');

                    tableData.push({
                        date: formatDate(adv.date, false),
                        group: group ? group.name : 'Sans Groupe',
                        name: employee ? employee.name : 'N/A',
                        amount: formattedAmount,
                        signature: ''
                    });
                    totalAdvances += amount;
                });

                doc.autoTable({
                    body: tableData,
                    columns: [
                        { header: 'Date', dataKey: 'date' },
                        { header: 'Groupe', dataKey: 'group' },
                        { header: 'Nom de l\'Employé', dataKey: 'name' },
                        { header: 'Montant (Ar)', dataKey: 'amount' },
                        { header: 'Signature', dataKey: 'signature' },
                    ],
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillColor: [103, 80, 164], textColor: 255, fontStyle: 'bold', fontSize: 9 },
                    styles: { fontSize: 8.5, cellPadding: 2.5 },
                    columnStyles: { 
                        date: { cellWidth: 25 },
                        group: { cellWidth: 45 },
                        name: { cellWidth: 70 },
                        amount: { halign: 'right', cellWidth: 30 },
                        signature: { cellWidth: 60 }
                    },
                    // =======================================================================
                    //                      FANITSIANA LEHIBE ETO
                    // =======================================================================
                    // Ity no manome haavo farafahakeliny ho an'ny andalana tsirairay
                    // Ny sanda 12 dia efa manome toerana malalaka tsara. Azonao ampitomboina (ohatra: 15) raha ilaina.
                    minCellHeight: 12 
                    // =======================================================================
                });

                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                
                let formattedTotal = formatCurrency(totalAdvances || 0);
                formattedTotal = formattedTotal.replace(/\s/g, ' ');

                doc.text(`Total des Avances à Payer: ${formattedTotal}`, 14, finalY);

                doc.save(`liste-avances-a-signer-${monthFilter || 'tous'}.pdf`);
                showAlert('La liste PDF finale a été générée avec succès!', 'success');

            } else if (format === 'xlsx') {
                // Ny kaody Excel dia tsy miova
                const headers = ["Date", "Nom de l'Employé", "Groupe", "Montant (Ar)", "Motif", "Statut"];
                const sheetData = [headers];
                let totalAdvances = 0;
                dataToExport.forEach(adv => {
                    const employee = employees.find(e => e.id === adv.employeeId);
                    const group = groups.find(g => g.id === employee?.groupId);
                    const amount = adv.amount || 0;
                    sheetData.push([
                        adv.date,
                        employee ? employee.name : 'N/A',
                        group ? group.name : 'Sans groupe',
                        amount,
                        adv.reason || '',
                        adv.status || 'En attente'
                    ]);
                    totalAdvances += amount;
                });
                sheetData.push([]);
                sheetData.push(["", "", "Total des Avances:", totalAdvances, ""]);
                const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
                const numberFormat = "#,##0";
                const totalFormat = `#,##0 "Ar"`;
                for (let i = 1; i < dataToExport.length + 1; i++) {
                    const cellRef = XLSX.utils.encode_cell({r: i, c: 3});
                    if(worksheet[cellRef]) worksheet[cellRef].z = numberFormat;
                }
                const totalCellRef = XLSX.utils.encode_cell({r: dataToExport.length + 2, c: 3});
                if(worksheet[totalCellRef]) {
                    worksheet[totalCellRef].z = totalFormat;
                    worksheet[totalCellRef].s = { font: { bold: true } };
                }
                const totalLabelCellRef = XLSX.utils.encode_cell({r: dataToExport.length + 2, c: 2});
                if(worksheet[totalLabelCellRef]) worksheet[totalLabelCellRef].s = { font: { bold: true } };
                worksheet['!cols'] = [ { wch: 12 }, { wch: 30 }, { wch: 20 }, { wch: 18 }, { wch: 40 }, { wch: 15 } ];
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Avances");
                XLSX.writeFile(workbook, `${filename}.xlsx`);
                showAlert('Export Excel des avances réussi!', 'success');
            }
        }



        /**
         * Manamarina ny fandoavana ny trosa iray.
         * Ovainy ho 'Confirmé' ny satan'ilay trosa.
         * @param {string} advanceId - Ny ID an'ilay trosa ho hamarinina.
         */
        async function confirmAdvance(advanceId) {
            const advanceIndex = advances.findIndex(adv => adv.id === advanceId);
            
            if (advanceIndex === -1) {
                showAlert("Erreur: Avance non trouvée.", 'error');
                return;
            }

            // Ovaina ny sata
            advances[advanceIndex].status = 'Confirmé';

            // Tehirizina ny fanovana
            await saveData();

            // Havaozina ny fampisehoana
            displayAdvances();

            showAlert("L'avance a été marquée comme confirmée et payée.", 'success');
        }


        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
            
            navigator.serviceWorker.register(`service-worker.js`)

                .then(registration => {
                    console.log('ServiceWorker voasoratra anarana: ', registration);
                })
                .catch(error => {
                console.log('Fisoratana anarana ServiceWorker nisy olana: ', error);
                });
            });
        }

                // =======================================================================
        //  handleImportedFile (VERSION FARANY - TSY Mampiasa location.reload())
        // =======================================================================
        async function handleImportedFile(file) {
            if (!file) {
                showAlert("Tsy nisy rakitra voafantina.", "warning");
                return;
            }

            try {
                const fileContent = await file.text();
                const data = JSON.parse(fileContent);

                if (!data.employees || !data.attendance || !data.dbType) {
                    showAlert("Erreur: Le fichier de sauvegarde semble invalide ou corrompu.", 'error');
                    return;
                }

                const confirmationMessage = `
                    Vous êtes sur le point de restaurer une sauvegarde.
                    ATTENTION: Toutes les données actuelles seront écrasées.
                    
                    Date de la sauvegarde: ${formatDate(data.exportDate || new Date())}
                    Version: ${data.version || 'Inconnue'}
                    
                    Êtes-vous sûr de vouloir continuer ?
                `;

                if (confirm(confirmationMessage)) {
                    // 1. Ampidirina ao anaty variables ireo angona vaovao
                    employees = data.employees || [];
                    attendance = data.attendance || {};
                    payrolls = data.payrolls || [];
                    advances = data.advances || [];
                    qrAttendance = data.qrAttendance || [];
                    groups = data.groups || [];
                    
                    // Ampidirina koa ny paramètres raha misy
                    if (data.settings) {
                        currentTheme = data.settings.theme || 'light';
                        qrSettings = data.settings.qrSettings || { size: 256, color: '#6750A4' };
                    }

                    // 2. Tehirizina ao amin'ny IndexedDB ireo angona vaovao ireo
                    await saveData();
                    
                    // 3. Fafana ilay baiko "reload" ary soloina amin'ny fanavaozana ny interface
                    showAlert('Données importées avec succès! L\'interface va être mise à jour.', 'success');
                    
                    // Antsoina ireo function rehetra ilaina mba hamenoana indray ny pejy
                    // toy ny hoe vao nosokafana ilay izy.
                    updateStats();
                    setCurrentDate();
                    setCurrentMonth();
                    populateEmployeeSelects();
                    populateGroupSelects();
                    initializeTheme();
                    displayDashboardCharts();
                    runSmartChecks();
                    
                    // Averina any amin'ny fizarana voalohany (Tableau de Bord)
                    showSection('dashboard');
                    // Ataovy "active" ilay bokotra mifanaraka aminy
                    document.querySelector('.nav-tab[onclick="showSection(\'dashboard\')"]').classList.add('active');

                } else {
                    showAlert("Importation annulée par l'utilisateur.", "info");
                }    
                
            } catch (error) {
                showAlert('Erreur lors de l\'importation: Fichier invalide ou corrompu.', 'error');
                console.error("Erreur d'importation:", error);
            }
        }

        
                // =======================================================================
        //  calculateSTC (VERSION MIARA-MIASA AMIN'NY getStartDateForCalculation VAOVAO)
        // =======================================================================
        async function calculateSTC() {
            const employeeId = document.getElementById('stcEmployeeSelect').value;
            const container = document.getElementById('stcResultsContainer');

            if (!employeeId) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = '<div class="loading"></div><p>Calcul en cours...</p>';

            const employee = employees.find(e => e.id === employeeId);
            if (!employee || !employee.departureDate) {
                container.innerHTML = '<p class="alert alert-error">Erreur: Date de départ non définie pour cet employé.</p>';
                return;
            }

            const departureDate = new Date(employee.departureDate + 'T23:59:59Z');
            const lastPaidMonth = getLastPaidMonth(employeeId);
            
            // Ity andalana ity izao dia mandray ny daty marina (na daty nidirana, na 1er du mois suivant)
            const startDateForCalc = getStartDateForCalculation(lastPaidMonth, employeeId);

            if (departureDate < startDateForCalc) {
                container.innerHTML = `<p class="alert alert-warning">Cet employé a déjà été payé pour toute sa période de travail. Aucun calcul n'est nécessaire.</p>`;
                return;
            }

            let totalGrossSalaryToPay = 0;
            let totalAdvancesToDeduct = 0;
            let totalDaysToPay = 0;
            let detailsHTML = '';

            let currentYear = startDateForCalc.getUTCFullYear();
            let currentMonth = startDateForCalc.getUTCMonth(); // 0-11

            const endYear = departureDate.getUTCFullYear();
            const endMonth = departureDate.getUTCMonth();

            while (currentYear < endYear || (currentYear === endYear && currentMonth <= endMonth)) {
                
                const monthForCalc = currentMonth + 1;
                const currentMonthStr = `${currentYear}-${monthForCalc.toString().padStart(2, '0')}`;
                const daysInCurrentMonth = getDaysInMonth(currentYear, monthForCalc);

                const presenceInMonth = countPresenceDays(employeeId, currentMonthStr);
                totalDaysToPay += presenceInMonth;

                const grossSalaryForMonth = (employee.salary / daysInCurrentMonth) * presenceInMonth;
                totalGrossSalaryToPay += grossSalaryForMonth;

                const advancesInMonth = advances
                    .filter(adv => adv.employeeId === employeeId && adv.date.startsWith(currentMonthStr))
                    .reduce((sum, adv) => sum + adv.amount, 0);
                totalAdvancesToDeduct += advancesInMonth;

                if (presenceInMonth > 0 || advancesInMonth > 0) {
                    detailsHTML += `<li>Mois ${currentMonthStr}: Présence: ${presenceInMonth.toFixed(2)} j | Brut: ${formatCurrency(grossSalaryForMonth)} | Avances: ${formatCurrency(advancesInMonth)}</li>`;
                }
                
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
            }

            const netSalaryToPay = Math.max(0, totalGrossSalaryToPay - totalAdvancesToDeduct);

            // Fampisehoana ny vokany
            container.innerHTML = `
                <h3>Détail du Solde pour ${employee.name}</h3>
                <p>Période de calcul: du <strong>${startDateForCalc.toLocaleDateString('fr-FR', { timeZone: 'UTC' })}</strong> au <strong>${new Date(employee.departureDate + 'T00:00:00Z').toLocaleDateString('fr-FR', { timeZone: 'UTC' })}</strong></p>
                
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="stat-card">
                        <div class="stat-content"><h3>${totalDaysToPay.toFixed(2)}</h3><p>Total Jours à Payer</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content"><h3>${formatCurrency(totalGrossSalaryToPay)}</h3><p>Total Salaire Brut</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content"><h3>${formatCurrency(totalAdvancesToDeduct)}</h3><p>Total Avances</p></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px; background-color: var(--md-sys-color-primary-container);">
                    <h2 style="color: var(--md-sys-color-on-primary-container);">Montant Final à Payer: ${formatCurrency(netSalaryToPay)}</h2>
                </div>

                <h4>Résumé mensuel:</h4>
                <ul style="max-height: 150px; overflow-y: auto; padding: 10px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">
                    ${detailsHTML || "<li>Aucune activité enregistrée pour cette période.</li>"}
                </ul>

                <button class="btn btn-success" style="margin-top: 24px;" onclick="finalizeSTC('${employee.id}', ${netSalaryToPay})">
                    <span class="material-icons">check_circle</span>
                    Valider et Payer le Solde
                </button>
            `;
        }






        // Ireo fonctions mpanampy ireo dia ilaina mba handehanan'ny etsy ambony
        function getLastPaidMonth(employeeId) {
            const employeePayments = payrolls.filter(p => p.employeeId === employeeId && p.month !== 'SOLDE_DE_TOUT_COMPTE');
            if (employeePayments.length === 0) return null;
            employeePayments.sort((a, b) => b.month.localeCompare(a.month));
            return employeePayments[0].month;
        }

                // =======================================================================
        //  getStartDateForCalculation (VERSION FARANY INDRINDRA - UTC 100%)
        // =======================================================================
        function getStartDateForCalculation(lastPayMonth, employeeId) {
            // Raha efa nisy karama voaloa (ohatra: Jolay 2025)
            if (lastPayMonth) {
                const [year, month] = lastPayMonth.split('-').map(Number);
                // Manomboka amin'ny andro voalohan'ny volana MANARAKA (1 Aogositra 2025)
                // Ny volana dia 0-11, ka ny volana faha-8 (Aogositra) dia 7.
                // Ny volana manaraka dia lasa volana faha-9 (Septambra)
                return new Date(Date.UTC(year, month, 1)); 
            } 
            
            // Raha mbola TSY nisy karama voaloa mihitsy
            else {
                const employee = employees.find(emp => emp.id === employeeId);
                // Raha manana daty nidirana ilay mpiasa
                if (employee && employee.dateAdded) {
                    // --- FANITSIANA LEHIBE ETO ---
                    // Avadika ho objet Date aloha ilay dateAdded
                    const dateAdded = new Date(employee.dateAdded);
                    // Avy eo, ampiasaina ny taona, volana, ary andro avy aminy mba hamoronana daty UTC vaovao
                    // Izay miantoka fa tsy misy fiantraikan'ny timezone
                    return new Date(Date.UTC(dateAdded.getUTCFullYear(), dateAdded.getUTCMonth(), dateAdded.getUTCDate()));
                } 
                // Raha sendra tsy misy (ho an'ny angona taloha be)
                else {
                    const today = new Date();
                    return new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));
                }
            }
        }


                // =======================================================================
        //  FONCTION VAOVAO: Maka ny daty tena tokony hiseho
        // =======================================================================
        function getDisplayStartDate(lastPayMonth, employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);

            // Raha mbola tsy nisy karama voaloa mihitsy
            if (!lastPayMonth) {
                // Raha manana daty nidirana izy, dia io no aseho
                if (employee && employee.dateAdded) {
                    return new Date(employee.dateAdded);
                }
            }
            
            // Amin'ny tranga hafa rehetra, dia ny andro voalohan'ny volana
            // manaraka ny karama farany no aseho.
            // Na raha tsy misy dateAdded aza.
            const startDateForCalc = getStartDateForCalculation(lastPayMonth, employeeId);
            return startDateForCalc;
        }


        // Fonction fanampiny ilaina
        function populateSTCEmployeeSelect() {
            const select = document.getElementById('stcEmployeeSelect');
            const employeesToLeave = employees.filter(e => e.status === 'depart');
            select.innerHTML = '<option value="">-- Choisir un employé --</option>' + 
                            employeesToLeave.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }

        // =======================================================================
        //  finalizeSTC (VERSION NOHATSARAINA - TSY MAMAFY INTSONY)
        //  Izy ity dia manova ny satan'ny mpiasa ho "inactif"
        // =======================================================================
        async function finalizeSTC(employeeId, amount) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showAlert("Erreur: Employé non trouvé lors de la finalisation.", "error");
                return;
            }

            if (confirm(`Vous êtes sur le point de payer un solde de ${formatCurrency(amount)} à ${employee.name}. Cette action marquera l'employé comme "Inactif" et est définitive. Continuer ?`)) {
                
                // 1. Tehirizina ho toy ny karama manokana (tsy miova)
                const stcRecord = {
                    id: `stc-${employeeId}-${Date.now()}`,
                    employeeId: employeeId,
                    employeeName: employee.name, 
                    month: 'SOLDE_DE_TOUT_COMPTE',
                    amount: amount,
                    date: new Date().toISOString()
                };
                payrolls.push(stcRecord);

                // 2. FANovana LEHIBE: Ovaina ho "inactif" ny satan'ilay mpiasa
                const employeeIndex = employees.findIndex(e => e.id === employeeId);
                if (employeeIndex > -1) {
                    employees[employeeIndex].status = 'inactif';
                    // Azonao atao koa ny manampy daty fialana ofisialy raha ilaina
                    employees[employeeIndex].departureDate = new Date().toISOString().split('T')[0];
                }

                // 3. Tehirizina ny fanovana rehetra (tsy miova)
                await saveData();

                // 4. Havaozina ny interface (tsy miova)
                showAlert('Solde de tout compte payé et finalisé avec succès! L\'employé est maintenant inactif.', 'success');
                populateSTCEmployeeSelect(); // Esorina ao anaty lisitra ilay mpiasa
                document.getElementById('stcResultsContainer').style.display = 'none';
                
                // Havaozina ny lisitry ny mpiasa mba tsy hisehoany intsony
                displayEmployees();
            }
        }

        // =======================================================================
        //  VERSION VOAHITSY - Mampiseho ny kalandrie rehefa miova ny sata
        // =======================================================================
        // Mampifandray ny hetsika amin'ilay SELECT marina ao anatin'ny MODAL FANovana
        document.getElementById('editEmployeeStatus').addEventListener('change', function() {
            // Alaina ilay DIV misy ilay kalandrie
            const departureDateContainer = document.getElementById('editDepartureDateContainer');
            
            // Hamarino aloha raha hita ilay DIV
            if (departureDateContainer) {
                // Raha "Départ Programmé" na "Inactif" no voafidy, dia ASEHOY ilay kalandrie
                if (this.value === 'depart' || this.value === 'inactif') {
                    departureDateContainer.style.display = 'block';
                } 
                // Raha "Actif" no voafidy, dia AFENO ilay kalandrie
                else {
                    departureDateContainer.style.display = 'none';
                }
            }
        });

                // =======================================================================
        //  calculateSalaryEstimation (VERSION FARANY - MISY BRUT SY NET)
        // =======================================================================
        function calculateSalaryEstimation() {
            const startDateStr = document.getElementById('estimationStartDate').value;
            const endDateStr = document.getElementById('estimationEndDate').value;
            const groupFilter = document.getElementById('estimationGroupFilter').value;
            const container = document.getElementById('estimationResultsContainer');

            if (!startDateStr || !endDateStr) {
                showAlert("Veuillez sélectionner une date de début et de fin.", 'error');
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00Z');
            const endDate = new Date(endDateStr + 'T23:59:59Z');

            if (endDate < startDate) {
                showAlert("La date de fin ne peut pas être antérieure à la date de début.", 'error');
                return;
            }

            container.style.display = 'block';
            container.innerHTML = '<div class="loading"></div><p>Calcul de l\'estimation en cours...</p>';

            let employeesToEstimate = employees.filter(e => e.status !== 'inactif');
            if (groupFilter !== 'all') {
                employeesToEstimate = employeesToEstimate.filter(emp => emp.groupId === groupFilter);
            }

            let totalEstimatedGrossSalary = 0;
            let totalAdvancesInPeriod = 0; // <-- VARIABLA VAOVAO HO AN'NY TROSA
            let totalDaysCount = 0;
            let totalPastDays = 0;
            let totalFutureDays = 0;

            // Famakiana ny andro tsirairay
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().slice(0, 10);
                const today = new Date();
                today.setUTCHours(0, 0, 0, 0);

                const daysInCurrentMonth = getDaysInMonth(d.getUTCFullYear(), d.getUTCMonth() + 1);

                employeesToEstimate.forEach(employee => {
                    const dailySalary = employee.salary / daysInCurrentMonth;
                    let dayValue = 0;

                    if (d < today) { // Andro efa lasa
                        const dayAttendanceData = attendance[dateStr];
                        if (dayAttendanceData && dayAttendanceData[employee.id]) {
                            const presenceData = dayAttendanceData[employee.id];
                            const dayOfWeek = d.getUTCDay();
                            if (dayOfWeek === 0) { dayValue = 1; }
                            else {
                                if (typeof presenceData === 'object' && presenceData.arrivee) {
                                    if (presenceData.depart) {
                                        const duration = calculateWorkDuration(presenceData.arrivee, presenceData.depart);
                                        dayValue = (duration.totalMinutes / 60 >= 4) ? 1 : 0.5;
                                    } else { dayValue = 0.5; }
                                } else if (presenceData === true || presenceData === 'journee') {
                                    dayValue = 1;
                                } else if (presenceData === 'demi') {
                                    dayValue = 0.5;
                                }
                            }
                        }
                        totalPastDays += dayValue;
                    } else { // Andro anio na ho avy
                        const dayOfWeek = d.getUTCDay();
                        if (dayOfWeek !== 6) { dayValue = 1; }
                        totalFutureDays += dayValue;
                    }

                    totalEstimatedGrossSalary += dailySalary * dayValue;
                    totalDaysCount += dayValue;
                });
            }

            // --- KAJY VAOVAO: Alaina ny totalin'ny trosa rehetra ao anatin'ilay fe-potoana ---
            employeesToEstimate.forEach(employee => {
                const employeeAdvances = advances.filter(adv => {
                    const advDate = new Date(adv.date + 'T00:00:00Z');
                    return adv.employeeId === employee.id && advDate >= startDate && advDate <= endDate;
                });
                const totalEmployeeAdvances = employeeAdvances.reduce((sum, adv) => sum + adv.amount, 0);
                totalAdvancesInPeriod += totalEmployeeAdvances;
            });
            
            const totalEstimatedNetSalary = totalEstimatedGrossSalary - totalAdvancesInPeriod;

            // --- Fampisehoana ny valiny miaraka amin'ny NET ---
            container.innerHTML = `
                <h3>Résultats de l'Estimation</h3>
                <p>Pour la période du <strong>${startDate.toLocaleDateString('fr-FR', { timeZone: 'UTC' })}</strong> au <strong>${endDate.toLocaleDateString('fr-FR', { timeZone: 'UTC' })}</strong></p>
                
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-icons">receipt_long</span></div>
                        <div class="stat-content">
                            <h3>${formatCurrency(totalEstimatedGrossSalary)}</h3>
                            <p>Total Salaire BRUT Estimé</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: var(--md-sys-color-error);"><span class="material-icons">trending_down</span></div>
                        <div class="stat-content">
                            <h3>${formatCurrency(totalAdvancesInPeriod)}</h3>
                            <p>Total Avances sur Période</p>
                        </div>
                    </div>
                    <div class="stat-card" style="background-color: var(--md-sys-color-primary-container);">
                        <div class="stat-icon"><span class="material-icons">payments</span></div>
                        <div class="stat-content">
                            <h3 style="color: var(--md-sys-color-on-primary-container);">${formatCurrency(totalEstimatedNetSalary)}</h3>
                            <p>Total Salaire NET Estimé</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; padding: 12px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">
                    <h4>Détails des jours comptabilisés:</h4>
                    <ul>
                        <li><strong>Jours passés (réels):</strong> ${totalPastDays.toFixed(2)} jours</li>
                        <li><strong>Jours futurs (estimés):</strong> ${totalFutureDays.toFixed(2)} jours</li>
                        <li><strong>Total Jours-Homme Estimés:</strong> ${totalDaysCount.toFixed(2)} jours</li>
                    </ul>
                </div>
            `;
        }




        // =======================================================================
        //  countEstimatedPresence (VERSION VAOVAO - MANITSY NY KAJY NY ANDRO LASA)
        // =======================================================================
        function countEstimatedPresence(employeeId, startDate, endDate) {
            let pastDays = 0;
            let futureDays = 0;
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0);

            // Famakiana ny andro rehetra ao anatin'ny fe-potoana
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().slice(0, 10); // "YYYY-MM-DD"

                // Raha daty efa lasa
                if (d < today) {
                    // --- FANITSIANA LEHIBE ETO ---
                    // Alaina mivantana ny angona ho an'io andro io
                    const dayAttendanceData = attendance[dateStr];
                    if (dayAttendanceData) {
                        const presenceData = dayAttendanceData[employeeId];
                        if (presenceData) {
                            // Ampiasaina ny lojika mitovy amin'ny countPresenceDays
                            const currentDate = new Date(dateStr + 'T00:00:00Z');
                            const dayOfWeek = currentDate.getUTCDay();
                            const isSunday = (dayOfWeek === 0);

                            if (isSunday) {
                                pastDays += 1;
                            } else {
                                if (typeof presenceData === 'object' && presenceData !== null && presenceData.arrivee) {
                                    if (presenceData.depart) {
                                        const duration = calculateWorkDuration(presenceData.arrivee, presenceData.depart);
                                        if (duration.totalMinutes / 60 >= 4) {
                                            pastDays += 1;
                                        } else if (duration.totalMinutes > 0) {
                                            pastDays += 0.5;
                                        }
                                    } else {
                                        pastDays += 0.5;
                                    }
                                } else if (presenceData === true || presenceData === 'journee') {
                                    pastDays += 1;
                                } else if (presenceData === 'demi') {
                                    pastDays += 0.5;
                                }
                            }
                        }
                    }
                } 
                // Raha daty anio na ho avy
                else {
                    const dayOfWeek = d.getUTCDay();
                    // Raha tsy Alahady (0) na Asabotsy (6), dia heverina ho tonga
                    if (dayOfWeek !== 0) { // Ovaina mba ho isaina koa ny Asabotsy raha ilaina
                        futureDays += 1;
                    }
                }
            }

            return {
                estimatedDays: pastDays + futureDays,
                pastDays: pastDays,
                futureDays: futureDays
            };
        }
        // =======================================================================
        //  FONCTION VAOVAO: Mifehy ny fisehoan'ny sehatra fampidirana andro
        // =======================================================================
        function toggleAdvanceDaysInput() {
            const checkbox = document.getElementById('includeAdvanceCheckbox');
            const container = document.getElementById('advanceDaysContainer');
            const input = document.getElementById('advanceDaysInput');

            if (checkbox.checked) {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                input.value = 0; // Averina ho 0 foana rehefa tsy voatsindry
            }
        }

        /**
         * Manisa ny isan'ny andro nisy ho an'ny mpiasa iray nandritra ny volana iray
         * @param {string} employeeId - ID ny mpiasa
         * @param {string} month - Volana (format: YYYY-MM)
         * @returns {number} - Isan'ny andro nisy (>= 4 ora)
         */
        function calculateAttendanceDaysForMonth(employeeId, month) {
            if (!month) return 0;
            
            const [year, monthNum] = month.split('-');
            let totalDays = 0;
            
            // Mijery ny andro rehetra ao anatin'ny volana
            const daysInMonth = new Date(year, monthNum, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${monthNum.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Jerena ao amin'ny présence manuelle
                if (attendance[dateStr] && attendance[dateStr][employeeId]) {
                    totalDays++;
                    continue;
                }
                
                // Jerena ao amin'ny présence QR
                const qrRecords = qrAttendance.filter(record => 
                    record.employeeId === employeeId && 
                    record.date === dateStr
                );
                
                if (qrRecords.length > 0) {
                    // Kajy ny totalin'ny ora
                    const totalHours = qrRecords.reduce((sum, record) => sum + (record.hours || 0), 0);
                    if (totalHours >= 4) {
                        totalDays++;
                    }
                }
            }
            
            return totalDays;
        }

        /**
         * Mamorona ny badge HTML mampiseho ny isan'ny andro nisy
         * @param {number} days - Isan'ny andro
         * @returns {string} - HTML ny badge
         */
        function createAttendanceBadge(days) {
            if (days === 0) {
                return `
                    <span class="attendance-badge no-attendance">
                        <span class="material-icons">event_busy</span>
                        <span>0 jour</span>
                    </span>
                `;
            }
            
            return `
                <span class="attendance-badge">
                    <span class="material-icons">check_circle</span>
                    <span>${days} jour${days > 1 ? 's' : ''}</span>
                </span>
            `;
        }

        async function handleQRImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const img = new Image();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.getElementById('qrCanvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, canvas.width, canvas.height);
                    
                    if (code) {
                        processQRCode(code.data);
                    } else {
                        showAlert('Aucun QR code détecté dans l\'image', 'error');
                    }
                };
            };
            
            reader.readAsDataURL(file);
        }



        // ==========================================
        // FACE RECOGNITION MODULE
        // ==========================================

        const FaceRecognition = {
            modelsLoaded: false,
            
            async loadModels() {
                if (this.modelsLoaded) return true;
                
                try {
                    console.log('📦 Chargement models face-api.js...');
                    
                    const basePath = window.location.pathname.includes('/systeme-rh-behavana/') 
                        ? '/systeme-rh-behavana' 
                        : '';
                    const modelPath = `${basePath}/models`;
                    
                    console.log('Model path:', modelPath);
                    
                    // ⬇️⬇️⬇️ VERSION AVEC FALLBACK CDN ⬇️⬇️⬇️
                    try {
                        // Essayer local d'abord
                        await faceapi.nets.tinyFaceDetector.loadFromUri(modelPath);
                        await faceapi.nets.faceLandmark68Net.loadFromUri(modelPath);
                        await faceapi.nets.faceRecognitionNet.loadFromUri(modelPath);
                        console.log('✅ Models chargés depuis:', modelPath);
                    } catch (localError) {
                        console.warn('⚠️ Models locaux non trouvés, tentative CDN...');
                        const cdnPath = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
                        await faceapi.nets.tinyFaceDetector.loadFromUri(cdnPath);
                        await faceapi.nets.faceLandmark68Net.loadFromUri(cdnPath);
                        await faceapi.nets.faceRecognitionNet.loadFromUri(cdnPath);
                        console.log('✅ Models chargés depuis CDN');
                    }
                    // ⬆️⬆️⬆️ FIN MODIFICATION ⬆️⬆️⬆️
                    
                    this.modelsLoaded = true;
                    return true;
                } catch (error) {
                    console.error('❌ Erreur models:', error);
                    alert('Erreur chargement models: ' + error.message);
                    return false;
                }
            },

            
            calculateEAR(eye) {
                const points = eye.map(p => ({x: p.x, y: p.y}));
                const v1 = this.distance(points[1], points[5]);
                const v2 = this.distance(points[2], points[4]);
                const h = this.distance(points[0], points[3]);
                return (v1 + v2) / (2.0 * h);
            },
            
            distance(p1, p2) {
                return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
            },
            
            // =================================================================
            //  ENROLLFACE (VERSION 6 - MISARAKA NY DINGANA)
            // =================================================================
            async enrollFace(videoElement, employeData) {
                const descriptors = [];
                const instructions = [
                    "Mijere mahitsy",
                    "Atongilano kely miankavia ny loha",
                    "Atongilano kely miankavanana ny loha",
                    "Atongilano kely miakatra ny loha",
                    "Atongilano kely midina ny loha"
                ];
                
                console.log('🎥 Démarrage enrollment (version manuelle)...');
                
                const statusElement = document.getElementById('enrollStatus');
                const btnStart = document.getElementById('btnEnrollStart');
                
                for (let i = 0; i < instructions.length; i++) {
                    if(statusElement) {
                        statusElement.innerHTML = `Sary ${i + 1}/${instructions.length}: <strong>${instructions[i]}</strong><br><small>Tsindrio ny bokotra rehefa vonona</small>`;
                    }
                    
                    // Miandry ny admin hanindry ny bokotra "Manaraka" na "Haka sary"
                    if (btnStart) {
                        btnStart.disabled = false;
                        btnStart.style.opacity = '1';
                        btnStart.innerHTML = i === 0 ? '📸 Haka sary voalohany' : `📸 Haka sary faha ${i + 1}`;
                    }

                    await new Promise(resolve => {
                        const originalOnClick = btnStart.onclick;
                        btnStart.onclick = () => {
                            btnStart.disabled = true;
                            btnStart.style.opacity = '0.5';
                            btnStart.innerHTML = '⏳ Miandry...';
                            resolve();
                        };
                    });

                    // Maka ny sary
                    const detectionWithData = await faceapi.detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                        .withFaceLandmarks()
                        .withFaceDescriptor();

                    if (!detectionWithData) {
                        // Raha tsy nahita tarehy dia averina amin'io sary io ihany
                        i--; 
                        if(statusElement) statusElement.innerHTML = `❌ Tsy nahita tarehy. Avereno azafady.<br>Sary ${i + 2}/${instructions.length}: <strong>${instructions[i+1]}</strong>`;
                        await new Promise(r => setTimeout(r, 2000));
                        continue;
                    }
                    
                    descriptors.push(Array.from(detectionWithData.descriptor));
                    console.log(`📸 Descriptor ${descriptors.length}/${instructions.length} voaray.`);
                    
                    if(statusElement) {
                        statusElement.innerHTML = `✅ Sary faha ${i + 1} voaray!`;
                        statusElement.style.background = '#d4edda';
                    }
                    await new Promise(r => setTimeout(r, 1000));
                    if(statusElement) statusElement.style.background = '#f0f0f0';
                }
                
                if (descriptors.length < instructions.length) {
                    throw new Error('Tsy feno ny sary voaray. Avereno azafady.');
                }
                
                console.log(`✅ Enrollment OK: ${descriptors.length} descriptors voaray.`);
                
                return {
                    ...employeData,
                    face_descriptors: descriptors,
                    face_enrolled: true,
                    face_enrollment_date: new Date().toISOString()
                };
            },



            
            // =================================================================
            //  RECOGNIZEFACE (VERSION 6 - HAINGANA INDRINDRA)
            // =================================================================
            async recognizeFace(videoElement, employesDatabase) {
                // ===> FANITSIANA LEHIBE: Mampiasa `detectSingleFace` mitambatra indray isika <===
                // Ity no fomba haingana indrindra
                const detection = await faceapi
                    .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (!detection) {
                    return { success: false, message: 'Tsy nahita tarehy mazava' };
                }
                
                const labeledDescriptors = employesDatabase
                    .filter(emp => emp.face_descriptors && emp.face_descriptors.length > 0)
                    .map(emp => {
                        const descriptors = emp.face_descriptors.map(d => new Float32Array(d));
                        return new faceapi.LabeledFaceDescriptors(emp.id, descriptors);
                    });
                
                if (labeledDescriptors.length === 0) {
                    return { success: false, message: 'Tsy misy mpiasa voasoratra anarana' };
                }
                
                // Hamafisina foana ny fepetra mba tsy hisy fahadisoana
                const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5); 
                
                // Miverina amin'ny `findBestMatch` izay haingana kokoa
                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                
                if (bestMatch.label === 'unknown') {
                    return { 
                        success: false, 
                        message: 'Tsy fantatra',
                        distance: bestMatch.distance 
                    };
                }
                
                const employe = employesDatabase.find(e => e.id === bestMatch.label);
                const confidence = 1 - bestMatch.distance;
                
                return {
                    success: true,
                    employe: employe,
                    confidence: confidence,
                    distance: bestMatch.distance
                };
            },



        };

        // ==========================================
        // UI: ENROLLMENT MODAL
        // ==========================================

        async function openEnrollmentModal(employeId) {
            // Utilise directement la variable globale employees
            const employe = employees.find(e => e.id === employeId);

            if (!employe) return;
            
            const loaded = await FaceRecognition.loadModels();
            if (!loaded) return;
            
            const modal = document.createElement('div');
            // ===> FANAMPIANA: Omena ID ilay modal mba ho mora esorina raha misy olana
            modal.id = 'enrollmentModal'; 
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div class="modal-content-facial" style="background: white; padding: 24px; border-radius: 12px; max-width: 500px; width: 95%; max-height: 95vh; overflow-y: auto;">
                <h2 style="margin: 0 0 16px 0; color: #333; font-size: clamp(1.1rem, 4vw, 1.5rem);">
                    📸 Enrollment: ${employe.name} 
                </h2>
                
                <div style="position: relative; width: 100%; max-width: 320px; margin: 0 auto 16px; aspect-ratio: 4/3; background: #000; border-radius: 8px; overflow: hidden;">
                    <video id="enrollVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                    <canvas id="enrollCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                </div>
                
                <div id="enrollStatus" style="padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center; margin-bottom: 16px; font-size: 13px;">
                    📹 Apetraho eo anoloan'ny fakantsary ny tarehy...
                </div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button id="btnEnrollStart" style="flex: 1; min-width: 120px; padding: 12px; background: #6750A4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500;">
                    ▶ Hanomboka
                    </button>
                    <button id="btnEnrollCancel" style="flex: 1; min-width: 120px; padding: 12px; background: #ccc; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 15px;">
                    ✕ Hanakatona
                    </button>
                </div>
                </div>
                <style>
                    @media (max-height: 500px) {
                        .modal-content-facial { padding: 12px !important; }
                        .modal-content-facial h2 { margin-bottom: 8px !important; }
                        .modal-content-facial div[style*="max-width: 320px"] { max-width: 200px !important; margin-bottom: 8px !important; }
                        .modal-content-facial #enrollStatus { margin-bottom: 8px !important; padding: 6px !important; }
                    }
                </style>
            `;
            
            document.body.appendChild(modal);
            
            const video = modal.querySelector('#enrollVideo');
            const canvas = modal.querySelector('#enrollCanvas');
            const status = modal.querySelector('#enrollStatus');
            const btnStart = modal.querySelector('#btnEnrollStart');
            const btnCancel = modal.querySelector('#btnEnrollCancel');
            
            let stream; 
            let animationId;

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 320 },
                        height: { ideal: 240 }
                    }
                });
                video.srcObject = stream;

                // Fampisehoana landmarks amin'ny fotoana tena izy
                video.onplay = () => {
                    const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
                    faceapi.matchDimensions(canvas, displaySize);

                    async function drawLandmarks() {
                        if (video.paused || video.ended) return;
                        
                        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                            .withFaceLandmarks();

                        const ctx = canvas.getContext('2d');
                        
                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        if (detections) {
                            const resizedDetections = faceapi.resizeResults(detections, displaySize);
                            // Sary teboka sy tsipika (Landmarks)
                            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                            
                            // Manampy cadre mavo toy ny amin'ny sary nomen'ny mpampiasa
                            const box = resizedDetections.detection.box;
                            ctx.strokeStyle = '#FFEB3B';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(box.x, box.y, box.width, box.height);
                        }
                    
                        animationId = requestAnimationFrame(drawLandmarks);
                    }
                    drawLandmarks();
                };
                
                btnStart.onclick = async () => {
                    try {
                        status.innerHTML = '⏳ Manangona données... Aza mihetsika! (3 sec)';
                        btnStart.disabled = true;
                        btnStart.style.opacity = '0.5';
                        
                        const enrolledData = await FaceRecognition.enrollFace(video, employe);
                        
                        // Update dans la variable globale
                        const index = employees.findIndex(e => e.id === employeId);
                        if (index > -1) {
                            employees[index] = enrolledData;
                        }
                        await saveData(); // Utilise la fonction de sauvegarde existante

                        
                        status.innerHTML = '✅ Enrollment vita!';
                        status.style.background = '#d4edda';
                        status.style.color = '#155724';
                        
                        if (stream) stream.getTracks().forEach(track => track.stop());
                        if (animationId) cancelAnimationFrame(animationId);
                        
                        setTimeout(() => {
                            const modalToClose = document.getElementById('enrollmentModal');
                            if (modalToClose) modalToClose.remove();
                            
                            alert(`✅ ${employe.name} enrollé!`);
                            
                            // Havaozina ny fampisehoana
                            displayEmployees();
                            if (document.getElementById('face-presence').classList.contains('active')) {
                                displayEnrolledEmployees();
                            }
                        }, 1500);
                        
                    } catch (error) {
                        status.innerHTML = `❌ ${error.message}`;
                        status.style.background = '#f8d7da';
                        status.style.color = '#721c24';
                        btnStart.disabled = false;
                        btnStart.style.opacity = '1';
                    }
                };
                
                btnCancel.onclick = () => {
                    if (stream) stream.getTracks().forEach(track => track.stop());
                    if (animationId) cancelAnimationFrame(animationId);
                    const modalToClose = document.getElementById('enrollmentModal');
                    if (modalToClose) modalToClose.remove();
                };
                
            } catch (error) {
                alert('❌ Erreur camera: ' + error.message);
                const modalToClose = document.getElementById('enrollmentModal');
                if (modalToClose) modalToClose.remove();
            }
        }


        // ==========================================
        // UI: POINTAGE FACIAL
        // ==========================================

        async function openFacePointageModal() {
            const loaded = await FaceRecognition.loadModels();
            if (!loaded) return;
            
            // Utilise directement employees
            const enrolled = employees.filter(e => e.face_descriptors && e.face_descriptors.length > 0);

            
            if (enrolled.length === 0) {
                alert('⚠ Tsy misy employé enrolled! Mba enrollment aloha.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div class="modal-content-facial" style="background: white; padding: 24px; border-radius: 12px; max-width: 500px; width: 95%; max-height: 95vh; overflow-y: auto;">
                    
                    <!-- ================== FANITSIANA ETO ================== -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0; color: #333; font-size: clamp(1.1rem, 4vw, 1.5rem);">
                            🎯 Pointage Reconnaissance Faciale
                        </h2>
                        
                        <!-- Ity ilay bokotra vaovao nampidirina -->
                        <button id="btnSwitchCamera" title="Changer de caméra" style="background: none; border: 1px solid #ccc; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span class="material-icons">cameraswitch</span>
                        </button>
                    </div>
                    <!-- ==================================================== -->

                    <div style="position: relative; width: 100%; max-width: 320px; margin: 0 auto 16px; aspect-ratio: 4/3; background: #000; border-radius: 8px; overflow: hidden;">
                        <video id="pointageVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                    </div>
                    
                    <div id="pointageStatus" style="padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center; margin-bottom: 16px; font-size: 13px;">
                        📹 Prêt pour le pointage...
                    </div>
                    
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button id="btnPointageCapture" style="flex: 1; min-width: 120px; padding: 12px; background: #6750A4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500;">
                        📸 Pointage
                        </button>
                        <button id="btnPointageClose" style="flex: 1; min-width: 120px; padding: 12px; background: #ccc; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 15px;">
                        ✕ Hanakatona
                        </button>
                    </div>
                    
                    <div style="margin-top: 12px; font-size: 12px; color: #666; text-align: center;">
                        ${enrolled.length} employé(s) enrolled
                    </div>
                </div>
                <style>
                    @media (max-height: 500px) {
                        .modal-content-facial { padding: 12px !important; }
                        .modal-content-facial h2 { margin-bottom: 8px !important; }
                        .modal-content-facial div[style*="max-width: 320px"] { max-width: 200px !important; margin-bottom: 8px !important; }
                        .modal-content-facial #pointageStatus { margin-bottom: 8px !important; padding: 6px !important; }
                    }
                </style>
            `;

            
            document.body.appendChild(modal);
            
            const video = modal.querySelector('#pointageVideo');
            const status = modal.querySelector('#pointageStatus');
            const btnCapture = modal.querySelector('#btnPointageCapture');
            const btnClose = modal.querySelector('#btnPointageClose');
            const btnSwitchCamera = modal.querySelector('#btnSwitchCamera');
            
            let stream;
            let currentFacingMode = 'user';
            
            async function startCamera(facingMode) {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                try {
                    const constraints = {
                        video: { 
                            facingMode: { ideal: facingMode },
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    await new Promise(resolve => video.onloadedmetadata = resolve);
                    video.play();
                    currentFacingMode = facingMode;
                } catch (error) {
                    console.error("ERREUR CAMERA:", error); // Mba hahitantsika tsara ny tena karazana erreur
                    
                    // ================== FANAMPIANA ETO ==================
                    // Manome hafatra mazava kokoa ho an'ny mpampiasa
                    let userMessage = "Tsy afaka nampiasa ny fakan-tsary. ";
                    if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                        userMessage += "Nolavinao ny fahazoan-dàlana. Azafady, amboary ao amin'ny paramètres-n'ny navigateur-nao.";
                    } else if (error.name === "NotFoundError" || error.name === "DevicesNotFoundError") {
                        userMessage += "Tsy nahitana fakan-tsary tamin'ity fitaovana ity.";
                    } else if (error.name === "NotReadableError" || error.name === "TrackStartError") {
                        userMessage += "Efa misy fampiharana hafa mampiasa ny fakan-tsary.";
                    } else {
                        userMessage += "Nisy olana tsy nampoizina.";
                    }
                    
                    // Asehoy amin'ny alerte ilay hafatra
                    alert(userMessage);
                    
                    // Akatona ilay modal satria tsy misy azo atao
                    const modalToClose = document.getElementById('facePointageModal'); // Hamarino tsara ny ID-n'ny modal
                    if(modalToClose) modalToClose.remove();
                    // ====================================================
                }
            }


            // Ampifandraisina ilay bokotra
            btnSwitchCamera.onclick = () => {
                const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                startCamera(newFacingMode);
            };

            // Antsoina voalohany
            await startCamera(currentFacingMode);
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                video.srcObject = stream;

                // ⬇️⬇️⬇️ NOUVEAU CODE: Attendre que la vidéo soit prête ⬇️⬇️⬇️
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        console.log('✅ Vidéo prête:', video.videoWidth, 'x', video.videoHeight);
                        resolve();
                    };
                });

                // Petit délai supplémentaire pour stabilisation
                await new Promise(r => setTimeout(r, 500));
                // ⬆️⬆️⬆️ FIN NOUVEAU CODE ⬆️⬆️⬆️

                // ⬇️⬇️⬇️ AJOUTER WARM-UP ⬇️⬇️⬇️
                status.innerHTML = '⏳ Initialisation de la caméra...';

                // Effectuer 2 détections "vides" pour warm-up
                for (let i = 0; i < 2; i++) {
                    try {
                        await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
                            inputSize: 224,
                            scoreThreshold: 0.4
                        }));
                    } catch (e) {
                        // Ignore les erreurs de warm-up
                    }
                    await new Promise(r => setTimeout(r, 300));
                }

                status.innerHTML = '🔹 Prêt pour le pointage...';
                // ⬆️⬆️⬆️ FIN WARM-UP ⬆️⬆️⬆️
            
                // Ity no apetraka ao anatin'ny openFacePointageModal
                btnCapture.onclick = async () => {
                    try {
                        // ===> FANITSIANA: Esorina ilay "Analyse en cours" <===
                        status.innerHTML = '⏳ Maka sary...';
                        btnCapture.disabled = true;
                        btnCapture.style.opacity = '0.5';

                        // Antsoina avy hatrany ilay recognizeFace haingana
                        const result = await FaceRecognition.recognizeFace(video, enrolled);
                        
                        if (result.success) {
                            const emp = result.employe;
                            const confidence = (result.confidence * 100).toFixed(1);
                            
                            status.innerHTML = `✅ <strong>${emp.name}</strong>  
                Confiance: ${confidence}%`;
                            status.style.background = '#d4edda';
                            status.style.color = '#155724';
                            
                            playAuSuivantSound();
                            await processFacialAttendance(emp);
                            
                            // Fiatoana kely alohan'ny hahafahana manindry indray
                            setTimeout(() => {
                                status.innerHTML = '🔹 Prêt pour le suivant...';
                                status.style.background = '#f0f0f0';
                                status.style.color = '#333';
                                btnCapture.disabled = false;
                                btnCapture.style.opacity = '1';
                            }, 2000);
                            
                        } else {
                            status.innerHTML = `❌ ${result.message}`;
                            status.style.background = '#f8d7da';
                            status.style.color = '#721c24';
                            btnCapture.disabled = false;
                            btnCapture.style.opacity = '1';
                        }
                        
                    } catch (error) {
                        status.innerHTML = `❌ Erreur: ${error.message}`;
                        status.style.background = '#f8d7da';
                        status.style.color = '#721c24';
                        btnCapture.disabled = false;
                        btnCapture.style.opacity = '1';
                    }


                };
                
                btnClose.onclick = () => {
                    stream.getTracks().forEach(track => track.stop());
                    document.body.removeChild(modal);
                    
                    // ⬇️⬇️⬇️ HAFINDRA ETO ⬇️⬇️⬇️
                    // Rafraîchir l'affichage si on est dans l'onglet
                    if (document.getElementById('face-presence')?.classList.contains('active')) {
                        displayEnrolledEmployees();
                        displayTodayFaceAttendance();
                    }
                    // ⬆️⬆️⬆️ ETO NO MARINA ⬆️⬆️⬆️
                };

                
            } catch (error) {
                alert('❌ Erreur camera: ' + error.message);
                document.body.removeChild(modal);
            }
            

        }

        // =================================================================
        //  RECONNAISSANCE FACIALE POUR SÉLECTION (AVANCE & PAIE)
        // =================================================================

        /**
         * Manokatra ny fakantsary mba hisafidianana mpiasa amin'ny alalan'ny tarehy.
         * @param {string} purpose - Ny tanjona ('advance' na 'payroll') mba hahafantarana hoe aiza no hametrahana ny valiny.
         */
        async function startFaceScanForSelection(purpose) {
            // 1. Fanamarinana raha efa vonona ny maodely
            const loaded = await FaceRecognition.loadModels();
            if (!loaded) {
                showAlert("Tsy afaka nampiditra ny maodely reconnaissance faciale.", "error");
                return;
            }

            // 2. Fanamarinana raha misy mpiasa efa voasoratra anarana
            const enrolledEmployees = employees.filter(e => e.face_enrolled && e.face_descriptors && e.face_descriptors.length > 0);
            if (enrolledEmployees.length === 0) {
                showAlert("Tsy misy mpiasa voasoratra anarana amin'ny reconnaissance faciale.", 'warning');
                return;
            }

            // 3. Famoronana ny varavarankely (modal) fampisehoana ny fakantsary
            const modal = document.createElement('div');
            modal.id = 'faceScanSelectionModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 10001;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; text-align: center;">
                    <div class="modal-header">
                        <h3><span class="material-icons">face</span> Scanner le visage</h3>
                        <button class="close-btn" onclick="document.getElementById('faceScanSelectionModal').remove();">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div style="position: relative; width: 100%; max-width: 320px; margin: 16px auto; aspect-ratio: 4/3; background: #000; border-radius: 8px; overflow: hidden;">
                        <video id="selectionVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                    </div>
                    <div id="selectionStatus" class="alert alert-info" style="margin-bottom: 16px;">
                        Azafady, apetraho eo anoloan'ny fakantsary ny tarehinao...
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const video = modal.querySelector('#selectionVideo');
            const status = modal.querySelector('#selectionStatus');
            let stream; // Tehirizina eto ny stream mba hahafahana manapaka azy

            // 4. Fandefasana ny fakantsary sy ny fizotry ny "reconnaissance"
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
                });
                video.srcObject = stream;

                // Miandry kely mba ho vonona tsara ny video
                await new Promise(resolve => video.onloadedmetadata = resolve);

                // Manomboka ny fitadiavana tarehy isaky ny 1 segondra
                const intervalId = setInterval(async () => {
                    const result = await FaceRecognition.recognizeFace(video, enrolledEmployees);

                    if (result.success) {
                        clearInterval(intervalId); // Ajanona ny fitadiavana
                        const employee = result.employe;

                        // Fampisehoana ny fahombiazana
                        status.className = 'alert alert-success';
                        status.innerHTML = `✅ Fantatra: <strong>${employee.name}</strong>`;
                        
                        // Alefa ny feo "Tritone" (ilay efa anananao)
                        playSuccessSound();

                        // 5. Fametrahana ny anaran'ilay mpiasa ao amin'ny SELECT mety aminy
                        if (purpose === 'advance') {
                            const select = document.getElementById('advanceEmployee');
                            if (select) select.value = employee.id;
                        } else if (purpose === 'payroll') {
                            const select = document.getElementById('payrollEmployeeSelect');
                            if (select) select.value = employee.id;
                        }

                        // Miandry 1.5 segondra vao manakatona ny modal
                        setTimeout(() => {
                            if (stream) stream.getTracks().forEach(track => track.stop());
                            modal.remove();
                        }, 1500);
                    } else {
                        // Raha tsy mahita na tsy fantatra
                        status.innerHTML = result.message || 'Mitady tarehy...';
                    }
                }, 1000); // Isaky ny 1 segondra

                // Manapaka ny stream rehefa mikatona ny modal
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    clearInterval(intervalId);
                    if (stream) stream.getTracks().forEach(track => track.stop());
                });

            } catch (error) {
                showAlert('Tsy afaka nampiasa ny fakantsary: ' + error.message, 'error');
                if (stream) stream.getTracks().forEach(track => track.stop());
                modal.remove();
            }
        }

        // ==========================================
        // FACE RECOGNITION: AJOUT BOUTONS UI
        // ==========================================

        // Fonction pour ajouter les boutons enrollment après le chargement
        function addEnrollmentButtons() {
            // Trouve tous les items employés
            const employeeItems = document.querySelectorAll('.employee-item');
            
            employeeItems.forEach(item => {
                // Vérifie si le bouton n'existe pas déjà
                if (item.querySelector('.btn-enroll-face')) return;
                
                // Trouve le conteneur d'actions (avec les boutons edit/delete)
                const actionsDiv = item.querySelector('.employee-actions');
                if (!actionsDiv) return;
                
                // Essaie de trouver l'ID de l'employé
                let employeeId = null;
                
                // Méthode 1: depuis onclick de l'item
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr) {
                const match = onclickAttr.match(/['"]([^'"]+)['"]/);
                if (match) employeeId = match[1];
                }
                
                // Méthode 2: depuis le bouton edit
                if (!employeeId) {
                const editBtn = actionsDiv.querySelector('[onclick*="editEmployee"]');
                if (editBtn) {
                    const editMatch = editBtn.getAttribute('onclick').match(/editEmployee\(['"]([^'"]+)['"]\)/);
                    if (editMatch) employeeId = editMatch[1];
                }
                }
                
                if (!employeeId) return;
                
                // Trouve l'employé dans la base
                const employee = employees.find(e => e.id === employeeId);
                if (!employee) return;
                
                // Crée le bouton enrollment
                const btnEnroll = document.createElement('button');
                btnEnroll.className = 'btn-icon btn-enroll-face';
                btnEnroll.title = employee.face_enrolled ? 'Déjà enrolled' : 'Enrollment facial';
                btnEnroll.style.cssText = `
                background: ${employee.face_enrolled ? '#28a745' : '#6750A4'};
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                margin: 0 4px;
                `;
                btnEnroll.innerHTML = `<span class="material-icons">${employee.face_enrolled ? 'face' : 'face_retouching_natural'}</span>`;
                btnEnroll.onclick = (e) => {
                e.stopPropagation();
                openEnrollmentModal(employeeId);
                };
                
                // Ajoute le bouton au début du conteneur
                actionsDiv.insertBefore(btnEnroll, actionsDiv.firstChild);
            });
        }

        // Remplace displayEmployees pour ajouter les boutons après affichage
        if (typeof displayEmployees === 'function') {
            const originalDisplayEmployees = displayEmployees;
            displayEmployees = async function() {
                await originalDisplayEmployees.apply(this, arguments);
                setTimeout(addEnrollmentButtons, 100); // Petit délai pour être sûr que le DOM est prêt
            };
        }

        // Ajoute aussi au chargement initial
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(addEnrollmentButtons, 1000);
        });

        // ==========================================
        // BOUTON POINTAGE FACIAL DANS PRÉSENCE
        // ==========================================

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Cherche la section présence
                const tabs = document.querySelectorAll('button[data-section]');
                let presenceTab = null;
                tabs.forEach(tab => {
                if (tab.textContent.includes('Présence') || tab.getAttribute('data-section') === 'presences') {
                    presenceTab = tab;
                }
                });
                
                if (presenceTab) {
                // Ajoute le bouton pointage facial
                const btnContainer = document.createElement('div');
                btnContainer.style.cssText = 'margin: 16px 0;';
                
                const btnFacePointage = document.createElement('button');
                btnFacePointage.className = 'btn btn-face-pointage';
                btnFacePointage.innerHTML = `
                    <span class="material-icons" style="margin-right: 8px;">face</span>
                    Pointage Facial
                `;
                btnFacePointage.style.cssText = `
                    padding: 12px 24px;
                    background: #6750A4;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 500;
                    display: inline-flex;
                    align-items: center;
                    margin: 8px;
                `;
                btnFacePointage.onclick = openFacePointageModal;
                
                btnContainer.appendChild(btnFacePointage);
                
                // Trouve où insérer (après le titre ou au début de la section)
                const section = document.querySelector('[data-section="presences"]') || 
                                document.getElementById('presences-section') ||
                                document.querySelector('.attendance-section');
                
                if (section) {
                    section.insertBefore(btnContainer, section.firstChild);
                }
                }
            }, 1500);
        });

        // ==========================================
        // AFFICHAGE SECTION POINTAGE FACIAL
        // ==========================================

        function displayEnrolledEmployees() {
            const container = document.getElementById('enrolledEmployeesList');
            const countSpan = document.getElementById('enrolledCount');
            if (!container) return;
            
            const enrolled = employees.filter(e => e.face_enrolled && e.face_descriptors && e.face_descriptors.length > 0);
            
            if (countSpan) countSpan.textContent = enrolled.length;
            
            if (enrolled.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 32px; color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-icons" style="font-size: 64px; opacity: 0.3;">face_retouching_off</span>
                        <p style="margin-top: 16px; font-size: 16px;">Aucun employé enrolled pour le moment.</p>
                        <p style="font-size: 14px; opacity: 0.8;">Allez dans la liste des employés et cliquez sur l'icône 📸</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = enrolled.map(emp => `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 14px;
                    background: var(--md-sys-color-surface);
                    border: 1px solid var(--md-sys-color-outline-variant);
                    border-radius: 12px;
                    margin-bottom: 12px;
                    border-left: 4px solid var(--md-sys-color-success);
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">
                    <div style="display: flex; align-items: center; gap: 14px;">
                        <span class="material-icons" style="font-size: 40px; color: var(--md-sys-color-success);">face</span>
                        <div>
                            <div style="font-weight: 600; font-size: 16px;">${emp.name}</div>
                            <div style="font-size: 13px; color: var(--md-sys-color-on-surface-variant);">${emp.position || 'N/A'}</div>
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
                        <div style="opacity: 0.7;">Enrolled le</div>
                        <div style="font-weight: 500; margin-top: 4px;">${formatDate(emp.face_enrollment_date, false)}</div>
                    </div>
                </div>
            `).join('');
        }

        // =================================================================
        //  DISPLAYTODAYFACEATTENDANCE (VERSION 2 - Mitovy endrika amin'ny Présence QR)
        // =================================================================
        function displayTodayFaceAttendance() {
            const container = document.getElementById('todayFaceAttendance');
            if (!container) return;

            const today = new Date().toISOString().split('T')[0];
            const dayAttendance = attendance[today] || {};

            // 1. Famintinana (Présents, Absents, Total)
            // Isaina fotsiny ireo izay nanao pointage FACIAL
            const facialPresents = Object.values(dayAttendance).filter(att => att && att.method === 'FACIAL').length;
            const totalEmployees = employees.length;
            const summaryHTML = `
                <div style="display: flex; gap: 16px; margin-bottom: 16px; padding: 12px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">
                    <div style="color: var(--md-sys-color-success); font-weight: 500;">
                        <span class="material-icons" style="vertical-align: middle;">check_circle</span>
                        Présents (Facial): ${facialPresents}
                    </div>
                    <div style="color: var(--md-sys-color-on-surface-variant); font-weight: 500;">
                        <span class="material-icons" style="vertical-align: middle;">people</span>
                        Total Employés: ${totalEmployees}
                    </div>
                </div>
            `;

            // 2. Fampisehoana ny lisitry ny mpiasa rehetra
            // Alahatra mba ho eo ambony foana ireo izay nanao pointage facial
            const sortedEmployees = [...employees].sort((a, b) => {
                const aIsFacial = dayAttendance[a.id] && dayAttendance[a.id].method === 'FACIAL';
                const bIsFacial = dayAttendance[b.id] && dayAttendance[b.id].method === 'FACIAL';
                if (aIsFacial && !bIsFacial) return -1;
                if (!aIsFacial && bIsFacial) return 1;
                return a.name.localeCompare(b.name);
            });

            const listHTML = sortedEmployees.map(employee => {
                const presenceData = dayAttendance[employee.id];
                const isFacialPresent = presenceData && presenceData.method === 'FACIAL';

                let statusHTML = `
                    <div class="qr-status absent">
                        <span class="material-icons">cancel</span>
                        <span>Absent</span>
                    </div>
                `;

                if (isFacialPresent) {
                    const arrivalTime = formatDisplayTime(presenceData.arrivee);
                    const departureTime = formatDisplayTime(presenceData.depart);
                    
                    statusHTML = `
                        <div>
                            <div class="qr-status present">
                                <span class="material-icons">check_circle</span>
                                <span>Présent</span>
                            </div>
                            <div style="font-size: 12px; text-align: right; margin-top: 4px;">
                                Arrivée: <strong>${arrivalTime}</strong> | Départ: <strong>${departureTime}</strong>
                                <span style="color: var(--md-sys-color-primary); display: inline-flex; align-items: center; gap: 4px; font-size: 12px; margin-left: 8px; vertical-align: middle;">
                                    <span class="material-icons" style="font-size: 14px;">face</span>
                                    FACIAL
                                </span>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="employee-qr-item">
                        <div class="employee-qr-info">
                            <h4>${employee.name}</h4>
                            <p>${employee.position}</p>
                        </div>
                        <div>
                            ${statusHTML}
                        </div>
                    </div>
                `;
            }).join('');

            // 3. Atambatra ny famintinana sy ny lisitra
            container.innerHTML = summaryHTML + listHTML;
        }


        // Mettre à jour quand on affiche la section
        const _originalShowSection = showSection;
        showSection = function(sectionId, event) {
            _originalShowSection(sectionId, event);
            if (sectionId === 'face-presence') {
                displayEnrolledEmployees();
                displayTodayFaceAttendance();
            }
        };

    
        // --- Synchronisation Logic ---
        async function exportDataAsQR() {
            const data = {
                employees: JSON.parse(localStorage.getItem('employees') || '[]'),
                attendance: JSON.parse(localStorage.getItem('attendance') || '{}')
            };
            const jsonStr = JSON.stringify(data);
            // On utilise un QR Code pour partager les données (limité en taille)
            // Pour les grosses données, on génère un fichier JSON à scanner ou transférer
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rh_sync_data.json';
            a.click();
            showAlert('Data exported as JSON for sync', 'success');
        }

        async function importDataFromSync(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.employees) localStorage.setItem('employees', JSON.stringify(data.employees));
                    if (data.attendance) localStorage.setItem('attendance', JSON.stringify(data.attendance));
                    showAlert('Data synchronized successfully!', 'success');
                    location.reload();
                } catch (err) {
                    showAlert('Sync failed: Invalid file', 'error');
                }
            };
            reader.readAsText(file);
        }
    
        // ==========================================
        // SYNC QR CODE SYSTEM
        // ==========================================
        async function generateSyncQR() {
            try {
                // Préparer les données COMPLÈTES
                const syncData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    employees: employees,
                    attendance: attendance,
                    qrAttendance: qrAttendance,
                    advances: advances,
                    payments: payments,
                    groups: groups || [],
                    settings: {
                        theme: localStorage.getItem('theme') || 'light'
                    }
                };
                
                // Update counts
                document.getElementById('syncEmployeesCount').textContent = employees.length;
                document.getElementById('syncAttendanceCount').textContent = qrAttendance.length;
                document.getElementById('syncAdvancesCount').textContent = advances.length;
                document.getElementById('syncGroupsCount').textContent = (groups || []).length;
                
                // Compresser les données (base64)
                const jsonString = JSON.stringify(syncData);
                const compressed = btoa(unescape(encodeURIComponent(jsonString)));
                
                console.log('📊 Taille données:', jsonString.length, 'bytes');
                console.log('📦 Taille compressée:', compressed.length, 'bytes');
                
                // ⬇️⬇️⬇️ VÉRIFIER TAILLE QR CODE ⬇️⬇️⬇️
                const maxQRSize = 15000; // Limite sécurisée ~15KB
                
                const canvas = document.getElementById('syncQRCanvas');
                const ctx = canvas.getContext('2d');
                
                if (compressed.length > maxQRSize) {
                    // ❌ TROP GROS → Fallback automatique JSON
                    console.warn('⚠️ Données trop volumineuses pour QR Code!');
                    console.log(`📦 Taille: ${compressed.length} bytes (max: ${maxQRSize} bytes)`);
                    
                    canvas.width = 400;
                    canvas.height = 320;
                    
                    // Afficher message d'information
                    ctx.fillStyle = '#fff3cd';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Icône warning
                    ctx.font = '48px Arial';
                    ctx.fillText('⚠️', canvas.width/2 - 24, 70);
                    
                    // Texte principal
                    ctx.fillStyle = '#856404';
                    ctx.font = 'bold 16px Roboto, Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Base de données volumineuse', canvas.width/2, 120);
                    
                    ctx.font = '14px Roboto, Arial';
                    ctx.fillText(`Taille: ${(compressed.length/1024).toFixed(1)} KB`, canvas.width/2, 150);
                    ctx.fillText('Limite QR Code: 15 KB', canvas.width/2, 175);
                    
                    ctx.font = '12px Roboto, Arial';
                    ctx.fillStyle = '#666';
                    ctx.fillText('Un fichier JSON va être téléchargé', canvas.width/2, 220);
                    ctx.fillText('automatiquement.', canvas.width/2, 240);
                    ctx.fillText('Transférez-le vers l\'autre appareil', canvas.width/2, 265);
                    ctx.fillText('puis importez dans Paramètres.', canvas.width/2, 285);
                    
                    // Alert + Download automatique
                    setTimeout(() => {
                        alert(
                            '⚠️ Base de données trop volumineuse pour QR Code!\n\n' +
                            `📊 Taille actuelle: ${(compressed.length/1024).toFixed(1)} KB\n` +
                            `📦 Limite QR Code: 15 KB\n\n` +
                            '💡 SOLUTION AUTOMATIQUE:\n' +
                            '1. Un fichier JSON va être téléchargé\n' +
                            '2. Transférez-le via USB/Email/Drive\n' +
                            '3. Sur l\'autre appareil: Paramètres → Importer Sauvegarde\n\n' +
                            '✅ Aucune perte de données!'
                        );
                        
                        // Télécharger automatiquement
                        exportData();
                        
                    }, 500);
                    
                    return; // Stop ici
                }
                
                // ✅ TAILLE OK → Générer QR Code
                console.log('✅ Taille OK pour QR Code!');
                
                // Créer QR avec qrcode-generator
                const typeNumber = 0; // Auto-detect
                const errorCorrectionLevel = 'M';
                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(compressed);
                qr.make();
                
                // Paramètres de dessin
                const cellSize = 4;
                const margin = 8;
                const moduleCount = qr.getModuleCount();
                
                canvas.width = (moduleCount + margin * 2) * cellSize;
                canvas.height = (moduleCount + margin * 2) * cellSize;
                
                // Dessiner fond blanc
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Dessiner QR code (violet)
                ctx.fillStyle = '#6750A4';
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(
                                (col + margin) * cellSize,
                                (row + margin) * cellSize,
                                cellSize,
                                cellSize
                            );
                        }
                    }
                }
                
                console.log('✅ QR Code généré avec succès!');
                console.log('📐 Taille:', canvas.width, 'x', canvas.height, 'pixels');
                
            } catch (error) {
                console.error('❌ Erreur:', error);
                alert('Erreur: ' + error.message);
            }
        }

        // Toggle hamburger menu
        function toggleNavMenu() {
            const menu = document.getElementById('navMenu');
            const overlay = document.getElementById('navOverlay');
            const btn = document.getElementById('hamburgerBtn');
            
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
            btn.classList.toggle('active');
        }

        // Navigate to section
        function navigateToSection(sectionId) {
            // Hanakatona ny menu
            toggleNavMenu();
            
            // Hanova ny active item
            document.querySelectorAll('.nav-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Hiantso ny showSection fonction
            showSection(sectionId);
        }


        // Mobile: ahafahana mitsindry ny menu item hamoaka tooltip
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.nav-menu-item').forEach(item => {
                item.addEventListener('touchstart', function(e) {
                    // Toggle show-tooltip class
                    this.classList.toggle('show-tooltip');
                    
                    // Esorina amin'ny hafa
                    document.querySelectorAll('.nav-menu-item').forEach(other => {
                        if (other !== this) {
                            other.classList.remove('show-tooltip');
                        }
                    });
                });
            });
        }

        // === FONCTION DE RECHERCHE INTELLIGENTE POUR QR CODES ===
        function filterQRCodes() {
            const searchTerm = document.getElementById('qrSearchInput').value.toLowerCase().trim();
            const qrCards = document.querySelectorAll('.qr-card');
            const resultsDiv = document.getElementById('qrSearchResults');
            const countSpan = document.getElementById('qrResultCount');
            
            let visibleCount = 0;
            
            qrCards.forEach(card => {
                const name = card.querySelector('h4')?.textContent.toLowerCase() || '';
                const position = card.querySelector('p')?.textContent.toLowerCase() || '';
                const groupBadge = card.querySelector('.group-badge')?.textContent.toLowerCase() || '';
                
                const matches = name.includes(searchTerm) || 
                            position.includes(searchTerm) || 
                            groupBadge.includes(searchTerm);
                
                if (matches) {
                    card.style.display = 'block';
                    card.style.animation = 'fadeIn 0.3s ease';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Afficher le compteur
            if (searchTerm.length > 0) {
                resultsDiv.style.display = 'block';
                if (visibleCount === 0) {
                    countSpan.innerHTML = `<span style="color: var(--md-sys-color-error);">❌ Aucun résultat trouvé pour "${searchTerm}"</span>`;
                } else {
                    countSpan.innerHTML = `✅ <strong>${visibleCount}</strong> résultat${visibleCount > 1 ? 's' : ''} trouvé${visibleCount > 1 ? 's' : ''}`;
                }
            } else {
                resultsDiv.style.display = 'none';
            }
        }

        function clearQRSearch() {
            document.getElementById('qrSearchInput').value = '';
            filterQRCodes();
        }

        // =====================================================
        // === FONCTIONS FILTRE MÉTHODE SCAN ===
        // =====================================================

        // Variable globale
        window.currentMethodFilter = 'all';

        // =====================================================
        // === TOGGLE MENU 
        // =====================================================
        function toggleScanMethodMenu(event) {
            event.stopPropagation();
            
            const menu = document.getElementById('scanMethodMenu');
            const button = event.currentTarget;
            
            if (!menu || !button) return;
            
            if (menu.style.display === 'none') {
                // CALCULATION POSITION
                const rect = button.getBoundingClientRect();
                
                // Position menu eo ambanin'ny button
                menu.style.top = (rect.bottom + 8) + 'px';
                menu.style.right = (window.innerWidth - rect.right) + 'px';
                
                // Hamarino fa tsy hivoaka ny écran
                menu.style.display = 'block';
                
                // Ajustement raha tsy mifanaraka
                setTimeout(() => {
                    const menuRect = menu.getBoundingClientRect();
                    
                    // Raha mivoaka eo ambany
                    if (menuRect.bottom > window.innerHeight) {
                        menu.style.top = (rect.top - menuRect.height - 8) + 'px';
                    }
                    
                    // Raha mivoaka eo ankavanana
                    if (menuRect.left < 0) {
                        menu.style.right = '8px';
                    }
                }, 10);
                
                updateMethodCounts();
            } else {
                menu.style.display = 'none';
            }
        }

        // Close menu si click ailleurs
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('scanMethodMenu');
            if (menu && menu.style.display === 'block') {
                if (!e.target.closest('#scanMethodMenu') && !e.target.closest('button')) {
                    menu.style.display = 'none';
                }
            }
        });


        // Update counts dans le menu
        function updateMethodCounts() {
            const counts = window.attendanceMethodCounts || {qr: 0, manual: 0, facial: 0, total: 0};
            
            const allEl = document.getElementById('allCount');
            const qrEl = document.getElementById('qrCount');
            const manualEl = document.getElementById('manualCount');
            const facialEl = document.getElementById('facialCount');
            
            if (allEl) allEl.textContent = `${counts.total} pointage${counts.total > 1 ? 's' : ''}`;
            if (qrEl) qrEl.textContent = `${counts.qr} scan${counts.qr > 1 ? 's' : ''}`;
            if (manualEl) manualEl.textContent = `${counts.manual} entrée${counts.manual > 1 ? 's' : ''}`;
            if (facialEl) facialEl.textContent = `${counts.facial} reconnaissance${counts.facial > 1 ? 's' : ''}`;
        }

        // Filtrer selon méthode
        function filterScanMethod(method) {
            window.currentMethodFilter = method;
            
            const counts = window.attendanceMethodCounts || {qr: 0, manual: 0, facial: 0, total: 0};
            const countEl = document.getElementById('qrScansToday');
            const iconEl = document.getElementById('scanMethodIcon');
            const labelEl = document.getElementById('scanMethodLabel');
            
            // Update count
            if (countEl) {
                if (method === 'all') {
                    countEl.textContent = counts.total;
                } else if (method === 'qr') {
                    countEl.textContent = counts.qr;
                } else if (method === 'manual') {
                    countEl.textContent = counts.manual;
                } else if (method === 'facial') {
                    countEl.textContent = counts.facial;
                }
            }
            
            // Update icon & label
            if (iconEl && labelEl) {
                if (method === 'all') {
                    iconEl.textContent = 'apps';
                    iconEl.style.color = '#6750A4';
                    labelEl.textContent = 'Tous Pointages';
                } else if (method === 'qr') {
                    iconEl.textContent = 'qr_code_scanner';
                    iconEl.style.color = '#6750A4';
                    labelEl.textContent = 'Scans QR';
                } else if (method === 'manual') {
                    iconEl.textContent = 'edit';
                    iconEl.style.color = '#f59e0b';
                    labelEl.textContent = 'Entrées Manuel';
                } else if (method === 'facial') {
                    iconEl.textContent = 'face';
                    iconEl.style.color = '#0ea5e9';
                    labelEl.textContent = 'Reconnaissance Facial';
                }
            }
            
            // Close menu
            const menu = document.getElementById('scanMethodMenu');
            if (menu) menu.style.display = 'none';
            
            // Animation feedback
            if (countEl) {
                countEl.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    countEl.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // =====================================================
        // === AFFICHER HISTORIQUE CHECKS ===
        // =====================================================

        function displayAttendanceHistory(employeeId, date) {
            if (!attendance[date] || !attendance[date][employeeId]) {
                return '<p style="color: #94a3b8;">Aucun historique</p>';
            }
            
            const record = attendance[date][employeeId];
            const checks = record.checks || [];
            
            if (checks.length === 0) {
                return '<p style="color: #94a3b8;">Aucun historique</p>';
            }
            
            let html = '<div style="margin-top: 12px; padding: 12px; background: rgba(51, 65, 85, 0.3); border-radius: 8px;">';
            html += '<h4 style="margin: 0 0 8px 0; font-size: 0.9em; color: #cbd5e1;">📋 Historique des pointages</h4>';
            
            checks.forEach((check, index) => {
                const icon = check.type === 'arrivee' ? '🟢' : 
                            check.type === 'depart' ? '🔴' : '🔄';
                const label = check.type === 'arrivee' ? 'Arrivée' :
                            check.type === 'depart' ? 'Départ' : 'Mise à jour départ';
                
                html += `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 0.85em;">
                    <span>${icon}</span>
                    <span style="color: #e2e8f0;"><strong>${label}</strong>: ${check.time}</span>
                    ${check.oldTime ? `<span style="color: #94a3b8;">(ancien: ${check.oldTime})</span>` : ''}
                </div>`;
            });
            
            html += '</div>';
            return html;
        }

        // =====================================================
        // === PROCESS FACIAL ATTENDANCE - VERSION MULTIPLE CHECKS ===
        // =====================================================

        async function processFacialAttendance(employee) {
            try {
                const now = new Date();
                
                // ===== FANITSIANA: LOCAL DATE (TSY UTC) =====
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const today = `${year}-${month}-${day}`; // ← LOCAL DATE!
                
                const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);
                
                console.log('========================================');
                console.log('👤 FACIAL - Traitement présence:', employee.name);
                console.log('📅 DATE ACTUELLE:', today); // ← Tokony 2026-01-12
                console.log('Date:', today, '| Heure:', currentTime);
        
                // Initialiser si nécessaire
                if (!attendance[today]) {
                    console.log('🆕 Création nouvelle entrée pour:', today);
                    attendance[today] = {};
                }
                
                const existingAttendance = attendance[today][employee.id];
                console.log('📋 Attendance existante @ ' + today + ':', existingAttendance);
                console.log('========================================');
                
                // =====================================================
                // CAS 1: PREMIÈRE FOIS → ARRIVÉE
                // =====================================================
                if (!existingAttendance) {
                    console.log('✅ CAS 1: Première fois → Arrivée');
                    
                    attendance[today][employee.id] = {
                        arrivee: currentTime,
                        depart: null,
                        method: 'FACIAL',
                        checks: [{
                            type: 'arrivee',
                            time: currentTime,
                            timestamp: now.toISOString()
                        }]
                    };
                    
                    await saveAttendanceData();
                    playSuccessSound();
                    
                    showAlert(
                        `✅ ARRIVÉE ENREGISTRÉE\n${employee.name}\nHeure: ${currentTime}`,
                        'success'
                    );
                    
                    updateStats();
                    runSmartChecks();
                    if (document.getElementById('attendance').classList.contains('active')) {
                        displayAttendance();
                    }
                    
                    return true;
                }
                
                // =====================================================
                // CAS 2: DEUXIÈME FOIS → DÉPART
                // =====================================================
                else if (!existingAttendance.depart) {
                    console.log('✅ CAS 2: Deuxième fois → Départ');
                    
                    attendance[today][employee.id].depart = currentTime;
                    
                    if (!attendance[today][employee.id].checks) {
                        attendance[today][employee.id].checks = [];
                    }
                    attendance[today][employee.id].checks.push({
                        type: 'depart',
                        time: currentTime,
                        timestamp: now.toISOString()
                    });
                    
                    await saveAttendanceData();
                    playSuccessSound();
                    
                    showAlert(
                        `✅ DÉPART ENREGISTRÉ\n${employee.name}\nHeure: ${currentTime}`,
                        'success'
                    );
                    
                    updateStats();
                    runSmartChecks();
                    if (document.getElementById('attendance').classList.contains('active')) {
                        displayAttendance();
                    }
                    
                    return true;
                }
                
                // =====================================================
                // CAS 3: DÉJÀ 2 CHECKS → VÉRIFIER TIMING
                // =====================================================
                else {
                    console.log('========================================');
                    console.log('🔍 CAS 3: Déjà 2 checks détectés');
                    console.log('Arrivée:', existingAttendance.arrivee);
                    console.log('Départ:', existingAttendance.depart);
                    
                    // =====================================================
                    // CAS 3: CALCUL DU TEMPS - VERSION FIXED
                    // =====================================================

                    // Vérification sécurité
                    if (!existingAttendance.depart) {
                        console.error('❌ Erreur: depart est null!');
                        showAlert('❌ Erreur: Départ non enregistré', 'error');
                        return false;
                    }

                    // ===== FANITSIANA: Gestion HH:MM:SS et HH:MM =====
                    let departTime = existingAttendance.depart;

                    // Raha misy secondes (HH:MM:SS) → Esorina ny secondes
                    if (departTime.split(':').length === 3) {
                        departTime = departTime.substring(0, 5); // Mitahiry HH:MM fotsiny
                        console.log('⚙️ Format converti de HH:MM:SS → HH:MM:', departTime);
                    }

                    // Calcul du temps
                    const departureTimeString = `${today}T${departTime}:00`;
                    console.log('🕐 Departure string:', departureTimeString);

                    const lastDeparture = new Date(departureTimeString);

                    if (isNaN(lastDeparture.getTime())) {
                        console.error('❌ Date invalide:', departureTimeString);
                        showAlert('❌ Erreur format heure', 'error');
                        return false;
                    }

                    const diffMs = now - lastDeparture;
                    const minutesSinceDeparture = Math.floor(diffMs / 1000 / 60);

                    console.log('🕐 lastDeparture:', lastDeparture);
                    console.log('🕐 now:', now);
                    console.log('⏱️ Minutes depuis départ:', minutesSinceDeparture);
                    console.log('========================================');

                    
                    // ===== SI >= 30 MINUTES → PROPOSER UPDATE =====
                    if (minutesSinceDeparture >= 30) {
                        console.log('✅ >= 30 min → Proposition update');
                        
                        const heures = Math.floor(minutesSinceDeparture / 60);
                        const minutes = minutesSinceDeparture % 60;
                        let dureeTexte = heures > 0 ? `${heures}h${minutes}min` : `${minutesSinceDeparture} minutes`;
                        
                        const confirmMessage = 
                            `⚠️ POINTAGE MULTIPLE DÉTECTÉ\n\n` +
                            `Employé: ${employee.name}\n\n` +
                            `Pointages existants:\n` +
                            `• Arrivée: ${existingAttendance.arrivee}\n` +
                            `• Départ: ${existingAttendance.depart}\n\n` +
                            `🕐 Il y a ${dureeTexte}\n\n` +
                            `Voulez-vous mettre à jour le départ avec:\n` +
                            `${currentTime} ?`;
                        
                        const userConfirmed = confirm(confirmMessage);
                        console.log('💬 User réponse:', userConfirmed);
                        
                        if (userConfirmed) {
                            // ✅ UPDATE CONFIRMÉ
                            console.log('✅ Mise à jour confirmée');
                            
                            const oldDepart = attendance[today][employee.id].depart;
                            attendance[today][employee.id].depart = currentTime;
                            
                            if (!attendance[today][employee.id].checks) {
                                attendance[today][employee.id].checks = [];
                            }
                            attendance[today][employee.id].checks.push({
                                type: 'depart_update',
                                time: currentTime,
                                oldTime: oldDepart,
                                timestamp: now.toISOString()
                            });
                            
                            await saveAttendanceData();
                            playSuccessSound();
                            
                            showAlert(
                                `✅ DÉPART MIS À JOUR\n${employee.name}\nAncien: ${oldDepart}\nNouveau: ${currentTime}`,
                                'success'
                            );
                            
                            updateStats();
                            runSmartChecks();
                            if (document.getElementById('attendance').classList.contains('active')) {
                                displayAttendance();
                            }
                            
                            return true;
                            
                        } else {
                            // ❌ ANNULÉ
                            console.log('❌ Annulé par user');
                            
                            showAlert(
                                `⚠️ ANNULÉ\n${employee.name}\nDépart maintenu: ${existingAttendance.depart}`,
                                'warning'
                            );
                            
                            return false;
                        }
                    }
                    
                    // ===== SI < 30 MINUTES → REFUSER AVEC MODAL ROUGE =====
                    else {
                        console.log('❌ < 30 min → Refusé');
                        
                        // ===== PLAY ERROR SOUND efateo.mp3 =====
                        playErrorSound();
                        
                        // ===== AFFICHER MODAL ROUGE CUSTOM =====
                        const errorModal = document.createElement('div');
                        errorModal.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.85);
                            z-index: 99999;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            padding: 20px;
                            animation: fadeIn 0.3s ease;
                        `;
                        
                        errorModal.innerHTML = `
                            <style>
                                @keyframes fadeIn {
                                    from { opacity: 0; }
                                    to { opacity: 1; }
                                }
                                @keyframes shake {
                                    0%, 100% { transform: translateX(0); }
                                    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                                    20%, 40%, 60%, 80% { transform: translateX(10px); }
                                }
                                .error-modal-content {
                                    animation: shake 0.5s ease;
                                }
                            </style>
                            <div class="error-modal-content" style="
                                background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                                border: 3px solid #fca5a5;
                                padding: 32px;
                                border-radius: 20px;
                                max-width: 450px;
                                width: 90%;
                                text-align: center;
                                box-shadow: 0 20px 60px rgba(220, 38, 38, 0.6),
                                            0 0 0 1px rgba(255, 255, 255, 0.1) inset;
                            ">
                                <!-- Icône warning animée -->
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    margin: 0 auto 20px;
                                    background: rgba(254, 202, 202, 0.2);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    animation: pulse 2s infinite;
                                ">
                                    <span class="material-icons" style="
                                        font-size: 48px;
                                        color: #fef2f2;
                                    ">error</span>
                                </div>
                                
                                <style>
                                    @keyframes pulse {
                                        0%, 100% { transform: scale(1); opacity: 1; }
                                        50% { transform: scale(1.1); opacity: 0.8; }
                                    }
                                </style>
                                
                                <!-- Titre -->
                                <h2 style="
                                    color: #fef2f2;
                                    font-size: 1.5rem;
                                    font-weight: 800;
                                    margin: 0 0 16px 0;
                                    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                                ">⚠️ POINTAGE TROP RAPPROCHÉ</h2>
                                
                                <!-- Employé -->
                                <div style="
                                    background: rgba(254, 202, 202, 0.15);
                                    padding: 16px;
                                    border-radius: 12px;
                                    margin-bottom: 20px;
                                    border: 1px solid rgba(254, 202, 202, 0.3);
                                ">
                                    <div style="
                                        color: #fef2f2;
                                        font-size: 1.3rem;
                                        font-weight: 700;
                                        margin-bottom: 12px;
                                    ">${employee.name}</div>
                                    
                                    <div style="
                                        color: #fecaca;
                                        font-size: 0.95rem;
                                        line-height: 1.8;
                                    ">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Arrivée:</span>
                                            <strong style="color: #fef2f2;">${existingAttendance.arrivee}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Départ:</span>
                                            <strong style="color: #fef2f2;">${existingAttendance.depart}</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Message timing -->
                                <div style="
                                    background: rgba(153, 27, 27, 0.4);
                                    padding: 16px;
                                    border-radius: 12px;
                                    border-left: 4px solid #fca5a5;
                                    margin-bottom: 24px;
                                ">
                                    <div style="
                                        color: #fef2f2;
                                        font-size: 1.1rem;
                                        font-weight: 700;
                                        margin-bottom: 8px;
                                    ">
                                        ⏱️ Seulement ${minutesSinceDeparture} minute${minutesSinceDeparture > 1 ? 's' : ''}
                                    </div>
                                    <div style="
                                        color: #fecaca;
                                        font-size: 0.9rem;
                                    ">
                                        Minimum requis: <strong style="color: #fef2f2;">30 minutes</strong>
                                    </div>
                                </div>
                                
                                <!-- Bouton fermer -->
                                <button onclick="this.closest('[style*=fixed]').remove();" style="
                                    background: rgba(254, 202, 202, 0.2);
                                    color: #fef2f2;
                                    border: 2px solid #fca5a5;
                                    padding: 14px 32px;
                                    border-radius: 12px;
                                    font-size: 1rem;
                                    font-weight: 700;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    width: 100%;
                                " onmouseover="this.style.background='rgba(254, 202, 202, 0.3)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='rgba(254, 202, 202, 0.2)'; this.style.transform='scale(1)';">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">close</span>
                                    Fermer
                                </button>
                            </div>
                        `;
                        
                        document.body.appendChild(errorModal);
                        
                        // Auto-fermer après 5 secondes
                        setTimeout(() => {
                            if (errorModal.parentNode) {
                                errorModal.remove();
                            }
                        }, 5000);
                        
                        return false;
                    }

                }
                
            } catch (error) {
                console.error('❌ Erreur traitement facial:', error);
                showAlert(`❌ Erreur: ${error.message}`, 'error');
                return false;
            }
        }

    </script>
</body>
</html>
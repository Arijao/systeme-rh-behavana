<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Gestion RH - QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- TRANOMBOKY VAOVAO SY TOKANA HO AN'NY QR CODE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-success: #4CAF50;
            --md-sys-color-warning: #FF9800;
            
            /* ================== VARIABLES VAOVAO HO AN'NY SIDEBAR ================== */
            --sidebar-width-open: 240px;
            --sidebar-width-closed: 78px;
            --header-height: 70px;
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface );
            color: var(--md-sys-color-on-surface);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
            min-height: 100vh;
        }
        
        /* ======================================================================= */
        /* ================== STYLE VAOVAO HO AN'NY SIDEBAR SY LAYOUT ================== */
        /* ======================================================================= */

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--sidebar-width-closed);
            background-color: var(--md-sys-color-surface-variant);
            padding: 6px 14px;
            z-index: 99;
            transition: all 0.5s ease;
            border-right: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            width: var(--sidebar-width-open);
        }

        .sidebar .logo-details {
            height: 60px;
            display: flex;
            align-items: center;
            position: relative;
            padding-left: 4px;
        }

        .sidebar .logo-details .icon {
            opacity: 0;
            transition: all 0.5s ease;
            font-size: 28px;
            color: var(--md-sys-color-primary);
        }

        .sidebar .logo-details .logo_name {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 20px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.5s ease;
            white-space: nowrap;
        }

        .sidebar.open .logo-details .icon,
        .sidebar.open .logo-details .logo_name {
            opacity: 1;
        }

        .sidebar #sidebar-toggle {
            position: absolute;
            top: 50%;
            right: -16px;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            text-align: center;
            line-height: 32px;
            border-radius: 50%;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.5s ease;
            border: 2px solid var(--md-sys-color-surface);
            z-index: 100;
        }
        
        .sidebar.open #sidebar-toggle {
            transform: translateY(-50%) rotate(180deg);
        }

        .sidebar .nav-list {
            margin-top: 20px;
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px; /* Ho an'ny scrollbar */
        }
        
        .sidebar .nav-list::-webkit-scrollbar {
            width: 5px;
        }
        .sidebar .nav-list::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar .nav-list::-webkit-scrollbar-thumb {
            background: var(--md-sys-color-outline);
            border-radius: 5px;
        }


        .sidebar li {
            position: relative;
            margin: 0;
            list-style: none;
        }

        .sidebar li .tooltip {
            position: absolute;
            top: -20px;
            left: calc(100% + 15px);
            z-index: 3;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 400;
            opacity: 0;
            white-space: nowrap;
            pointer-events: none;
            transition: 0s;
        }

        .sidebar li:hover .tooltip {
            opacity: 1;
            pointer-events: auto;
            transition: all 0.4s ease;
            top: 50%;
            transform: translateY(-50%);
        }

        .sidebar.open li .tooltip {
            display: none;
        }

        .sidebar li a {
            display: flex;
            height: 50px;
            width: 100%;
            border-radius: 12px;
            align-items: center;
            text-decoration: none;
            transition: all 0.4s ease;
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
        }

        .sidebar li a:hover {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .sidebar li a.active {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .sidebar li a .material-icons {
            height: 50px;
            min-width: 50px;
            font-size: 24px;
            text-align: center;
            line-height: 50px;
        }

        .sidebar .links_name {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: 0.4s;
        }

        .sidebar.open .links_name {
            opacity: 1;
            pointer-events: auto;
        }

        .main-content {
            position: relative;
            background: var(--md-sys-color-surface);
            min-height: 100vh;
            top: 0;
            left: var(--sidebar-width-closed);
            width: calc(100% - var(--sidebar-width-closed));
            transition: all 0.5s ease;
            padding: 16px;
        }
        
        .sidebar.open ~ .main-content {
            left: var(--sidebar-width-open);
            width: calc(100% - var(--sidebar-width-open));
        }
        
        /* Responsive Design ho an'ny Sidebar */
        @media (max-width: 768px) {
            .sidebar {
                left: calc(-1 * var(--sidebar-width-open)); /* Afenina tanteraka */
                width: var(--sidebar-width-open); /* Sakan'ny misokatra foana rehefa miseho */
            }
            .sidebar.open {
                left: 0;
            }
            .sidebar #sidebar-toggle {
                display: none; 
            }
            .main-content {
                width: 100%;
                left: 0;
            }
            
            /* Overlay ho an'ny finday */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.4);
                z-index: 98;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.5s ease;
            }
            body.sidebar-open .sidebar-overlay {
                opacity: 1;
                pointer-events: auto;
            }
        }

        /* ======================================================================= */
        /* ================== FANITSIANA NY STYLE EFA NISY ================== */
        /* ======================================================================= */

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0; /* Esorina ny padding eto fa efa ao amin'ny main-content */
        }

        .header {
            background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-primary-container));
            color: var(--md-sys-color-on-primary);
            padding: 16px 24px;
            border-radius: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* Bokotra vaovao ho an'ny sidebar amin'ny finday */
        #mobile-sidebar-toggle {
            display: none; /* Afenina amin'ny desktop */
            background: none;
            border: none;
            color: var(--md-sys-color-on-primary);
            cursor: pointer;
            padding: 8px;
        }
        
        @media (max-width: 768px) {
            #mobile-sidebar-toggle {
                display: block;
            }
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            flex-grow: 1; /* Mba haka ny toerana sisa */
        }

        .header p {
           display: none; /* Azo avela raha tiana, fa manamaivana ny header */
        }
        
        .header .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .theme-toggle, .settings-btn {
            position: static; /* Esorina ny position absolute */
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--md-sys-color-on-primary);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover, .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Esorina ny nav-tabs taloha */
        .nav-tabs {
            display: none;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ny sisa amin'ny CSS dia tsy misy fiovana lehibe */
        /* ... (CSS teo aloha manomboka eto) ... */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--md-sys-color-surface-variant);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-icon {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-content h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }

        .stat-content p {
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        .card {
            background: var(--md-sys-color-surface-variant);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--md-sys-color-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 8px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.12);
        }

        .btn {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .btn-danger {
            background: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .btn-success {
            background: var(--md-sys-color-success);
        }

        .btn-warning {
            background: var(--md-sys-color-warning);
        }


        .employee-list {
            display: grid;
            gap: 12px;
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-on-surface-variant);
            font-size: 20px;
            z-index: 1;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 48px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 24px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.12);
        }

        .employee-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-top: 8px;
        }

        .employee-status.present {
            color: var(--md-sys-color-success);
        }

        .employee-status.absent {
            color: var(--md-sys-color-error);
        }

        .employee-status.qr-present {
            color: var(--md-sys-color-primary);
        }


        .employee-item {
            background: var(--md-sys-color-surface);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .employee-item:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .employee-info h4 {
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }

        .employee-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .employee-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            transform: scale(1.1);
        }

        .btn-icon:active {
            transform: scale(0.95); /* Ataovy kely kokoa rehefa tsindriana */
            background: var(--md-sys-color-outline-variant); /* Loko hafa kely */
        }


        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--md-sys-color-surface);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .attendance-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--md-sys-color-error);
        }

        .status-indicator.present {
            background: var(--md-sys-color-success);
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--md-sys-color-primary);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
            position: relative;
        }

        @media (max-width: 600px) {
            .modal-content {
                padding: 16px;
                width: 95%;
                max-height: 95vh;
            }
            
            .modal-header h3 {
                font-size: 1.2rem;
            }
        }

        @media (max-height: 500px) {
            .modal.active {
                align-items: center;
                padding: 5px;
            }
            .modal-content {
                max-height: 98vh;
                padding: 12px;
                width: 98%;
                max-width: 600px;
            }
            .qr-modal-body {
                padding: 4px 0 !important;
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                align-items: center;
                justify-content: center;
                gap: 12px;
                text-align: left !important;
            }
            .qr-video-container {
                max-width: 160px !important;
                margin: 0 !important;
                flex-shrink: 0;
            }
            #qrScannerInstruction {
                margin-bottom: 0 !important;
                flex: 1;
                font-size: 0.85rem !important;
            }
            .modal-header {
                margin-bottom: 4px;
                padding-bottom: 4px;
            }
            .modal-header h3 {
                font-size: 1rem !important;
            }
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .modal-header h3 {
            color: var(--md-sys-color-primary);
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            padding: 4px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--md-sys-color-success);
            border: 1px solid var(--md-sys-color-success);
        }

                .alert-error {
            background: rgba(179, 38, 30, 0.1);
            color: var(--md-sys-color-error);
            border: 1px solid var(--md-sys-color-error);
        }

        .alert-warning {
            background: rgba(255, 152, 0, 0.1);
            color: #FFA000;
            border: 1px solid var(--md-sys-color-warning);
            border-left: 5px solid var(--md-sys-color-warning);
        }

        .alert-info {
            background: rgba(103, 80, 164, 0.08);
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-primary-container);
            border-left: 5px solid var(--md-sys-color-primary);
        }

        .qr-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .qr-card {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .qr-code-canvas {
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 100%;
        }

        .qr-code-canvas img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .qr-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }

        @media (max-height: 500px) {
            .video-container {
                max-width: 280px;
            }
        }

        #qrVideo {
            width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid var(--md-sys-color-primary);
            border-radius: 12px;
            background: rgba(103, 80, 164, 0.1);
            pointer-events: none;
        }

        .scan-overlay::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--md-sys-color-primary);
            border-radius: 12px;
            animation: scanPulse 2s ease-in-out infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .scan-result {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .scan-result.success {
            background: var(--md-sys-color-success);
            color: white;
        }

        .scan-result.error {
            background: var(--md-sys-color-error);
            color: white;
        }

        .qr-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .db-status {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .db-status.connected {
            background: rgba(76, 175, 80, 0.1);
            color: var(--md-sys-color-success);
            border: 1px solid var(--md-sys-color-success);
        }

        .db-status.error {
            background: rgba(179, 38, 30, 0.1);
            color: var(--md-sys-color-error);
            border: 1px solid var(--md-sys-color-error);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--md-sys-color-surface);
            box-shadow: -4px 0 16px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            z-index: 3000;
            padding: 24px;
            overflow-y: auto;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2999;
            display: none;
        }

        .settings-overlay.active {
            display: block;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h3 {
            color: var(--md-sys-color-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .qr-scan-section {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .employee-qr-item {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .employee-qr-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .employee-qr-info h4 {
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }

        .employee-qr-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .qr-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .qr-status.present {
            color: var(--md-sys-color-success);
        }

        .qr-status.absent {
            color: var(--md-sys-color-error);
        }

        .payroll-item {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .payroll-item.paid {
            border-left-color: var(--md-sys-color-success);
        }

        .payroll-item.paid .amount {
            color: var(--md-sys-color-success);
        }

        .payroll-item.paid .material-icons {
            color: var(--md-sys-color-success);
        }

        .payroll-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        #advancesList {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .advance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--md-sys-color-surface);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .advance-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid var(--md-sys-color-primary);
            padding-left: 13px;
        }

        .advance-item .advance-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .advance-item .advance-info h4 {
            color: var(--md-sys-color-primary);
            margin: 0;
            font-size: 1.1rem;
        }

        .advance-item .advance-info p {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
            margin: 0;
        }

        .advance-item .amount-actions {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .advance-item .amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--md-sys-color-error);
        }

        
        #editAdvanceEmployeeName {
            padding: 12px 16px;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 8px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        .pagination-controls button {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        .filter-controls {
            display: flex;
            gap: 24px;
            align-items: flex-end;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-controls .search-group {
            flex-grow: 1;
        }

        .filter-controls .items-per-page-group {
            flex-shrink: 0;
            min-width: 150px;
        }

        .search-container {
            margin-bottom: 0; 
        }

        .attendance-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid var(--md-sys-color-success);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--md-sys-color-success);
            vertical-align: middle;
        }

        .attendance-badge .material-icons {
            font-size: 16px;
        }

        .attendance-badge.no-attendance {
            background: rgba(211, 47, 47, 0.1);
            border-color: var(--md-sys-color-error);
            color: var(--md-sys-color-error);
        }

    
        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .container { padding: 8px; }
            .card { padding: 16px; }
            
            .video-container {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
            #qrVideo {
                width: 100% !important;
                height: auto !important;
            }
        }
    
    </style>
</head>
<body>
    <!-- ======================================================================= -->
    <!-- ================== RAFITRA VAOVAO MISY SIDEBAR ================== -->
    <!-- ======================================================================= -->

    <nav class="sidebar">
        <div class="logo-details">
            <span class="material-icons icon">business</span>
            <div class="logo_name">BEHAVANA</div>
            <span class="material-icons" id="sidebar-toggle">menu</span>
        </div>
        <ul class="nav-list">
            <li>
                <a href="#" class="active" onclick="showSection('dashboard', event)">
                    <span class="material-icons">dashboard</span>
                    <span class="links_name">Tableau de Bord</span>
                </a>
                <span class="tooltip">Tableau de Bord</span>
            </li>
            <li>
                <a href="#" onclick="showSection('employees', event)">
                    <span class="material-icons">people</span>
                    <span class="links_name">Employés</span>
                </a>
                <span class="tooltip">Employés</span>
            </li>
            <li>
                <a href="#" onclick="showSection('groups', event)">
                    <span class="material-icons">groups</span>
                    <span class="links_name">Groupes</span>
                </a>
                <span class="tooltip">Groupes</span>
            </li>
            <li>
                <a href="#" onclick="showSection('employee-stats', event)">
                    <span class="material-icons">person_search</span>
                    <span class="links_name">Statut Employé</span>
                </a>
                <span class="tooltip">Statut Employé</span>
            </li>
            <li>
                <a href="#" onclick="showSection('attendance', event)">
                    <span class="material-icons">schedule</span>
                    <span class="links_name">Présence</span>
                </a>
                <span class="tooltip">Présence</span>
            </li>
            <li>
                <a href="#" onclick="showSection('qr-presence', event)">
                    <span class="material-icons">qr_code</span>
                    <span class="links_name">Présence QR</span>
                </a>
                <span class="tooltip">Présence QR</span>
            </li>
            <li>
                <a href="#" onclick="showSection('face-presence', event)">
                    <span class="material-icons">face</span>
                    <span class="links_name">Pointage Facial</span>
                </a>
                <span class="tooltip">Pointage Facial</span>
            </li>
            <li>
                <a href="#" onclick="showSection('qr-codes', event)">
                    <span class="material-icons">qr_code_2</span>
                    <span class="links_name">Codes QR</span>
                </a>
                <span class="tooltip">Codes QR</span>
            </li>
            <li>
                <a href="#" onclick="showSection('advances', event)">
                    <span class="material-icons">savings</span>
                    <span class="links_name">Avances</span>
                </a>
                <span class="tooltip">Avances</span>
            </li>
            <li>
                <a href="#" onclick="showSection('payroll', event)">
                    <span class="material-icons">payments</span>
                    <span class="links_name">Paie</span>
                </a>
                <span class="tooltip">Paie</span>
            </li>
            <li>
                <a href="#" onclick="showSection('stc', event)">
                    <span class="material-icons">exit_to_app</span>
                    <span class="links_name">Solde Tout Compte</span>
                </a>
                <span class="tooltip">Solde Tout Compte</span>
            </li>
            <li>
                <a href="#" onclick="showSection('payments', event)">
                    <span class="material-icons">history</span>
                    <span class="links_name">Paiements</span>
                </a>
                <span class="tooltip">Paiements</span>
            </li>
            <li>
                <a href="#" onclick="showSection('reports', event)">
                    <span class="material-icons">analytics</span>
                    <span class="links_name">Rapports</span>
                </a>
                <span class="tooltip">Rapports</span>
            </li>
            <li>
                <a href="#" onclick="showSection('estimation', event)">
                    <span class="material-icons">request_quote</span>
                    <span class="links_name">Estimation</span>
                </a>
                <span class="tooltip">Estimation</span>
            </li>
        </ul>
    </nav>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <section class="main-content">
        <div class="container">
            <div class="header">
                <span class="material-icons" id="mobile-sidebar-toggle">menu</span>
                <h1>Système RH BEHAVANA</h1>
                <div class="header-actions">
                    <button class="settings-btn" onclick="toggleSettings()">
                        <span class="material-icons">settings</span>
                    </button>
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <span class="material-icons" id="theme-icon">dark_mode</span>
                    </button>
                </div>
            </div>

            <!-- Status de la base de données -->
            <div id="dbStatus" class="db-status">
                <span class="material-icons">database</span>
                <span id="dbStatusText">Initialisation de la base de données...</span>
            </div>

            <div id="notificationsContainer" style="margin-bottom: 16px; display: flex; flex-direction: column; gap: 8px;">
                <!-- Ho fenoina amin'ny alalan'ny JavaScript ity fizarana ity -->
            </div>

            <!-- Eto no manomboka ny fizarana (sections) rehetra -->
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-icons">people</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalEmployees">0</h3>
                            <p>Total Employés</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: var(--md-sys-color-secondary);">
                            <span class="material-icons">fact_check</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="checkedInToday">0</h3>
                            <p>Employés Ayant Pointé</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-icons">check_circle</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="presentToday">0</h3>
                            <p>Journées Complètes (>= 4h)</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-icons">qr_code</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="qrScansToday">0</h3>
                            <p>Scans QR Aujourd'hui</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-icons">payments</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalSalaries">0 Ar</h3>
                            <p>Salaires ce Mois</p>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 24px;">
                    <h2 style="margin-bottom: 24px;"><span class="material-icons">analytics</span>Aperçu Visuel</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px;">
                        
                        <div>
                            <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">Taux de Présence (7 derniers jours)</h3>
                            <div style="position: relative; height:300px;">
                                <canvas id="weeklyAttendanceChart"></canvas>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">Répartition des Employés par Groupe</h3>
                            <div style="position: relative; height:300px;">
                                <canvas id="groupDistributionChart"></canvas>
                            </div>
                        </div>

                        <div>
                            <h3 style="font-size: 1.1em; font-weight: 500; text-align: center; margin-bottom: 16px;">Répartition par Genre</h3>
                            <div style="position: relative; height:280px;">
                                <canvas id="genderDistributionChart"></canvas>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Employees Section -->
            <div id="employees" class="section">
                <div class="card">
                    <h2><span class="material-icons">people</span>Liste des Employés</h2>
                    <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
                        <button class="btn" onclick="openAddEmployeeModal()">
                            <span class="material-icons">person_add</span>
                            Ajouter un Nouvel Employé
                        </button>
                    </div>
                    <div class="form-group" style="max-width: 300px; margin-bottom: 16px;">
                        <label for="employeeGroupFilter">Filtrer par Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="employeeGroupFilter" onchange="displayEmployees()">
                                <option value="all">Tous les Groupes</option>
                                <option value="none">Sans Groupe</option>
                            </select>
                        </div>
                    </div>

                    <div class="search-container">
                        <span class="material-icons search-icon">search</span>
                        <input type="text" class="search-input" id="employeeSearch" placeholder="Rechercher un employé...">
                    </div>
                    <div class="form-group" style="max-width: 200px; margin-top: 16px;">
                        <label for="employeeItemsPerPageSelect">Eléments par page</label>
                        <select id="employeeItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('employee', this.value)">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>

                    <div class="employee-list" id="employeeList"></div>
                    <div class="pagination-controls" id="employeePagination">
                    </div>

                </div>
            </div>

            <!-- Groups Section -->
            <div id="groups" class="section">
                <div class="card">
                    <h2><span class="material-icons">groups</span>Gestion des Groupes d'Employés</h2>
                    <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                        Créez et gérez les équipes ou départements de votre organisation.
                    </p>

                    <form id="groupForm" style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="groupName">Nom du Groupe</label>
                                <input type="text" id="groupName" class="form-control" placeholder="Ex: Équipe Technique, Vente, Administration" required>
                            </div>
                            <div class="form-group">
                                <label for="groupDescription">Description (Optionnel)</label>
                                <input type="text" id="groupDescription" class="form-control" placeholder="Courte description du rôle du groupe">
                            </div>
                        </div>
                        <input type="hidden" id="groupId">
                        <button type="submit" class="btn">
                            <span class="material-icons">add</span>
                            <span id="groupFormBtnText">Ajouter le Groupe</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelEditGroupBtn" style="display: none;" onclick="cancelGroupEdit()">
                            <span class="material-icons">cancel</span>
                            Annuler
                        </button>
                    </form>

                    <h3>Liste des Groupes</h3>
                    <div id="groupList" class="employee-list">
                    </div>
                </div>
            </div>

            <!-- Statut Employé (Smart Search) Section -->
            <div id="employee-stats" class="section">
                <div class="card">
                    <h2><span class="material-icons">person_search</span>Recherche Intelligente de Statut</h2>
                    <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                        Recherchez un employé par son nom pour voir son statut en temps réel.
                    </p>

                    <div class="form-row" style="align-items: flex-end;">
                        <div class="form-group">
                            <label for="smartSearchInput">Nom de l'employé</label>
                            <div class="search-container" style="margin-bottom: 0;">
                                <span class="material-icons search-icon">search</span>
                                <input type="text" class="search-input" id="smartSearchInput" placeholder="Commencez à taper un nom...">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="statsMonth">Mois</label>
                            <input type="month" class="form-control" id="statsMonth">
                        </div>
                    </div>

                    <div id="smartSearchResults" style="margin-top: 16px;"></div>
                    
                    <div id="employeeStatusResults" style="margin-top: 24px;"></div>
                </div>
            </div>

            <!-- SECTION: POINTAGE FACIAL -->
            <div id="face-presence" class="section">
                <div class="card">
                    <h2>
                        <span class="material-icons">face</span>
                        Pointage par Reconnaissance Faciale
                    </h2>
                    <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                        Système de pointage automatique par reconnaissance faciale avec détection de vivacité.
                    </p>

                    <div style="margin-bottom: 24px; padding: 16px; background: rgba(103, 80, 164, 0.08); border-radius: 12px; border-left: 4px solid var(--md-sys-color-primary);">
                        <h3 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons" style="color: var(--md-sys-color-primary);">info</span>
                            Comment ça marche?
                        </h3>
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Enrollment</strong>: Chaque employé doit d'abord enregistrer son visage (bouton 📸 dans la liste employés)</li>
                            <li><strong>Pointage</strong>: Cliquez sur le bouton ci-dessous et regardez la caméra</li>
                            <li><strong>Reconnaissance</strong>: Le système identifie automatiquement l'employé</li>
                            <li><strong>Sécurité</strong>: La détection de vivacité empêche l'utilisation de photos</li>
                        </ol>
                    </div>

                    <div style="text-align: center; margin-bottom: 32px;">
                        <button 
                            onclick="openFacePointageModal()" 
                            style="
                                padding: 20px 40px;
                                background: linear-gradient(135deg, #6750A4 0%, #7C4DFF 100%);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 18px;
                                font-weight: 600;
                                display: inline-flex;
                                align-items: center;
                                gap: 12px;
                                box-shadow: 0 4px 12px rgba(103, 80, 164, 0.3);
                                transition: all 0.3s ease;
                            "
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(103, 80, 164, 0.4)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(103, 80, 164, 0.3)';"
                        >
                            <span class="material-icons" style="font-size: 32px;">face_retouching_natural</span>
                            <span>Démarrer le Pointage Facial</span>
                        </button>
                        
                        <p style="margin-top: 16px; color: var(--md-sys-color-on-surface-variant); font-size: 14px;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">verified_user</span>
                            Reconnaissance faciale sécurisée avec détection de vivacité
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="color: var(--md-sys-color-primary);">people</span>
                        Employés Enrolled (<span id="enrolledCount">0</span>)
                    </h3>
                    <div id="enrolledEmployeesList">
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="color: var(--md-sys-color-success);">check_circle</span>
                        Pointages Faciaux du Jour
                    </h3>
                    <div id="todayFaceAttendance">
                    </div>
                </div>
            </div>

            <!-- QR Presence Section -->
            <div id="qr-presence" class="section">
                <div class="qr-scan-section">
                    <h2><span class="material-icons">qr_code_scanner</span>Scanner QR Code pour Présence</h2>
                    <p>Tsindrio ny bokotra hanombohana ny scan.</p>
                    
                    <div style="margin-top: 16px;">
                        <button class="btn" onclick="startQRScan('attendance')">
                            <span class="material-icons">camera_alt</span>
                            Démarrer le Scanner
                        </button>
                        
                        <button class="btn btn-secondary" onclick="document.getElementById('qrImageInput').click()">
                            <span class="material-icons">photo_library</span>
                            Choisir une Image
                        </button>
                        <input type="file" id="qrImageInput" accept="image/*" capture="environment" style="display: none;" onchange="handleQRImageUpload(event)">

                    </div>
                </div>

                <div class="card">
                    <h2><span class="material-icons">today</span>Présences QR d'Aujourd'hui</h2>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <input type="date" class="form-control" id="qrAttendanceDate" style="max-width: 200px; flex: 1; min-width: 150px;" onchange="qrAttendanceCurrentPage = 1; displayQRAttendance()">
                        <button class="btn btn-secondary" onclick="refreshQRAttendance()" style="flex: 1; min-width: 120px;">
                            <span class="material-icons">refresh</span>
                            Actualiser
                        </button>
                        <button class="btn btn-warning" onclick="exportQRAttendancePDF()" style="flex: 1; min-width: 120px;">
                            <span class="material-icons">picture_as_pdf</span>
                            Export PDF
                        </button>
                    </div>
                    <div id="qrAttendanceList"></div>
                    <div class="pagination-controls" id="qrAttendancePagination" style="margin-top: 16px;">
                    </div>

                </div>
            </div>


            <!-- QR Codes Section -->
            <div id="qr-codes" class="section">
                <div class="card">
                    <h2><span class="material-icons">qr_code_2</span>Codes QR des Employés</h2>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button class="btn" onclick="generateAllQRCodes()">
                            <span class="material-icons">refresh</span>
                            Générer Tous les QR
                        </button>
                        <button class="btn btn-secondary" onclick="downloadAllQRCodes()">
                            <span class="material-icons">download</span>
                            Télécharger Tous
                        </button>
                        <button class="btn btn-warning" onclick="printAllQRCodes()">
                            <span class="material-icons">print</span>
                            Imprimer Tous
                        </button>
                    </div>
                    <div class="qr-container" id="qrContainer"></div>
                </div>
            </div>

            <!-- Attendance Section (Original) -->
            <div id="attendance" class="section">
                <div class="card">
                    <h2><span class="material-icons">schedule</span>Gestion des Présences (Manuel)</h2>
                    <div class="form-row" style="margin-bottom: 16px;">
                        <div class="form-group">
                            <label>Date de Présence</label>
                            <input type="date" class="form-control" id="attendanceDate" onchange="displayAttendance()">
                        </div>
                        <div class="form-group">
                            <label style="visibility: hidden;">Actions</label>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="goToPreviousDay()">
                                    <span class="material-icons">chevron_left</span>
                                    Jour Précédent
                                </button>
                                <button class="btn btn-secondary" onclick="goToNextDay()">
                                    <span class="material-icons">chevron_right</span>
                                    Jour Suivant
                                </button>
                            </div>
                        </div>
                        <div class="filter-controls">
                            <div class="form-group search-group">
                                <label for="attendanceEmployeeSearch">Rechercher un employé</label>
                                <div class="search-container">
                                    <span class="material-icons search-icon">search</span>
                                    <input type="text" class="search-input" id="attendanceEmployeeSearch" placeholder="Taper un nom..." oninput="filterAttendanceEmployees()">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="attendanceGroupFilter">Filtrer par Groupe</label>
                                <select class="form-control" id="attendanceGroupFilter" onchange="displayAttendance()">
                                    <option value="all">Tous les Groupes</option>
                                </select>
                            </div>

                            <div class="form-group items-per-page-group">
                                <label for="attendanceItemsPerPageSelect">Éléments par page</label>
                                <select id="attendanceItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('attendance', this.value)">
                                    <option value="10">10</option>
                                    <option value="20" selected>20</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                        </div>


                    </div>
                    <div id="attendanceList"></div>
                    <div class="pagination-controls" id="attendancePagination">
                    </div>

                    <button class="btn" onclick="saveAttendance()" style="margin-top: 16px;">
                        <span class="material-icons">save</span>
                        Enregistrer Présences
                    </button>
                </div>
            </div>

            <!-- Advances Section -->
            <div id="advances" class="section">
                <div class="card">
                    <h2><span class="material-icons">savings</span>Gestion des Avances</h2>
                    <form id="advanceForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Employé</label>
                                <div class="select-dropdown">
                                    <select class="form-control" id="advanceEmployee" required>
                                        <option value="">Sélectionner un employé</option>
                                    </select>
                                    <button type="button" class="btn btn-secondary" onclick="startQRScan('advance')" title="Scanner QR">

                                        <span class="material-icons">qr_code_scanner</span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="startFaceScanForSelection('advance')" title="Scanner Visage">
                                        <span class="material-icons">face</span>
                                    </button>

                                </div>
                            </div>

                            
                            <div class="form-group">
                                <label>Montant (Ar)</label>
                                <input type="text" class="form-control currency-input" id="advanceAmount" required data-type="currency">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" class="form-control" id="advanceDate" required>
                        </div>
                        <div class="form-group">
                            <label>Motif/Observation</label>
                            <textarea class="form-control" id="advanceReason" rows="3" placeholder="Motif de l'avance..."></textarea>
                        </div>

                        <div id="netSalaryPreview" style="margin-bottom: 16px; padding: 10px; border-radius: 8px; background-color: var(--md-sys-color-surface); display: none;"></div>

                        <button type="submit" class="btn">
                            <span class="material-icons">add</span>
                            Ajouter Avance
                        </button>
                    </form>
                    <div id="advancesSummary" style="margin-top: 24px; margin-bottom: 16px; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px; border-left: 5px solid var(--md-sys-color-primary);">
                        <h4 style="margin-top: 0; margin-bottom: 8px; color: var(--md-sys-color-primary);">Résumé des Avances pour le Mois Sélectionné</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.1em; font-weight: 500;">Total des Avances:</span>
                            <span id="totalAdvancesMonth" style="font-size: 1.5em; font-weight: 700; color: var(--md-sys-color-error);">0 Ar</span>
                        </div>
                        <p id="advancesSummaryPeriod" style="font-size: 0.9em; color: var(--md-sys-color-on-surface-variant); margin: 8px 0 0 0; text-align: right;"></p>
                    </div>

                    <div style="margin-top: 24px; margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="exportAdvances('pdf')">
                            <span class="material-icons">picture_as_pdf</span>
                            Export PDF
                        </button>
                        <button class="btn btn-success" onclick="exportAdvances('xlsx')">
                            <span class="material-icons">table_view</span>
                            Export Excel
                        </button>

                    </div>

                    <div class="form-row" style="margin-top: 24px; align-items: flex-end;">
                        <div class="form-group">
                            <label for="advanceSearchInput">Rechercher par nom, poste ou motif</label>
                            <div class="search-container" style="margin-bottom: 0; position: relative;">
                                <span class="material-icons search-icon">search</span>
                                <input type="text" class="search-input" id="advanceSearchInput" placeholder="Taper pour filtrer..." style="padding-right: 60px;">
                                <button type="button" class="btn btn-secondary" onclick="startQRScan('advances-search')" 
                                        title="Rechercher par QR Code" 
                                        style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 8px; border-radius: 50%; min-width: 40px; height: 40px;">
                                    <span class="material-icons">qr_code_scanner</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="advanceMonthFilter">Filtrer par mois</label>
                            <input type="month" class="form-control" id="advanceMonthFilter">
                        </div>
                        <div class="form-group">
                            <label for="advanceGroupFilter">Filtrer par Groupe</label>
                            <select class="form-control" id="advanceGroupFilter">
                                <option value="all">Tous les Groupes</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="max-width: 200px; margin-top: 16px;">
                        <label for="advancesItemsPerPageSelect">Éléments par page</label>
                        <select id="advancesItemsPerPageSelect" class="form-control" onchange="changeItemsPerPage('advances', this.value)">
                            <option value="10">10</option>
                            <option value="15" selected>15</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                        </select>
                    </div>


                    <div id="advancesList" style="margin-top: 16px;"></div>
                    <div class="pagination-controls" id="advancesPagination">
                    </div>


                </div>
            </div>

            <!-- Payroll Section -->
            <div id="payroll" class="section">
                <div class="card">
                    <h2><span class="material-icons">payments</span>Gestion de la Paie</h2>
                    
                    <div class="form-row" style="align-items: flex-end;">

                        <div class="form-group">
                            <label>Sélectionner Employé</label>
                            <div class="select-dropdown" style="display: flex;">
                                <select class="form-control" id="payrollEmployeeSelect" onchange="handlePayrollEmployeeChange()">
                                    <option value="">Tous les employés</option>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="startQRScan('payroll')" title="Scanner QR">
                                    <span class="material-icons">qr_code_scanner</span>
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="startFaceScanForSelection('payroll')" title="Scanner Visage">
                                    <span class="material-icons">face</span>
                                </button>

                            </div>
                        </div>

                        <div class="form-group">
                            <label>Filtrer par Groupe</label>
                            <div class="select-dropdown">
                                <select class="form-control" id="payrollGroupFilter" onchange="handlePayrollGroupChange()">
                                    <option value="all">Tous les Groupes</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Mois</label>
                            <input type="month" class="form-control" id="payrollMonth" value="">
                        </div>

                        <div class="form-group" style="margin-top: 16px; padding: 12px; background-color: rgba(103, 80, 164, 0.08); border-radius: 8px;">
                            <label for="includeAdvanceCheckbox" style="display: flex; align-items: center; cursor: pointer; font-weight: 500;">
                                <input type="checkbox" id="includeAdvanceCheckbox" class="checkbox" style="width: 20px; height: 20px; margin-right: 12px;" onchange="toggleAdvanceDaysInput()">
                                Inclure un acompte pour le mois suivant
                            </label>
                            <div id="advanceDaysContainer" class="form-group" style="display: none; margin-top: 12px; margin-bottom: 0;">
                                <label for="advanceDaysInput">Nombre de jours d'acompte</label>
                                <input type="number" id="advanceDaysInput" class="form-control" value="0" min="0" style="max-width: 150px;">
                            </div>
                        </div>

                    </div>

                    <button class="btn" onclick="calculatePayroll()">
                        <span class="material-icons">calculate</span>
                        Calculer Paie
                    </button>

                    <div id="payrollSummary" style="margin-top: 24px; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px; display: none;">
                        <h3 style="color: var(--md-sys-color-primary); margin-top: 0; margin-bottom: 16px;">Résumé de la Paie pour la Période</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <p style="margin: 0; font-size: 0.9em; color: var(--md-sys-color-on-surface-variant);">Total Brut Calculé</p>
                                <strong id="summaryTotalGross" style="color: var(--md-sys-color-primary); font-size: 1.2em;">0 Ar</strong>
                            </div>
                            <div>
                                <p style="margin: 0; font-size: 0.9em; color: var(--md-sys-color-on-surface-variant);">Total Avances Déduites</p>
                                <strong id="summaryTotalAdvances" style="color: var(--md-sys-color-error); font-size: 1.2em;">0 Ar</strong>
                            </div>
                            <div>
                                <p style="margin: 0; font-size: 0.9em; color: var(--md-sys-color-on-surface-variant);">Total Net à Payer</p>
                                <strong id="summaryTotalNet" style="color: var(--md-sys-color-success); font-size: 1.3em; font-weight: 700;">0 Ar</strong>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <p style="margin: 0; font-size: 0.8em; color: var(--md-sys-color-on-surface-variant);">Employés non payés:</p>
                            <div id="unpaidEmployeesList" style="font-size: 0.9em; max-height: 100px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>


                    <div id="payrollResults"></div>
                </div>
            </div>


            <!-- Payments Section -->
            <div id="payments" class="section">
                <div class="card">
                    <h2><span class="material-icons">history</span>Historique de Paiement</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Filtrer par Employé</label>
                            <div class="select-dropdown">
                                <select class="form-control" id="paymentEmployeeFilter" onchange="displayPayments()">
                                    <option value="">Tous les employés</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Recherche</label>
                            <input type="text" class="form-control" id="paymentSearch" placeholder="Rechercher...">
                        </div>
                    </div>
                    <div id="paymentList"></div>
                </div>
            </div>

            <!-- Solde de Tout Compte Section -->
            <div id="stc" class="section">
                <div class="card">
                    <h2><span class="material-icons">exit_to_app</span>Calcul du Solde de Tout Compte</h2>
                    <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                        Calculez et finalisez le paiement pour les employés qui quittent l'entreprise.
                    </p>

                    <div class="form-group">
                        <label>Sélectionner l'Employé (Départ Programmé)</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="stcEmployeeSelect" onchange="calculateSTC()">
                                <option value="">-- Choisir un employé --</option>
                            </select>
                        </div>
                    </div>

                    <div id="stcResultsContainer" style="margin-top: 24px; display: none;">
                    </div>
                </div>
            </div>


            <!-- Reports Section -->
            <div id="reports" class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-icons">today</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="reportPresentToday">0</h3>
                            <p>Présents Aujourd'hui</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-icons">calendar_month</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="reportPresentMonth">0</h3>
                            <p>Présences ce Mois</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-icons">payments</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="reportSalariesPaid">0 Ar</h3>
                            <p>Salaires Payés</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-icons">people</span>
                        </div>
                        <div class="stat-content">
                            <h3 id="reportActiveEmployees">0</h3>
                            <p>Employés Actifs</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2><span class="material-icons">analytics</span>Génération de Rapports</h2>
                    
                    <div class="form-group" style="max-width: 300px;">
                        <label for="reportMonth">Sélectionner le mois pour les rapports</label>
                        <input type="month" class="form-control" id="reportMonth">
                    </div>

                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px;">
                        <button class="btn" onclick="exportGlobalReport()">
                            <span class="material-icons">download</span>
                            Export Global (JSON)
                        </button>
                        <button class="btn btn-secondary" onclick="exportAttendanceReport()">
                            <span class="material-icons">schedule</span>
                            Export Présences (JSON)
                        </button>
                        <button class="btn btn-warning" onclick="generatePayrollPDFReport()">
                            <span class="material-icons">picture_as_pdf</span>
                            Rapport de Paie (PDF)
                        </button>
                    </div>
                </div>

            </div>
            <!-- SECTION : ESTIMATION DES SALAIRES -->
            <div id="estimation" class="section">
                <div class="card">
                    <h2><span class="material-icons">request_quote</span>Estimation des Salaires</h2>
                    <p style="margin-top: -12px; margin-bottom: 20px; color: var(--md-sys-color-on-surface-variant);">
                        Calculez une estimation du coût salarial total pour une période future.
                    </p>

                    <div class="form-row" style="align-items: flex-end; margin-bottom: 16px;">
                        <div class="form-group">
                            <label for="estimationStartDate">Date de Début</label>
                            <input type="date" class="form-control" id="estimationStartDate">
                        </div>
                        <div class="form-group">
                            <label for="estimationEndDate">Date de Fin</label>
                            <input type="date" class="form-control" id="estimationEndDate">
                        </div>
                        <div class="form-group">
                            <label for="estimationGroupFilter">Filtrer par Groupe</label>
                            <select class="form-control" id="estimationGroupFilter">
                                <option value="all">Tous les Groupes</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn" onclick="calculateSalaryEstimation()">
                        <span class="material-icons">calculate</span>
                        Lancer l'Estimation
                    </button>

                    <div id="estimationResultsContainer" style="margin-top: 24px; display: none;">
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="modal-header">
            <h3><span class="material-icons">settings</span>Paramètres</h3>
            <button class="close-btn" onclick="toggleSettings()">
                <span class="material-icons">close</span>
            </button>
        </div>

        <div class="settings-section">
            <h3><span class="material-icons">palette</span>Apparence</h3>
            <div class="form-group">
                <label>Thème</label>
                <div class="select-dropdown">
                    <select class="form-control" id="themeSelect" onchange="changeTheme(this.value)">
                        <option value="light">Clair</option>
                        <option value="dark">Sombre</option>
                        <option value="auto">Automatique</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3><span class="material-icons">qr_code</span>QR Code</h3>
            <div class="form-group">
                <label>Taille des QR Codes</label>
                <select class="form-control" id="qrSizeSelect" onchange="updateQRSettings()">
                    <option value="128">Petit (128px)</option>
                    <option value="256" selected>Moyen (256px)</option>
                    <option value="512">Grand (512px)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Couleur QR Code</label>
                <input type="color" class="form-control" id="qrColorSelect" value="#6750A4" onchange="updateQRSettings()">
            </div>
        </div>

        <div class="settings-section">
            
            <div class="settings-section">
                <h3><span class="material-icons">import_export</span>Synchronisation & Sauvegarde</h3>
                
                <div class="alert alert-info">
                    <span class="material-icons">info</span>
                    <div>
                        <strong>Fomba Fampiasana (Synchronisation):</strong>  

                        1. <strong>(Source)</strong> Tsindrio "Télécharger les Données" hamorona rakitra.  

                        2. Alefaso amin'ny fitaovana hafa ilay rakitra (USB, Email, sns).  

                        3. <strong>(Destination)</strong> Tsindrio "Importer les Données" ary safidio ilay rakitra.
                    </div>
                </div>

                <button class="btn" onclick="exportData()" style="width: 100%; margin-bottom: 12px; background-color: var(--md-sys-color-primary);">
                    <span class="material-icons">file_download</span>
                    Télécharger les Données (Export)
                </button>
                
                <div class="form-group">
                    <label for="importFile" style="cursor: pointer; display: block; padding: 12px; background-color: var(--md-sys-color-secondary-container); text-align: center; border-radius: 8px;">
                        <span class="material-icons">file_upload</span>
                        Importer les Données (Import)
                    </label>
                    <input type="file" class="form-control" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
                </div>
                <p id="lastBackupInfo" style="font-size: 12px; text-align: center; color: var(--md-sys-color-on-surface-variant);"></p>
            </div>

        </div>

        <div class="settings-section">
            <h3><span class="material-icons">delete_forever</span>Réinitialisation</h3>
            <p style="
                margin-bottom:8px;
                font-size: 11px;
                color: var(--md-sys-color-on-surface-variant);
                font-style: italic;
            ">
                Hamafa tanteraka ny angona rehetra ao amin'ny rafitra
                (employés, présences, paie, avances, groupes, QR, paramètres).
            </p>

            <button class="btn btn-danger" onclick="resetAllData()" style="width:100%;">
                <span class="material-icons">delete_forever</span>
                Reset total des données
            </button>
        </div>

        <div class="settings-section" style="margin-top: 40px; text-align: center; opacity: 0.8;">
            <h3 style="justify-content: center;">
                <span class="material-icons">code</span>
                Mombamomba ny Fampiharana
            </h3>
            <p style="font-size: 14px; margin-top: 8px;">
                Noforonin'i Rado Arijao tamim-pitiavana.
            </p>
            <p style="font-size: 12px; margin-top: 4px;">
                Version 1.0.0 &copy; 2025
            </p>
        </div>

    </div>

    <!-- Modals -->
    <div class="modal" id="editEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier Employé</h3>
                <button class="close-btn" onclick="closeModal('editEmployeeModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="editEmployeeForm">
                <input type="hidden" id="editEmployeeId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom Complet</label>
                        <input type="text" class="form-control" id="editEmployeeName" required>
                    </div>
                    <div class="form-group">
                        <label>Poste</label>
                        <input type="text" class="form-control" id="editEmployeePosition" required>
                    </div>
                    <div class="form-group">
                        <label>Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="editEmployeeGroup">
                                <option value="">Aucun groupe</option>
                            </select>
                        </div>
                    </div>

                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Genre</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="editEmployeeGender" required>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Salaire Mensuel (Ar)</label>
                        <input type="text" class="form-control currency-input" id="editEmployeeSalary" required data-type="currency">
                    </div>
                </div>
                <div class="form-group">
                    <label>Statut de l'Employé</label>
                    <div class="select-dropdown">
                        <select class="form-control" id="editEmployeeStatus">
                            <option value="actif">Actif</option>
                            <option value="depart">Départ Programmé</option>
                            <option value="inactif">Inactif (A quitté)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="editDepartureDateContainer" style="display: none;">
                    <label>Date de Départ</label>
                    <input type="date" class="form-control" id="editEmployeeDepartureDate">
                </div>
                <button type="submit" class="btn">
                    <span class="material-icons">save</span>
                    Sauvegarder
                </button>
            </form>
        </div>
    </div>

    <div class="modal" id="editAdvanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier une Avance</h3>
                <button class="close-btn" onclick="closeModal('editAdvanceModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="editAdvanceForm">
                <input type="hidden" id="editAdvanceId">
                
                <div class="form-group">
                    <label>Employé</label>
                    <p id="editAdvanceEmployeeName" style="font-weight: 500; font-size: 1.1rem;"></p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nouveau Montant (Ar)</label>
                        <input type="text" class="form-control currency-input" id="editAdvanceAmount" required data-type="currency">
                    </div>
                    <div class="form-group">
                        <label>Date de l'avance</label>
                        <input type="date" class="form-control" id="editAdvanceDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Motif/Observation</label>
                    <textarea class="form-control" id="editAdvanceReason" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn">
                    <span class="material-icons">save</span>
                    Enregistrer les modifications
                </button>
            </form>
        </div>
    </div>

    <div class="modal" id="addEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><span class="material-icons">person_add</span> Ajouter un Nouvel Employé</h3>
                <button class="close-btn" onclick="closeModal('addEmployeeModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="employeeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom Complet</label>
                        <input type="text" class="form-control" id="employeeName_add" required>
                    </div>
                    <div class="form-group">
                        <label>Poste</label>
                        <input type="text" class="form-control" id="employeePosition_add" required>
                    </div>
                    <div class="form-group">
                        <label>Groupe</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="employeeGroup_add">
                                <option value="">Aucun groupe</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Genre</label>
                        <div class="select-dropdown">
                            <select class="form-control" id="employeeGender_add" required>
                                <option value="">Sélectionner</option>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Salaire Mensuel (Ar)</label>
                        <input type="text" class="form-control currency-input" id="employeeSalary_add" required data-type="currency">
                    </div>
                </div>
                <button type="submit" class="btn">
                    <span class="material-icons">add</span>
                    Ajouter Employé
                </button>
            </form>
        </div>
    </div>

    <div class="modal" id="qrScannerModal">
        <div class="modal-content qr-modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="qrScannerTitle" style="display: flex; align-items: center; gap: 8px; font-size: clamp(1rem, 4vw, 1.3rem);"><span class="material-icons">qr_code_scanner</span> Scanner le QR Code</h3>
                <button class="close-btn" onclick="stopQRScan()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <div class="qr-modal-body" style="text-align: center; padding: 12px 0;">
                <p id="qrScannerInstruction" style="margin-bottom: 12px; color: var(--md-sys-color-on-surface-variant); font-size: 0.9rem; line-height: 1.2;">
                    Veuillez pointer la caméra vers le QR Code de l'employé.
                </p>

                <div class="video-container qr-video-container">
                    <video id="qrVideo" playsinline autoplay muted style="width: 100%; border-radius: 8px; display: none;"></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                    <div class="scan-overlay" id="scanOverlay" style="display: none;"></div>
                </div>
                
                <div id="cameraPermissionMessage" class="alert alert-warning" style="display: none; justify-content: center; margin-top: 12px; padding: 8px; font-size: 0.85rem;">
                    <span class="material-icons" style="font-size: 18px;">videocam_off</span>
                    <span>Mila fahazoan-dàlana hampiasa ny fakantsary.</span>
                </div>

                <div id="scanResult" class="scan-result" style="display: none; margin-top: 12px; padding: 8px; font-size: 0.9rem;"></div>
            </div>

            <div style="text-align: center; margin-top: 8px; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 12px;">
                <button class="btn btn-danger" onclick="stopQRScan()" style="width: 100%; max-width: 200px; padding: 10px;">
                    <span class="material-icons">cancel</span>
                    Annuler le Scan
                </button>
            </div>
        </div>
    </div>

    <script>
        // =======================================================================
        // ================== JAVASCRIPT VAOVAO SY NOHAVAOZINA ==================
        // =======================================================================

        // ===============================
        // SIDEBAR MANAGEMENT
        // ===============================
        const sidebar = document.querySelector(".sidebar");
        const sidebarToggle = document.querySelector("#sidebar-toggle");
        const mobileSidebarToggle = document.querySelector("#mobile-sidebar-toggle");
        const sidebarOverlay = document.querySelector(".sidebar-overlay");

        function toggleSidebar() {
            document.body.classList.toggle("sidebar-open");
            sidebar.classList.toggle("open");
        }

        if (sidebarToggle) {
            sidebarToggle.addEventListener("click", toggleSidebar);
        }
        if (mobileSidebarToggle) {
            mobileSidebarToggle.addEventListener("click", toggleSidebar);
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener("click", toggleSidebar);
        }

        // ===============================
        // INDEXEDDB MANAGER CLASS (tsy miova)
        // ===============================
        class IndexedDBManager {
            constructor() {
                this.db = null;
                this.dbName = 'BehavanaHRSystem';
                this.version = 4;
                this.isInitialized = false;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => {
                        console.error('Erreur lors de l\'ouverture de la base de données:', request.error);
                        this.updateDBStatus('Erreur de connexion à la base de données', 'error');
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        this.isInitialized = true;
                        this.updateDBStatus('Base de données connectée', 'connected');
                        console.log('Base de données IndexedDB initialisée avec succès');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        if (!db.objectStoreNames.contains('groups')) {
                            const groupStore = db.createObjectStore('groups', { keyPath: 'id' });
                            groupStore.createIndex('name', 'name', { unique: true });
                        }

                        if (db.objectStoreNames.contains('employees')) {
                            const employeeStore = event.target.transaction.objectStore('employees');
                            if (!employeeStore.indexNames.contains('groupId')) {
                                employeeStore.createIndex('groupId', 'groupId', { unique: false });
                            }
                        }
                        
                        if (!db.objectStoreNames.contains('employees')) {
                            const employeeStore = db.createObjectStore('employees', { keyPath: 'id' });
                            employeeStore.createIndex('name', 'name', { unique: false });
                            employeeStore.createIndex('position', 'position', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('attendance')) {
                            const attendanceStore = db.createObjectStore('attendance', { keyPath: 'date' });
                            attendanceStore.createIndex('date', 'date', { unique: true });
                        }

                        if (!db.objectStoreNames.contains('payrolls')) {
                            const payrollStore = db.createObjectStore('payrolls', { keyPath: 'id' });
                            payrollStore.createIndex('employeeId', 'employeeId', { unique: false });
                            payrollStore.createIndex('month', 'month', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('advances')) {
                            const advanceStore = db.createObjectStore('advances', { keyPath: 'id' });
                            advanceStore.createIndex('employeeId', 'employeeId', { unique: false });
                            advanceStore.createIndex('date', 'date', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }

                        if (!db.objectStoreNames.contains('qr_attendance')) {
                            const qrAttendanceStore = db.createObjectStore('qr_attendance', { keyPath: 'id' });
                            qrAttendanceStore.createIndex('employeeId', 'employeeId', { unique: false });
                            qrAttendanceStore.createIndex('date', 'date', { unique: false });
                            qrAttendanceStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('qr_codes')) {
                            const qrCodesStore = db.createObjectStore('qr_codes', { keyPath: 'employeeId' });
                            qrCodesStore.createIndex('generated', 'generated', { unique: false });
                        }
                    };
                });
            }

            updateDBStatus(message, type = 'connected') {
                const statusElement = document.getElementById('dbStatus');
                const textElement = document.getElementById('dbStatusText');
                
                if (statusElement && textElement) {
                    statusElement.className = `db-status ${type}`;
                    textElement.textContent = message;
                }
            }

            async add(storeName, data) {
                if (!this.isInitialized) throw new Error('Base de données non initialisée');
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async put(storeName, data) {
                if (!this.isInitialized) throw new Error('Base de données non initialisée');
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async get(storeName, key) {
                if (!this.isInitialized) throw new Error('Base de données non initialisée');
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                if (!this.isInitialized) throw new Error('Base de données non initialisée');
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, key) {
                if (!this.isInitialized) throw new Error('Base de données non initialisée');
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                if (!this.isInitialized) throw new Error('Base de données non initialisée');
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // ===============================
        // APPLICATION STATE & VARIABLES (tsy miova)
        // ===============================
        let dbManager = new IndexedDBManager();
        let weeklyAttendanceChartInstance = null;
        let genderDistributionChartInstance = null;
        let groupDistributionChartInstance = null;
        let employees = [];
        let employeeCurrentPage = 1;
        let employeeItemsPerPage = 20;
        let attendanceCurrentPage = 1;
        let attendanceItemsPerPage = 20;
        let advancesCurrentPage = 1;
        let advancesItemsPerPage = 15;
        let qrAttendanceCurrentPage = 1;
        let qrAttendanceItemsPerPage = 15;
        let groups = [];
        let attendance = {};
        let payrolls = [];
        let advances = [];
        let qrAttendance = [];
        let qrCodes = {};
        let currentTheme = 'light';
        let isScanning = false;
        let scanInterval = null;
        let qrSettings = {
            size: 256,
            color: '#6750A4'
        };
        let currentScanPurpose = null;
        let scanStream = null;
        let audioContext;
        let successSoundBuffer;
        let nextSoundBuffer;
        let displayedEmployeesCount = 0;
        const employeesPerPage = 25;

        // ===============================
        // GESTION DU SON (tsy miova)
        // ===============================
        function initializeAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    const resume = () => {
                        audioContext.resume();
                        document.body.removeEventListener('click', resume);
                        document.body.removeEventListener('touchstart', resume);
                    };
                    document.body.addEventListener('click', resume);
                    document.body.addEventListener('touchstart', resume);
                }
            } catch (e) {
                console.error("Tsy afaka namorona AudioContext:", e);
            }
        }

        function playSuccessSound() {
            if (!audioContext) return;
            try {
                const now = audioContext.currentTime;
                const gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.5, now);
                const osc1 = audioContext.createOscillator();
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(440, now);
                osc1.connect(gainNode);
                osc1.start(now);
                osc1.stop(now + 0.1);
                const osc2 = audioContext.createOscillator();
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(554.37, now + 0.1);
                osc2.connect(gainNode);
                osc2.start(now + 0.1);
                osc2.stop(now + 0.2);
                const osc3 = audioContext.createOscillator();
                osc3.type = 'sine';
                osc3.frequency.setValueAtTime(739.99, now + 0.2);
                osc3.connect(gainNode);
                osc3.start(now + 0.2);
                osc3.stop(now + 0.5);
            } catch (e) {
                console.error("Tsy afaka nandefa feo:", e);
            }
        }

        function playAuSuivantSound() {
            let audioPlayer = document.getElementById('audioPlayerAuSuivant');
            if (!audioPlayer) {
                audioPlayer = new Audio('suivant.mp3'); 
                audioPlayer.id = 'audioPlayerAuSuivant';
                audioPlayer.style.display = 'none';
                document.body.appendChild(audioPlayer);
            }
            audioPlayer.currentTime = 0; 
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Tsy afaka nandefa ny feo 'suivant.mp3':", error);
                    if (typeof audioContext !== 'undefined' && audioContext.state === 'suspended') {
                        audioContext.resume().then(() => audioPlayer.play());
                    }
                });
            }
        }

        // ===============================
        // INITIALIZATION (tsy miova)
        // ===============================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                initializeAudio();
                await dbManager.init();
                await loadData();
                await new Promise(resolve => setTimeout(resolve, 100));
                updateStats();
                setCurrentDate();
                setCurrentMonth();
                populateEmployeeSelects();
                populateGroupSelects();
                initializeTheme();
                initializeCurrencyInputs();
                initializeQRFunctionality();
                updateLastBackupInfo();
                displayDashboardCharts();
                runSmartChecks();
                console.log('🚀 Système RH avec QR Code initialisé avec succès');
            } catch (error) {
                console.error('❌ Erreur lors de l\'initialisation:', error);
                dbManager.updateDBStatus('Erreur d\'initialisation', 'error');
                showAlert('Erreur lors de l\'initialisation de la base de données', 'error');
            }

            document.getElementById('editEmployeeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const employeeId = document.getElementById('editEmployeeId').value;
                const newName = capitalizeWords(document.getElementById('editEmployeeName').value.trim());
                const newPosition = capitalizeWords(document.getElementById('editEmployeePosition').value.trim());
                const newGender = document.getElementById('editEmployeeGender').value;
                const newSalary = getCurrencyValue('editEmployeeSalary');
                const newGroupId = document.getElementById('editEmployeeGroup').value;
                const newStatus = document.getElementById('editEmployeeStatus').value;
                const newDepartureDate = document.getElementById('editEmployeeDepartureDate').value || null;

                if (!employeeId || !newName || !newPosition || newSalary === 0) {
                    showAlert("Veuillez remplir tous les champs correctement.", 'error');
                    return;
                }

                const employeeIndex = employees.findIndex(emp => emp.id === employeeId);
                if (employeeIndex === -1) {
                    showAlert("Erreur: Employé non trouvé.", 'error');
                    return;
                }

                employees[employeeIndex].name = newName;
                employees[employeeIndex].position = newPosition;
                employees[employeeIndex].gender = newGender;
                employees[employeeIndex].salary = newSalary;
                employees[employeeIndex].groupId = newGroupId || null;
                employees[employeeIndex].status = newStatus;
                employees[employeeIndex].departureDate = newDepartureDate;

                await saveData();
                closeModal('editEmployeeModal');
                displayEmployees();
                updateStats();
                populateEmployeeSelects();
                showAlert("Les informations de l'employé ont été mises à jour avec succès!", 'success');
            });

            const smartSearchInput = document.getElementById('smartSearchInput');
            const statsMonthInput = document.getElementById('statsMonth');
            if (statsMonthInput) statsMonthInput.value = new Date().toISOString().slice(0, 7);
            if (smartSearchInput) smartSearchInput.addEventListener('input', debounce(handleSmartSearch, 300));
            if (statsMonthInput) {
                statsMonthInput.addEventListener('change', () => {
                    if (document.getElementById('employeeStatusResults').innerHTML !== '' && document.getElementById('employeeStatusResults').innerText.trim() !== '') {
                        const currentEmployeeName = document.getElementById('smartSearchInput').value;
                        const employee = employees.find(e => e.name === currentEmployeeName);
                        if (employee) displayEmployeeStatus(employee.id);
                    }
                });
            }
            document.getElementById('editAdvanceForm').addEventListener('submit', handleUpdateAdvance);
            document.getElementById('advanceSearchInput').addEventListener('input', displayAdvances);
            document.getElementById('advanceMonthFilter').addEventListener('change', displayAdvances);
            const advanceMonthFilter = document.getElementById('advanceMonthFilter');
            if (advanceMonthFilter) advanceMonthFilter.value = new Date().toISOString().slice(0, 7);
            document.getElementById('employeeSearch').addEventListener('input', () => {
                employeeCurrentPage = 1;
                displayEmployees();
            });
            document.getElementById('employeeGroupFilter').addEventListener('change', () => {
                employeeCurrentPage = 1;
                displayEmployees();
            });
            document.getElementById('attendanceDate').addEventListener('change', () => {
                attendanceCurrentPage = 1;
                displayAttendance();
            });
            document.getElementById('attendanceEmployeeSearch').addEventListener('input', () => {
                attendanceCurrentPage = 1;
                displayAttendance();
            });
            document.getElementById('advanceSearchInput').addEventListener('input', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });
            document.getElementById('advanceMonthFilter').addEventListener('change', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });
            document.getElementById('advanceGroupFilter').addEventListener('change', () => {
                advancesCurrentPage = 1;
                displayAdvances();
            });
        });

        // ===============================
        // SHOW SECTION (NOHAVAOZINA)
        // ===============================
        function showSection(sectionId, event = null) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                sectionToShow.classList.add('active');
            }
            
            document.querySelectorAll('.sidebar li a').forEach(tab => {
                tab.classList.remove('active');
            });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                const tabToActivate = document.querySelector(`.sidebar a[onclick*="'${sectionId}'"]`);
                if (tabToActivate) {
                    tabToActivate.classList.add('active');
                }
            }
            
            // Manidy ho azy ny sidebar amin'ny finday
            if (window.innerWidth <= 768 && document.body.classList.contains('sidebar-open')) {
                toggleSidebar();
            }

            switch (sectionId) {
                case 'dashboard':
                    updateStats();
                    displayDashboardCharts();
                    break;
                case 'employees':
                    displayEmployees();
                    break;
                case 'groups':
                    displayGroups();
                    break;
                case 'attendance':
                    displayAttendance();
                    break;
                case 'qr-presence':
                    displayQRAttendance();
                    break;
                case 'face-presence': 
                    displayEnrolledEmployees();
                    displayTodayFaceAttendance();
                    break;    
                case 'qr-codes':
                    generateAllQRCodes();
                    break;
                case 'advances':
                    displayAdvances();
                    break;
                case 'payroll':
                    document.getElementById('payrollResults').innerHTML = '<p style="text-align: center; padding: 20px;">Veuillez sélectionner un mois et cliquer sur "Calculer Paie".</p>';
                    document.getElementById('payrollSummary').style.display = 'none';
                    break;
                case 'payments':
                    displayPayments();
                    break;
                case 'stc':
                    populateSTCEmployee
                case 'stc':
                    populateSTCEmployeeSelect();
                    const stcContainer = document.getElementById('stcResultsContainer');
                    if (stcContainer) {
                        stcContainer.style.display = 'none';
                    }
                    break;
                case 'reports':
                    updateReportStats();
                    break;
                case 'estimation':
                    populateGroupSelects();
                    const today = new Date();
                    const startDateInput = document.getElementById('estimationStartDate');
                    const endDateInput = document.getElementById('estimationEndDate');
                    if(startDateInput && endDateInput) {
                        startDateInput.value = today.toISOString().slice(0, 10);
                        const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        endDateInput.value = endOfMonth.toISOString().slice(0, 10);
                    }
                    break;
            }
        }

        // Ny ambin'ny kaody JavaScript rehetra dia mitovy amin'ny teo aloha
        // ... (Adikao eto daholo ny ambin'ny script teo aloha)
        
        // Ity ny tohin'ny script rehetra tsy niova
        // (Ny ankamaroan'ny fonctions-nao teo aloha)

        function initializeQRFunctionality() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('qrAttendanceDate').value = today;
            displayQRAttendance();
        }

        async function generateQRCode(employee, size = 256, color = '#6750A4') {
            const tempDiv = document.createElement('div');
            tempDiv.style.display = 'none';
            document.body.appendChild(tempDiv);
            try {
                const qrDataString = `BEHAVANA_HR::${employee.id}`;
                const qrcode = new QRCode(tempDiv, {
                    text: qrDataString,
                    width: size,
                    height: size,
                    colorDark: color,
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                await new Promise(resolve => setTimeout(resolve, 50));
                const imgElement = tempDiv.querySelector('img');
                if (!imgElement) throw new Error("Tsy voaforona ny sary QR Code.");
                const dataURL = imgElement.src;
                document.body.removeChild(tempDiv);
                return dataURL;
            } catch (error) {
                console.error(`Erreur critique avec QRCode.js pour ${employee.name}:`, error);
                if (document.body.contains(tempDiv)) document.body.removeChild(tempDiv);
                return null;
            }
        }

        async function generateAllQRCodes() {
            const container = document.getElementById('qrContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>Génération des QR codes en cours...</p></div>';
            try {
                const qrCardsHTML = [];
                for (const employee of employees) {
                    const dataURL = await generateQRCode(employee, qrSettings.size, qrSettings.color);
                    if (dataURL) {
                        await dbManager.put('qr_codes', {
                            employeeId: employee.id,
                            dataURL: dataURL,
                            generated: new Date().toISOString(),
                            size: qrSettings.size,
                            color: qrSettings.color
                        });
                        qrCardsHTML.push(`
                            <div class="qr-card">
                                <h4>${employee.name}</h4>
                                <p>${employee.position}</p>
                                <div class="qr-code-canvas">
                                    <img src="${dataURL}" alt="QR Code de ${employee.name}" width="${qrSettings.size}" height="${qrSettings.size}" />
                                </div>
                                <div class="qr-actions">
                                    <button class="btn-icon" onclick="downloadQRCode('${employee.id}')" title="Télécharger"><span class="material-icons">download</span></button>
                                    <button class="btn-icon" onclick="printQRCode('${employee.id}')" title="Imprimer"><span class="material-icons">print</span></button>
                                </div>
                            </div>
                        `);
                    }
                }
                container.innerHTML = qrCardsHTML.join('');
                showAlert(`${qrCardsHTML.length} QR codes générés avec succès!`, 'success');
            } catch (error) {
                console.error('Erreur critique lors de la génération des QR codes:', error);
                container.innerHTML = '<p style="text-align: center; color: var(--md-sys-color-error);">Une erreur inattendue est survenue.</p>';
                showAlert('Erreur critique lors de la génération des QR codes', 'error');
            }
        }

        async function startQRScan(purpose) {
            if (isScanning) stopQRScan(false);
            currentScanPurpose = purpose;
            const video = document.getElementById('qrVideo');
            const overlay = document.getElementById('scanOverlay');
            const permissionMsg = document.getElementById('cameraPermissionMessage');
            const scannerTitle = document.getElementById('qrScannerTitle');
            const scannerInstruction = document.getElementById('qrScannerInstruction');
            const scanResult = document.getElementById('scanResult');
            scanResult.style.display = 'none';
            permissionMsg.style.display = 'none';
            switch (purpose) {
                case 'attendance':
                    scannerTitle.innerHTML = `<span class="material-icons">qr_code_scanner</span> Scanner pour Présence`;
                    scannerInstruction.textContent = "Marquer l'arrivée ou le départ d'un employé.";
                    break;
                case 'payroll':
                    scannerTitle.innerHTML = `<span class="material-icons">payments</span> Scanner pour la Paie`;
                    scannerInstruction.textContent = "Sélectionner un employé pour le calcul de la paie.";
                    break;
                case 'advance':
                    scannerTitle.innerHTML = `<span class="material-icons">savings</span> Scanner pour Avance`;
                    scannerInstruction.textContent = "Sélectionner un employé pour une demande d'avance.";
                    break;
                case 'advances-search':
                    scannerTitle.innerHTML = `<span class="material-icons">search</span> Scanner pour Rechercher`;
                    scannerInstruction.textContent = "Scannez le QR Code pour rechercher les avances de cet employé.";
                    break;
                default:
                    scannerTitle.innerHTML = `<span class="material-icons">qr_code_scanner</span> Scanner QR Code`;
                    scannerInstruction.textContent = "Veuillez pointer la caméra vers le QR Code.";
                    break;
            }
            isScanning = true;
            openModal('qrScannerModal');
            try {
                const constraints = { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
                scanStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = scanStream;
                video.setAttribute('playsinline', '');
                video.setAttribute('autoplay', '');
                video.setAttribute('muted', '');
                await video.play().catch(err => console.error('Erreur lecture vidéo:', err));
                video.style.display = 'block';
                overlay.style.display = 'block';
                const canvas = document.getElementById('qrCanvas');
                scanInterval = setInterval(() => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) scanQRFromVideo(video, canvas);
                }, 500);
            } catch (error) {
                console.error("Erreur d'accès à la caméra:", error);
                permissionMsg.style.display = 'flex';
                let errorMessage = '';
                if (error.name === 'NotAllowedError') errorMessage = "Permission refusée. Sur iPhone: Réglages > Safari > Caméra > Autoriser.";
                else if (error.name === 'NotFoundError') errorMessage = "Aucune caméra trouvée sur cet appareil.";
                else if (error.name === 'NotReadableError') errorMessage = "Caméra déjà utilisée. Fermez les autres apps utilisant la caméra.";
                else errorMessage = "Erreur: " + error.message;
                permissionMsg.querySelector('span').textContent = errorMessage;
                stopQRScan();
            }
        }

        function stopQRScan(showMsg = true) {
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            const video = document.getElementById('qrVideo');
            if(video) video.style.display = 'none';
            const overlay = document.getElementById('scanOverlay');
            if(overlay) overlay.style.display = 'none';
            closeModal('qrScannerModal');
            if (showMsg && isScanning) showAlert("Scan annulé.", "warning");
            isScanning = false;
        }

        function scanQRFromVideo(video, canvas) {
            const context = canvas.getContext('2d', { willReadFrequently: true });
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                playSuccessSound();
                handleQRScanResult(code.data);
            }
        }

        async function handleQRScanResult(qrData) {
            const purpose = currentScanPurpose;
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            let employeeId = null;
            try {
                if (qrData.startsWith('BEHAVANA_HR::')) {
                    employeeId = qrData.split('::')[1];
                } else if (qrData.startsWith('{') && qrData.endsWith('}')) {
                    const parsedData = JSON.parse(qrData);
                    if (parsedData.type === 'BEHAVANA_ATTENDANCE' && parsedData.employeeId) employeeId = parsedData.employeeId;
                } else {
                    try {
                        const decodedString = decodeURIComponent(escape(atob(qrData)));
                        if (decodedString.startsWith('{')) {
                            const parsedData = JSON.parse(decodedString);
                            if (parsedData.type === 'BEHAVANA_ATTENDANCE' && parsedData.employeeId) employeeId = parsedData.employeeId;
                        }
                    } catch (base64Error) {
                        console.log("Tsy Base64 ilay QR Code, mandroso...");
                    }
                }
            } catch (e) {
                console.error("Erreur famakiana QR Data:", e);
                showScanResult('QR Code illisible na simba.', 'error');
                return;
            }
            if (!employeeId) {
                showScanResult('QRCode non valide pour ce système.', 'error');
                return;
            }
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) {
                showScanResult(`Employé tsy hita (ID: ${employeeId})`, 'error');
                return;
            }
            if (purpose === 'attendance') {
                const success = await processAttendanceScan(employee);
                if (success) setTimeout(() => { stopQRScan(false); }, 800);
            } else {
                if (purpose === 'advance') {
                    const advanceEmployeeSelect = document.getElementById('advanceEmployee');
                    advanceEmployeeSelect.value = employee.id;
                    advanceEmployeeSelect.dispatchEvent(new Event('change'));
                    showAlert(`Employé sélectionné: ${employee.name}`, 'success');
                } else if (purpose === 'payroll') {
                    const payrollEmployeeSelect = document.getElementById('payrollEmployeeSelect');
                    populatePayrollEmployeeSelect('all');
                    payrollEmployeeSelect.value = employee.id;
                    handlePayrollEmployeeChange();
                    showAlert(`Employé sélectionné: ${employee.name}`, 'success');
                } else if (purpose === 'advances-search') {
                    const searchInput = document.getElementById('advanceSearchInput');
                    if (searchInput) {
                        searchInput.value = employee.name;
                        advancesCurrentPage = 1;
                        displayAdvances();
                        showAlert(`🔍 Recherche effectuée pour: ${employee.name}`, 'success');
                    }
                }
                stopQRScan(false);
            }
        }

        async function processAttendanceScan(employee) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toLocaleTimeString('fr-FR', { hour12: false });
            if (!attendance[today]) attendance[today] = {};
            const existingAttendance = attendance[today][employee.id];
            if (!existingAttendance) {
                attendance[today][employee.id] = { status: 'journee', arrivee: currentTime, depart: null, method: 'QR' };
                showScanResult(`✅ Arrivée enregistrée pour ${employee.name} à ${currentTime}`, 'success');
                await saveAttendanceData();
                updateStats();
                runSmartChecks();
                if (document.getElementById('qr-presence').classList.contains('active')) displayQRAttendance();
                if (document.getElementById('attendance').classList.contains('active')) displayAttendance();
                return true;
            } else if (existingAttendance && !existingAttendance.depart) {
                existingAttendance.depart = currentTime;
                showScanResult(`✅ Départ enregistré pour ${employee.name} à ${currentTime}`, 'success');
                await saveAttendanceData();
                updateStats();
                runSmartChecks();
                if (document.getElementById('qr-presence').classList.contains('active')) displayQRAttendance();
                if (document.getElementById('attendance').classList.contains('active')) displayAttendance();
                return true;
            } else {
                const arrivalTime = existingAttendance.arrivee;
                const departureTime = existingAttendance.depart;
                const errorMessageHTML = `<div style="text-align: center;"><span class="material-icons" style="font-size: 36px; margin-bottom: 8px;">error</span><h4 style="margin: 0; font-size: 1.1rem;">DÉJÀ ENREGISTRÉ</h4><p style="margin: 8px 0 0 0;"><strong>${employee.name}</strong> a déjà pointé pour la journée.</p><div style="margin-top: 12px; padding: 8px; background-color: rgba(0,0,0,0.1); border-radius: 8px;">Heure d'arrivée: <strong style="font-size: 1.1em;">${arrivalTime}</strong> | Heure de départ: <strong style="font-size: 1.1em;">${departureTime}</strong></div></div>`;
                showScanResult(errorMessageHTML, 'error');
                return false;
            }
        }

        function showScanResult(message, type) {
            const scanResult = document.getElementById('scanResult');
            if (!scanResult) return;
            scanResult.innerHTML = message;
            scanResult.className = `scan-result ${type}`;
            scanResult.style.display = 'block';
        }

        // ... Tohizo eto ny ambin'ny fonctions JavaScript rehetra ...
        // (displayQRAttendance, saveData, loadData, updateStats, sns...)
        // Ny code rehetra teo aloha dia tokony ho tafiditra eto.
        // Ity dia ohatra fohy fotsiny.
        
        async function saveData() {
            try {
                await dbManager.clear('employees');
                for (const employee of employees) await dbManager.add('employees', employee);
                await dbManager.clear('groups');
                for (const group of groups) await dbManager.add('groups', group);
                await dbManager.clear('attendance');
                for (const [date, dayAttendance] of Object.entries(attendance)) await dbManager.put('attendance', { date, data: dayAttendance });
                await dbManager.clear('payrolls');
                for (const payroll of payrolls) await dbManager.add('payrolls', payroll);
                await dbManager.clear('advances');
                for (const advance of advances) await dbManager.add('advances', advance);
                await dbManager.put('settings', { key: 'theme', value: currentTheme });
                await dbManager.put('settings', { key: 'qrSettings', value: qrSettings });
                await dbManager.put('settings', { key: 'lastUpdated', value: new Date().toISOString() }); 
                console.log('Données sauvegardées dans IndexedDB');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showAlert('Erreur lors de la sauvegarde des données', 'error');
            }
        }

        async function loadData() {
            try {
                employees = await dbManager.getAll('employees');
                const attendanceRecords = await dbManager.getAll('attendance');
                attendance = {};
                attendanceRecords.forEach(record => { attendance[record.date] = record.data; });
                payrolls = await dbManager.getAll('payrolls');
                advances = await dbManager.getAll('advances');
                groups = await dbManager.getAll('groups');
                qrAttendance = await dbManager.getAll('qr_attendance');
                const themeSettings = await dbManager.get('settings', 'theme');
                if (themeSettings) currentTheme = themeSettings.value;
                const qrSettingsData = await dbManager.get('settings', 'qrSettings');
                if (qrSettingsData) qrSettings = qrSettingsData.value;
                console.log('Données chargées depuis IndexedDB');
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                showAlert('Erreur lors du chargement des données', 'error');
            }
        }
        
        // ... sy ny sisa rehetra ...
        // Ny ankamaroan'ny fonctions hafa dia tsy mila ovaina fa efa mandeha.
        // Aza adino ny mametraka azy rehetra eto.

        // Ohatra:
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span> ${message}`;
            document.body.appendChild(alertDiv);
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '24px';
            alertDiv.style.right = '24px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.animation = 'slideInRight 0.3s ease';
            setTimeout(() => {
                alertDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv);
                }, 300);
            }, 3000);
        }

        // ... sy ny sisa ...
        // Ataovy azo antoka fa tafiditra daholo ny script teo aloha.
    </script>
</body>
</html>
